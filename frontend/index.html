<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸª™</text></svg>" type="image/svg+xml">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinShelf - Collection Manager</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom styles for a more polished look */
        body {
            background-color: #111827; /* Dark gray background */
            color: #d1d5db; /* Light gray text */
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        /* Custom scrollbar for a modern feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Custom scrollbar for specific elements */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }


        /* General styles for containers, no specific map library styles needed here */
        #map-container {
            width: 100%; /* min-height can be adjusted based on desired aspect ratio. 500px is a good start. */
            min-height: 500px;
            display: flex; /* Flex to center content if needed, though GeoChart fills its container */
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            overflow: hidden; /* Hide any overflow from the chart */
        }
        /* Make sure Google Charts fits its container */
        #map-container > div {
            width: 100% !important;
            height: 100% !important;
        }

        /* --- Google Charts Tooltip Custom Styles --- */
        /* This targets the main tooltip container, typically generated by Google Charts */
        .google-visualization-tooltip {
            background-color: #1f2937 !important; /* Dark background */
            border: 1px solid #4b5563 !important; /* Darker border */
            color: #d1d5db !important; /* Light text */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4) !important; /* Soft shadow */
            border-radius: 0.5rem !important; /* Rounded corners */
            padding: 0.75rem 1rem !important; /* Padding inside */
            font-family: 'Inter', sans-serif !important; /* Match app font */
            font-size: 0.875rem !important; /* Standard text size */
            line-height: 1.5 !important; /* Better line spacing */
        }
        /* Style for text within the tooltip */
        .google-visualization-tooltip p {
            margin-bottom: 0.25rem !important;
        }
        /* Style for headers within the tooltip if any */
        .google-visualization-tooltip h3 {
            color: #34D399 !important; /* Highlight color for headers, e.g., emerald */
            font-size: 1.125rem !important; /* Slightly larger heading */
            margin-bottom: 0.5rem !important;
        }
        /* Style for scrollable content within tooltip */
        .google-visualization-tooltip .tooltip-scroll-content {
            max-height: 100px; /* Limit height */
            overflow-y: auto; /* Enable scroll if content overflows */
            padding-right: 5px; /* Space for scrollbar */
        }
        /* Custom scrollbar for tooltip content */
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar {
            width: 6px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 3px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }

        /* Table hover effect */
        .data-table tbody tr:hover {
            background-color: #1f2937;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Chart.js tooltip custom styles */
        .chartjs-tooltip {
            background: #1f2937 !important;
            border: 1px solid #4b5563 !important;
            border-radius: 0.5rem !important;
            color: #d1d5db !important;
        }

        /* Overlay for unauthenticated state */
        .unauthenticated-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(17, 24, 39, 0.9); /* Opaque gray-900 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            z-index: 10; /* Ensure it's above content */
        }
        .unauthenticated-overlay p {
            color: #9ca3af; /* Gray-400 */
            font-size: 1.125rem;
            text-align: center;
            padding: 1rem;
        }
        /* Hidden by default, shown when unauthenticated */
        .unauthenticated-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    <aside class="w-64 bg-gray-900 text-gray-200 flex flex-col hidden md:flex">
        <div class="p-4 border-b border-gray-700 flex items-center justify-between">
            <div class="flex items-center">
                <i class="ph ph-coin text-3xl text-emerald-400"></i>
                <h1 class="text-xl font-bold ml-2">CoinShelf by Oscar</h1>
            </div>
        </div>
        <div class="flex-grow overflow-y-auto">
            <nav class="p-4">
                <a href="#" id="nav-home" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white transition-colors active-nav-link">
                    <i class="ph ph-house text-lg mr-3"></i>
                    Home
                </a>
                <a href="#" id="nav-dashboard" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="ph ph-chart-bar text-lg mr-3"></i>
                    Dashboard
                </a>
                <a href="#" id="nav-bullion" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="ph ph-flask-ask text-lg mr-3"></i> Bullion
                </a>
                <a href="#" id="nav-collection" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="ph ph-wallet text-lg mr-3"></i>
                    Collection
                </a>
                <a href="#" id="nav-map" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="ph ph-map-pin text-lg mr-3"></i>
                    Map View
                </a>
                <a href="#" id="nav-public-collection" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="ph ph-globe-hemisphere-west text-lg mr-3"></i>
                    Public Collection
                </a>
                <a href="#" id="nav-settings" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">
                    <i class="ph ph-gear text-lg mr-3"></i>
                    Settings
                </a>
            </nav>
        </div>
        <div class="p-4 border-t border-gray-700">
            <button id="signin-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Sign In</button>
            <button id="signup-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm mt-3">Sign Up</button>
            <button id="signout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm mt-3 hidden transition-colors">Sign Out</button>
        </div>
    </aside>

    <main id="main-content-area" class="flex-1 flex flex-col md:ml-64">
        <header class="bg-gray-800 p-4 md:hidden flex items-center justify-between">
            <button id="mobile-menu-btn" class="text-gray-400 hover:text-white focus:outline-none">
                <i class="ph ph-list text-2xl"></i>
            </button>
            <h1 class="text-xl font-bold text-gray-200">CoinShelf</h1>
            <div class="w-8"></div> </header>

        <div id="content-home" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative active">
            <div id="home-unauthenticated-overlay" class="unauthenticated-overlay hidden">
                <p>Please sign in or create an account to manage your collection.</p>
            </div>
            <div class="max-w-4xl mx-auto py-8">
                <h1 class="text-4xl font-extrabold text-white mb-6">Welcome to CoinShelf!</h1>
                <p class="text-lg text-gray-300 mb-8">
                    Your personal collection manager for coins, banknotes, and now, precious metals.
                    Keep track of your valuable items, view statistics, and explore your collection on a map.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Items</h3>
                        <p class="text-4xl font-bold text-emerald-400" id="home-total-items">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Value</h3>
                        <p class="text-4xl font-bold text-blue-400" id="home-total-value">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Unique Countries</h3>
                        <p class="text-4xl font-bold text-purple-400" id="home-unique-countries">0</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-8">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Quick Actions</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="quick-add-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                            <i class="ph ph-plus-circle text-xl mr-2"></i> Add New Item
                        </button>
                        <button id="quick-import-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                            <i class="ph ph-upload-simple text-xl mr-2"></i> Import Collection
                        </button>
                        <button id="quick-export-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                            <i class="ph ph-download-simple text-xl mr-2"></i> Export Collection
                        </button>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Your Latest Additions</h2>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-700 data-table">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Country</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Year</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Denomination</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Value</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Notes</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Image</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="latest-additions-table-body" class="divide-y divide-gray-800">
                                <tr><td colspan="9" class="p-4 text-center text-gray-500">No items yet. Add one using the "Add Item" button!</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-dashboard" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
            <div id="dashboard-unauthenticated-overlay" class="unauthenticated-overlay hidden">
                <p>Please sign in to view your dashboard.</p>
            </div>
            <div class="max-w-4xl mx-auto py-8">
                <h1 class="text-4xl font-extrabold text-white mb-6">Your Dashboard</h1>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Items</h3>
                        <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-items">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Value</h3>
                        <p class="text-4xl font-bold text-blue-400" id="dashboard-total-value">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Unique Countries</h3>
                        <p class="text-4xl font-bold text-purple-400" id="dashboard-unique-countries">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h2 class="text-2xl font-bold text-gray-200 mb-4">Collection Highlights</h2>
                        <div class="space-y-4">
                            <div>
                                <p class="text-lg font-semibold text-gray-300">Most Valuable Item:</p>
                                <p id="dashboard-most-valuable" class="text-emerald-400 text-xl italic">N/A</p>
                            </div>
                            <div>
                                <p class="text-lg font-semibold text-gray-300">Oldest Item:</p>
                                <p id="dashboard-oldest-item" class="text-blue-400 text-xl italic">N/A</p>
                            </div>
                            <div>
                                <p class="text-lg font-semibold text-gray-300">Newest Item:</p>
                                <p id="dashboard-newest-item" class="text-purple-400 text-xl italic">N/A</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h2 class="text-2xl font-bold text-gray-200 mb-4">Top 5 Countries by Item Count</h2>
                        <ul id="dashboard-top-countries" class="list-disc list-inside text-gray-300">
                            <li>No data yet.</li>
                        </ul>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-8">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Value Distribution by Type</h2>
                    <canvas id="chart-value-by-type"></canvas>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Collection Value Over Years</h2>
                    <canvas id="chart-value-by-year"></canvas>
                </div>
            </div>
        </div>

        <div id="content-bullion" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
            <div id="bullion-unauthenticated-overlay" class="unauthenticated-overlay hidden">
                <p>Please sign in to view your bullion collection and live prices.</p>
            </div>
            <div class="max-w-5xl mx-auto py-8">
                <h1 class="text-4xl font-extrabold text-white mb-6">Your Bullion Collection</h1>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Current Metal Prices</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-lg font-semibold text-gray-400">Gold (XAU/USD):</p>
                            <p id="live-gold-price" class="text-3xl font-bold text-yellow-400">$ LOADING...</p>
                        </div>
                        <div>
                            <p class="text-lg font-semibold text-gray-400">Silver (XAG/USD):</p>
                            <p id="live-silver-price" class="text-3xl font-bold text-gray-300">$ LOADING...</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Prices updated periodically from Metals-API.com</p>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Your Bullion Collection</h2>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-700 data-table">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Weight (g)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Purity (%)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Year</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Value (USD)</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name/Notes</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Reference Link</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bullion-collection-table-body" class="divide-y divide-gray-800">
                                <tr><td colspan="8" class="p-4 text-center text-gray-500">No bullion items yet. Add one using the "Add Item" button!</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <div id="content-collection" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
            <div id="collection-unauthenticated-overlay" class="unauthenticated-overlay hidden">
                <p>Please sign in to view your collection.</p>
            </div>
            <div class="max-w-5xl mx-auto py-8">
                <h1 class="text-4xl font-extrabold text-white mb-6">Your Collection</h1>

                <div class="mb-6 flex justify-between items-center">
                    <button id="add-item-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center">
                        <i class="ph ph-plus-circle text-lg mr-2"></i> Add New Item
                    </button>
                    <button id="import-export-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition-colors flex items-center">
                        <i class="ph ph-upload-simple text-lg mr-2"></i> Import/Export
                    </button>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-700 data-table">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Country</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Year</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Denomination</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Value</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Notes</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Image</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="collection-table-body" class="divide-y divide-gray-800">
                                <tr><td colspan="9" class="p-4 text-center text-gray-500">No items yet. Add one using the "Add Item" button!</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-map" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
            <div id="map-unauthenticated-overlay" class="unauthenticated-overlay hidden">
                <p>Please sign in to view your collection on the map.</p>
            </div>
            <div class="max-w-4xl mx-auto py-8">
                <h1 class="text-4xl font-extrabold text-white mb-6">Collection Map View</h1>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6">
                    <h2 class="text-2xl font-bold text-gray-200 mb-4">Countries in Your Collection</h2>
                    <div id="map-container">
                        <p class="text-gray-400">Loading map...</p>
                    </div>
                    <div id="missing-countries-status" class="text-gray-400 mt-6 text-center"></div>
                </div>

                <div id="country-items-container" class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 hidden">
                    <h3 class="text-xl font-semibold text-gray-300 mb-4">Items from this Country</h3>
                    <div class="bg-gray-900 rounded-md p-4 max-h-60 overflow-y-auto custom-scrollbar">
                        <ul id="country-items-list" class="list-disc list-inside text-gray-300">
                            </ul>
                    </div>
                    <button id="close-country-items-btn" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-colors">Close</button>
                </div>
            </div>
        </div>

        <div id="content-public-collection" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
            <div class="max-w-5xl mx-auto py-8">
                <h1 id="public-collection-title" class="text-4xl font-extrabold text-white mb-6">Public Collection</h1>

                <div id="public-collection-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Items</h3>
                        <p class="text-4xl font-bold text-emerald-400" id="public-total-items">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Value</h3>
                        <p class="text-4xl font-bold text-blue-400" id="public-total-value">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Unique Countries</h3>
                        <p class="text-4xl font-bold text-purple-400" id="public-unique-countries">0</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-700 data-table">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Country</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Year</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Denomination</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Value</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Notes</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Image</th>
                                </tr>
                            </thead>
                            <tbody id="public-collection-table-body" class="divide-y divide-gray-800">
                                <tr><td colspan="8" class="p-4 text-center text-gray-500">No items available in this public collection.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-settings" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
            <div id="settings-unauthenticated-overlay" class="unauthenticated-overlay hidden">
                <p>Please sign in to manage your account settings.</p>
            </div>
            <div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                <h2 class="text-2xl font-bold text-gray-200 mb-6">Account Settings</h2>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-300 mb-4">Change Password</h3>
                    <form id="change-password-form" class="space-y-4">
                        <div>
                            <label for="current-password" class="block text-sm font-medium text-gray-400 mb-1">Current Password:</label>
                            <input type="password" id="current-password" name="currentPassword" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-400 mb-1">New Password:</label>
                            <input type="password" id="new-password" name="newPassword" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label for="confirm-new-password" class="block text-sm font-medium text-gray-400 mb-1">Confirm New Password:</label>
                            <input type="password" id="confirm-new-password" name="confirmNewPassword" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Change Password</button>
                    </form>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-300 mb-4">Public Collection Link</h3>
                    <div class="space-y-4">
                        <p id="public-link-display" class="text-gray-300 break-all">No public link generated yet.</p>
                        <div class="flex flex-wrap gap-3">
                            <button id="generate-public-link-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Generate New Link</button>
                            <button id="copy-public-link-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-colors hidden">Copy Link</button>
                            <button id="disable-public-link-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors hidden">Disable Link</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="signin-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Sign In</h2>
            <form id="signin-form" class="space-y-4">
                <div>
                    <label for="signin-email" class="block text-sm font-medium text-gray-400 mb-1">Email:</label>
                    <input type="email" id="signin-email" name="email" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="signin-password" class="block text-sm font-medium text-gray-400 mb-1">Password:</label>
                    <input type="password" id="signin-password" name="password" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="cancel-signin-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Sign In</button>
                </div>
            </form>
        </div>
    </div>

    <div id="signup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Sign Up</h2>
            <form id="signup-form" class="space-y-4">
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-400 mb-1">Email:</label>
                    <input type="email" id="signup-email" name="email" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-400 mb-1">Password:</label>
                    <input type="password" id="signup-password" name="password" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="signup-confirm-password" class="block text-sm font-medium text-gray-400 mb-1">Confirm Password:</label>
                    <input type="password" id="signup-confirm-password" name="confirmPassword" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="cancel-signup-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Sign Up</button>
                </div>
            </form>
        </div>
    </div>

    <div id="item-form-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 overflow-y-auto p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 w-full max-w-lg my-8">
            <h2 id="item-form-title" class="text-2xl font-bold text-white mb-6 text-center">Add New Item</h2>
            <form id="item-form" class="space-y-4">
                <input type="hidden" id="item-id">
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-400 mb-1">Type:</label>
                    <select id="type" name="type" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="Coin">Coin</option>
                        <option value="Banknote">Banknote</option>
                        <option value="Bullion">Bullion</option> </select>
                </div>

                <div id="coin-banknote-fields">
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-400 mb-1">Country:</label>
                        <input type="text" id="country" name="country" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="denomination" class="block text-sm font-medium text-gray-400 mb-1">Denomination:</label>
                        <input type="text" id="denomination" name="denomination" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                </div>

                <div id="bullion-fields" class="hidden">
                    <div>
                        <label for="bullion-type" class="block text-sm font-medium text-gray-400 mb-1">Bullion Type:</label>
                        <select id="bullion-type" name="bullionType" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Gold">Gold</option>
                            <option value="Silver">Silver</option>
                        </select>
                    </div>
                    <div>
                        <label for="weight-grams" class="block text-sm font-medium text-gray-400 mb-1">Weight (grams):</label>
                        <input type="number" step="0.01" id="weight-grams" name="weightGrams" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="purity-percent" class="block text-sm font-medium text-gray-400 mb-1">Purity (%):</label>
                        <input type="number" step="0.01" min="0" max="100" id="purity-percent" name="purityPercent" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                </div>
                
                <div>
                    <label for="year" class="block text-sm font-medium text-gray-400 mb-1">Year:</label>
                    <input type="number" id="year" name="year" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div id="value-field">
                    <label for="value" class="block text-sm font-medium text-gray-400 mb-1">Value (USD):</label>
                    <input type="number" step="0.01" id="value" name="value" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-400 mb-1">Notes:</label>
                    <textarea id="notes" name="notes" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>
                <div>
                    <label for="image-url" class="block text-sm font-medium text-gray-400 mb-1">Image URL:</label>
                    <input type="url" id="image-url" name="imageUrl" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="reference-link" class="block text-sm font-medium text-gray-400 mb-1">Reference Link:</label>
                    <input type="url" id="reference-link" name="referenceLink" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-200 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div class="flex justify-end mt-8">
                    <button type="button" id="cancel-item-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-export-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Import / Export Collection</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-xl font-semibold text-gray-300 mb-3">Import Data (JSON)</h3>
                    <p class="text-gray-400 text-sm mb-3">Upload a JSON file containing your collection data. Existing items with matching IDs will be updated.</p>
                    <input type="file" id="import-json-file" accept=".json" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-emerald-500 file:text-white hover:file:bg-emerald-600 cursor-pointer">
                    <button id="perform-import-btn" class="mt-4 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Import</button>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-300 mb-3">Export Data (JSON)</h3>
                    <p class="text-gray-400 text-sm mb-3">Download your entire collection as a JSON file.</p>
                    <button id="perform-export-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Export</button>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-300 mb-3">Export as PDF</h3>
                    <p class="text-gray-400 text-sm mb-3">Generate a printable PDF report of your collection.</p>
                    <button id="perform-pdf-export-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Export to PDF</button>
                </div>
            </div>
            <div class="flex justify-end mt-8">
                <button type="button" id="cancel-import-export-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Close</button>
            </div>
        </div>
    </div>


    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-gray-700 w-full max-w-sm text-center">
            <p id="custom-confirm-message" class="text-lg text-white mb-6"></p>
            <div id="custom-confirm-buttons" class="flex justify-center space-x-4">
                </div>
        </div>
    </div>


<script>
    // --- API Configuration ---
    // IMPORTANT: Replace with your Render-hosted backend URL in production!
    const API_BASE_URL = 'http://127.0.0.1:5000/api'; 
    // Get a free API key from https://metals-api.com/ (free plan available)
    const METALS_API_KEY = 'YOUR_METALS_API_KEY'; // REPLACE WITH YOUR ACTUAL METALS-API KEY


    // --- Global State ---
    let collectionData = []; // Stores coin and banknote data
    let bullionData = [];    // Stores bullion data
    let currentGoldPrice = 0; // Price per gram
    let currentSilverPrice = 0; // Price per gram
    let publicCollectionOwner = null; // Stores public collection user data if viewing a public collection

    // --- Utility Functions ---
    function getAuthToken() {
        return sessionStorage.getItem('jwt_token');
    }

    function isAuthenticated() {
        return !!getAuthToken();
    }

    // Fetches collection data from the backend
    async function loadCollectionFromBackend() {
        if (!isAuthenticated()) {
            console.log('Not authenticated, clearing collection data and rendering views.');
            collectionData = []; // Clear data if not authenticated
            renderAllViews();
            return;
        }
        console.log('Authenticated, attempting to load collection data from backend...');
        try {
            const response = await fetch(`${API_BASE_URL}/collection`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            if (response.ok) {
                collectionData = await response.json();
                console.log('Collection data loaded successfully:', collectionData);
                renderAllViews(); // Re-render views after data is loaded
            } else {
                const errorData = await response.json();
                console.error('Failed to load collection data:', errorData.message);
                showCustomConfirm(`Failed to load collection: ${errorData.message}. Please try logging in again.`, () => {});
                collectionData = []; // Clear data on error
                renderAllViews();
            }
        } catch (error) {
            console.error('Error fetching collection data:', error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
            collectionData = []; // Clear data on network error
            renderAllViews();
        }
    }

    // NEW: Fetches bullion data from the backend
    async function loadBullionFromBackend() {
        if (!isAuthenticated()) {
            console.log('Not authenticated, clearing bullion data.');
            bullionData = [];
            renderBullionCollection(); // Render empty collection
            return;
        }
        console.log('Authenticated, attempting to load bullion data from backend...');
        try {
            const response = await fetch(`${API_BASE_URL}/bullion`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            if (response.ok) {
                bullionData = await response.json();
                console.log('Bullion data loaded successfully:', bullionData);
                renderBullionCollection(); // Re-render bullion view after data is loaded
                updateDashboard(); // Update dashboard total value with bullion
            } else {
                const errorData = await response.json();
                console.error('Failed to load bullion data:', errorData.message);
                showCustomConfirm(`Failed to load bullion: ${errorData.message}. Please try logging in again.`, () => {});
                bullionData = [];
                renderBullionCollection();
            }
        } catch (error) {
            console.error('Error fetching bullion data:', error);
            showCustomConfirm('Error connecting to backend for bullion. Please ensure the backend is running.', () => {});
            bullionData = [];
            renderBullionCollection();
        }
    }


    // Fetches public collection data from the backend
    async function loadPublicCollectionFromBackend(publicId) {
        console.log(`Attempting to load public collection for ID: ${publicId}...`);
        try {
            const response = await fetch(`${API_BASE_URL}/public_collection/${publicId}`);
            if (response.ok) {
                const data = await response.json();
                publicCollectionOwner = data.user;
                collectionData = data.items;
                console.log('Public collection data loaded successfully:', collectionData);
                document.getElementById('public-collection-summary').classList.remove('hidden');
                document.getElementById('public-collection-title').innerText = `Public Collection of ${publicCollectionOwner.email}`;
                renderPublicCollection(); // Render public collection view
            } else {
                const errorData = await response.json();
                console.error('Failed to load public collection:', errorData.message);
                showCustomConfirm(`Failed to load public collection: ${errorData.message}. Please check the link.`, () => {});
                collectionData = []; // Clear data on error
                document.getElementById('public-collection-summary').classList.add('hidden');
                document.getElementById('public-collection-table-body').innerHTML = '';
                document.getElementById('public-collection-title').innerText = 'Public Collection (Not Found)';
            }
        } catch (error) {
            console.error('Error fetching public collection data:', error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
            collectionData = []; // Clear data on network error
            document.getElementById('public-collection-summary').classList.add('hidden');
            document.getElementById('public-collection-table-body').innerHTML = '';
            document.getElementById('public-collection-title').innerText = 'Public Collection (Not Found)';
        }
    }

    // Helper to clear and reset the item form
    function clearItemForm() {
        document.getElementById('item-id').value = '';
        document.getElementById('type').value = 'Coin';
        document.getElementById('country').value = '';
        document.getElementById('denomination').value = '';
        document.getElementById('year').value = '';
        document.getElementById('value').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('image-url').value = '';
        document.getElementById('reference-link').value = '';

        // NEW: Clear bullion specific fields
        document.getElementById('bullion-type').value = 'Gold';
        document.getElementById('weight-grams').value = '';
        document.getElementById('purity-percent').value = '';

        // Trigger type change to update field visibility
        toggleItemFormFields();
    }

    // Handles the submission of the add/edit item form
    async function handleFormSubmission(e) {
        e.preventDefault();
        const itemId = document.getElementById('item-id').value;
        const type = document.getElementById('type').value;
        const country = document.getElementById('country').value;
        const denomination = document.getElementById('denomination').value;
        const year = document.getElementById('year').value;
        const value = parseFloat(document.getElementById('value').value);
        const notes = document.getElementById('notes').value;
        const imageUrl = document.getElementById('image-url').value;
        const referenceLink = document.getElementById('reference-link').value;

        let itemData = {
            type: type,
            year: year ? parseInt(year) : null,
            value: value || 0,
            notes: notes,
            image_url: imageUrl,
            reference_link: referenceLink
        };

        let endpoint = `${API_BASE_URL}/collection`;
        let method = 'POST';

        if (type === 'Bullion') {
            const bullionType = document.getElementById('bullion-type').value;
            const weightGrams = parseFloat(document.getElementById('weight-grams').value);
            const purityPercent = parseFloat(document.getElementById('purity-percent').value);

            itemData = {
                type: bullionType, // 'Gold' or 'Silver'
                weight_grams: weightGrams || 0,
                purity_percent: purityPercent || 0,
                year: year ? parseInt(year) : null,
                // Value for bullion will be calculated by backend based on live price and purity
                // For now, if user provides value, it will be sent, else 0.
                value: value || 0,
                notes: notes,
                image_url: imageUrl,
                reference_link: referenceLink
            };
            endpoint = `${API_BASE_URL}/bullion`; // Use new bullion endpoint
        } else {
            // For Coin/Banknote
            itemData.country = country;
            itemData.denomination = denomination;
        }


        if (itemId) { // Editing existing item
            endpoint = `${API_BASE_URL}/${type === 'Bullion' ? 'bullion' : 'collection'}/${itemId}`; // Adjust endpoint based on type
            method = 'PUT';
        }

        try {
            const response = await fetch(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(itemData)
            });

            if (response.ok) {
                showCustomConfirm(`Item ${itemId ? 'updated' : 'added'} successfully!`, () => {
                    document.getElementById('item-form-modal').classList.add('hidden');
                    // Reload relevant collection based on type
                    if (type === 'Bullion') {
                        loadBullionFromBackend();
                    } else {
                        loadCollectionFromBackend();
                    }
                });
            } else {
                const errorData = await response.json();
                showCustomConfirm(`Failed to ${itemId ? 'update' : 'add'} item: ${errorData.message}`, () => {});
            }
        } catch (error) {
            console.error('Error submitting item:', error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
        }
    }

    // Displays the add/edit item modal
    function showItemFormModal(item = null) {
        clearItemForm(); // Clear form on opening
        if (item) { // Populate form for editing
            document.getElementById('item-form-title').innerText = 'Edit Item';
            document.getElementById('item-id').value = item.id;
            document.getElementById('type').value = item.type === 'Gold' || item.type === 'Silver' ? 'Bullion' : item.type; // Set general type
            document.getElementById('country').value = item.country || '';
            document.getElementById('denomination').value = item.denomination || '';
            document.getElementById('year').value = item.year || '';
            document.getElementById('value').value = item.value || '';
            document.getElementById('notes').value = item.notes || '';
            document.getElementById('image-url').value = item.image_url || '';
            document.getElementById('reference-link').value = item.reference_link || '';

            // NEW: Populate bullion specific fields if it's a bullion item
            if (item.type === 'Gold' || item.type === 'Silver') {
                document.getElementById('bullion-type').value = item.type;
                document.getElementById('weight-grams').value = item.weight_grams || '';
                document.getElementById('purity-percent').value = item.purity_percent || '';
            }
            toggleItemFormFields(); // Adjust visibility based on item type
        } else {
            document.getElementById('item-form-title').innerText = 'Add New Item';
        }
        document.getElementById('item-form-modal').classList.remove('hidden');
    }

    // Handles item deletion
    async function deleteItem(id, type) {
        showCustomConfirm('Are you sure you want to delete this item?', async () => {
            try {
                const endpoint = `${API_BASE_URL}/${type === 'Gold' || type === 'Silver' ? 'bullion' : 'collection'}/${id}`;
                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                if (response.ok) {
                    showCustomConfirm('Item deleted successfully!', () => {
                        // Reload relevant collection based on type
                        if (type === 'Gold' || type === 'Silver') {
                            loadBullionFromBackend();
                        } else {
                            loadCollectionFromBackend();
                        }
                    });
                } else {
                    const errorData = await response.json();
                    showCustomConfirm(`Failed to delete item: ${errorData.message}`, () => {});
                }
            } catch (error) {
                console.error("Error deleting item:", error);
                showCustomConfirm(`Failed to delete item: ${error.message}. Please ensure the backend is running and you are logged in.`, () => {});
            }
        }, true); // Pass true for a confirm dialog
    }

    // Displays a custom confirmation/alert modal
    function showCustomConfirm(message, callback, isConfirm = false) {
        const modal = document.getElementById('custom-confirm-modal');
        const msgElement = document.getElementById('custom-confirm-message');
        const btnContainer = document.getElementById('custom-confirm-buttons');

        msgElement.innerText = message;
        btnContainer.innerHTML = ''; // Clear previous buttons

        if (isConfirm) {
            const confirmBtn = document.createElement('button');
            confirmBtn.innerText = 'Confirm';
            confirmBtn.className = 'bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition-colors';
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (callback) callback();
            };
            btnContainer.appendChild(confirmBtn);

            const cancelBtn = document.createElement('button');
            cancelBtn.innerText = 'Cancel';
            cancelBtn.className = 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors';
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
            };
            btnContainer.appendChild(cancelBtn);
        } else {
            const okBtn = document.createElement('button');
            okBtn.innerText = 'OK';
            okBtn.className = 'bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition-colors';
            okBtn.onclick = () => {
                modal.classList.add('hidden');
                if (callback) callback();
            };
            btnContainer.appendChild(okBtn);
        }
        modal.classList.remove('hidden');
    }

    // Hides all content views except the active one
    function showView(viewId) {
        document.querySelectorAll('.content-view').forEach(view => {
            view.classList.add('hidden');
            view.classList.remove('active');
        });
        document.getElementById(viewId).classList.remove('hidden');
        document.getElementById(viewId).classList.add('active');

        // Update active class for nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active-nav-link');
        });
        const activeNavLink = document.getElementById(`nav-${viewId.replace('content-', '')}`);
        if (activeNavLink) {
            activeNavLink.classList.add('active-nav-link');
        }

        // Handle unauthenticated overlays
        updateAuthUI(isAuthenticated());
        // Specific map view initialization, if it's the map view
        if (viewId === 'content-map') {
            // Only draw map if authenticated
            if (isAuthenticated()) {
                google.charts.load('current', {
                    'packages': ['geochart']
                });
                google.charts.setOnLoadCallback(drawRegionsMap);
            }
        }
        // Specific bullion view initialization
        if (viewId === 'content-bullion' && isAuthenticated()) {
            fetchMetalPrices(); // Fetch prices when bullion view is shown
            loadBullionFromBackend(); // Load bullion data
        }
    }

    // Updates UI elements based on authentication status
    function updateAuthUI(loggedIn) {
        const signinBtn = document.getElementById('signin-btn');
        const signupBtn = document.getElementById('signup-btn');
        const signoutBtn = document.getElementById('signout-btn');

        if (signinBtn && signupBtn && signoutBtn) {
            if (loggedIn) {
                signinBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                signoutBtn.classList.remove('hidden');
            } else {
                signinBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                signoutBtn.classList.add('hidden');
            }
        }

        // Handle overlays for authenticated views
        const authRequiredViews = ['home', 'dashboard', 'collection', 'map', 'settings', 'bullion']; // Added 'bullion'
        authRequiredViews.forEach(viewName => {
            const contentDiv = document.getElementById(`content-${viewName}`);
            const overlayDiv = document.getElementById(`${viewName}-unauthenticated-overlay`);

            if (contentDiv && overlayDiv) {
                if (loggedIn) {
                    contentDiv.classList.remove('hidden'); // Show content
                    overlayDiv.classList.add('hidden'); // Hide overlay
                } else {
                    if (contentDiv.classList.contains('active')) { // If this is the active view
                        contentDiv.classList.add('hidden'); // Hide content
                        overlayDiv.classList.remove('hidden'); // Show overlay
                    }
                }
            }
        });

        // Special handling for content-home overlay when logged out and it's the active view
        const homeContent = document.getElementById('content-home');
        const homeOverlay = document.getElementById('home-unauthenticated-overlay');
        if (homeContent && homeOverlay && homeContent.classList.contains('active')) {
            if (!loggedIn) {
                homeContent.classList.add('hidden');
                homeOverlay.classList.remove('hidden');
            } else {
                homeContent.classList.remove('hidden');
                homeOverlay.classList.add('hidden');
            }
        }

        const settingsContent = document.getElementById('content-settings');
        const settingsOverlay = document.getElementById('settings-unauthenticated-overlay');
        if (settingsContent && settingsOverlay) {
            if (loggedIn) {
                settingsContent.classList.remove('hidden');
                settingsOverlay.classList.add('hidden');
            } else {
                settingsContent.classList.add('hidden');
                settingsOverlay.classList.remove('hidden');
            }
        }

        // Adjust public link buttons visibility
        updatePublicLinkUI();
    }

    // Renders all dynamic views
    function renderAllViews() {
        renderHomeDashboard();
        renderDashboard();
        renderCollection();
        renderBullionCollection(); // NEW: Render bullion collection
        drawRegionsMap(); // Re-draw map
    }


    // --- Home View Rendering ---
    function renderHomeDashboard() {
        const totalItems = collectionData.length + bullionData.length; // Include bullion
        const totalValue = collectionData.reduce((sum, item) => sum + item.value, 0) + 
                           bullionData.reduce((sum, item) => sum + calculateBullionValue(item), 0); // Include bullion value
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        document.getElementById('home-total-items').innerText = totalItems;
        document.getElementById('home-total-value').innerText = `$${totalValue.toFixed(2)}`;
        document.getElementById('home-unique-countries').innerText = uniqueCountries;

        renderLatestAdditions();
    }

    function renderLatestAdditions() {
        const tableBody = document.getElementById('latest-additions-table-body');
        tableBody.innerHTML = ''; // Clear existing rows

        if (collectionData.length === 0 && bullionData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">No items yet. Add one using the "Add Item" button!</td></tr>';
            return;
        }

        // Combine and sort by ID (assuming higher ID means newer)
        const combinedData = [...collectionData, ...bullionData].sort((a, b) => b.id - a.id);
        const latestFive = combinedData.slice(0, 5); // Get the 5 latest items

        latestFive.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-700 transition-colors';

            let displayedValue = '';
            if (item.type === 'Gold' || item.type === 'Silver') {
                const calculatedValue = calculateBullionValue(item);
                displayedValue = `$${calculatedValue.toFixed(2)}`;
            } else {
                displayedValue = `$${(item.value || 0).toFixed(2)}`;
            }

            row.innerHTML = `
                <td class="p-4">${item.id}</td>
                <td class="p-4">${item.type}</td>
                <td class="p-4">${item.country || 'N/A'}</td>
                <td class="p-4">${item.year || 'N/A'}</td>
                <td class="p-4">${item.denomination || 'N/A'}</td>
                <td class="p-4">${displayedValue}</td>
                <td class="p-4 text-xs">${item.notes || 'N/A'}</td>
                <td class="p-4">
                    ${item.image_url ? `<img src="${item.image_url}" alt="Item Image" class="h-12 w-12 object-cover rounded-md">` : '<span class="text-gray-500">No Image</span>'}
                </td>
                <td class="p-4">
                    <button onclick="showItemFormModal(${item.id ? JSON.stringify(item) : 'null'})" class="text-blue-400 hover:text-blue-300 mr-2"><i class="ph ph-pencil"></i></button>
                    <button onclick="deleteItem(${item.id}, '${item.type}')" class="text-red-400 hover:text-red-300"><i class="ph ph-trash"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }


    // --- Dashboard View Rendering ---
    let valueByTypeChart, valueByYearChart; // Declare chart variables globally

    function renderDashboard() {
        const totalItems = collectionData.length + bullionData.length;
        const totalValue = collectionData.reduce((sum, item) => sum + item.value, 0) +
                           bullionData.reduce((sum, item) => sum + calculateBullionValue(item), 0);
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        document.getElementById('dashboard-total-items').innerText = totalItems;
        document.getElementById('dashboard-total-value').innerText = `$${totalValue.toFixed(2)}`;
        document.getElementById('dashboard-unique-countries').innerText = uniqueCountries;

        // Collection Highlights
        const mostValuable = collectionData.concat(bullionData).reduce((highest, current) => {
            let currentValue = (current.type === 'Gold' || current.type === 'Silver') ? calculateBullionValue(current) : current.value;
            let highestValue = (highest && (highest.type === 'Gold' || highest.type === 'Silver')) ? calculateBullionValue(highest) : (highest ? highest.value : 0);

            if (currentValue && (!highest || currentValue > highestValue)) {
                return current;
            }
            return highest;
        }, null);

        document.getElementById('dashboard-most-valuable').innerText = mostValuable ?
            `${mostValuable.type === 'Bullion' ? mostValuable.type : (mostValuable.denomination ? mostValuable.denomination + ' ' : '')}${mostValuable.country ? mostValuable.country + ' ' : ''}${mostValuable.year ? mostValuable.year : ''} ($${((mostValuable.type === 'Gold' || mostValuable.type === 'Silver') ? calculateBullionValue(mostValuable) : mostValuable.value || 0).toFixed(2)})` :
            'N/A';

        const oldestItem = collectionData.concat(bullionData).reduce((oldest, current) => {
            if (current.year && (!oldest || current.year < oldest.year)) {
                return current;
            }
            return oldest;
        }, null);
        document.getElementById('dashboard-oldest-item').innerText = oldestItem ?
            `${oldestItem.type === 'Bullion' ? oldestItem.type : (oldestItem.denomination ? oldestItem.denomination + ' ' : '')}${oldestItem.country ? oldestItem.country + ' ' : ''}${oldestItem.year ? oldestItem.year : ''}` :
            'N/A';

        const newestItem = collectionData.concat(bullionData).reduce((newest, current) => {
            if (current.year && (!newest || current.year > newest.year)) {
                return current;
            }
            return newest;
        }, null);
        document.getElementById('dashboard-newest-item').innerText = newestItem ?
            `${newestItem.type === 'Bullion' ? newestItem.type : (newestItem.denomination ? newestItem.denomination + ' ' : '')}${newestItem.country ? newestItem.country + ' ' : ''}${newestItem.year ? newestItem.year : ''}` :
            'N/A';


        // Top 5 Countries
        const countryCounts = collectionData.reduce((acc, item) => {
            acc[item.country] = (acc[item.country] || 0) + 1;
            return acc;
        }, {});
        const sortedCountries = Object.entries(countryCounts).sort(([, countA], [, countB]) => countB - countA).slice(0, 5);
        const topCountriesList = document.getElementById('dashboard-top-countries');
        topCountriesList.innerHTML = '';
        if (sortedCountries.length === 0) {
            topCountriesList.innerHTML = '<li>No data yet.</li>';
        } else {
            sortedCountries.forEach(([country, count]) => {
                const li = document.createElement('li');
                li.innerText = `${country} (${count} items)`;
                topCountriesList.appendChild(li);
            });
        }

        // Charts
        renderValueByTypeChart();
        renderValueByYearChart();
    }

    function renderValueByTypeChart() {
        const ctx = document.getElementById('chart-value-by-type').getContext('2d');
        if (valueByTypeChart) {
            valueByTypeChart.destroy();
        }

        const typeValues = {};
        collectionData.forEach(item => {
            typeValues[item.type] = (typeValues[item.type] || 0) + item.value;
        });
        // NEW: Add bullion values to the chart
        bullionData.forEach(item => {
            const bullionTypeKey = `Bullion (${item.type})`; // e.g., "Bullion (Gold)"
            typeValues[bullionTypeKey] = (typeValues[bullionTypeKey] || 0) + calculateBullionValue(item);
        });


        const labels = Object.keys(typeValues);
        const data = Object.values(typeValues);

        valueByTypeChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#34D399', // emerald-400
                        '#60A5FA', // blue-400
                        '#A78BFA', // purple-400
                        '#FCD34D', // yellow-400 (for gold)
                        '#9CA3AF', // gray-400 (for silver)
                        '#F87171', // red-400
                        '#FB923C'  // orange-400
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db' // Light gray for legend text
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderValueByYearChart() {
        const ctx = document.getElementById('chart-value-by-year').getContext('2d');
        if (Chart.getChart('chart-value-by-year')) { // Use Chart.getChart to destroy specific chart instances
            Chart.getChart('chart-value-by-year').destroy();
        }

        const yearValues = {};
        collectionData.forEach(item => {
            if (item.year) {
                yearValues[item.year] = (yearValues[item.year] || 0) + item.value;
            }
        });
        // NEW: Add bullion values to the year chart
        bullionData.forEach(item => {
            if (item.year) {
                yearValues[item.year] = (yearValues[item.year] || 0) + calculateBullionValue(item);
            }
        });


        const sortedYears = Object.keys(yearValues).sort((a, b) => parseInt(a) - parseInt(b));
        const data = sortedYears.map(year => yearValues[year]);

        valueByYearChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedYears,
                datasets: [{
                    label: 'Collection Value',
                    data: data,
                    borderColor: '#60A5FA', // blue-400
                    backgroundColor: 'rgba(96, 165, 250, 0.2)', // Light blue with transparency
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Year',
                            color: '#d1d5db'
                        },
                        ticks: {
                            color: '#d1d5db'
                        },
                        grid: {
                            color: '#374151'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value (USD)',
                            color: '#d1d5db'
                        },
                        ticks: {
                            color: '#d1d5db',
                            callback: function(value) {
                                return `$${value.toFixed(0)}`;
                            }
                        },
                        grid: {
                            color: '#374151'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- Collection View Rendering ---
    function renderCollection() {
        const tableBody = document.getElementById('collection-table-body');
        tableBody.innerHTML = ''; // Clear existing rows

        if (collectionData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">No items yet. Add one using the "Add Item" button!</td></tr>';
            return;
        }

        collectionData.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-700 transition-colors';
            row.innerHTML = `
                <td class="p-4">${item.id}</td>
                <td class="p-4">${item.type}</td>
                <td class="p-4">${item.country || 'N/A'}</td>
                <td class="p-4">${item.year || 'N/A'}</td>
                <td class="p-4">${item.denomination || 'N/A'}</td>
                <td class="p-4">$${(item.value || 0).toFixed(2)}</td>
                <td class="p-4 text-xs">${item.notes || 'N/A'}</td>
                <td class="p-4">
                    ${item.image_url ? `<img src="${item.image_url}" alt="Item Image" class="h-12 w-12 object-cover rounded-md">` : '<span class="text-gray-500">No Image</span>'}
                </td>
                <td class="p-4">
                    <button onclick="showItemFormModal(${item.id ? JSON.stringify(item) : 'null'})" class="text-blue-400 hover:text-blue-300 mr-2"><i class="ph ph-pencil"></i></button>
                    <button onclick="deleteItem(${item.id}, '${item.type}')" class="text-red-400 hover:text-red-300"><i class="ph ph-trash"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // --- NEW: Bullion Collection Rendering ---
    // Helper function to calculate bullion value based on current prices and purity
    function calculateBullionValue(item) {
        if (!item || !item.type || !item.weight_grams || !item.purity_percent) {
            return 0;
        }

        const weightInGrams = item.weight_grams;
        const purityFactor = item.purity_percent / 100;
        let valuePerGram = 0;

        if (item.type === 'Gold') {
            valuePerGram = currentGoldPrice;
        } else if (item.type === 'Silver') {
            valuePerGram = currentSilverPrice;
        }
        
        return (weightInGrams * purityFactor * valuePerGram) || 0;
    }

    // Fetches live gold and silver prices
    async function fetchMetalPrices() {
        const goldPriceElem = document.getElementById('live-gold-price');
        const silverPriceElem = document.getElementById('live-silver-price');
        goldPriceElem.innerText = '$ LOADING...';
        silverPriceElem.innerText = '$ LOADING...';

        try {
            const response = await fetch(`https://api.metals.dev/v1/latest?api_key=${METALS_API_KEY}&currency=USD&unit=toz`);
            const data = await response.json();

            if (data.status === 'success') {
                // Metals-API returns price per troy ounce (toz). Convert to price per gram.
                // 1 troy ounce = 31.1034768 grams
                const troyOunceToGram = 31.1034768;

                currentGoldPrice = (data.metals.gold || 0) / troyOunceToGram;
                currentSilverPrice = (data.metals.silver || 0) / troyOunceToGram;

                goldPriceElem.innerText = `$${currentGoldPrice.toFixed(2)} / gram`;
                silverPriceElem.innerText = `$${currentSilverPrice.toFixed(2)} / gram`;
                console.log('Metal prices fetched:', { gold: currentGoldPrice, silver: currentSilverPrice });

                // After fetching new prices, re-render bullion collection to update values
                renderBullionCollection();
                updateDashboard(); // Recalculate dashboard values as well
            } else {
                goldPriceElem.innerText = '$ ERROR';
                silverPriceElem.innerText = '$ ERROR';
                console.error('Failed to fetch metal prices:', data.message || 'Unknown error');
            }
        } catch (error) {
            goldPriceElem.innerText = '$ ERROR';
            silverPriceElem.innerText = '$ ERROR';
            console.error('Error fetching metal prices:', error);
        }
    }
    // Set an interval to refresh prices every 5 minutes (300000 milliseconds)
    setInterval(fetchMetalPrices, 300000);

    function renderBullionCollection() {
        const tableBody = document.getElementById('bullion-collection-table-body');
        tableBody.innerHTML = ''; // Clear existing rows

        if (bullionData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">No bullion items yet. Add one using the "Add Item" button!</td></tr>';
            return;
        }

        bullionData.forEach(item => {
            const calculatedValue = calculateBullionValue(item);
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-700 transition-colors';
            row.innerHTML = `
                <td class="p-4">${item.type}</td>
                <td class="p-4">${(item.weight_grams || 0).toFixed(2)}</td>
                <td class="p-4">${(item.purity_percent || 0).toFixed(2)}%</td>
                <td class="p-4">${item.year || 'N/A'}</td>
                <td class="p-4">$${calculatedValue.toFixed(2)}</td>
                <td class="p-4 text-xs">${item.notes || 'N/A'}</td>
                <td class="p-4">
                    ${item.reference_link ? `<a href="${item.reference_link}" target="_blank" class="text-blue-400 hover:underline">Link</a>` : 'N/A'}
                </td>
                <td class="p-4">
                    <button onclick="showItemFormModal(${item.id ? JSON.stringify(item) : 'null'})" class="text-blue-400 hover:text-blue-300 mr-2"><i class="ph ph-pencil"></i></button>
                    <button onclick="deleteItem(${item.id}, '${item.type}')" class="text-red-400 hover:text-red-300"><i class="ph ph-trash"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // NEW: Function to toggle visibility of fields in the item form based on item type
    function toggleItemFormFields() {
        const itemType = document.getElementById('type').value;
        const coinBanknoteFields = document.getElementById('coin-banknote-fields');
        const bullionFields = document.getElementById('bullion-fields');
        const valueField = document.getElementById('value-field');

        if (itemType === 'Bullion') {
            coinBanknoteFields.classList.add('hidden');
            bullionFields.classList.remove('hidden');
            // For bullion, value is calculated, so hide the direct input
            valueField.classList.add('hidden'); 
        } else {
            coinBanknoteFields.classList.remove('hidden');
            bullionFields.classList.add('hidden');
            // For coin/banknote, value is direct input
            valueField.classList.remove('hidden');
        }
    }


    // --- Map View Rendering ---
    function drawRegionsMap() {
        // Only proceed if Google Charts is loaded and authenticated
        if (typeof google === 'undefined' || typeof google.charts === 'undefined' || !isAuthenticated()) {
            document.getElementById('map-container').innerHTML = '<p class="text-gray-400">Sign in to load the map.</p>';
            return;
        }

        const mapContainer = document.getElementById('map-container');
        mapContainer.innerHTML = ''; // Clear previous map or message

        const countries = {};
        collectionData.forEach(item => {
            if (item.country) {
                countries[item.country] = (countries[item.country] || 0) + 1;
            }
        });

        if (Object.keys(countries).length === 0) {
            document.getElementById('missing-countries-status').innerText = 'No country data available to display on the map.';
            mapContainer.innerHTML = '<p class="text-gray-400">Add items with country information to see your collection on the map.</p>';
            return;
        }

        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Country');
        data.addColumn('number', 'Items');
        data.addColumn({type:'string', role:'tooltip', 'p': {'html': true}}); // Add tooltip column

        for (const country in countries) {
            const itemsInCountry = collectionData.filter(item => item.country === country);
            let tooltipContent = `<div class="tooltip-scroll-content"><h3>${country}</h3><ul>`;
            itemsInCountry.forEach(item => {
                tooltipContent += `<li>${item.type} - ${item.denomination || ''} (${item.year || 'N/A'})</li>`;
            });
            tooltipContent += `</ul></div>`;
            data.addRow([country, countries[country], tooltipContent]);
        }

        const options = {
            colorAxis: {
                colors: ['#60A5FA', '#3B82F6', '#1D4ED8'] // Shades of blue
            },
            backgroundColor: '#1f2937', // Dark gray background
            datalessRegionColor: '#4b5563', // Medium gray for countries with no data
            defaultColor: '#4b5563',
            resolution: 'countries',
            tooltip: {
                isHtml: true,
                trigger: 'focus' // Show tooltip on hover
            }
        };

        const chart = new google.visualization.GeoChart(mapContainer);

        google.visualization.events.addListener(chart, 'select', () => {
            const selection = chart.getSelection();
            if (selection.length > 0) {
                const region = data.getValue(selection[0].row, 0);
                displayCountryItems(region);
            }
        });

        chart.draw(data, options);
        document.getElementById('missing-countries-status').innerText = ''; // Clear status if map drawn
    }

    function displayCountryItems(country) {
        const countryItemsContainer = document.getElementById('country-items-container');
        const countryItemsList = document.getElementById('country-items-list');
        countryItemsList.innerHTML = '';

        const itemsInCountry = collectionData.filter(item => item.country === country);

        if (itemsInCountry.length > 0) {
            itemsInCountry.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${item.type}</strong>: ${item.denomination || 'N/A'} (${item.year || 'N/A'}) - $${(item.value || 0).toFixed(2)}`;
                countryItemsList.appendChild(li);
            });
            countryItemsContainer.classList.remove('hidden');
        } else {
            countryItemsContainer.classList.add('hidden');
        }
    }

    // --- Public Collection View Rendering ---
    function renderPublicCollection() {
        const publicSummary = document.getElementById('public-collection-summary');
        const publicTableBody = document.getElementById('public-collection-table-body');
        publicTableBody.innerHTML = '';

        if (collectionData.length === 0) {
            publicTableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-gray-500">No items available in this public collection.</td></tr>';
            publicSummary.classList.remove('grid'); // Hide grid if no data
            return;
        }

        publicSummary.classList.add('grid'); // Show grid if data exists

        const totalItems = collectionData.length;
        const totalValue = collectionData.reduce((sum, item) => sum + item.value, 0);
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        document.getElementById('public-total-items').innerText = totalItems;
        document.getElementById('public-total-value').innerText = `$${totalValue.toFixed(2)}`;
        document.getElementById('public-unique-countries').innerText = uniqueCountries;

        collectionData.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-700 transition-colors';
            row.innerHTML = `
                <td class="p-4">${item.id}</td>
                <td class="p-4">${item.type}</td>
                <td class="p-4">${item.country || 'N/A'}</td>
                <td class="p-4">${item.year || 'N/A'}</td>
                <td class="p-4">${item.denomination || 'N/A'}</td>
                <td class="p-4">$${(item.value || 0).toFixed(2)}</td>
                <td class="p-4 text-xs">${item.notes || 'N/A'}</td>
                <td class="p-4">
                    ${item.image_url ? `<img src="${item.image_url}" alt="Item Image" class="h-12 w-12 object-cover rounded-md">` : '<span class="text-gray-500">No Image</span>'}
                </td>
            `;
            publicTableBody.appendChild(row);
        });
    }


    // --- Authentication & Account Settings ---
    async function handleSignIn(e) {
        e.preventDefault();
        const email = document.getElementById('signin-email').value;
        const password = document.getElementById('signin-password').value;

        try {
            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                const data = await response.json();
                sessionStorage.setItem('jwt_token', data.access_token);
                showCustomConfirm('Signed in successfully!', () => {
                    document.getElementById('signin-modal').classList.add('hidden');
                    updateAuthUI(true);
                    loadCollectionFromBackend();
                    loadBullionFromBackend(); // Load bullion after sign-in
                    showView('content-home');
                });
            } else {
                const errorData = await response.json();
                showCustomConfirm(`Sign-in failed: ${errorData.message}`, () => {});
            }
        } catch (error) {
            console.error('Error during sign-in:', error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
        }
    }

    async function handleSignUp(e) {
        e.preventDefault();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;

        if (password !== confirmPassword) {
            showCustomConfirm('Passwords do not match.', () => {});
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                showCustomConfirm('Account created successfully! You can now sign in.', () => {
                    document.getElementById('signup-modal').classList.add('hidden');
                    document.getElementById('signin-email').value = email; // Pre-fill sign-in form
                    showItemFormModal(document.getElementById('signin-modal'));
                });
            } else {
                const errorData = await response.json();
                showCustomConfirm(`Sign-up failed: ${errorData.message}`, () => {});
            }
        } catch (error) {
            console.error('Error during sign-up:', error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
        }
    }

    function handleSignOut() {
        sessionStorage.removeItem('jwt_token');
        publicCollectionOwner = null; // Clear public collection info
        collectionData = []; // Clear local data
        bullionData = []; // Clear local bullion data
        updateAuthUI(false); // Update UI to logged out state
        history.replaceState(null, '', window.location.pathname); // Clear public URL param on logout
        renderAllViews();
        showCustomConfirm('Signed out successfully!', () => {});
    }

    async function handleChangePassword(e) {
        e.preventDefault();
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;

        if (newPassword !== confirmNewPassword) {
            showCustomConfirm('New passwords do not match.', () => {});
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/change_password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
            });

            if (response.ok) {
                showCustomConfirm('Password changed successfully!', () => {
                    document.getElementById('change-password-form').reset();
                });
            } else {
                const errorData = await response.json();
                showCustomConfirm(`Failed to change password: ${errorData.message}`, () => {});
            }
        } catch (error) {
            console.error('Error changing password:', error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
        }
    }

    async function generatePublicCollectionLink() {
        try {
            const response = await fetch(`${API_BASE_URL}/public_collection_link/generate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const publicLink = `${window.location.origin}${window.location.pathname}?public=${data.public_id}`;
                document.getElementById('public-link-display').innerHTML = `<a href="${publicLink}" target="_blank" class="text-blue-400 hover:underline break-all">${publicLink}</a>`;
                updatePublicLinkUI(true);
                showCustomConfirm('New public link generated!', () => {});
            } else {
                const errorData = await response.json();
                showCustomConfirm(`Failed to generate link: ${errorData.message}`, () => {});
            }
        } catch (error) {
            console.error('Error generating public link:', error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
        }
    }

    async function disablePublicCollectionLink() {
        showCustomConfirm('Are you sure you want to disable your public collection link? It will no longer be accessible.', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/public_collection_link/disable`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (response.ok) {
                    document.getElementById('public-link-display').innerText = 'No public link generated yet.';
                    updatePublicLinkUI(false);
                    showCustomConfirm('Public link disabled successfully!', () => {});
                } else {
                    const errorData = await response.json();
                    showCustomConfirm(`Failed to disable link: ${errorData.message}`, () => {});
                }
            } catch (error) {
                console.error('Error disabling public link:', error);
                showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
            }
        }, true); // Pass true for a confirm dialog
    }

    async function checkPublicCollectionLink() {
        if (!isAuthenticated()) {
            document.getElementById('public-link-display').innerText = 'Sign in to manage your public link.';
            updatePublicLinkUI(false);
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/public_collection_link`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.public_id) {
                    const publicLink = `${window.location.origin}${window.location.pathname}?public=${data.public_id}`;
                    document.getElementById('public-link-display').innerHTML = `<a href="${publicLink}" target="_blank" class="text-blue-400 hover:underline break-all">${publicLink}</a>`;
                    updatePublicLinkUI(true);
                } else {
                    document.getElementById('public-link-display').innerText = 'No public link generated yet.';
                    updatePublicLinkUI(false);
                }
            } else if (response.status === 404) {
                document.getElementById('public-link-display').innerText = 'No public link generated yet.';
                updatePublicLinkUI(false);
            } else {
                const errorData = await response.json();
                console.error('Failed to check public link:', errorData.message);
                document.getElementById('public-link-display').innerText = `Error: ${errorData.message}`;
                updatePublicLinkUI(false);
            }
        } catch (error) {
            console.error('Error checking public link:', error);
            document.getElementById('public-link-display').innerText = 'Error connecting to backend.';
            updatePublicLinkUI(false);
        }
    }

    function updatePublicLinkUI(linkExists) {
        const generateBtn = document.getElementById('generate-public-link-btn');
        const copyBtn = document.getElementById('copy-public-link-btn');
        const disableBtn = document.getElementById('disable-public-link-btn');

        if (linkExists) {
            generateBtn.classList.add('hidden');
            copyBtn.classList.remove('hidden');
            disableBtn.classList.remove('hidden');
        } else {
            generateBtn.classList.remove('hidden');
            copyBtn.classList.add('hidden');
            disableBtn.classList.add('hidden');
        }
    }

    function copyPublicLink() {
        const linkElement = document.querySelector('#public-link-display a');
        if (linkElement) {
            navigator.clipboard.writeText(linkElement.href).then(() => {
                showCustomConfirm('Public link copied to clipboard!', () => {});
            }).catch(err => {
                console.error('Failed to copy link: ', err);
                showCustomConfirm('Failed to copy link. Please copy it manually.', () => {});
            });
        }
    }

    // --- Import/Export Functions ---
    async function handleImportJson(e) {
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to import data.', () => {});
            return;
        }

        const fileInput = document.getElementById('import-json-file');
        const file = fileInput.files[0];

        if (!file) {
            showCustomConfirm('Please select a JSON file to import.', () => {});
            return;
        }

        const reader = new FileReader();
        reader.onload = async (event) => {
            try {
                const jsonData = JSON.parse(event.target.result);
                console.log("Importing JSON data:", jsonData);

                // Assuming the backend has an endpoint for batch import
                const response = await fetch(`${API_BASE_URL}/import_collection`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(jsonData)
                });

                if (response.ok) {
                    showCustomConfirm('Collection imported successfully!', () => {
                        document.getElementById('import-export-modal').classList.add('hidden');
                        loadCollectionFromBackend(); // Reload collection after import
                        loadBullionFromBackend(); // Reload bullion after import
                    });
                } else {
                    const errorData = await response.json();
                    showCustomConfirm(`Import failed: ${errorData.message}. Please check your JSON format.`, () => {});
                }
            } catch (error) {
                console.error('Error importing JSON:', error);
                showCustomConfirm('Error processing JSON file or connecting to backend. Ensure file is valid JSON.', () => {});
            }
        };
        reader.onerror = () => {
            showCustomConfirm('Error reading file.', () => {});
        };
        reader.readAsText(file);
    }

    async function handleExportJson() {
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to export data.', () => {});
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/export_collection`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'coinshelf_collection.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showCustomConfirm('Collection exported as JSON!', () => {});
            } else {
                const errorData = await response.json();
                showCustomConfirm(`Export failed: ${errorData.message}`, () => {});
            }
        } catch (error) {
            console.error("Error exporting JSON:", error);
            showCustomConfirm('Error connecting to backend. Please ensure the backend is running.', () => {});
        }
    }

    function handleExportPdf() {
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to export data.', () => {});
            return;
        }

        // Combine all data for PDF export (coins, banknotes, bullion)
        const combinedItems = collectionData.map(item => ({...item, type: item.type})) // Coins/Banknotes
                                .concat(bullionData.map(item => ({ // Bullion
                                    ...item,
                                    type: `Bullion (${item.type})`, // e.g., "Bullion (Gold)"
                                    value: calculateBullionValue(item) // Calculate current value
                                })));

        if (combinedItems.length === 0) {
            showCustomConfirm('Your collection is empty. Add some items before exporting to PDF!', () => {});
            return;
        }

        let tableHtml = `
            <style>
                body { font-family: sans-serif; margin: 20px; }
                h1 { color: #333; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                img { max-width: 50px; max-height: 50px; object-fit: cover; border-radius: 4px; }
            </style>
            <h1>My CoinShelf Collection</h1>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Country</th>
                        <th>Year</th>
                        <th>Denomination</th>
                        <th>Weight (g)</th>
                        <th>Purity (%)</th>
                        <th>Value (USD)</th>
                        <th>Notes</th>
                        <th>Image</th>
                        <th>Reference Link</th>
                    </tr>
                </thead>
                <tbody>
        `;

        combinedItems.forEach(item => {
            const isBullion = item.type.startsWith('Bullion');
            tableHtml += `
                <tr>
                    <td>${item.id || 'N/A'}</td>
                    <td>${item.type || 'N/A'}</td>
                    <td>${isBullion ? 'N/A' : (item.country || 'N/A')}</td>
                    <td>${item.year || 'N/A'}</td>
                    <td>${isBullion ? 'N/A' : (item.denomination || 'N/A')}</td>
                    <td>${isBullion ? (item.weight_grams || 0).toFixed(2) : 'N/A'}</td>
                    <td>${isBullion ? (item.purity_percent || 0).toFixed(2) : 'N/A'}</td>
                    <td>$${(item.value || 0).toFixed(2)}</td>
                    <td>${item.notes || 'N/A'}</td>
                    <td>${item.image_url ? `<img src="${item.image_url}" />` : 'No Image'}</td>
                    <td>${item.reference_link ? `<a href="${item.reference_link}">Link</a>` : 'N/A'}</td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;

        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>CoinShelf Collection Report</title>');
        printWindow.document.write('</head><body>');
        printWindow.document.write(tableHtml);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }


    // --- Event Listeners ---
    function attachGlobalEventListeners() {
        // Mobile menu button
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.querySelector('aside');
        if (mobileMenuBtn && sidebar) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('absolute');
                sidebar.classList.toggle('inset-y-0');
                sidebar.classList.toggle('left-0');
                sidebar.classList.toggle('z-40');
            });
        } else { console.error('mobile-menu-btn or sidebar not found during attachGlobalEventListeners!'); }

        // Navigation links
        document.getElementById('nav-home')?.addEventListener('click', () => showView('content-home'));
        document.getElementById('nav-dashboard')?.addEventListener('click', () => showView('content-dashboard'));
        document.getElementById('nav-collection')?.addEventListener('click', () => showView('content-collection'));
        document.getElementById('nav-map')?.addEventListener('click', () => showView('content-map'));
        document.getElementById('nav-public-collection')?.addEventListener('click', () => showView('content-public-collection'));
        document.getElementById('nav-settings')?.addEventListener('click', () => showView('content-settings'));
        // NEW: Bullion nav link
        document.getElementById('nav-bullion')?.addEventListener('click', () => showView('content-bullion'));


        // Modals
        document.getElementById('signin-btn')?.addEventListener('click', () => document.getElementById('signin-modal').classList.remove('hidden'));
        document.getElementById('signup-btn')?.addEventListener('click', () => document.getElementById('signup-modal').classList.remove('hidden'));
        document.getElementById('cancel-signin-btn')?.addEventListener('click', () => document.getElementById('signin-modal').classList.add('hidden'));
        document.getElementById('cancel-signup-btn')?.addEventListener('click', () => document.getElementById('signup-modal').classList.add('hidden'));

        document.getElementById('add-item-btn')?.addEventListener('click', () => showItemFormModal());
        document.getElementById('cancel-item-btn')?.addEventListener('click', () => document.getElementById('item-form-modal').classList.add('hidden'));
        document.getElementById('item-form')?.addEventListener('submit', handleFormSubmission);
        
        // NEW: Event listener for type dropdown to toggle fields
        document.getElementById('type')?.addEventListener('change', toggleItemFormFields);


        document.getElementById('close-country-items-btn')?.addEventListener('click', () => document.getElementById('country-items-container').classList.add('hidden'));

        document.getElementById('import-export-btn')?.addEventListener('click', () => document.getElementById('import-export-modal').classList.remove('hidden'));
        document.getElementById('cancel-import-export-btn')?.addEventListener('click', () => document.getElementById('import-export-modal').classList.add('hidden'));

        // Form Submissions
        document.getElementById('signin-form')?.addEventListener('submit', handleSignIn);
        document.getElementById('signup-form')?.addEventListener('submit', handleSignUp);
        document.getElementById('signout-btn')?.addEventListener('click', handleSignOut);
        
        const changePasswordForm = document.getElementById('change-password-form');
        if (changePasswordForm) { changePasswordForm.addEventListener('submit', handleChangePassword); } else { console.error('change-password-form not found during attachGlobalEventListeners!'); }

        // Public Link Buttons
        document.getElementById('generate-public-link-btn')?.addEventListener('click', generatePublicCollectionLink);
        document.getElementById('disable-public-link-btn')?.addEventListener('click', disablePublicCollectionLink);
        document.getElementById('copy-public-link-btn')?.addEventListener('click', copyPublicLink);

        // Import/Export buttons
        document.getElementById('perform-import-btn')?.addEventListener('click', handleImportJson);
        document.getElementById('perform-export-btn')?.addEventListener('click', handleExportJson);
        document.getElementById('perform-pdf-export-btn')?.addEventListener('click', handleExportPdf);


        // Quick Add button
        const quickAddBtn = document.getElementById('quick-add-btn');
        if (quickAddBtn) {
            console.log('Found quick-add-btn');
            quickAddBtn.addEventListener('click', () => {
                console.log('Quick Add button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to add new items.', () => {});
                    return;
                }
                showItemFormModal();
            });
        } else { console.error('quick-add-btn not found during attachGlobalEventListeners!'); }

        // Quick Import button
        const quickImportBtn = document.getElementById('quick-import-btn');
        if (quickImportBtn) {
            console.log('Found quick-import-btn');
            quickImportBtn.addEventListener('click', () => {
                console.log('Quick Import button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to import data.', () => {});
                    return;
                }
                document.getElementById('import-export-modal').classList.remove('hidden');
            });
        } else { console.error('quick-import-btn not found during attachGlobalEventListeners!'); }
        
        // Quick Export button (re-uses existing handleExportJson)
        const quickExportBtn = document.getElementById('quick-export-btn');
        if (quickExportBtn) {
            console.log('Found quick-export-btn');
            quickExportBtn.addEventListener('click', () => {
                console.log('Quick Export button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to export data.', () => {});
                    return;
                }
                handleExportJson();
            });
        } else { console.error('quick-export-btn not found during attachGlobalEventListeners!'); }

        // Logout button
        const logoutBtn = document.getElementById('signout-btn');
        if (logoutBtn) {
            console.log('Found signout-btn');
            logoutBtn.addEventListener('click', () => {
                console.log('Sign Out button clicked');
                handleSignOut();
            });
        } else { console.error('logout-btn not found during attachGlobalEventListeners!'); }
    }

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded. Starting app initialization...');
        applySavedTheme(); // Apply theme immediately on load
        attachGlobalEventListeners();

        const urlParams = new URLSearchParams(window.location.search);
        const publicId = urlParams.get('public');

        if (publicId) {
            // If public ID is present, render public collection view directly
            updateAuthUI(false); // Ensure logged out state for public view
            showView('content-public-collection'); // This will trigger loading public data
            loadPublicCollectionFromBackend(publicId);
        } else {
            // Otherwise, proceed with normal authenticated app flow
            updateAuthUI(isAuthenticated()); // Update UI based on initial token presence
            loadCollectionFromBackend(); // Attempt to load coin/banknote data if already authenticated
            loadBullionFromBackend(); // NEW: Attempt to load bullion data if already authenticated
            fetchMetalPrices(); // NEW: Fetch metal prices on initial load
            showView('content-home'); // Default view on load is now the home page
            checkPublicCollectionLink(); // Check and display public link status
        }
        console.log('App initialization completed successfully.');
    });

</script>

</body>
</html>
