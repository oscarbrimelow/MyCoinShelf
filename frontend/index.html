<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<!-- Favicon for browser tab icon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸª™</text></svg>" type="image/svg+xml">
<!-- You can also use a hosted image like this (replace URL with your own) -->
<!-- <link rel="icon" href="https://placehold.co/32x32/1f2937/d1d5db?text=CO" type="image/png"> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinShelf - Collection Manager</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Charts for GeoChart -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- Phosphor Icons for a clean icon set -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom styles for a more polished look */
        body {
            background-color: #111827; /* Dark gray background */
            color: #d1d5db; /* Light gray text */
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Custom scrollbar for a modern feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* General styles for containers, no specific map library styles needed here */
        #map-container {
            width: 100%;
            /* min-height can be adjusted based on desired aspect ratio. 500px is a good start. */
            min-height: 500px;
            display: flex; /* Flex to center content if needed, though GeoChart fills its container */
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            overflow: hidden; /* Hide any overflow from the chart */
        }
        /* Make sure Google Charts fits its container */
        #map-container > div {
            width: 100% !important;
            height: 100% !important;
        }

        /* --- Google Charts Tooltip Custom Styles --- */
        /* This targets the main tooltip container, typically generated by Google Charts */
        .google-visualization-tooltip {
            background-color: #1f2937 !important; /* Dark background */
            border: 1px solid #4b5563 !important; /* Darker border */
            color: #d1d5db !important; /* Light text */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4) !important; /* Soft shadow */
            border-radius: 0.5rem !important; /* Rounded corners */
            padding: 0.75rem 1rem !important; /* Padding inside */
            font-family: 'Inter', sans-serif !important; /* Match app font */
            font-size: 0.875rem !important; /* Standard text size */
            line-height: 1.5 !important; /* Better line spacing */
        }
        /* Style for text within the tooltip */
        .google-visualization-tooltip p {
            margin-bottom: 0.25rem !important;
        }
        /* Style for headers within the tooltip if any */
        .google-visualization-tooltip h3 {
            color: #34D399 !important; /* Highlight color for headers, e.g., emerald */
            font-size: 1.125rem !important; /* Slightly larger heading */
            margin-bottom: 0.5rem !important;
        }
        /* Style for scrollable content within tooltip */
        .google-visualization-tooltip .tooltip-scroll-content {
            max-height: 100px; /* Limit height */
            overflow-y: auto; /* Enable scroll if content overflows */
            padding-right: 5px; /* Space for scrollbar */
        }
        /* Custom scrollbar for tooltip content */
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar {
            width: 6px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 3px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }

        /* Table hover effect */
        .data-table tbody tr:hover {
            background-color: #1f2937;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Chart.js tooltip custom styles */
        .chartjs-tooltip {
            background: #1f2937 !important;
            border: 1px solid #4b5563 !important;
            border-radius: 0.5rem !important;
            color: #d1d5db !important;
        }

        /* Overlay for unauthenticated state */
        /* Changed z-index from 50 to 20 to ensure sidebar and its content are visible above it */
        .unauthenticated-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9); /* Same as body bg with transparency */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 20; /* Adjusted from 50 */
            border-radius: 0.5rem; /* Match card styling */
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <!-- Overlay for mobile sidebar when open -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Main App Content -->
    <div id="app-content" class="flex flex-col md:flex-row min-h-screen bg-gray-900 text-gray-300">
        <!-- Sidebar Navigation -->
        <!-- Responsive classes: fixed and off-screen by default on mobile, then relative and visible on md screens up -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-gray-800 border-r border-gray-700 flex flex-col
                                  transform -translate-x-full md:relative md:translate-x-0 md:flex-shrink-0 transition-transform duration-300 ease-in-out">
            <div class="h-16 flex items-center justify-center border-b border-gray-700">
                <i class="ph-bold ph-coins text-3xl text-emerald-400"></i>
                <h1 class="text-xl font-bold ml-2">CoinShelf by Oscar</h1>
            </div>
            <nav class="flex-grow p-4 overflow-y-auto">
                <a href="#" id="nav-dashboard" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md bg-gray-700 text-white">
                    <i class="ph-bold ph-chart-pie-slice mr-3"></i> Dashboard
                </a>
                <a href="#" id="nav-collection" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                    <i class="ph-bold ph-list-dashes mr-3"></i> Collection
                </a>
                <a href="#" id="nav-map" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                    <i class="ph-bold ph-map-trifold mr-3"></i> World Map
                </a>
                <a href="#" id="nav-missing" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                    <i class="ph-bold ph-flag mr-3"></i> Missing Countries
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700 flex flex-col space-y-3">
                <button id="quick-add-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-plus-circle mr-2"></i> Quick Add Item
                </button>
                 <button id="import-data-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-upload-simple mr-2"></i> Import Data
                </button>
                 <button id="clear-all-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-trash-simple mr-2"></i> Clear All Items
                </button>
            </div>

            <!-- Authentication Section -->
            <div class="p-4 border-t border-gray-700 mt-auto">
                <div id="auth-status" class="text-center text-sm mb-2"></div>
                <div id="auth-form-container">
                    <form id="login-form" class="space-y-3">
                        <input type="email" id="login-email" placeholder="Email" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <input type="password" id="login-password" placeholder="Password" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <button type="submit" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Sign In</button>
                        <button type="button" id="signup-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Sign Up</button>
                    </form>
                    <button type="button" id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm mt-3 hidden transition-colors">Sign Out</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden md:ml-64">
            <!-- Top bar for mobile (hamburger menu and title) -->
            <header class="bg-gray-800 p-4 md:hidden flex items-center justify-between border-b border-gray-700">
                <button id="mobile-menu-toggle" class="text-white text-2xl focus:outline-none">
                    <i class="ph-bold ph-list"></i>
                </button>
                <h1 class="text-xl font-bold text-white">CoinShelf</h1>
                <div class="w-8"></div> <!-- Placeholder for right alignment to balance toggle button -->
            </header>

            <div id="content-dashboard" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative">
                <!-- Dashboard Content Here -->
            </div>

            <div id="content-collection" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <!-- Collection Content Here -->
            </div>

            <div id="content-map" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <!-- Map Content Here -->
                <div id="map-container" class="h-[95%] w-full rounded-lg border border-gray-700">
                    <!-- Google GeoChart will be rendered here -->
                    <div id="geochart-canvas"></div>
                </div>
            </div>

            <!-- Missing Countries Content -->
            <div id="content-missing" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <h2 class="text-3xl font-bold text-white mb-6">Countries to Collect</h2>
                <div id="missing-countries-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- Missing countries will be rendered here -->
                </div>
                <div id="missing-countries-status" class="text-gray-400 mt-6 text-center"></div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-2xl border border-gray-700 transform transition-all scale-95 opacity-0">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Item</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Form fields -->
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-400">Type</label>
                        <select id="type" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option>Coin</option>
                            <option>Banknote</option>
                        </select>
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-400">Country</label>
                        <input type="text" id="country" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-400">Year</label>
                        <input type="number" id="year" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                     <div>
                        <label for="value" class="block text-sm font-medium text-gray-400">Estimated Value (USD)</label>
                        <input type="number" step="0.01" id="value" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="denomination" class="block text-sm font-medium text-gray-400">Denomination</label>
                        <input type="text" id="denomination" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-400">Notes</label>
                        <textarea id="notes" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="referenceUrl" class="block text-sm font-medium text-gray-400">Reference URL (eBay, etc.)</label>
                        <input type="text" id="referenceUrl" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="localImagePath" class="block text-sm font-medium text-gray-400">Local Image Path</label>
                        <input type="text" id="localImagePath" placeholder="e.g., C:\Users\YourName\Pictures\Coins\my_coin.jpg" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button type="button" id="cancel-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-md transition-colors">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="import-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-2xl border border-gray-700 transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-6">Import Collection Data</h2>
            <p class="text-gray-400 mb-4">Paste your coin collection data as a JSON array below.</p>
            <textarea id="import-json-data" rows="15" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-3 font-mono text-sm"></textarea>
            <div class="flex justify-end mt-6">
                <button type="button" id="import-cancel-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                <button type="button" id="import-submit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Upload & Import</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-sm text-center transform transition-all scale-95 opacity-0">
            <p id="confirm-message" class="text-lg font-semibold mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Clear All Confirmation Modal -->
    <div id="clear-confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-md text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-red-400 mb-4">CONFIRM CLEAR ALL DATA</h2>
            <p class="text-lg text-gray-300 mb-6">
                This action will permanently delete ALL your coin collection data.
                To proceed, please type "<span class="font-bold text-red-300">CLEARYES</span>" into the box below.
            </p>
            <input type="text" id="clear-confirm-input" placeholder="Type CLEARYES here"
                   class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 text-white p-3 text-center text-lg uppercase mb-6">
            <div class="flex justify-center space-x-4">
                <button type="button" id="clear-all-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                <button type="button" id="clear-all-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Delete All Data</button>
            </div>
        </div>
    </div>


<script>
    // --- Backend API Base URL ---
    // This will be updated later with your actual Render backend URL
    const API_BASE_URL = 'https://mycoinshelf.onrender.com/api';

    // --- Data Store ---
    let collectionData = []; // This will be populated from the backend

    // List of all countries (you can expand this as needed)
    const ALL_COUNTRIES = [
        "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan",
        "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi",
        "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czechia (Czech Republic)",
        "Denmark", "Djibouti", "Dominica", "Dominican Republic",
        "East Timor (Timor-Leste)", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia",
        "Fiji", "Finland", "France",
        "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana",
        "Haiti", "Honduras", "Hungary",
        "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Ivory Coast",
        "Jamaica", "Japan", "Jordan",
        "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan",
        "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
        "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar (Burma)",
        "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia (Macedonia)", "Norway",
        "Oman",
        "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
        "Qatar",
        "Romania", "Russia", "Rwanda",
        "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
        "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu",
        "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan",
        "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
        "Yemen",
        "Zambia", "Zimbabwe"
    ].sort();


    // --- UTILS ---
    let chartInstance = null; // To store the Chart.js instance for dashboard chart
    let geoChart = null; // To store the Google GeoChart instance

    // Debounce function to limit how often a function is called
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Map for standardizing country names for Google Charts GeoChart
    const countryAliasMap = {
        "united states of america": "United States", "usa": "United States", "uk": "United Kingdom",
        "britain": "United Kingdom", "russia": "Russia", "china": "China", "india": "India",
        "japan": "Japan", "germany": "Germany", "deutschland": "Germany", "france": "France",
        "italy": "Italy", "brazil": "Brazil", "brasil": "Brazil", "south africa": "South Africa",
        "eswatini": "Eswatini", "rome": "Italy", "constantinople": "Turkey", "nicomedia": "Turkey",
        "antioch": "Syria", "ancient greece": "Greece", "seleucid": "Syria", "ussr": "Russia",
        "yugoslavia": "Serbia", "east germany": "Germany", "german democratic republic": "Germany",
        "phillipines": "Philippines",
    };

    /**
     * Gets the standardized country name for Google GeoChart.
     * @param {string} countryName - The country name from your data.
     * @returns {string} The standardized country name or the original if no alias found.
     */
    function getGeoChartCountryName(countryName) {
        if (!countryName) return "";
        const normalized = countryName.toLowerCase().trim();
        return countryAliasMap[normalized] || countryName;
    }

    /**
     * Retrieves the geographic region for a given country.
     * @param {string} countryName The country name.
     * @returns {string} The region name, or 'Other' if not found.
     */
    function getRegionForCountry(countryName) {
        const countryToRegionMap = {
            "south africa": "Africa", "eswatini": "Africa", "kenya": "Africa", "central african states": "Africa",
            "mauritius": "Africa", "ghana": "Africa", "rwanda": "Africa", "zimbabwe": "Africa",
            "tanzania": "Africa", "mozambique": "Africa", "botswana": "Africa", "zambia": "Africa",
            "eritrea": "Africa", "somalia": "Africa", "sudan": "Africa", "malawi": "Africa",
            "ethiopia": "Africa", "nigeria": "Africa", "egypt": "Africa", "algeria": "Africa", "angola": "Africa",
            "benin": "Africa", "burkina faso": "Africa", "burundi": "Africa", "cabo verde": "Africa",
            "cameroon": "Africa", "chad": "Africa", "comoros": "Africa", "congo (brazzaville)": "Africa",
            "congo (kinshasa)": "Africa", "djibouti": "Africa", "equatorial guinea": "Africa",
            "gabon": "Africa", "gambia": "Africa", "guinea": "Africa", "guinea-bissau": "Africa",
            "lesotho": "Africa", "liberia": "Africa", "libya": "Africa", "liechtenstein": "Europe", "madagascar": "Africa",
            "mali": "Africa", "mauritania": "Africa", "morocco": "Africa", "niger": "Africa",
            "sao tome and principe": "Africa", "senegal": "Africa", "sierra leone": "Africa",
            "south sudan": "Africa", "togo": "Africa", "uganda": "Africa",

            "taiwan": "Asia", "india": "Asia", "china": "Asia", "japan": "Asia", "philippines": "Asia",
            "united arab Emirates": "Asia", "israel": "Asia", "vietnam": "Asia", "bangladesh": "Asia",
            "mongolia": "Asia", "myanmar (burma)": "Asia", "cambodia": "Asia", "lebanon": "Asia",
            "uzbekistan": "Asia", "indonesia": "Asia", "laos": "Asia", "nepal": "Asia",
            "sri Lanka": "Asia", "iran": "Asia", "pakistan": "Asia", "jordan": "Asia",
            "kazakhstan": "Asia", "kuwait": "Asia", "kyrgyzstan": "Asia", "malaysia": "Asia",
            "maldives": "Asia", "north korea": "Asia", "oman": "Asia", "palestine": "Asia",
            "qatar": "Asia", "saudi arabia": "Asia", "singapore": "Asia", "south korea": "Asia",
            "syria": "Asia", "tajikistan": "Asia", "turkey": "Asia", "turkmenistan": "Asia",
            "yemen": "Asia", "afghanistan": "Asia", "azerbaijan": "Asia", "bahrain": "Asia",
            "brunei": "Asia", "east timor (timor-leste)": "Asia", "georgia": "Asia",
            "iraq": "Asia",

            "netherlands": "Europe", "united kingdom": "Europe", "belgium": "Europe",
            "eu": "Europe", "ireland": "Europe", "spain": "Europe", "portugal": "Europe",
            "isle of man": "Europe", "germany": "Europe", "bulgaria": "Europe",
            "france": "Europe", "croatia": "Europe", "moldova": "Europe",
            "ukraine": "Europe", "denmark": "Europe", "finland": "Europe",
            "norway": "Europe", "san marino": "Europe", "switzerland": "Europe",
            "belarus": "Europe", "albania": "Europe",
            "andorra": "Europe", "austria": "Europe", "bosnia and herzegovina": "Europe",
            "czechia (czech republic)": "Europe", "estonia": "Europe",
            "greece": "Europe", "hungary": "Europe", "iceland": "Europe",
            "italy": "Europe", "latvia": "Europe", "lithuania": "Europe",
            "luxembourg": "Europe", "malta": "Europe",
            "monaco": "Europe", "montenegro": "Europe", "north macedonia (macedonia)": "Europe",
            "poland": "Europe", "romania": "Europe", "serbia": "Europe",
            "slovakia": "Europe", "slovenia": "Europe", "sweden": "Europe",
            "vatican city": "Europe", "russia": "Europe",

            "canada": "North America", "united states": "North America", "mexico": "North America",
            "antigua and barbuda": "North America", "bahamas": "North America", "barbados": "North America",
            "belize": "North America", "costa rica": "North America", "cuba": "North America",
            "dominica": "North America", "dominican republic": "North America", "el salvador": "North America",
            "grenada": "North America", "guatemala": "North America", "haiti": "North America",
            "honduras": "North America", "jamaica": "North America", "nicaragua": "North America",
            "panama": "North America", "saint kitts and nevis": "North America", "saint lucia": "North America",
            "saint vincent and the grenadines": "North America", "trinidad and tobago": "North America",

            "brazil": "South America", "argentina": "South America", "peru": "South America",
            "colombia": "South America", "chile": "South America", "bolivia": "South America",
            "ecuador": "South America", "guyana": "South America", "paraguay": "South America",
            "suriname": "South America", "uruguay": "South America", "venezuela": "South America",

            "australia": "Oceania", "new zealand": "Oceania", "fiji": "Oceania",
            "kiribati": "Oceania", "marshall islands": "Oceania", "micronesia": "Oceania",
            "nauru": "Oceania", "palau": "Oceania", "papua new guinea": "Oceania",
            "samoa": "Oceania", "solomon islands": "Oceania", "tonga": "Oceania",
            "tuvalu": "Oceania", "vanuatu": "Oceania",

            "siscia": "Ancient", "consz": "Ancient", "rome": "Ancient", "nicomedia": "Ancient",
            "constantinople": "Ancient", "mediolanum (milan)": "Ancient", "antioch": "Ancient",
            "ancient greece": "Ancient", "?": "Ancient",
            "thessalonica": "Ancient", "ussr": "Ancient", "yugoslavia": "Ancient",
            "rhodesia": "Ancient", "czechoslovakia": "Ancient", "east germany": "Ancient",
            "german democratic republic": "Ancient",
        };
        const normalizedCountry = countryName.toLowerCase().trim();
        const geoChartCountry = getGeoChartCountryName(normalizedCountry);

        if (countryToRegionMap[normalizedCountry]) {
            return countryToRegionMap[normalizedCountry];
        }
        if (countryToRegionMap[geoChartCountry.toLowerCase()]) {
             return countryToRegionMap[geoChartCountry.toLowerCase()];
        }
        if (normalizedCountry.includes("united states") || normalizedCountry === "usa") return "North America";
        if (normalizedCountry.includes("uk") || normalizedCountry.includes("britain")) return "Europe";
        if (normalizedCountry.includes("russia")) return "Europe";
        if (normalizedCountry.includes("china")) return "Asia";
        if (normalizedCountry.includes("india")) return "Asia";
        if (normalizedCountry.includes("japan")) return "Asia";
        if (normalizedCountry.includes("africa")) return "Africa";
        if (normalizedCountry.includes("roman")) return "Ancient";
        if (normalizedCountry.includes("greece")) return "Europe";

        return "Other";
    }

    // Custom confirmation modal instead of alert/confirm
    function showCustomConfirm(message, onConfirmCallback) {
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok');
        const confirmCancelBtn = document.getElementById('confirm-cancel');

        // Reset previous listeners
        confirmOkBtn.replaceWith(confirmOkBtn.cloneNode(true));
        confirmCancelBtn.replaceWith(confirmCancelBtn.cloneNode(true));
        const newConfirmOkBtn = document.getElementById('confirm-ok');
        const newConfirmCancelBtn = document.getElementById('confirm-cancel');


        confirmMessage.innerText = message;
        confirmModal.classList.remove('hidden');
        confirmModal.classList.add('flex');
        setTimeout(() => {
            confirmModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            confirmModal.querySelector('div').classList.add('scale-100', 'opacity-100');
        }, 10);

        const handleConfirm = () => {
            onConfirmCallback();
            closeModal(confirmModal, confirmModal.querySelector('div'));
        };

        const handleCancel = () => {
            closeModal(confirmModal, confirmModal.querySelector('div'));
        };

        newConfirmOkBtn.addEventListener('click', handleConfirm);
        newConfirmCancelBtn.addEventListener('click', handleCancel);
    }

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('div').classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeModal(modalElement, modalContentElement) {
        modalContentElement.classList.remove('scale-100', 'opacity-100');
        modalContentElement.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
        }, 300);
    }

    // --- Data Operations (interacting with Flask Backend) ---
    function getAuthToken() {
        return sessionStorage.getItem('jwt_token');
    }

    function isAuthenticated() {
        return !!getAuthToken();
    }

    // Fetches collection data from the backend
    async function loadCollectionFromBackend() {
        if (!isAuthenticated()) {
            collectionData = []; // Clear data if not authenticated
            renderAllViews();
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/coins`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            if (!response.ok) {
                if (response.status === 401) { // Unauthorized, token expired or invalid
                    handleUnauthorized();
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            collectionData = await response.json();
            console.log("Collection data loaded from backend.");

            // Assign region and isHistorical on load for consistency
            collectionData.forEach(item => {
                if (!item.region || item.region === "" || item.region === "Uncategorized") {
                    item.region = getRegionForCountry(item.country);
                }
                if (typeof item.isHistorical === 'undefined') {
                     const historicalCountries = ["ussr", "yugoslavia", "rhodesia", "czechoslovakia", "east germany", "german democratic republic", "roman empire", "ancient greece", "seleucid", "siscia", "consz", "nicomedia", "constantinople", "rome", "thessalonica"];
                     const yearInput = item.year;
                     const parsedYear = yearInput ? parseInt(yearInput) : null;
                     item.isHistorical = historicalCountries.includes(item.country.toLowerCase()) || (parsedYear !== null && parsedYear < 1900 && parsedYear !== 0);
                }
            });
            renderAllViews(); // Re-render UI with fresh data
        } catch (error) {
            console.error("Error loading collection from backend:", error);
            showCustomConfirm('Failed to load collection. Please try logging in again or check backend server.', () => {});
            collectionData = []; // Clear local data on load error
            renderAllViews();
        }
    }

    function clearItemForm() {
        document.getElementById('item-id').value = '';
        document.getElementById('type').value = 'Coin';
        document.getElementById('country').value = '';
        document.getElementById('year').value = '';
        document.getElementById('denomination').value = '';
        document.getElementById('value').value = '';
        document.getElementById('notes').value = '';
        document.getElementById('referenceUrl').value = '';
        document.getElementById('localImagePath').value = '';
        document.getElementById('modal-title').innerText = 'Add New Item';
    }

    function reinitItemForm() {
        const form = document.getElementById('item-form');
        // Check if the form content has been replaced (e.g., by the map's country details)
        if (!document.getElementById('denomination')) {
            form.innerHTML = `
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-400">Type</label>
                        <select id="type" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option>Coin</option>
                            <option>Banknote</option>
                        </select>
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-400">Country</label>
                        <input type="text" id="country" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-400">Year</label>
                        <input type="number" id="year" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                     <div>
                        <label for="value" class="block text-sm font-medium text-gray-400">Estimated Value (USD)</label>
                        <input type="number" step="0.01" id="value" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="denomination" class="block text-sm font-medium text-gray-400">Denomination</label>
                        <input type="text" id="denomination" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-400">Notes</label>
                        <textarea id="notes" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="referenceUrl" class="block text-sm font-medium text-gray-400">Reference URL (eBay, etc.)</label>
                        <input type="text" id="referenceUrl" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="localImagePath" class="block text-sm font-medium text-gray-400">Local Image Path</label>
                        <input type="text" id="localImagePath" placeholder="e.g., C:\Users\YourName\Pictures\Coins\my_coin.jpg" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button type="button" id="cancel-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-md transition-colors">Save Item</button>
                </div>
            `;
            attachFormEventListeners(); // Re-attach event listeners after recreating elements
        }
        document.getElementById('modal-title').innerText = 'Add New Item'; // Reset title
    }

    function attachFormEventListeners() {
        const form = document.getElementById('item-form');
        const modalElement = document.getElementById('item-modal');
        const modalContentElement = modalElement.querySelector('div');

        // Remove existing listeners by replacing buttons with clones
        const oldCancelBtn = document.getElementById('cancel-btn');
        if (oldCancelBtn) { // Check if element exists before replacing
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
            newCancelBtn.addEventListener('click', () => closeModal(modalElement, modalContentElement));
        }


        const oldSubmitBtn = form.querySelector('button[type="submit"]');
        if (oldSubmitBtn) { // Check if element exists before replacing
            const newSubmitBtn = oldSubmitBtn.cloneNode(true);
            oldSubmitBtn.parentNode.replaceChild(newSubmitBtn, oldSubmitBtn);
            newSubmitBtn.addEventListener('click', handleFormSubmission);
        }
    }

    async function handleFormSubmission(e) {
        e.preventDefault();
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to save items.', () => {});
            return;
        }

        const itemId = document.getElementById('item-id').value;
        const countryValue = document.getElementById('country').value.trim();

        if (!countryValue || !document.getElementById('denomination').value.trim()) {
            showCustomConfirm('Country and Denomination are required fields.', () => {});
            return;
        }

        const historicalCountries = ["ussr", "yugoslavia", "rhodesia", "czechoslovakia", "east germany", "german democratic republic", "roman empire", "ancient greece", "seleucid", "siscia", "consz", "nicomedia", "constantinople", "rome", "thessalonica"];
        const yearInput = document.getElementById('year').value;
        const parsedYear = yearInput ? parseInt(yearInput) : null;
        const isHistoricalFlag = historicalCountries.includes(countryValue.toLowerCase()) || (parsedYear !== null && parsedYear < 1900 && parsedYear !== 0);

        const itemData = {
            type: document.getElementById('type').value,
            country: countryValue,
            year: parsedYear,
            denomination: document.getElementById('denomination').value.trim(),
            value: parseFloat(document.getElementById('value').value) || 0,
            notes: document.getElementById('notes').value.trim(),
            referenceUrl: document.getElementById('referenceUrl').value.trim(),
            localImagePath: document.getElementById('localImagePath').value.trim() || "https://placehold.co/300x300/1f2937/d1d5db?text=No+Image",
            region: getRegionForCountry(countryValue),
            isHistorical: isHistoricalFlag
        };

        const method = itemId ? 'PUT' : 'POST';
        const url = itemId ? `${API_BASE_URL}/coins/${itemId}` : `${API_BASE_URL}/coins`;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(itemData)
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            showCustomConfirm(result.message || 'Item saved successfully!', () => {});
            loadCollectionFromBackend(); // Reload data after successful save
        } catch (error) {
            console.error("Error saving item:", error);
            showCustomConfirm(`Failed to save item: ${error.message}. Please ensure the backend is running and you are logged in.`, () => {});
        } finally {
            closeModal(document.getElementById('item-modal'), document.getElementById('item-modal').querySelector('div'));
            clearItemForm();
        }
    }

    // --- DASHBOARD RENDERING ---
    function renderDashboard() {
        const dashboardDiv = document.getElementById('content-dashboard');
        // Only render if authenticated
        if (!isAuthenticated()) {
            dashboardDiv.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view your dashboard.</p></div>`;
            return;
        }

        dashboardDiv.innerHTML = `
            <h2 class="text-3xl font-bold text-white mb-6">Dashboard Overview</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Total Items</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-items">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Total Value</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-value">$0.00</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Unique Countries</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-unique-countries">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Combined Collection Highlights and Top 5 Countries -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-emerald-400 mb-4">Collection Overview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-blue-400 mb-2">Collection Highlights</h4>
                            <div id="collection-highlights" class="text-gray-300 text-sm leading-relaxed">
                                <!-- Highlights will be rendered here -->
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-yellow-400 mb-2">Top 5 Countries by Items</h4>
                            <ul id="top-countries-list" class="list-disc list-inside text-gray-300">
                                <!-- Top countries will be rendered here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Items by Region (Pie Chart) -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Items by Region</h3>
                    <div style="position: relative; height:320px; width:100%;">
                        <canvas id="chart-by-region-pie" height="320"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Items by Type (Pie Chart) -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Items by Type</h3>
                    <div style="position: relative; height:320px; width:100%;">
                        <canvas id="chart-by-type" height="320"></canvas>
                    </div>
                </div>
                <!-- Value by Region (Bar Chart) -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Value by Region</h3>
                    <div style="position: relative; height:320px; width:100%;">
                        <canvas id="chart-by-value-region" height="320"></canvas>
                    </div>
                </div>
            </div>
        `;

        // Update dashboard stats
        const totalItems = collectionData.length;
        const totalValue = collectionData.reduce((sum, item) => sum + (item.value || 0), 0);
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        document.getElementById('dashboard-total-items').innerText = totalItems;
        document.getElementById('dashboard-total-value').innerText = `$${totalValue.toFixed(2)}`;
        document.getElementById('dashboard-unique-countries').innerText = uniqueCountries;

        // Render additional dashboard content
        renderCollectionHighlights();
        renderTop5Countries();

        // Render Charts
        renderChartByType();
        renderChartByValueRegion();
        renderChartByRegionPie();
    }

    function renderCollectionHighlights() {
        const highlightsDiv = document.getElementById('collection-highlights');
        if (collectionData.length === 0) {
            highlightsDiv.innerHTML = '<p>No items in collection yet. Start adding items to see highlights!</p>';
            return;
        }

        const oldestItem = collectionData.reduce((oldest, current) => {
            if (current.year && (!oldest || current.year < oldest.year)) {
                return current;
            }
            return oldest;
        }, null);

        const newestItem = collectionData.reduce((newest, current) => {
            if (current.year && (!newest || current.year > newest.year)) {
                return current;
            }
            return newest;
        }, null);

        const highestValueItem = collectionData.reduce((highest, current) => {
            if (current.value && (!highest || current.value > highest.value)) {
                return current;
            }
            return highest;
        }, null);

        let highlightsHtml = '<ul class="space-y-2">';
        highlightsHtml += `<li><strong>Total Items:</strong> ${collectionData.length}</li>`;
        highlightsHtml += `<li><strong>Total Estimated Value:</strong> $${collectionData.reduce((sum, item) => sum + (item.value || 0), 0).toFixed(2)}</li>`;
        highlightsHtml += `<li><strong>Unique Countries Represented:</strong> ${new Set(collectionData.map(item => item.country)).size}</li>`;

        if (oldestItem) {
            highlightsHtml += `<li><strong>Oldest Item:</strong> ${oldestItem.denomination} from ${oldestItem.country} (${oldestItem.year})</li>`;
        }
        if (newestItem) {
            highlightsHtml += `<li><strong>Newest Item:</strong> ${newestItem.denomination} from ${newestItem.country} (${newestItem.year})</li>`;
        }
        if (highestValueItem) {
            highlightsHtml += `<li><strong>Highest Value Item:</strong> ${highestValueItem.denomination} from ${highestValueItem.country} ($${highestValueItem.value.toFixed(2)})</li>`;
        }
        highlightsHtml += '</ul>';
        highlightsDiv.innerHTML = highlightsHtml;
    }

    function renderTop5Countries() {
        const topCountriesList = document.getElementById('top-countries-list');
        topCountriesList.innerHTML = ''; // Clear previous list

        if (collectionData.length === 0) {
            topCountriesList.innerHTML = '<li>No data to show. Add items to see top countries.</li>';
            return;
        }

        const countryItemCounts = collectionData.reduce((acc, item) => {
            acc[item.country] = (acc[item.country] || 0) + 1;
            return acc;
        }, {});

        const sortedCountries = Object.entries(countryItemCounts)
            .sort(([, countA], [, countB]) => countB - countA)
            .slice(0, 5); // Get top 5

        if (sortedCountries.length > 0) {
            sortedCountries.forEach(([country, count]) => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="font-medium">${country}:</span> ${count} items`;
                topCountriesList.appendChild(li);
            });
        } else {
            topCountriesList.innerHTML = '<li>No data to show.</li>';
        }
    }


    function renderChartByType() {
        const ctx = document.getElementById('chart-by-type').getContext('2d');
        if (chartInstance) { // Destroy previous instance if it exists
            chartInstance.destroy();
        }

        const typeCounts = collectionData.reduce((acc, item) => {
            acc[item.type] = (acc[item.type] || 0) + 1;
            return acc;
        }, {});

        chartInstance = new Chart(ctx, { // Assign to chartInstance
            type: 'pie',
            data: {
                labels: Object.keys(typeCounts),
                datasets: [{
                    data: Object.values(typeCounts),
                    backgroundColor: [
                        '#34D399', // Emerald
                        '#60A5FA', // Blue
                        '#FCD34D', // Yellow
                        '#FB7185'  // Rose
                    ],
                    borderColor: '#111827',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db' // Light gray for legend text
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937', // Dark background for tooltip
                        borderColor: '#4b5563', // Border for tooltip
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                    }
                }
            }
        });
    }

    function renderChartByValueRegion() {
        const ctx = document.getElementById('chart-by-value-region').getContext('2d');
        if (Chart.getChart('chart-by-value-region')) {
            Chart.getChart('chart-by-value-region').destroy();
        }

        const regionValues = collectionData.reduce((acc, item) => {
            const region = item.region || 'Unknown';
            acc[region] = (acc[region] || 0) + (item.value || 0);
            return acc;
        }, {});

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(regionValues),
                datasets: [{
                    label: 'Total Value (USD)',
                    data: Object.values(regionValues),
                    backgroundColor: '#34D399', // Emerald
                    borderColor: '#111827',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#d1d5db' },
                        grid: { color: '#374151' }
                    },
                    y: {
                        ticks: {
                            color: '#d1d5db',
                            callback: function(value) {
                                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
                            }
                        },
                        grid: { color: '#374151' }
                    }
                }
            }
        });
    }

    function renderChartByRegionPie() {
        const ctx = document.getElementById('chart-by-region-pie').getContext('2d');
        if (Chart.getChart('chart-by-region-pie')) {
            Chart.getChart('chart-by-region-pie').destroy();
        }

        const regionCounts = collectionData.reduce((acc, item) => {
            acc[item.region] = (acc[item.region] || 0) + 1;
            return acc;
        }, {});

        const chartColors = [
            '#8b5cf6', '#60A5FA', '#FCD34D', '#34D399', '#FB7185', '#a855f7', '#ec4899', '#eab308',
            '#facc15', '#6ee7b7', '#93c5fd', '#f87171', '#fb923c', '#c084fc', '#fde047'
        ];

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(regionCounts),
                datasets: [{
                    data: Object.values(regionCounts),
                    backgroundColor: chartColors,
                    borderColor: '#111827',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                    }
                },
                onClick: (event, elements, chart) => {
                    if (elements.length > 0) {
                        const firstElement = elements[0];
                        const label = chart.data.labels[firstElement.index];
                        showRegionDetails(label);
                    }
                }
            }
        });
    }

    function showRegionDetails(regionName) {
        const dashboardDiv = document.getElementById('content-dashboard');
        // Add overlay if not authenticated
        if (!isAuthenticated()) {
            dashboardDiv.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view region details.</p></div>`;
            return;
        }

        const itemsInRegion = collectionData.filter(item => item.region === regionName);

        itemsInRegion.sort((a, b) => {
            const countryCompare = a.country.localeCompare(b.country);
            if (countryCompare !== 0) return countryCompare;
            return a.denomination.localeCompare(b.denomination);
        });

        let detailsHtml = `
            <h2 class="text-3xl font-bold text-white mb-6">${regionName} Collection</h2>
            <button id="back-to-dashboard-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md mb-6 flex items-center transition-colors">
                <i class="ph-bold ph-arrow-left mr-2"></i> Back to Dashboard
            </button>
            <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 overflow-y-auto max-h-[70vh]">
                <table class="w-full text-left data-table">
                    <thead class="bg-gray-700 sticky top-0">
                        <tr>
                            <th class="p-4 font-semibold">ID</th>
                            <th class="p-4 font-semibold">Type</th>
                            <th class="p-4 font-semibold">Country</th>
                            <th class="p-4 font-semibold">Year</th>
                            <th class="p-4 font-semibold">Denomination</th>
                            <th class="p-4 font-semibold">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsInRegion.length > 0 ? itemsInRegion.map(item => `
                            <tr class="border-b border-gray-700">
                                <td class="p-4">${item.id}</td>
                                <td class="p-4">${item.type}</td>
                                <td class="p-4">${item.country}</td>
                                <td class="p-4">${item.year || 'N/A'}</td>
                                <td class="p-4">${item.denomination}</td>
                                <td class="p-4">$${(item.value || 0).toFixed(2)}</td>
                            </tr>
                        `).join('') : `<tr><td colspan="6" class="p-4 text-center text-gray-500">No items in this region.</td></tr>`}
                    </tbody>
                </table>
            </div>
        `;
        dashboardDiv.innerHTML = detailsHtml;

        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
            renderDashboard();
        });
    }


    // --- COLLECTION INTERACTIVITY ---
    function initializeFilters() {
        const searchInput = document.getElementById('search-input');
        const regionFilter = document.getElementById('region-filter');
        const typeFilter = document.getElementById('type-filter');

        const applyFilters = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRegion = regionFilter.value;
            const selectedType = typeFilter.value;

            const filtered = collectionData.filter(item => {
                const matchesSearch = searchTerm === '' ||
                                      String(item.id).toLowerCase().includes(searchTerm) ||
                                      (item.country && item.country.toLowerCase().includes(searchTerm)) || // Added null check
                                      (item.denomination && item.denomination.toLowerCase().includes(searchTerm)) || // Added null check
                                      (item.notes && item.notes.toLowerCase().includes(searchTerm)) ||
                                      (item.year && item.year.toString().includes(searchTerm));
                const matchesRegion = selectedRegion === '' || item.region === selectedRegion;
                const matchesType = selectedType === '' || item.type === selectedType;
                return matchesSearch && matchesRegion && matchesType;
            });
            renderCollectionTable(filtered);
        };

        const uniqueRegions = [...new Set(collectionData.map(item => item.region))].sort();
        regionFilter.innerHTML = '<option value="">All Regions</option>' + uniqueRegions.map(r => `<option value="${r}">${r}</option>`).join('');

        const uniqueTypes = [...new Set(collectionData.map(item => item.type))].sort();
        typeFilter.innerHTML = '<option value="">All Types</option>' + uniqueTypes.map(t => `<option value="${t}">${t}</option>`).join('');


        searchInput.addEventListener('input', debounce(applyFilters, 300));
        regionFilter.addEventListener('change', applyFilters);
        typeFilter.addEventListener('change', applyFilters);
    }

    function initializeActionButtons() {
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = parseInt(button.dataset.id); // Ensure ID is parsed as integer
                const item = collectionData.find(d => d.id === id);
                if (item) {
                    document.getElementById('item-id').value = item.id;
                    document.getElementById('modal-title').innerText = 'Edit Item';
                    document.getElementById('type').value = item.type;
                    document.getElementById('country').value = item.country;
                    document.getElementById('year').value = item.year;
                    document.getElementById('denomination').value = item.denomination;
                    document.getElementById('value').value = item.value;
                    document.getElementById('notes').value = item.notes;
                    document.getElementById('referenceUrl').value = item.referenceUrl;
                    document.getElementById('localImagePath').value = item.localImagePath;
                    openModal('item-modal'); // Pass modal ID
                }
            });
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const idToDelete = parseInt(button.dataset.id);
                showCustomConfirm('Are you sure you want to delete this item?', async () => {
                    if (!isAuthenticated()) {
                        showCustomConfirm('Please sign in to delete items.', () => {});
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/coins/${idToDelete}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                handleUnauthorized();
                                return;
                            }
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        showCustomConfirm(result.message || 'Item deleted successfully!', () => {});
                        loadCollectionFromBackend(); // Reload data after deletion
                    } catch (error) {
                        console.error("Error deleting item:", error);
                        showCustomConfirm(`Failed to delete item: ${error.message}. Please ensure the backend is running and you are logged in.`, () => {});
                    }
                });
            });
        });
    }

    // --- COLLECTION RENDERING ---
    let currentSort = { column: null, direction: 'asc' };

    function renderCollection(filteredData = collectionData) {
        const collectionContent = document.getElementById('content-collection');
        if (!isAuthenticated()) {
            collectionContent.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to manage your collection.</p></div>`;
            return;
        }

        collectionContent.innerHTML = `
            <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-4 sm:space-y-0 sm:space-x-4">
                <h1 class="text-3xl font-bold text-white">Collection</h1>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                    <input type="text" id="search-input" placeholder="Search..." class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2">
                    <select id="region-filter" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2"></select>
                    <select id="type-filter" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2"></select>
                </div>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-full flex flex-col">
                    <div class="flex-1 overflow-y-auto overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
                        <table class="w-full text-left data-table min-w-max"> <!-- min-w-max to prevent crushing columns -->
                            <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="id">ID</th>
                                    <th class="p-4 font-semibold">Type</th>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="country">Country</th>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="year">Year</th>
                                    <th class="p-4 font-semibold">Denomination</th>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="value">Value</th>
                                    <th class="p-4 font-semibold">Notes & Ref.</th>
                                    <th class="p-4 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="collection-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        initializeFilters();
        renderCollectionTable(filteredData);
        attachSortEventListeners();
    };

    function renderCollectionTable(dataToRender) {
        const tableBody = document.getElementById('collection-table-body');
        const tableRows = dataToRender.map(item => `
            <tr class="border-b border-gray-700 cursor-pointer" data-item-id="${item.id}">
                <td class="p-4">${item.id}</td>
                <td class="p-4">${item.type}</td>
                <td class="p-4">${item.country} ${item.isHistorical ? '<span class="text-xs text-amber-400">(Historical)</span>' : ''}</td>
                <td class="p-4">${item.year || 'N/A'}</td>
                <td class="p-4">${item.denomination}</td>
                <td class="p-4">$${(item.value || 0).toFixed(2)}</td>
                <td class="p-4">
                    <p class="text-xs text-gray-400">${item.notes || 'N/A'}</p>
                    ${item.referenceUrl ? `<a href="${item.referenceUrl}" target="_blank" class="text-blue-400 hover:underline text-xs view-reference-link"><i class="ph-bold ph-link"></i> Open Reference</a>` : ''}
                </td>
                <td class="p-4">
                     <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2" data-id="${item.id}"><i class="ph ph-pencil-simple"></i></button>
                     <button class="delete-btn text-red-400 hover:text-red-300" data-id="${item.id}"><i class="ph ph-trash"></i></button>
                </td>
            </tr>
        `).join('');
        tableBody.innerHTML = tableRows;

        initializeActionButtons();
    }

    function attachSortEventListeners() {
        document.querySelectorAll('.data-table th[data-sort-column]').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.sortColumn;
                let direction = 'asc';

                if (currentSort.column === column) {
                    direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                }

                sortCollection(column, direction);
                currentSort = { column, direction };
            });
        });
    }

    function sortCollection(column, direction) {
        const sortedData = [...collectionData].sort((a, b) => {
            let valA = a[column];
            let valB = b[column];

            if (column === 'year' || column === 'value' || column === 'id') {
                // Ensure numbers are treated as numbers and handle N/A/null for sorting
                valA = (valA === null || valA === 'N/A') ? (direction === 'asc' ? Infinity : -Infinity) : parseFloat(valA);
                valB = (valB === null || valB === 'N/A') ? (direction === 'asc' ? Infinity : -Infinity) : parseFloat(valB);
                return direction === 'asc' ? valA - valB : valB - valA;
            } else { // String comparison
                return direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
            }
        });
        renderCollectionTable(sortedData);
    }


    // Render Map
    function renderGeoChart() {
        const mapContainer = document.getElementById('geochart-canvas');
        if (!mapContainer) {
            console.error('Error: GeoChart canvas element not found!');
            return;
        }

        if (!isAuthenticated()) {
            mapContainer.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view the map.</p></div>`;
            return;
        }

        if (geoChart) {
            geoChart.clearChart();
            mapContainer.innerHTML = '';
        }

        google.charts.load('current', {'packages': ['geochart']});
        google.charts.setOnLoadCallback(drawRegionsMap);

        function drawRegionsMap() {
            const countryCounts = {};
            collectionData.forEach(item => {
                const geoChartCountry = getGeoChartCountryName(item.country);
                if (geoChartCountry) {
                    countryCounts[geoChartCountry] = (countryCounts[geoChartCountry] || 0) + 1;
                }
            });

            if (Object.keys(countryCounts).length === 0) {
                 mapContainer.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500 text-lg">No collection data to display on the map.</div>`;
                 return;
            }

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Country');
            dataTable.addColumn('number', 'Items');
            dataTable.addColumn({ type: 'string', role: 'tooltip', 'p': {'html': true} });

            const countriesWithItems = Object.keys(countryCounts);
            const maxItems = Math.max(...Object.values(countryCounts));

            countriesWithItems.forEach(country => {
                const itemCount = countryCounts[country];
                let tooltipContent = `<div class="p-2 font-semibold">${country}</div>`;
                tooltipContent += `<div class="px-2 pb-1">Items: ${itemCount}</div>`;

                const itemsInCountry = collectionData.filter(item => getGeoChartCountryName(item.country) === country);
                tooltipContent += `<div class="px-2 text-sm text-gray-400 tooltip-scroll-content">`;
                itemsInCountry.forEach(item => {
                    tooltipContent += `<div>${item.denomination} (${item.year || 'N/A'}) - $${(item.value || 0).toFixed(2)}</div>`;
                });
                tooltipContent += `</div>`;
                dataTable.addRow([country, itemCount, tooltipContent]);
            });


            const options = {
                colorAxis: {
                    colors: ['#d9f99d', '#65a30d', '#facc15', '#f97316', '#dc2626'],
                    minValue: 1,
                    maxValue: maxItems,
                },
                backgroundColor: {
                    fill: '#1f2937',
                },
                defaultColor: '#4b5563',
                tooltip: {
                    isHtml: true,
                    trigger: 'focus',
                    textStyle: { color: '#d1d5db' },
                },
                keepAspectRatio: true,
                legend: { textStyle: { color: '#d1d5db' } },
            };

            if (!geoChart) {
                geoChart = new google.visualization.GeoChart(mapContainer);
            }

            geoChart.draw(dataTable, options);

            window.addEventListener('resize', debounce(() => {
                if (geoChart) {
                    geoChart.draw(dataTable, options);
                }
            }, 250));
        }
    }


    // --- MISSING COUNTRIES RENDERING ---
    function renderMissingCountries() {
        const missingCountriesListDiv = document.getElementById('missing-countries-list');
        const missingCountriesStatusDiv = document.getElementById('missing-countries-status');

        if (!isAuthenticated()) {
            missingCountriesListDiv.innerHTML = '';
            missingCountriesStatusDiv.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view missing countries.</p></div>`;
            return;
        }

        missingCountriesListDiv.innerHTML = '';

        const collectedCountriesNormalized = new Set(collectionData.map(item => getGeoChartCountryName(item.country)));
        const missingCountries = ALL_COUNTRIES.filter(country => !collectedCountriesNormalized.has(getGeoChartCountryName(country)));

        if (missingCountries.length === 0) {
            missingCountriesStatusDiv.innerHTML = '<p class="text-2xl text-emerald-400 font-semibold">ðŸ¥³ Congratulations! You have collected items from all tracked countries!</p>';
            missingCountriesListDiv.classList.add('hidden');
        } else {
            missingCountriesStatusDiv.innerHTML = `<p class="text-lg">You still need to collect items from <span class="font-bold text-red-400">${missingCountries.length}</span> countries.</p>`;
            missingCountriesListDiv.classList.remove('hidden');

            missingCountries.forEach(country => {
                const countryElement = document.createElement('div');
                countryElement.className = 'bg-gray-800 p-4 rounded-md shadow-md border border-gray-700 flex items-center justify-between transition-transform transform hover:scale-102';
                countryElement.innerHTML = `
                    <span class="text-gray-200 font-medium">${country}</span>
                    <button class="add-missing-country-btn text-emerald-400 hover:text-emerald-300 transition-colors" data-country="${country}" title="Quick Add Item from ${country}">
                        <i class="ph-bold ph-plus-circle text-xl"></i>
                    </button>
                `;
                missingCountriesListDiv.appendChild(countryElement);
            });

            document.querySelectorAll('.add-missing-country-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const countryToAdd = e.currentTarget.dataset.country;
                    clearItemForm();
                    document.getElementById('country').value = countryToAdd;
                    document.getElementById('modal-title').innerText = `Quick Add Item from ${countryToAdd}`;
                    openModal('item-modal');
                });
            });
        }
    }


    // --- NAVIGATION & UI Management ---
    function showView(viewId) {
        document.querySelectorAll('.content-view').forEach(view => {
            view.classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('bg-gray-700', 'text-white');
            link.classList.add('hover:bg-gray-700');
        });
        document.getElementById(`nav-${viewId.replace('content-', '')}`).classList.add('bg-gray-700', 'text-white');

        renderAllViews();
    }

    function renderAllViews() {
        // These functions now check isAuthenticated() internally
        renderDashboard();
        renderCollection();
        renderGeoChart();
        renderMissingCountries();
    }

    function handleUnauthorized() {
        sessionStorage.removeItem('jwt_token');
        showCustomConfirm('Your session has expired or is invalid. Please log in again.', () => {});
        updateAuthUI(false);
        collectionData = []; // Clear data on logout/unauthorized
        renderAllViews(); // Re-render all views to show login prompts
    }

    function updateAuthUI(loggedIn) {
        const authStatusDiv = document.getElementById('auth-status');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const quickAddBtn = document.getElementById('quick-add-btn');
        const importDataBtn = document.getElementById('import-data-btn');
        const clearAllBtn = document.getElementById('clear-all-btn'); // Get clear all button

        if (loggedIn) {
            authStatusDiv.innerHTML = `<span class="text-emerald-400 font-semibold">Logged in!</span>`;
            loginForm.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            quickAddBtn.classList.remove('hidden'); // Show Quick Add
            importDataBtn.classList.remove('hidden'); // Show Import Data
            clearAllBtn.classList.remove('hidden'); // Show Clear All
        } else {
            authStatusDiv.innerHTML = `<span class="text-red-400 font-semibold">Not logged in.</span>`;
            loginForm.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            quickAddBtn.classList.add('hidden'); // Hide Quick Add
            importDataBtn.classList.add('hidden'); // Hide Import Data
            clearAllBtn.classList.add('hidden'); // Hide Clear All
        }
    }


    // --- GLOBAL UI Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');
    // We target document.body for overflow-hidden to prevent background scroll when sidebar is open
    // const appContent = document.getElementById('app-content'); // No longer directly used for overflow control

    // Function to toggle sidebar visibility
    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full'); // Toggle sidebar's off-screen state
        if (sidebar.classList.contains('-translate-x-full')) {
            mobileSidebarOverlay.classList.add('hidden'); // Hide overlay
            document.body.classList.remove('overflow-hidden'); // Allow body scroll
        } else {
            mobileSidebarOverlay.classList.remove('hidden'); // Show overlay
            document.body.classList.add('overflow-hidden'); // Prevent body scroll
        }
    }

    // --- EVENT LISTENERS ---
    function attachGlobalEventListeners() {
        // Navigation links
        document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); showView('content-dashboard'); });
        document.getElementById('nav-collection').addEventListener('click', (e) => { e.preventDefault(); showView('content-collection'); });
        document.getElementById('nav-map').addEventListener('click', (e) => { e.preventDefault(); showView('content-map'); });
        document.getElementById('nav-missing').addEventListener('click', (e) => { e.preventDefault(); showView('content-missing'); });

        // Quick Add button
        document.getElementById('quick-add-btn').addEventListener('click', () => {
            if (!isAuthenticated()) {
                showCustomConfirm('Please sign in to add new items.', () => {});
                return;
            }
            clearItemForm();
            openModal('item-modal');
            // Close sidebar on mobile after clicking quick add
            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        });

        // Import Data button
        document.getElementById('import-data-btn').addEventListener('click', () => {
            if (!isAuthenticated()) {
                showCustomConfirm('Please sign in to import data.', () => {});
                return;
            }
            document.getElementById('import-json-data').value = ''; // Clear previous data
            openModal('import-modal');
            // Close sidebar on mobile after clicking import data
            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        });

        // Handle import submission
        document.getElementById('import-submit-btn').addEventListener('click', async () => {
            const jsonData = document.getElementById('import-json-data').value;
            let itemsToImport;
            try {
                itemsToImport = JSON.parse(jsonData);
                if (!Array.isArray(itemsToImport)) {
                    throw new Error("Pasted data is not a JSON array.");
                }
            } catch (error) {
                showCustomConfirm(`Invalid JSON data: ${error.message}. Please paste a valid JSON array of coin objects.`, () => {});
                return;
            }

            if (itemsToImport.length === 0) {
                showCustomConfirm('No items found in the pasted data.', () => {});
                return;
            }

            showCustomConfirm(`Are you sure you want to import ${itemsToImport.length} items? This will add them to your collection.`, async () => {
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to import data.', () => {});
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/coins/bulk_upload`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify(itemsToImport)
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            handleUnauthorized();
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    let message = result.message || 'Import process completed.';
                    if (result.errors && result.errors.length > 0) {
                        message += ` Some items had errors: ${result.errors.map(err => err.substring(0, 50) + "...").join('; ')}`; // Truncate errors for message box
                    }
                    showCustomConfirm(message, () => {});
                    loadCollectionFromBackend(); // Reload data after successful import
                } catch (error) {
                    console.error("Error during bulk import:", error);
                    showCustomConfirm(`Failed to import data: ${error.message}. Please ensure the backend is running and you are logged in.`, () => {});
                } finally {
                    closeModal(document.getElementById('import-modal'), document.getElementById('import-modal').querySelector('div'));
                }
            });
        });

        document.getElementById('import-cancel-btn').addEventListener('click', () => {
            closeModal(document.getElementById('import-modal'), document.getElementById('import-modal').querySelector('div'));
        });

        // Clear All Items button and modal logic
        const clearAllBtn = document.getElementById('clear-all-btn');
        const clearConfirmModal = document.getElementById('clear-confirm-modal');
        const clearConfirmInput = document.getElementById('clear-confirm-input');
        const clearAllConfirmBtn = document.getElementById('clear-all-confirm-btn');
        const clearAllCancelBtn = document.getElementById('clear-all-cancel-btn');

        clearAllBtn.addEventListener('click', () => {
            if (!isAuthenticated()) {
                showCustomConfirm('Please sign in to clear items.', () => {});
                return;
            }
            clearConfirmInput.value = ''; // Clear input field
            openModal('clear-confirm-modal');
            // Close sidebar on mobile after clicking clear all
            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        });

        clearAllConfirmBtn.addEventListener('click', async () => {
            if (clearConfirmInput.value.trim() === 'CLEARYES') {
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to clear items.', () => {});
                    closeModal(clearConfirmModal, clearConfirmModal.querySelector('div'));
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/coins/clear_all`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            handleUnauthorized();
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    showCustomConfirm(result.message || 'All items deleted successfully!', () => {});
                    collectionData = []; // Clear local data
                    renderAllViews(); // Re-render UI
                } catch (error) {
                    console.error("Error clearing all items:", error);
                    showCustomConfirm(`Failed to clear all items: ${error.message}. Please ensure the backend is running and you are logged in.`, () => {});
                } finally {
                    closeModal(clearConfirmModal, clearConfirmModal.querySelector('div'));
                }
            } else {
                showCustomConfirm('Incorrect confirmation phrase. Please type "CLEARYES" exactly to proceed.', () => {});
            }
        });

        clearAllCancelBtn.addEventListener('click', () => {
            closeModal(clearConfirmModal, clearConfirmModal.querySelector('div'));
        });


        // Modal close listeners (click outside or ESC)
        const itemModal = document.getElementById('item-modal');
        const importModal = document.getElementById('import-modal');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const clearConfirmModalElement = document.getElementById('clear-confirm-modal'); // Renamed to avoid conflict

        itemModal.addEventListener('click', function(event) {
            const modalContent = this.querySelector('div');
            if (!modalContent.contains(event.target)) {
                closeModal(this, modalContent);
                reinitItemForm();
            }
        });

        importModal.addEventListener('click', function(event) {
            const modalContent = this.querySelector('div');
            if (!modalContent.contains(event.target)) {
                closeModal(this, modalContent);
            }
        });

        clearConfirmModalElement.addEventListener('click', function(event) {
            const modalContent = this.querySelector('div');
            if (!modalContent.contains(event.target)) {
                closeModal(this, modalContent);
            }
        });

        customConfirmModal.addEventListener('click', function(event) {
            const modalContent = this.querySelector('div');
            if (!modalContent.contains(event.target)) {
                closeModal(this, modalContent);
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (!itemModal.classList.contains('hidden')) {
                    closeModal(itemModal, itemModal.querySelector('div'));
                    reinitItemForm();
                }
                if (!importModal.classList.contains('hidden')) { // Close import modal
                    closeModal(importModal, importModal.querySelector('div'));
                }
                if (!customConfirmModal.classList.contains('hidden')) {
                    closeModal(customConfirmModal, customConfirmModal.querySelector('div'));
                }
                 if (!clearConfirmModalElement.classList.contains('hidden')) { // Close clear all modal
                    closeModal(clearConfirmModalElement, clearConfirmModalElement.querySelector('div'));
                }
                // Close sidebar if open on mobile
                if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            }
        });

        // Event listener for mobile menu toggle button
        if (mobileMenuToggle) { // Ensure button exists
            mobileMenuToggle.addEventListener('click', toggleSidebar);
        }

        // Event listener for overlay to close sidebar
        if (mobileSidebarOverlay) { // Ensure overlay exists
            mobileSidebarOverlay.addEventListener('click', toggleSidebar);
        }

        // Close sidebar if screen resizes to desktop and is currently open
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // md breakpoint for Tailwind
                if (!sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar(); // Close it if it was open on mobile view
                }
            }
        });

        // When a nav link is clicked (on mobile), close the sidebar
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar();
                }
            });
        });


        attachFormEventListeners(); // Attach event listeners for the item form


        // --- AUTHENTICATION EVENT LISTENERS ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Login failed.');
                }

                const result = await response.json();
                sessionStorage.setItem('jwt_token', result.token); // Store JWT
                showCustomConfirm('Signed in successfully!', () => {});
                updateAuthUI(true);
                loadCollectionFromBackend(); // Load data after successful login
            } catch (error) {
                console.error("Login error:", error.message);
                showCustomConfirm(`Login failed: ${error.message}`, () => {});
            }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                showCustomConfirm('Please enter both email and password to sign up.', () => {});
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Signup failed.');
                }

                const result = await response.json();
                showCustomConfirm(result.message || 'Signed up successfully! Please log in.', () => {
                    // Optionally auto-login after signup if desired, but
                    // for explicit flow, user logs in separately
                });
            } catch (error) {
                console.error("Sign-up error:", error.message);
                showCustomConfirm(`Sign-up failed: ${error.message}`, () => {});
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('jwt_token'); // Clear JWT
            updateAuthUI(false);
            collectionData = []; // Clear data when logged out
            renderAllViews();
            showCustomConfirm('Signed out successfully!', () => {});
        });
    }

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        attachGlobalEventListeners();
        updateAuthUI(isAuthenticated()); // Update UI based on initial token presence
        loadCollectionFromBackend(); // Attempt to load data if already authenticated
        showView('content-dashboard'); // Default view on load
        console.log('App initialization completed successfully.');
    });

</script>

</body>
</html>
