<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11426831908"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'AW-11426831908');
    </script>
    
    <!-- Favicons and App Icons for all devices -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
    <link rel="manifest" href="site.webmanifest">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>CoinShelf - Professional Coin & Bullion Collection Manager | Oscar Brimelow</title>
    <meta name="title" content="CoinShelf - Professional Coin & Bullion Collection Manager | Oscar Brimelow">
    <meta name="description" content="Manage your coin, banknote, and bullion collection with live gold & silver prices. Track value, organize by country, and discover new treasures. Free collection management tool for numismatists and precious metal investors.">
    <meta name="keywords" content="coin collection, bullion tracking, gold prices, silver prices, numismatics, coin management, precious metals, coin catalog, banknote collection, coin value tracker, gold bullion, silver bullion, coin database, collection organizer, coin collector app, bullion portfolio, coin inventory, precious metal prices, coin tracking software, numismatic database">
    <meta name="author" content="Oscar Brimelow">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mycoinshelf.com/">
    <meta property="og:title" content="CoinShelf - Professional Coin & Bullion Collection Manager">
    <meta property="og:description" content="Manage your coin, banknote, and bullion collection with live gold & silver prices. Track value, organize by country, and discover new treasures.">
    <meta property="og:image" content="https://mycoinshelf.com/og-image.png">
    <meta property="og:site_name" content="CoinShelf">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://mycoinshelf.com/">
    <meta property="twitter:title" content="CoinShelf - Professional Coin & Bullion Collection Manager">
    <meta property="twitter:description" content="Manage your coin, banknote, and bullion collection with live gold & silver prices. Track value, organize by country, and discover new treasures.">
    <meta property="twitter:image" content="https://mycoinshelf.com/twitter-image.png">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="msapplication-TileColor" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CoinShelf">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mycoinshelf.com/">
    
    <!-- Structured Data for Rich Snippets -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "CoinShelf",
        "description": "Professional coin and bullion collection management tool with live precious metal prices",
        "url": "https://mycoinshelf.com",
        "applicationCategory": "FinanceApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Person",
            "name": "Oscar Brimelow",
            "url": "https://www.instagram.com/oscarbrimelow/"
        },
        "creator": {
            "@type": "Person",
            "name": "Oscar Brimelow"
        },
        "keywords": "coin collection, bullion tracking, gold prices, silver prices, numismatics",
        "featureList": [
            "Live gold and silver prices",
            "Coin and banknote cataloging",
            "Bullion portfolio tracking",
            "World map visualization",
            "Collection value analytics",
            "Multi-currency support"
        ]
    }
    </script>

    <!-- Additional Schema Markup for Organization -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "CoinShelf",
        "url": "https://mycoinshelf.com",
        "logo": "https://mycoinshelf.com/logo.png",
        "description": "Professional coin and bullion collection management platform",
        "sameAs": [
            "https://www.instagram.com/oscarbrimelow/"
        ]
    }
    </script>

    <!-- FAQ Schema for Common Questions -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "What is CoinShelf?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "CoinShelf is a comprehensive digital platform for coin collectors, numismatists, and precious metal investors to organize, track, and value their collections with live gold and silver prices."
                }
            },
            {
                "@type": "Question",
                "name": "Is CoinShelf free to use?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, CoinShelf is completely free to use. There are no hidden fees or premium subscriptions required."
                }
            },
            {
                "@type": "Question",
                "name": "What types of items can I track?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "CoinShelf supports tracking coins, banknotes, gold bullion, and silver bullion from around the world."
                }
            },
            {
                "@type": "Question",
                "name": "Are my collection data secure?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, CoinShelf uses encrypted password storage, secure HTTPS connections, and private collection data. Your information is protected and you control what you share."
                }
            }
        ]
    }
    </script>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Charts for GeoChart -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Hammer.js for touch gestures -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

    <!-- Phosphor Icons for a clean icon set -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Offline Database -->
    <script src="offline-db.js"></script>

    <!-- Globe.gl and Three.js -->
    <script src="//unpkg.com/three"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <!-- Custom Map Components -->
    <script src="components/maps/Map3D.js"></script>

    <style>
        /* Force Globe Canvas to fit container */
        #globe-container canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            outline: none;
        }
        /* Custom styles for a more polished look */
        body {
            background-color: #111827; /* Dark gray background */
            color: #d1d5db; /* Light gray text */
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Custom scrollbar for a modern feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Custom scrollbar for specific elements */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }


        /* General styles for containers, no specific map library styles needed here */
        #map-wrapper {
            position: relative;
            min-height: 500px;
            overflow: hidden; /* Hide overflow from zoomed map */
        }
        #map-container {
            width: 100%;
            /* min-height can be adjusted based on desired aspect ratio. 500px is a good start. */
            min-height: 500px;
            display: flex; /* Flex to center content if needed, though GeoChart fills its container */
            align-items: center;
            justify-content: center;
            overflow: visible; /* Allow overflow when zoomed */
            cursor: default;
            transition: transform 0.1s ease-out;
        }
        #map-container:active {
            cursor: grabbing;
        }
        /* Make sure Google Charts fits its container */
        #map-container > div {
            width: 100% !important;
            height: 100% !important;
            pointer-events: auto !important; /* Ensure interactions work */
        }
        #geochart-canvas svg {
            pointer-events: auto !important; /* Ensure SVG is interactive */
        }

        /* --- Google Charts Tooltip Custom Styles --- */
        /* This targets the main tooltip container, typically generated by Google Charts */
        .google-visualization-tooltip {
            background-color: #1f2937 !important; /* Dark background */
            border: 1px solid #4b5563 !important; /* Darker border */
            color: #d1d5db !important; /* Light text */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4) !important; /* Soft shadow */
            border-radius: 0.5rem !important; /* Rounded corners */
            padding: 0.75rem 1rem !important; /* Padding inside */
            font-family: 'Inter', sans-serif !important; /* Match app font */
            font-size: 0.875rem !important; /* Standard text size */
            line-height: 1.5 !important; /* Better line spacing */
        }
        /* Style for text within the tooltip */
        .google-visualization-tooltip p {
            margin-bottom: 0.25rem !important;
        }
        /* Style for headers within the tooltip if any */
        .google-visualization-tooltip h3 {
            color: #34D399 !important; /* Highlight color for headers, e.g., emerald */
            font-size: 1.125rem !important; /* Slightly larger heading */
            margin-bottom: 0.5rem !important;
        }
        /* Style for scrollable content within tooltip */
        .google-visualization-tooltip .tooltip-scroll-content {
            max-height: 100px; /* Limit height */
            overflow-y: auto; /* Enable scroll if content overflows */
            padding-right: 5px; /* Space for scrollbar */
        }
        /* Custom scrollbar for tooltip content */
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar {
            width: 6px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 3px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }

        /* Table hover effect */
        .data-table tbody tr:hover {
            background-color: #1f2937;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Chart.js tooltip custom styles */
        .chartjs-tooltip {
            background: #1f2937 !important;
            border: 1px solid #4b5563 !important;
            border-radius: 0.5rem !important;
            color: #d1d5db !important;
        }

        /* Overlay for unauthenticated state */
        .unauthenticated-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9); /* Same as body bg with transparency */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 20;
            border-radius: 0.5rem; /* Match card styling */
        }

        /* Ensure main content takes full height to allow its own scrolling */
        #main-content-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: auto; /* This allows the main content to scroll independently */
        }
        
        /* On small screens, hide the fixed sidebar to allow full width for content */
        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%); /* Hidden by default */
            }
            #sidebar.open {
                transform: translateX(0); /* Shown when open */
            }
            /* Main content takes full width on mobile */
            .md\:ml-64 { /* Override Tailwind's md:ml-64 on mobile */
                margin-left: 0 !important;
            }
        }

        /* Keyframe for subtle bounce animation */
        @keyframes bounce-slow {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px); /* Smaller bounce */
            }
        }

        .animate-bounce-slow {
            animation: bounce-slow 3s infinite ease-in-out; /* Slower and smoother */
        }
        
        /* For light mode */
        html.light body {
            background-color: #f3f4f6; /* Light gray */
            color: #1f2937; /* Dark text */
        }
        html.light #sidebar {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light #sidebar .border-b, html.light #sidebar .border-t {
            border-color: #e5e7eb;
        }
        html.light #sidebar h1 {
            color: #1f2937;
        }
        html.light #sidebar .nav-link {
            color: #4b5563;
        }
        html.light #sidebar .nav-link:hover {
            background-color: #f3f4f6;
        }
        html.light #sidebar .nav-link.bg-gray-700 { /* Active link */
            background-color: #e5e7eb;
            color: #1f2937;
        }
        
        /* Collapsible navigation sections */
        .nav-section-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .nav-section-content.collapsed {
            max-height: 0;
        }
        .nav-section-toggle[data-section] i {
            transition: transform 0.3s ease;
        }
        .nav-section-toggle[data-section].collapsed i {
            transform: rotate(-90deg);
        }
        
        /* Collection image hover zoom effect */
        .collection-image-zoom {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            z-index: 10;
            display: inline-block;
        }
        .collection-image-zoom:hover {
            transform: scale(2.5);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 50;
            background-color: #1f2937;
            border-radius: 4px;
        }
        /* Ensure table cells can show overflow for zoom effect */
        #collection-table-body td {
            overflow: visible;
        }
        html.light .bg-gray-800 { /* Main content cards */
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light .bg-gray-700 { /* Inputs, table headers, etc. */
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        html.light input, html.light select, html.light textarea {
            background-color: #f9fafb;
            border-color: #d1d5db;
            color: #1f2937;
        }
        html.light .text-gray-300 { /* General text */
            color: #374151;
        }
        html.light .text-gray-400 { /* Secondary text */
            color: #6b7280;
        }
        html.light .text-gray-500 { /* Placeholder text */
            color: #9ca3af;
        }
        html.light .data-table tbody tr:hover {
            background-color: #f3f4f6;
        }
        html.light #map-container {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light .google-visualization-tooltip {
            background-color: #ffffff !important;
            border-color: #e5e7eb !important;
            color: #1f2937 !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
        }
        html.light .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        html.light .chartjs-tooltip {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            color: #1f2937 !important;
        }
        html.light #home-signup-btn, html.light #home-learn-more-btn {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        html.light #main-content-area header {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light #main-content-area header h1, html.light #main-content-area header button {
            color: #1f2937;
        }
        html.light .unauthenticated-overlay {
            background-color: rgba(243, 244, 246, 0.9);
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <!-- Overlay for mobile sidebar when open -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Main App Content -->
    <div id="app-content" class="flex flex-col md:flex-row min-h-screen bg-gray-900 text-gray-300">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-gray-800 border-r border-gray-700 flex flex-col
                                  transform -translate-x-full md:translate-x-0 md:flex-shrink-0 transition-transform duration-300 ease-in-out">
            <div class="h-16 flex items-center justify-between px-4 border-b border-gray-700 flex-shrink-0">
                <div class="flex items-center">
                    <i class="ph-bold ph-coins text-3xl text-emerald-400"></i>
                    <h1 class="text-xl font-bold ml-2">CoinShelf by Oscar</h1>
                </div>
                <div id="online-status-indicator" class="text-emerald-400" title="Online">
                    <i class="ph-bold ph-wifi"></i>
                </div>
            </div>
            <!-- Wrapped navigation links in a separate div with overflow-y-auto and flex-grow -->
            <div class="flex-grow overflow-y-auto">
                <nav class="p-3 space-y-1">
                    <!-- Main Section -->
                    <div class="mb-3">
                        <button class="nav-section-toggle w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider hover:text-gray-300 transition-colors" data-section="main">
                            <span>Main</span>
                            <i class="ph-bold ph-caret-down transition-transform" data-icon="main"></i>
                        </button>
                        <div class="nav-section-content" data-section="main">
                            <a href="/" id="nav-home" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md bg-gray-700 text-white text-sm">
                                <i class="ph-bold ph-house-simple mr-2 text-base"></i> Home
                            </a>
                            <a href="/dashboard" id="nav-dashboard" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-chart-pie-slice mr-2 text-base"></i> Dashboard
                            </a>
                            <a href="/collection" id="nav-collection" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-list-dashes mr-2 text-base"></i> Collection
                            </a>
                            <a href="/wishlist" id="nav-wishlist" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-heart mr-2 text-base"></i> Wishlist
                            </a>
                            <a href="/map" id="nav-map" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-map-trifold mr-2 text-base"></i> World Map
                            </a>
                        </div>
                    </div>

                    <!-- Discovery Section -->
                    <div class="mb-3">
                        <button class="nav-section-toggle w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider hover:text-gray-300 transition-colors" data-section="discovery">
                            <span>Discovery</span>
                            <i class="ph-bold ph-caret-down transition-transform" data-icon="discovery"></i>
                        </button>
                        <div class="nav-section-content" data-section="discovery">
                            <a href="/members" id="nav-members" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-users mr-2 text-base"></i> Members
                            </a>
                            <a href="/catalogue" id="nav-catalogue" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-magnifying-glass mr-2 text-base"></i> Catalogue
                            </a>
                            <a href="/missing" id="nav-missing" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-flag mr-2 text-base"></i> Missing Countries
                            </a>
                        </div>
                    </div>

                    <!-- Account Section -->
                    <div class="mb-3">
                        <button class="nav-section-toggle w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider hover:text-gray-300 transition-colors" data-section="account">
                            <span>Account</span>
                            <i class="ph-bold ph-caret-down transition-transform" data-icon="account"></i>
                        </button>
                        <div class="nav-section-content" data-section="account">
                            <a href="/profile" id="nav-profile" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-user mr-2 text-base"></i> Profile
                            </a>
                            <a href="/settings" id="nav-settings" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-gear mr-2 text-base"></i> Settings
                            </a>
                            <a href="/about" id="nav-about" class="nav-link flex items-center px-3 py-1.5 mb-1 rounded-md hover:bg-gray-700 text-sm">
                                <i class="ph-bold ph-info mr-2 text-base"></i> About
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
            <!-- Buttons Section: flex-shrink-0 to keep it from shrinking -->
            <div class="p-3 border-t border-gray-700 flex flex-col space-y-2 flex-shrink-0">
                <button id="quick-add-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-2 px-3 rounded-md flex items-center justify-center transition-colors text-sm">
                    <i class="ph-bold ph-plus-circle mr-2"></i> Quick Add
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button id="import-data-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-2 rounded-md flex items-center justify-center transition-colors text-xs">
                        <i class="ph-bold ph-upload-simple mr-1"></i> Import
                    </button>
                    <button id="export-data-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-2 rounded-md flex items-center justify-center transition-colors text-xs">
                        <i class="ph-bold ph-download-simple mr-1"></i> Export
                    </button>
                </div>
                <button id="share-collection-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-md flex items-center justify-center transition-colors text-sm">
                    <i class="ph-bold ph-share-network mr-2"></i> Share
                </button>
            </div>

            <!-- Sign In Button at Bottom -->
            <div class="p-3 border-t border-gray-700 mt-auto flex-shrink-0">
                <button type="button" id="sidebar-signin-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm transition-colors flex items-center justify-center">
                    <i class="ph-bold ph-sign-in mr-2"></i> Sign In
                </button>
                <button type="button" id="sidebar-logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-md text-sm hidden transition-colors flex items-center justify-center mt-2">
                    <i class="ph-bold ph-sign-out mr-2"></i> Sign Out
                </button>
            </div>

        </aside>

        <!-- Main Content -->
        <main id="main-content-area" class="flex-1 flex flex-col md:ml-64">
            <!-- Top bar for mobile (hamburger menu and title) -->
            <header class="bg-gray-800 p-4 md:hidden flex items-center justify-between border-b border-gray-700 flex-shrink-0">
                <button id="mobile-menu-toggle" class="text-white text-2xl focus:outline-none">
                    <i class="ph-bold ph-list"></i>
                </button>
                <h1 class="text-xl font-bold text-white">CoinShelf</h1>
                <div class="w-8"></div> <!-- Placeholder for right alignment to balance toggle button -->
            </header>

            <!-- New Home Content View -->
            <div id="content-home" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative">
                <div class="max-w-7xl mx-auto h-full flex flex-col items-center justify-center text-center py-12 px-4">
                    <i class="ph-bold ph-coins text-8xl text-emerald-400 mb-8 animate-bounce-slow"></i>
                    <h2 class="text-5xl font-bold text-white mb-6 leading-tight">Welcome to CoinShelf</h2>
                    <p class="text-xl text-gray-300 mb-8 max-w-2xl">
                        Your personal digital vault for managing and exploring your precious coin and banknote collection.
                        Organize your treasures, track their value, and discover new countries to collect!
                    </p>
                    <p class="text-md text-gray-400 mb-2">
                        Crafted with passion by <span class="font-semibold text-emerald-300">Oscar Brimelow</span>.
                    </p>
                    <p class="text-md text-gray-400 mb-10 flex items-center">
                        <a href="https://www.instagram.com/oscarbrimelow/" target="_blank" class="text-pink-400 hover:text-pink-300 transition-colors flex items-center">
                            <i class="ph-bold ph-instagram-logo text-xl mr-2"></i> Follow on Instagram
                        </a>
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="home-signup-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md text-lg transition-colors shadow-lg">
                            Get Started - Sign Up
                        </button>
                        <button id="home-learn-more-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-md text-lg transition-colors shadow-lg">
                            Learn More
                        </button>
                    </div>
                </div>
            </div>

            <!-- Authentication Page -->
            <div id="content-auth" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
                <div class="max-w-md mx-auto h-full flex flex-col items-center justify-center py-12 px-4">
                    <div class="w-full bg-gray-800 rounded-lg shadow-xl border border-gray-700 p-8">
                        <!-- Logo and Title -->
                        <div class="text-center mb-8">
                            <i class="ph-bold ph-coins text-5xl text-emerald-400 mb-4"></i>
                            <h2 class="text-3xl font-bold text-white mb-2" id="auth-page-title">Sign In</h2>
                            <p class="text-gray-400">Access your CoinShelf collection</p>
                        </div>

                        <!-- Email/Password Form -->
                        <form id="auth-form" class="space-y-4">
                            <div>
                                <label for="auth-email" class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                                <input type="email" id="auth-email" placeholder="your@email.com" 
                                    class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-3 text-white focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div id="auth-password-container">
                                <label for="auth-password" class="block text-sm font-medium text-gray-400 mb-1">Password</label>
                                <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                    class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-3 text-white focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div id="auth-remember-container" class="flex items-center">
                                <input type="checkbox" id="auth-remember-me" class="mr-2">
                                <label for="auth-remember-me" class="text-gray-400 text-sm">Remember Me</label>
                            </div>
                            <button type="submit" id="auth-submit-btn" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors">
                                Sign In
                            </button>
                        </form>

                        <!-- Toggle between Sign In and Sign Up -->
                        <div class="mt-6 text-center">
                            <p class="text-gray-400 text-sm">
                                <span id="auth-toggle-text">Don't have an account?</span>
                                <button type="button" id="auth-toggle-btn" class="text-blue-400 hover:text-blue-300 ml-1 font-medium">
                                    Sign Up
                                </button>
                            </p>
                        </div>

                        <!-- Forgot Password Link -->
                        <div id="auth-forgot-password-container" class="mt-4 text-center">
                            <button type="button" id="auth-forgot-password-btn" class="text-blue-400 hover:text-blue-300 text-sm underline">
                                Forgot Password?
                            </button>
                        </div>

                        <!-- Back to Home -->
                        <div class="mt-6 text-center">
                            <button type="button" id="auth-back-to-home" class="text-gray-400 hover:text-gray-300 text-sm">
                                <i class="ph-bold ph-arrow-left mr-1"></i> Back to Home
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-dashboard" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
                <!-- Dashboard Content Here -->
                <div class="max-w-7xl mx-auto">
                    <!-- Dashboard content will be rendered inside this centered div -->
                </div>
                <!-- Dashboard Donation Box -->
                <div class="mt-8 pt-6 mb-12 border-t border-gray-700">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">üíù Support CoinShelf</h3>
                        <p class="text-sm text-gray-400 mb-4">If you find CoinShelf helpful, consider a small tip to keep it free and ad-free!</p>
                        <button id="show-donate-modal-dashboard" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-md transition-colors">
                            <i class="ph-bold ph-heart mr-2"></i>Say Thanks
                        </button>
                    </div>
                </div>
            </div>

            <div id="content-collection" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <!-- Collection Content Here -->
                <div class="max-w-7xl mx-auto">
                    <!-- Collection content will be rendered inside this centered div -->
                </div>
                <!-- Collection Donation Box -->
                <div class="mt-8 pt-6 mb-12 border-t border-gray-700">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">üíù Support CoinShelf</h3>
                        <p class="text-sm text-gray-400 mb-4">If you find CoinShelf helpful, consider a small tip to keep it free and ad-free!</p>
                        <button id="show-donate-modal-collection" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-md transition-colors">
                            <i class="ph-bold ph-heart mr-2"></i>Say Thanks
                        </button>
                    </div>
                </div>
            </div>

            <div id="content-map" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <!-- Map Content Here -->
                <div class="max-w-7xl mx-auto h-full flex flex-col lg:flex-row gap-6">
                    <div class="flex-1">
                        <div id="map-wrapper" class="relative h-[95%] w-full rounded-lg border border-gray-700 overflow-hidden">
                            <!-- Zoom Controls -->
                            <div class="absolute top-4 right-4 z-10 flex flex-col gap-2">
                                <button id="zoom-in-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md transition-colors border border-gray-600 shadow-lg" title="Zoom In">
                                    <i class="ph-bold ph-plus"></i>
                                </button>
                                <button id="zoom-out-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md transition-colors border border-gray-600 shadow-lg" title="Zoom Out">
                                    <i class="ph-bold ph-minus"></i>
                                </button>
                                <button id="zoom-reset-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md transition-colors border border-gray-600 shadow-lg" title="Reset Zoom">
                                    <i class="ph-bold ph-arrows-clockwise"></i>
                                </button>
                                <!-- Toggle 3D -->
                                <button id="toggle-map-mode-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md transition-colors border border-gray-600 shadow-lg" title="Toggle 2D/3D">
                                    <i class="ph-bold ph-globe" id="map-toggle-icon"></i>
                                </button>
                            </div>
                            <!-- Map Container -->
                            <div id="map-container" class="h-full w-full relative transform transition-transform duration-200 origin-center">
                                <!-- Google GeoChart will be rendered here -->
                                <div id="geochart-canvas" class="h-full w-full"></div>
                            </div>
                            <!-- 3D Globe Container -->
                            <div id="globe-container" class="h-full w-full relative hidden" style="min-height: 500px;"></div>
                        </div>
                        <div class="flex justify-end mt-4">
                          <button id="export-map-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                            <i class="ph-bold ph-download-simple mr-2"></i> Export Map as Image
                          </button>
                        </div>
                    </div>
                    <div id="unrecognized-places-panel" class="w-full lg:w-80 bg-gray-800 border border-yellow-600 rounded-lg p-4 mt-6 lg:mt-0 h-fit max-h-[500px] overflow-y-auto shadow-md">
                        <h3 class="text-lg font-bold text-yellow-400 mb-2 flex items-center"><i class="ph-bold ph-warning-circle mr-2"></i>Unrecognized Places</h3>
                        <div id="unrecognized-places-list" class="space-y-2 text-gray-200 text-sm">
                            <!-- Unrecognized places will be rendered here -->
                        </div>
                        <div id="unrecognized-places-status" class="text-gray-400 mt-2 text-xs"></div>
                    </div>
                </div>
            </div>

            <!-- Search Catalogue Content -->
            <div id="content-catalogue" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Search Numista Catalogue</h2>
                    <p class="text-gray-400 mb-6">Search for coins and banknotes from the Numista database and add them directly to your collection.</p>
                    
                    <!-- Search Form -->
                    <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <label for="catalogue-search-input" class="block text-sm font-medium text-gray-400 mb-2">Search Term</label>
                                <input type="text" id="catalogue-search-input" placeholder="e.g., 1 Rand, Silver Dollar, 1970" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div class="md:w-48">
                                <label for="catalogue-type-filter" class="block text-sm font-medium text-gray-400 mb-2">Type</label>
                                <select id="catalogue-type-filter" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                                    <option value="coin">Coin</option>
                                    <option value="banknote">Banknote</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="catalogue-search-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition-colors w-full md:w-auto">
                                    <i class="ph-bold ph-magnifying-glass mr-2"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="catalogue-loading" class="hidden text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div>
                        <p class="text-gray-400 mt-4">Searching Numista catalogue...</p>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="catalogue-error" class="hidden bg-red-900 border border-red-700 rounded-lg p-4 mb-6">
                        <p class="text-red-200" id="catalogue-error-message"></p>
                    </div>
                    
                    <!-- Results -->
                    <div id="catalogue-results" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white" id="catalogue-results-count"></h3>
                        </div>
                        <div id="catalogue-results-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Results will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- No Results Message -->
                    <div id="catalogue-no-results" class="hidden text-center py-12">
                        <i class="ph-bold ph-magnifying-glass text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-lg">No results found. Try a different search term.</p>
                    </div>
                </div>
            </div>

            <!-- Wishlist Content -->
            <div id="content-wishlist" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">My Wishlist</h2>
                    <p class="text-gray-400 mb-6">Items you want to add to your collection. Click "Move to Collection" when you acquire an item.</p>
                    
                    <!-- Loading State -->
                    <div id="wishlist-loading" class="hidden text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"></div>
                        <p class="text-gray-400 mt-4">Loading wishlist...</p>
                    </div>
                    
                    <!-- Error Message -->
                    <div id="wishlist-error" class="hidden bg-red-900 border border-red-700 rounded-lg p-4 mb-6">
                        <p class="text-red-200" id="wishlist-error-message"></p>
                    </div>
                    
                    <!-- Wishlist Items -->
                    <div id="wishlist-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Items will be inserted here -->
                    </div>
                    
                    <!-- Empty Wishlist Message -->
                    <div id="wishlist-empty" class="hidden text-center py-12">
                        <i class="ph-bold ph-heart text-6xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400 text-lg mb-4">Your wishlist is empty.</p>
                        <p class="text-gray-500 text-sm">Search the catalogue and add items to your wishlist!</p>
                    </div>
                </div>
            </div>

            <!-- Search Members Content -->
            <div id="content-members" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Search Members</h2>
                    
                    <!-- Search Bar -->
                    <div class="mb-6">
                        <div class="relative">
                            <input type="text" id="member-search-input" 
                                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 pl-12 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" 
                                   placeholder="Search for members by username or display name...">
                            <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl"></i>
                        </div>
                    </div>

                    <!-- Members List -->
                    <div id="members-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Members will be rendered here -->
                    </div>

                    <!-- Loading State -->
                    <div id="members-loading" class="hidden text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400 mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading members...</p>
                    </div>

                    <!-- No Members Found -->
                    <div id="members-empty" class="hidden text-center py-12">
                        <i class="ph-bold ph-users text-6xl text-gray-600 mb-4"></i>
                        <p class="text-xl text-gray-400 mb-2">No members found</p>
                        <p class="text-gray-500">Try adjusting your search or check back later</p>
                    </div>

                    <!-- Error State -->
                    <div id="members-error" class="hidden text-center py-12">
                        <i class="ph-bold ph-warning-circle text-6xl text-red-400 mb-4"></i>
                        <p class="text-xl text-red-400 mb-2">Error loading members</p>
                        <p class="text-gray-500" id="members-error-message"></p>
                    </div>
                </div>
            </div>

            <!-- Missing Countries Content -->
            <div id="content-missing" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Countries to Collect</h2>
                    <div id="missing-countries-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        <!-- Missing countries will be rendered here -->
                    </div>
                    <div id="missing-countries-status" class="text-gray-400 mt-6 text-center"></div>
                </div>
                <!-- Missing Countries Donation Box -->
                <div class="mt-8 pt-6 mb-12 border-t border-gray-700">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">üíù Support CoinShelf</h3>
                        <p class="text-sm text-gray-400 mb-4">If you find CoinShelf helpful, consider a small tip to keep it free and ad-free!</p>
                        <button id="show-donate-modal-missing" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-md transition-colors">
                            <i class="ph-bold ph-heart mr-2"></i>Say Thanks
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile Content -->
            <div id="content-profile" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
                <div class="max-w-4xl mx-auto">
                    <div id="profile-unauthenticated-overlay" class="unauthenticated-overlay hidden">
                        <p class="text-xl text-red-400">Please sign in to view your profile.</p>
                    </div>

                    <div id="profile-content" class="hidden">
                        <!-- Profile Header (Instagram-style) -->
                        <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
                            <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
                                <!-- Profile Picture Placeholder (can be enhanced later) -->
                                <div class="flex-shrink-0" id="profile-picture-container">
                                    <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-gradient-to-br from-emerald-500 to-blue-500 flex items-center justify-center text-white text-4xl md:text-5xl font-bold">
                                        <span id="profile-initial">U</span>
                                    </div>
                                </div>
                                
                                <!-- Profile Info -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex flex-col md:flex-row md:items-center gap-4 mb-4">
                                        <h1 id="profile-username-header" class="text-2xl md:text-3xl font-bold text-white"></h1>
                                        <div class="flex gap-2">
                                            <button id="edit-profile-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-md transition-colors text-sm">
                                                Edit Profile
                                            </button>
                                            <button id="profile-settings-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-md transition-colors text-sm flex items-center">
                                                <i class="ph-bold ph-gear mr-2"></i> Settings
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Follower/Following/Posts Stats (Instagram-style) -->
                                    <div class="flex gap-6 mb-4">
                                        <button id="profile-collection-count" class="cursor-pointer hover:opacity-80 transition-opacity">
                                            <span class="font-semibold text-white" id="profile-collection-number">0</span>
                                            <span class="text-gray-400 ml-1">items</span>
                                        </button>
                                        <button id="profile-followers-link" class="cursor-pointer hover:opacity-80 transition-opacity">
                                            <span class="font-semibold text-white" id="profile-followers-count">0</span>
                                            <span class="text-gray-400 ml-1">followers</span>
                                        </button>
                                        <button id="profile-following-link" class="cursor-pointer hover:opacity-80 transition-opacity">
                                            <span class="font-semibold text-white" id="profile-following-count">0</span>
                                            <span class="text-gray-400 ml-1">following</span>
                                        </button>
                                    </div>
                                    
                                    <!-- Display Name and Bio -->
                                    <div>
                                        <h2 id="profile-display-name-header" class="text-lg font-semibold text-white mb-2"></h2>
                                        <p id="profile-bio-text" class="text-gray-300 whitespace-pre-wrap"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Stats Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div class="text-sm text-gray-400 mb-1">Collection Items</div>
                                <div class="text-2xl font-bold text-white" id="profile-stats-collection">0</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div class="text-sm text-gray-400 mb-1">Total Value</div>
                                <div class="text-2xl font-bold text-emerald-400" id="profile-stats-value">$0</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div class="text-sm text-gray-400 mb-1">Countries</div>
                                <div class="text-2xl font-bold text-white" id="profile-stats-countries">0</div>
                            </div>
                            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                <div class="text-sm text-gray-400 mb-1">Wishlist</div>
                                <div class="text-2xl font-bold text-pink-400" id="profile-stats-wishlist">0</div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="profile-loading" class="text-center py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400 mx-auto mb-4"></div>
                            <p class="text-gray-400">Loading profile...</p>
                        </div>

                        <!-- Error State -->
                        <div id="profile-error" class="hidden text-center py-12">
                            <i class="ph-bold ph-warning-circle text-6xl text-red-400 mb-4"></i>
                            <p class="text-xl text-red-400 mb-2">Error loading profile</p>
                            <p class="text-gray-500" id="profile-error-message"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Settings Content -->
            <div id="content-settings" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
                <div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Account Settings</h2>

                    <div id="settings-unauthenticated-overlay" class="unauthenticated-overlay ${isAuthenticated() ? 'hidden' : ''}">
                         <p class="text-xl text-red-400">Please sign in to manage your account settings.</p>
                    </div>

                    <div id="settings-content" class="${isAuthenticated() ? '' : 'hidden'}">
                        <!-- Profile Section -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Profile</h3>
                            <form id="profile-form" class="space-y-4">
                                <!-- Profile Picture Upload -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Profile Picture</label>
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-shrink-0">
                                            <img id="profile-picture-preview" src="" alt="Profile" class="w-20 h-20 rounded-full object-cover border-2 border-gray-600 bg-gray-700 hidden">
                                            <div id="profile-picture-placeholder" class="w-20 h-20 rounded-full bg-gradient-to-br from-emerald-500 to-blue-500 flex items-center justify-center text-white text-2xl font-bold">
                                                <span id="profile-picture-initial">U</span>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <input type="file" id="profile-picture-input" accept="image/*" class="hidden">
                                            <button type="button" id="profile-picture-upload-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition-colors text-sm">
                                                <i class="ph-bold ph-upload-simple mr-2"></i> Upload Photo
                                            </button>
                                            <button type="button" id="profile-picture-remove-btn" class="ml-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition-colors text-sm hidden">
                                                <i class="ph-bold ph-trash mr-2"></i> Remove
                                            </button>
                                            <p class="text-xs text-gray-500 mt-2">JPG, PNG or GIF. Max size 5MB.</p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="profile-username" class="block text-sm font-medium text-gray-400">Username</label>
                                    <input type="text" id="profile-username" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" readonly>
                                    <p class="text-xs text-gray-500 mt-1">Your unique username (cannot be changed)</p>
                                </div>
                                <div>
                                    <label for="profile-display-name" class="block text-sm font-medium text-gray-400">Display Name</label>
                                    <input type="text" id="profile-display-name" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" placeholder="Your display name (optional)">
                                </div>
                                <div>
                                    <label for="profile-bio" class="block text-sm font-medium text-gray-400">Bio</label>
                                    <textarea id="profile-bio" rows="4" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" placeholder="Tell others about your collection..."></textarea>
                                </div>
                                <div class="space-y-2">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="profile-public" class="form-checkbox h-4 w-4 text-emerald-600">
                                        <span class="ml-2 text-gray-300">Make my profile public</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="collection-public" class="form-checkbox h-4 w-4 text-emerald-600">
                                        <span class="ml-2 text-gray-300">Make my collection public</span>
                                    </label>
                                </div>
                                <button type="submit" id="update-profile-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Update Profile</button>
                            </form>
                        </div>

                        <!-- Password Change Form -->
                        <div class="mb-8 pt-8 border-t border-gray-700">
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Change Password</h3>
                            <form id="change-password-form" class="space-y-4">
                                <div>
                                    <label for="current-password" class="block text-sm font-medium text-gray-400">Current Password</label>
                                    <input type="password" id="current-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-gray-400">New Password</label>
                                    <input type="password" id="new-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="confirm-new-password" class="block text-sm font-medium text-gray-400">Confirm New Password</label>
                                    <input type="password" id="confirm-new-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <button type="submit" id="change-password-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Update Password</button>
                            </form>
                        </div>

                        <!-- Theme Preference -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Theme Preference</h3>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="theme-preference" value="dark" class="form-radio h-4 w-4 text-emerald-600" checked>
                                    <span class="ml-2 text-gray-300">Dark Mode</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="theme-preference" value="light" class="form-radio h-4 w-4 text-emerald-600">
                                    <span class="ml-2 text-gray-300">Light Mode</span>
                                </label>
                            </div>
                        </div>

                        <!-- Currency Preference -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Currency Preference</h3>
                            <p class="text-gray-400 mb-4">Choose your preferred currency for displaying values throughout the app.</p>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="currency-preference" value="USD" class="form-radio h-4 w-4 text-emerald-600" ${currencySetting === 'USD' ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-300">USD (US Dollar)</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="currency-preference" value="ZAR" class="form-radio h-4 w-4 text-emerald-600" ${currencySetting === 'ZAR' ? 'checked' : ''}>
                                    <span class="ml-2 text-gray-300">ZAR (South African Rand)</span>
                                </label>
                            </div>
                            <button id="update-currency-btn" class="mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                Update Currency Setting
                            </button>
                        </div>

                        <!-- New Public Collection Link Section -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Public Collection Link</h3>
                            <p class="text-gray-400 mb-4">Share a read-only view of your collection with others. Generate a unique URL below.</p>
                            <div class="flex flex-col sm:flex-row gap-3 items-stretch">
                                <input type="text" id="public-collection-url" class="flex-grow bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-purple-500 focus:border-purple-500 text-gray-300" readonly placeholder="Your public collection URL will appear here">
                                <button id="copy-public-url-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors flex-shrink-0">
                                    <i class="ph-bold ph-copy mr-2"></i> Copy
                                </button>
                            </div>
                            <p id="public-url-status" class="text-xs mt-2 text-gray-500"></p>
                            <button id="generate-public-url-btn" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                Generate/Update Public Link
                            </button>
                            <button id="revoke-public-url-btn" class="mt-4 ml-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                Revoke Public Link
                            </button>
                        </div>

                        <!-- Duplicate Detection Section -->
                        <div class="mt-8 pt-8 border-t border-gray-700">
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Duplicate Detection</h3>
                            <p class="text-gray-400 mb-4">Find and merge duplicate coins that share the same country, year, and denomination.</p>
                            
                            <button id="find-duplicates-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors mb-4">
                                <i class="ph-bold ph-magnifying-glass mr-2"></i>Find Duplicates
                            </button>
                            
                            <div id="duplicates-container" class="hidden">
                                <div id="duplicates-list" class="space-y-4 mb-4">
                                    <!-- Duplicate groups will be rendered here -->
                                </div>
                                <div id="no-duplicates-message" class="hidden text-gray-400 text-center py-4">
                                    No duplicates found! Your collection is clean.
                                </div>
                            </div>
                        </div>

                        <!-- Data Management Section -->
                        <div class="mt-8 pt-8 border-t border-gray-700">
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Data Management</h3>
                            <p class="text-gray-400 mb-4">Manage your collection data. These actions cannot be undone.</p>
                            
                            <div class="bg-red-900/20 border border-red-700 rounded-lg p-4 mb-4">
                                <h4 class="text-lg font-semibold text-red-400 mb-2 flex items-center">
                                    <i class="ph-bold ph-warning-circle mr-2"></i>
                                    Dangerous Actions
                                </h4>
                                <p class="text-red-300 text-sm mb-4">
                                    The following actions will permanently delete your data and cannot be undone.
                                </p>
                                
                                <button id="clear-all-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center transition-colors">
                                    <i class="ph-bold ph-trash-simple mr-2"></i> Clear All Collection Items
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Settings Donation Box -->
                <div class="mt-8 pt-6 mb-12 border-t border-gray-700">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">üíù Support CoinShelf</h3>
                        <p class="text-sm text-gray-400 mb-4">If you find CoinShelf helpful, consider a small tip to keep it free and ad-free!</p>
                        <button id="show-donate-modal-settings" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-md transition-colors">
                            <i class="ph-bold ph-heart mr-2"></i>Say Thanks
                        </button>
                    </div>
                </div>
            </div>

            <!-- New Public Collection View -->
            <div id="content-public-collection" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <h2 id="public-collection-title" class="text-3xl font-bold text-white mb-6"></h2>
                    <div id="public-collection-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-300">Total Items</h3>
                            <p class="text-4xl font-bold text-emerald-400" id="public-total-items">0</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-300">Total Value</h3>
                            <p class="text-4xl font-bold text-emerald-400" id="public-total-value">$0.00</p>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-300">Unique Countries</h3>
                            <p class="text-4xl font-bold text-emerald-400" id="public-unique-countries">0</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-4">Collection Details</h3>
                    <div class="flex-1 flex overflow-hidden">
                        <div class="w-full flex flex-col">
                            <div class="flex-1 overflow-y-auto overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
                                <table class="w-full text-left data-table min-w-max">
                                    <thead class="bg-gray-700 sticky top-0">
                                        <tr>
                                            <th class="p-4 font-semibold cursor-pointer" data-sort-column="id">ID</th>
                                            <th class="p-4 font-semibold">Type</th>
                                            <th class="p-4 font-semibold cursor-pointer" data-sort-column="country">Country</th>
                                            <th class="p-4 font-semibold cursor-pointer" data-sort-column="year">Year</th>
                                            <th class="p-4 font-semibold">Denomination</th>
                                            <th class="p-4 font-semibold cursor-pointer" data-sort-column="quantity">Qty</th>
                                            <th class="p-4 font-semibold cursor-pointer" data-sort-column="value">Value</th>
                                            <th class="p-4 font-semibold">Notes & Ref.</th>
                                            <th class="p-4 font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="public-collection-table-body">
                                        <!-- Public collection items will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                     <div id="public-collection-status" class="text-gray-400 mt-6 text-center text-lg"></div>
                </div>
            </div>

            <!-- About CoinShelf Content -->
            <div id="content-about" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-4xl mx-auto">
                    <!-- Hero Section -->
                    <div class="text-center mb-12">
                        <i class="ph-bold ph-coins text-6xl text-emerald-400 mb-6"></i>
                        <h1 class="text-4xl font-bold text-white mb-4">About CoinShelf</h1>
                        <p class="text-xl text-gray-300">The Ultimate Coin & Bullion Collection Management Platform</p>
                    </div>

                    <!-- What is CoinShelf -->
                    <div class="bg-gray-800 p-8 rounded-lg shadow-md border border-gray-700 mb-8">
                        <h2 class="text-2xl font-bold text-white mb-4">What is CoinShelf?</h2>
                        <p class="text-gray-300 mb-4">
                            CoinShelf is a comprehensive digital platform designed specifically for coin collectors, numismatists, and precious metal investors. 
                            Whether you're a seasoned collector with thousands of pieces or just starting your journey into the fascinating world of numismatics, 
                            CoinShelf provides the tools you need to organize, track, and value your collection.
                        </p>
                        <p class="text-gray-300">
                            Built with modern web technologies and a focus on user experience, CoinShelf offers real-time precious metal pricing, 
                            advanced collection analytics, and intuitive organization features that make managing your treasures both efficient and enjoyable.
                        </p>
                    </div>

                    <!-- Key Features -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="ph-bold ph-chart-line text-emerald-400 mr-3"></i>
                                Live Precious Metal Prices
                            </h3>
                            <p class="text-gray-300">
                                Get real-time gold and silver prices from multiple reliable sources. Track your bullion portfolio value with live market data, 
                                supporting both USD and South African Rand (ZAR) currencies.
                            </p>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="ph-bold ph-globe text-emerald-400 mr-3"></i>
                                World Map Visualization
                            </h3>
                            <p class="text-gray-300">
                                Explore your collection geographically with our interactive world map. See which countries you've collected from and 
                                discover new territories to expand your collection.
                            </p>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="ph-bold ph-chart-pie-slice text-emerald-400 mr-3"></i>
                                Advanced Analytics
                            </h3>
                            <p class="text-gray-300">
                                Comprehensive dashboard with charts and statistics showing your collection's value distribution, 
                                regional breakdown, and historical trends.
                            </p>
                        </div>

                        <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <i class="ph-bold ph-share-network text-emerald-400 mr-3"></i>
                                Collection Sharing
                            </h3>
                            <p class="text-gray-300">
                                Share your collection with friends, family, or fellow collectors through secure public links. 
                                Perfect for showcasing your treasures and tracking your collection growth.
                            </p>
                        </div>
                    </div>

                    <!-- Supported Items -->
                    <div class="bg-gray-800 p-8 rounded-lg shadow-md border border-gray-700 mb-8">
                        <h2 class="text-2xl font-bold text-white mb-6">What Can You Track?</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <i class="ph-bold ph-coins text-4xl text-emerald-400 mb-3"></i>
                                <h3 class="text-lg font-semibold text-white mb-2">Coins</h3>
                                <p class="text-gray-300 text-sm">
                                    Ancient, modern, commemorative, and rare coins from around the world
                                </p>
                            </div>
                            <div class="text-center">
                                <i class="ph-bold ph-bank text-4xl text-emerald-400 mb-3"></i>
                                <h3 class="text-lg font-semibold text-white mb-2">Banknotes</h3>
                                <p class="text-gray-300 text-sm">
                                    Paper currency, historical notes, and special edition banknotes
                                </p>
                            </div>
                            <div class="text-center">
                                <i class="ph-bold ph-cube text-4xl text-emerald-400 mb-3"></i>
                                <h3 class="text-lg font-semibold text-white mb-2">Bullion</h3>
                                <p class="text-gray-300 text-sm">
                                    Gold and silver bars, rounds, and other precious metal investments
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- About the Creator -->
                    <div class="bg-gray-800 p-8 rounded-lg shadow-md border border-gray-700 mb-8">
                        <h2 class="text-2xl font-bold text-white mb-6">About the Creator</h2>
                        <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                            <div class="text-center md:text-left">
                                <h3 class="text-xl font-semibold text-emerald-300 mb-2">Oscar Brimelow</h3>
                                <p class="text-gray-300 mb-4">
                                    A passionate developer and collector who understands the unique needs of the numismatic community. 
                                    CoinShelf was born from a desire to create a modern, user-friendly platform that combines 
                                    traditional collection management with cutting-edge technology.
                                </p>
                                <div class="flex justify-center md:justify-start space-x-4">
                                    <a href="https://www.instagram.com/oscarbrimelow/" target="_blank" 
                                       class="text-pink-400 hover:text-pink-300 transition-colors flex items-center">
                                        <i class="ph-bold ph-instagram-logo text-xl mr-2"></i>
                                        Instagram
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Details -->
                    <div class="bg-gray-800 p-8 rounded-lg shadow-md border border-gray-700 mb-8">
                        <h2 class="text-2xl font-bold text-white mb-6">Technical Excellence</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-3">Built with Modern Technologies</h3>
                                <ul class="text-gray-300 space-y-2">
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                        Flask backend with SQLAlchemy database
                                    </li>
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                        Responsive HTML5/CSS3 frontend
                                    </li>
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                        Real-time price APIs integration
                                    </li>
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                        Secure JWT authentication
                                    </li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-3">Security & Privacy</h3>
                                <ul class="text-gray-300 space-y-2">
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-shield-check text-emerald-400 mr-2"></i>
                                        Encrypted password storage
                                    </li>
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-shield-check text-emerald-400 mr-2"></i>
                                        Secure HTTPS connections
                                    </li>
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-shield-check text-emerald-400 mr-2"></i>
                                        Private collection data
                                    </li>
                                    <li class="flex items-center">
                                        <i class="ph-bold ph-shield-check text-emerald-400 mr-2"></i>
                                        Optional public sharing
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Add to Homescreen -->
                    <div class="bg-gray-800 p-8 rounded-lg shadow-md border border-gray-700 mb-8">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                            <i class="ph-bold ph-device-mobile text-emerald-400 mr-3"></i>
                            Add CoinShelf to Your Homescreen
                        </h2>
                        <p class="text-gray-300 mb-6">
                            Enjoy CoinShelf like a native app by adding it to your device's homescreen. This gives you quick access and a full-screen experience without the browser interface.
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- iPhone Instructions -->
                            <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
                                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                    <i class="ph-bold ph-apple-logo text-gray-300 mr-2"></i>
                                    iPhone & iPad
                                </h3>
                                <ol class="text-gray-300 space-y-3 text-sm">
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">1</span>
                                        <span>Open CoinShelf in Safari browser</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">2</span>
                                        <span>Tap the <i class="ph-bold ph-share text-emerald-400"></i> Share button at the bottom</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">3</span>
                                        <span>Scroll down and tap "Add to Home Screen"</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">4</span>
                                        <span>Tap "Add" to confirm</span>
                                    </li>
                                </ol>
                            </div>

                            <!-- Android Instructions -->
                            <div class="bg-gray-900 p-6 rounded-lg border border-gray-700">
                                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                    <i class="ph-bold ph-android-logo text-green-400 mr-2"></i>
                                    Android
                                </h3>
                                <ol class="text-gray-300 space-y-3 text-sm">
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">1</span>
                                        <span>Open CoinShelf in Chrome browser</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">2</span>
                                        <span>Tap the <i class="ph-bold ph-dots-three-vertical text-emerald-400"></i> menu button (top right)</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">3</span>
                                        <span>Select "Add to Home screen" or "Install app"</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="bg-emerald-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">4</span>
                                        <span>Tap "Add" or "Install" to confirm</span>
                                    </li>
                                </ol>
                            </div>
                        </div>

                        <div class="mt-6 p-4 bg-emerald-900/20 border border-emerald-700 rounded-lg">
                            <h4 class="text-lg font-semibold text-emerald-300 mb-2">Benefits of Adding to Homescreen:</h4>
                            <ul class="text-gray-300 text-sm space-y-1">
                                <li class="flex items-center">
                                    <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                    Quick access with a single tap
                                </li>
                                <li class="flex items-center">
                                    <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                    Full-screen experience without browser UI
                                </li>
                                <li class="flex items-center">
                                    <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                    Works offline for viewing your collection
                                </li>
                                <li class="flex items-center">
                                    <i class="ph-bold ph-check-circle text-emerald-400 mr-2"></i>
                                    Looks and feels like a native app
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Call to Action -->
                    <div class="text-center bg-gradient-to-r from-emerald-600 to-blue-600 p-8 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold text-white mb-4">Ready to Start Your Collection Journey?</h2>
                        <p class="text-gray-100 mb-6">
                            Join thousands of collectors who trust CoinShelf to manage their precious collections.
                        </p>
                        <button id="about-signup-btn" class="bg-white text-emerald-600 hover:bg-gray-100 font-bold py-3 px-8 rounded-md text-lg transition-colors shadow-lg">
                            Get Started Today
                        </button>
                    </div>
                </div>
                <!-- About Donation Box -->
                <div class="mt-8 pt-6 mb-12 border-t border-gray-700">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">üíù Support CoinShelf</h3>
                        <p class="text-sm text-gray-400 mb-4">If you find CoinShelf helpful, consider a small tip to keep it free and ad-free!</p>
                        <button id="show-donate-modal-about" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-md transition-colors">
                            <i class="ph-bold ph-heart mr-2"></i>Say Thanks
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Profile Page -->
            <div id="content-user-profile" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <div id="user-profile-page-content">
                        <!-- User profile content will be rendered here -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-2xl border border-gray-700 transform transition-all scale-95 opacity-0">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Item</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Group 1: Type, Country, Year, Value -->
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-400">Type <span class="text-red-400">*</span></label>
                        <select id="type" required aria-label="Type" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option>Coin</option>
                            <option>Banknote</option>
                            <option>Gold Bullion</option>
                            <option>Silver Bullion</option>
                        </select>
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-400">Country <span class="text-red-400">*</span></label>
                        <input type="text" id="country" required aria-label="Country" placeholder="e.g., South Africa" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-400">Year</label>
                        <input type="number" id="year" aria-label="Year" placeholder="e.g., 2023" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="value" class="block text-sm font-medium text-gray-400">Estimated Value (USD)</label>
                        <input type="number" step="0.01" id="value" aria-label="Estimated Value" placeholder="e.g., 100.00" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <span class="text-xs text-gray-500">Leave blank if unknown</span>
                    </div>
                    <!-- Group 2: Denomination, Quantity -->
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="denomination" class="block text-sm font-medium text-gray-400">Denomination <span class="text-red-400">*</span></label>
                            <div class="mt-1 relative">
                                <input type="text" id="denomination" required aria-label="Denomination" placeholder="e.g., 1 Rand, $1" class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 pr-20">
                                <button type="button" id="search-numista-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 rounded text-xs transition-colors" title="Search Numista database">
                                    <i class="ph-bold ph-magnifying-glass"></i>
                                </button>
                            </div>
                            <div id="numista-results" class="hidden mt-2 bg-gray-700 border border-gray-600 rounded-md max-h-60 overflow-y-auto z-50 relative w-full shadow-lg"></div>
                        </div>
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-400">Quantity <span class="text-red-400">*</span></label>
                            <input type="number" id="quantity" min="1" value="1" required aria-label="Quantity" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                    </div>
                    <!-- Group 3: Notes (full width) -->
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-400">Notes</label>
                        <textarea id="notes" rows="3" aria-label="Notes" placeholder="Any extra details, history, or condition..." class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                    </div>
                    <!-- Group 4: Reference URL, Image (full width) -->
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="referenceUrl" class="block text-sm font-medium text-gray-400">Reference URL</label>
                            <input type="text" id="referenceUrl" aria-label="Reference URL" placeholder="e.g., eBay, Numista, etc." class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-2">Image</label>
                            <!-- Toggle between URL and Upload -->
                            <div class="flex gap-2 mb-2">
                                <button type="button" id="image-url-toggle" class="flex-1 px-3 py-1.5 text-sm rounded-md bg-emerald-600 text-white" onclick="toggleImageInput('url')">Image URL</button>
                                <button type="button" id="image-upload-toggle" class="flex-1 px-3 py-1.5 text-sm rounded-md bg-gray-700 text-gray-300 hover:bg-gray-600" onclick="toggleImageInput('upload')">Upload Image</button>
                            </div>
                            <!-- URL Input -->
                            <div id="image-url-input" class="image-input-section">
                                <input type="text" id="localImagePath" aria-label="Image URL" placeholder="https://example.com/image.jpg" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <span class="text-xs text-gray-500">Enter image URL or paste from Numista</span>
                            </div>
                            <!-- File Upload Input -->
                            <div id="image-upload-input" class="image-input-section hidden">
                                <input type="file" id="imageFileInput" accept="image/*" class="hidden">
                                <div class="flex items-center gap-2">
                                    <button type="button" onclick="document.getElementById('imageFileInput').click()" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-md text-sm transition-colors">
                                        <i class="ph-bold ph-upload mr-2"></i>Choose File
                                    </button>
                                    <button type="button" id="clear-image-btn" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm hidden transition-colors">
                                        <i class="ph-bold ph-x"></i>
                                    </button>
                                </div>
                                <p id="image-file-name" class="text-xs text-gray-500 mt-1"></p>
                                <span class="text-xs text-gray-500">Max 5MB. Formats: JPG, PNG, GIF, WebP</span>
                            </div>
                            <!-- Image Preview -->
                            <div id="image-preview-container" class="mt-2 hidden">
                                <img id="image-preview" src="" alt="Preview" class="max-w-full h-32 object-contain rounded-md bg-gray-700 p-2 border border-gray-600">
                            </div>
                        </div>
                    </div>
                    <!-- Bullion Fields (hidden by default, shown for Gold/Silver Bullion) -->
                    <div id="bullion-fields" class="md:col-span-2" style="display:none;">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="weight_grams" class="block text-sm font-medium text-gray-400">Weight (grams)</label>
                                <input type="number" id="weight_grams" step="0.01" aria-label="Weight in grams" placeholder="e.g., 31.1035" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div>
                                <label for="purity_percent" class="block text-sm font-medium text-gray-400">Purity (%)</label>
                                <input type="number" id="purity_percent" step="0.01" aria-label="Purity percent" placeholder="e.g., 99.9" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                        </div>
                        <span class="text-xs text-gray-500">Only required for bullion items.</span>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button type="button" id="cancel-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-8 rounded-md shadow-lg text-base transition-colors">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="import-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-gray-700 transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-6">Import Collection Data</h2>
            
            <!-- Import Method Tabs -->
            <div class="mb-6">
                <div class="border-b border-gray-600">
                    <nav class="-mb-px flex space-x-8">
                        <button id="tab-json" class="import-tab py-2 px-1 border-b-2 border-indigo-500 text-indigo-400 font-medium">
                            JSON Data
                        </button>
                        <button id="tab-csv" class="import-tab py-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-gray-300 font-medium">
                            CSV File
                        </button>
                        <button id="tab-excel" class="import-tab py-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-gray-300 font-medium">
                            Excel File
                        </button>
                        <button id="tab-template" class="import-tab py-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-gray-300 font-medium">
                            Templates
                        </button>
                        <button id="tab-popular-sites" class="import-tab py-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-gray-300 font-medium">
                            Popular Sites
                        </button>
                    </nav>
                </div>
            </div>

            <!-- JSON Import Tab -->
            <div id="json-tab" class="import-content">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">JSON Import</h3>
                    <p class="text-gray-400 mb-4">Paste your coin collection data as a JSON array. Each item should have the required fields.</p>
                    <div class="bg-gray-900 p-4 rounded-md mb-4">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">Required Fields:</h4>
                        <ul class="text-xs text-gray-400 space-y-1">
                            <li><code>type</code> - "Coin", "Banknote", "Gold Bullion", or "Silver Bullion"</li>
                            <li><code>country</code> - Country name</li>
                            <li><code>denomination</code> - Value/description (e.g., "1 Dollar", "1 oz Gold")</li>
                        </ul>
                        <h4 class="text-sm font-semibold text-gray-300 mt-3 mb-2">Optional Fields:</h4>
                        <ul class="text-xs text-gray-400 space-y-1">
                            <li><code>year</code> - Year minted/issued</li>
                            <li><code>value</code> - Estimated value in USD</li>
                            <li><code>quantity</code> - Number of items (default: 1)</li>
                            <li><code>notes</code> - Additional notes</li>
                            <li><code>referenceUrl</code> - Reference link</li>
                            <li><code>weight_grams</code> - Weight for bullion</li>
                            <li><code>purity_percent</code> - Purity for bullion</li>
                        </ul>
                    </div>
                    <button id="load-example-json" class="text-indigo-400 hover:text-indigo-300 text-sm mb-2">üìã Load Example JSON</button>
                </div>
                <textarea id="import-json-data" rows="8" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-3 font-mono text-sm" placeholder='[{"type": "Coin", "country": "United States", "denomination": "1 Dollar", "year": 2020, "value": 1.00, "notes": "Sacagawea dollar"}]'></textarea>
            </div>

            <!-- CSV Import Tab -->
            <div id="csv-tab" class="import-content hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">CSV File Import</h3>
                    <p class="text-gray-400 mb-4">Upload a CSV file with your collection data. The first row should contain column headers.</p>
                    <div class="bg-gray-900 p-4 rounded-md mb-4">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">Required CSV Columns:</h4>
                        <ul class="text-xs text-gray-400 space-y-1">
                            <li><code>type</code> - Item type (Coin, Banknote, Gold Bullion, Silver Bullion)</li>
                            <li><code>country</code> - Country name</li>
                            <li><code>denomination</code> - Value/description</li>
                        </ul>
                        <h4 class="text-sm font-semibold text-gray-300 mt-3 mb-2">Optional Columns:</h4>
                        <ul class="text-xs text-gray-400 space-y-1">
                            <li><code>year</code>, <code>value</code>, <code>quantity</code>, <code>notes</code>, <code>referenceUrl</code></li>
                            <li><code>weight_grams</code>, <code>purity_percent</code> (for bullion)</li>
                        </ul>
                    </div>
                    <button id="download-csv-template" class="text-indigo-400 hover:text-indigo-300 text-sm mb-4">üì• Download CSV Template</button>
                </div>
                <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center">
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                    <label for="csv-file-input" class="cursor-pointer">
                        <i class="ph-bold ph-upload-simple text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-400">Click to select CSV file or drag and drop</p>
                        <p class="text-gray-500 text-sm mt-1">Supports .csv files</p>
                    </label>
                </div>
                <div id="csv-preview" class="mt-4 hidden">
                    <h4 class="text-sm font-semibold text-gray-300 mb-2">Preview:</h4>
                    <div class="bg-gray-900 p-4 rounded-md max-h-40 overflow-y-auto">
                        <pre id="csv-preview-content" class="text-xs text-gray-400"></pre>
                    </div>
                </div>
            </div>

            <!-- Excel Import Tab -->
            <div id="excel-tab" class="import-content hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">Excel File Import</h3>
                    <p class="text-gray-400 mb-4">Upload an Excel file (.xlsx or .xls) with your collection data. The first row should contain column headers.</p>
                    <div class="bg-gray-900 p-4 rounded-md mb-4">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">Required Excel Columns:</h4>
                        <ul class="text-xs text-gray-400 space-y-1">
                            <li><code>type</code> - Item type (Coin, Banknote, Gold Bullion, Silver Bullion)</li>
                            <li><code>country</code> - Country name</li>
                            <li><code>denomination</code> - Value/description</li>
                        </ul>
                    </div>
                    <button id="download-excel-template" class="text-indigo-400 hover:text-indigo-300 text-sm mb-4">üì• Download Excel Template</button>
                </div>
                <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center">
                    <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="hidden">
                    <label for="excel-file-input" class="cursor-pointer">
                        <i class="ph-bold ph-upload-simple text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-400">Click to select Excel file or drag and drop</p>
                        <p class="text-gray-500 text-sm mt-1">Supports .xlsx and .xls files</p>
                    </label>
                </div>
                <div id="excel-preview" class="mt-4 hidden">
                    <h4 class="text-sm font-semibold text-gray-300 mb-2">Preview:</h4>
                    <div class="bg-gray-900 p-4 rounded-md max-h-40 overflow-y-auto">
                        <pre id="excel-preview-content" class="text-xs text-gray-400"></pre>
                    </div>
                </div>
            </div>

            <!-- Templates Tab -->
            <div id="template-tab" class="import-content hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">Import Templates</h3>
                    <p class="text-gray-400 mb-4">Download templates to help you format your data correctly.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-900 p-4 rounded-md">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">CSV Template</h4>
                        <p class="text-xs text-gray-400 mb-3">Template with sample data and all required columns</p>
                        <button id="download-csv-template-2" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1 rounded">Download CSV</button>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-md">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">Excel Template</h4>
                        <p class="text-xs text-gray-400 mb-3">Template with sample data and all required columns</p>
                        <button id="download-excel-template-2" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1 rounded">Download Excel</button>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-md">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">JSON Example</h4>
                        <p class="text-xs text-gray-400 mb-3">Sample JSON data with various item types</p>
                        <button id="copy-json-example" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1 rounded">Copy Example</button>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-md">
                        <h4 class="text-sm font-semibold text-gray-300 mb-2">Import Guide</h4>
                        <p class="text-xs text-gray-400 mb-3">Step-by-step instructions for importing data</p>
                        <button id="show-import-guide" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-3 py-1 rounded">View Guide</button>
                    </div>
                </div>
            </div>

            <!-- Popular Sites Tab -->
            <div id="popular-sites-tab" class="import-content hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">Import from Popular Coin Collection Sites</h3>
                    <p class="text-gray-400 mb-4">Import your collection from popular coin collecting websites. Upload the exported CSV file from these sites.</p>
                </div>
                
                <!-- Numista Section -->
                <div class="bg-gray-900 p-4 rounded-md mb-4 border border-gray-700">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-300 mb-1">ü™ô Numista</h4>
                            <p class="text-xs text-gray-400">Import from Numista.com collection exports</p>
                        </div>
                        <a href="https://en.numista.com" target="_blank" class="text-indigo-400 hover:text-indigo-300 text-xs">Visit Numista ‚Üí</a>
                    </div>
                    <div class="bg-gray-800 p-3 rounded mt-2 mb-2">
                        <p class="text-xs text-gray-300 mb-2"><strong>How to export from Numista:</strong></p>
                        <ol class="text-xs text-gray-400 space-y-1 list-decimal list-inside">
                            <li>Log in to your Numista account</li>
                            <li>Go to "My Collection"</li>
                            <li>Click "Export" or "Export CSV"</li>
                            <li>Select the following fields to include: <code class="text-indigo-400">Country</code>, <code class="text-indigo-400">Denomination</code>, <code class="text-indigo-400">Year</code>, <code class="text-indigo-400">Reference number</code>, <code class="text-indigo-400">Composition</code>, <code class="text-indigo-400">Weight</code>, <code class="text-indigo-400">Diameter</code> (optional: <code class="text-indigo-400">Grade</code>, <code class="text-indigo-400">Purchase price</code>, <code class="text-indigo-400">Notes</code>)</li>
                            <li>Download the CSV file</li>
                            <li>Upload it using the CSV File tab above</li>
                        </ol>
                    </div>
                    <p class="text-xs text-gray-500 italic">CoinShelf will automatically detect Numista format and map the fields correctly.</p>
                </div>

                <!-- UCoin Section -->
                <div class="bg-gray-900 p-4 rounded-md mb-4 border border-gray-700">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-300 mb-1">üåç UCoin</h4>
                            <p class="text-xs text-gray-400">Import from UCoin.net collection exports</p>
                        </div>
                        <a href="https://ucoin.net" target="_blank" class="text-indigo-400 hover:text-indigo-300 text-xs">Visit UCoin ‚Üí</a>
                    </div>
                    <div class="bg-gray-800 p-3 rounded mt-2 mb-2">
                        <p class="text-xs text-gray-300 mb-2"><strong>How to export from UCoin:</strong></p>
                        <ol class="text-xs text-gray-400 space-y-1 list-decimal list-inside">
                            <li>Log in to your UCoin account</li>
                            <li>Navigate to your collection</li>
                            <li>Click "Export" or "Export to CSV"</li>
                            <li>Make sure these columns are included: <code class="text-indigo-400">Country</code>, <code class="text-indigo-400">Year</code>, <code class="text-indigo-400">Denomination</code>, <code class="text-indigo-400">Material</code>, <code class="text-indigo-400">Weight</code>, <code class="text-indigo-400">Diameter</code> (optional: <code class="text-indigo-400">Value</code>, <code class="text-indigo-400">Notes</code>, <code class="text-indigo-400">Catalog code</code>)</li>
                            <li>Download the CSV file</li>
                            <li>Upload it using the CSV File tab above</li>
                        </ol>
                    </div>
                    <p class="text-xs text-gray-500 italic">CoinShelf will automatically detect UCoin format and map the fields correctly.</p>
                </div>

                <!-- Colnect Section -->
                <div class="bg-gray-900 p-4 rounded-md mb-4 border border-gray-700">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-300 mb-1">üìö Colnect</h4>
                            <p class="text-xs text-gray-400">Import from Colnect.com collection exports</p>
                        </div>
                        <a href="https://colnect.com" target="_blank" class="text-indigo-400 hover:text-indigo-300 text-xs">Visit Colnect ‚Üí</a>
                    </div>
                    <div class="bg-gray-800 p-3 rounded mt-2 mb-2">
                        <p class="text-xs text-gray-300 mb-2"><strong>How to export from Colnect:</strong></p>
                        <ol class="text-xs text-gray-400 space-y-1 list-decimal list-inside">
                            <li>Log in to your Colnect account</li>
                            <li>Go to "My Collections" ‚Üí Select your coin collection</li>
                            <li>Click "Export" or "Export Collection"</li>
                            <li>Choose CSV format and ensure these fields are included: <code class="text-indigo-400">Country</code>, <code class="text-indigo-400">Catalog Code</code>, <code class="text-indigo-400">Year</code>, <code class="text-indigo-400">Denomination</code>, <code class="text-indigo-400">Series</code> (optional: <code class="text-indigo-400">Value</code>, <code class="text-indigo-400">Grade</code>, <code class="text-indigo-400">Comments</code>)</li>
                            <li>Download the CSV file</li>
                            <li>Upload it using the CSV File tab above</li>
                        </ol>
                    </div>
                    <p class="text-xs text-gray-500 italic">CoinShelf will automatically detect Colnect format and map the fields correctly.</p>
                </div>

                <div class="bg-blue-900 bg-opacity-30 border border-blue-700 p-3 rounded mt-4">
                    <p class="text-xs text-blue-300"><strong>üí° Tip:</strong> After exporting from any of these sites, simply go to the "CSV File" tab above and upload your exported CSV file. CoinShelf will automatically detect which site's format it is and import your data correctly!</p>
                </div>
            </div>

            <!-- Support CoinShelf Section -->
            <div class="mt-8 pt-6 border-t border-gray-700">
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-300 mb-2">üíù Support CoinShelf</h3>
                    <p class="text-sm text-gray-400 mb-4">If you find CoinShelf helpful, consider a small tip to keep it free and ad-free!</p>
                    <button id="show-donate-modal" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-md transition-colors">
                        <i class="ph-bold ph-heart mr-2"></i>Say Thanks
                    </button>
                </div>
            </div>

            <!-- Sticky Action Buttons (moved inside modal content) -->
            <div class="sticky bottom-0 bg-gray-800 border-t border-gray-700 p-4 mt-6">
                <div class="flex justify-end">
                    <button type="button" id="import-cancel-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="button" id="import-submit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Upload & Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Donation Modal -->
    <div id="donate-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-2xl border border-gray-700 transform transition-all scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">üíù Support CoinShelf</h2>
                <button id="close-donate-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="text-center mb-6">
                <p class="text-gray-300 mb-4">Thank you for considering a small tip! CoinShelf is completely free and ad-free, and your support helps keep it that way.</p>
                <p class="text-sm text-gray-400">Choose your preferred payment method:</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Cash App -->
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 hover:border-emerald-500 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white">Cash App</h3>
                            <p class="text-sm text-gray-400">$OscarBrimelow</p>
                        </div>
                        <button onclick="copyToClipboard('$OscarBrimelow', 'Cash App')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Venmo -->
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 hover:border-emerald-500 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white">Venmo</h3>
                            <p class="text-sm text-gray-400">@oscarbrimelow</p>
                        </div>
                        <button onclick="copyToClipboard('@oscarbrimelow', 'Venmo')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            Copy
                        </button>
                    </div>
                </div>

                <!-- PayPal -->
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 hover:border-emerald-500 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white">PayPal</h3>
                            <p class="text-sm text-gray-400">@OBrimelow</p>
                        </div>
                        <button onclick="copyToClipboard('@OBrimelow', 'PayPal')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Crypto Section -->
                <div class="bg-gray-900 p-4 rounded-lg border border-gray-700 hover:border-emerald-500 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white">Crypto</h3>
                            <p class="text-sm text-gray-400">Multiple options</p>
                        </div>
                        <button onclick="showCryptoAddresses()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            View
                        </button>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <p class="text-xs text-gray-500 mb-4">Your support helps keep CoinShelf free and ad-free for everyone! üíô</p>
                <button id="close-donate-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Crypto Addresses Modal -->
    <div id="crypto-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-lg border border-gray-700 transform transition-all scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">ü™ô Crypto Addresses</h2>
                <button id="close-crypto-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <!-- Bitcoin -->
                <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white text-sm">Bitcoin (BTC)</h3>
                            <p class="text-xs text-gray-400 font-mono break-all">bc1p493h7rq49nhj0ahffythwyup7qmv6hw3rv77q6c78r508zjydmts4lmj2c</p>
                        </div>
                        <button onclick="copyToClipboard('bc1p493h7rq49nhj0ahffythwyup7qmv6hw3rv77q6c78r508zjydmts4lmj2c', 'Bitcoin')" class="bg-orange-600 hover:bg-orange-700 text-white px-2 py-1 rounded text-xs transition-colors">
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Ethereum -->
                <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white text-sm">Ethereum (ETH)</h3>
                            <p class="text-xs text-gray-400 font-mono break-all">0x9638AdbfaD918220f46492db6135E04a0aE1f76A</p>
                        </div>
                        <button onclick="copyToClipboard('0x9638AdbfaD918220f46492db6135E04a0aE1f76A', 'Ethereum')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs transition-colors">
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Solana -->
                <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white text-sm">Solana (SOL)</h3>
                            <p class="text-xs text-gray-400 font-mono break-all">BAqSgGwNMYR6FJomcVuLgMES8zPvbxHRBmzGRCCLNkkt</p>
                        </div>
                        <button onclick="copyToClipboard('BAqSgGwNMYR6FJomcVuLgMES8zPvbxHRBmzGRCCLNkkt', 'Solana')" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs transition-colors">
                            Copy
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button id="close-crypto-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div id="export-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-lg border border-gray-700 transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-white mb-6">Export Collection Data</h2>
            <p class="text-gray-400 mb-6">Choose your desired export format:</p>
            <div class="flex flex-col space-y-4">
                <button id="export-json-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-file-json mr-2"></i> Export as JSON
                </button>
                <button id="export-csv-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-file-csv mr-2"></i> Export as CSV
                </button>
                <button id="export-excel-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-file-xls mr-2"></i> Export as Excel
                </button>
                <button id="export-pdf-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-file-pdf mr-2"></i> Export as PDF
                </button>
                <button id="export-print-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-printer mr-2"></i> Print Report
                </button>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="export-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Country Details Modal -->
    <div id="country-details-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-4xl h-full max-h-[90vh] flex flex-col border border-gray-700 transform transition-all scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 id="country-details-title" class="text-2xl font-bold text-white"></h2>
                <button id="country-details-close-btn" class="text-gray-400 hover:text-gray-200">
                    <i class="ph-bold ph-x-circle text-2xl"></i>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Items</h3>
                        <p id="country-total-items" class="text-3xl font-bold text-emerald-400">0</p>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Value</h3>
                        <p id="country-total-value" class="text-3xl font-bold text-emerald-400">$0.00</p>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-300 mb-4">Items from this Country</h3>
                <div class="bg-gray-900 rounded-lg border border-gray-700 overflow-hidden">
                    <table class="w-full text-left data-table">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                                                    <th class="p-4 font-semibold">ID</th>
                                    <th class="p-4 font-semibold">Type</th>
                                    <th class="p-4 font-semibold">Year</th>
                                    <th class="p-4 font-semibold">Denomination</th>
                                    <th class="p-4 font-semibold">Qty</th>
                                    <th class="p-4 font-semibold">Value</th>
                                    <th class="p-4 font-semibold">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="country-items-table-body">
                            <!-- Country specific items will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-sm text-center transform transition-all scale-95 opacity-0">
            <p id="confirm-message" class="text-lg font-semibold mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner Modal -->
    <div id="loading-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 border border-gray-700 transform transition-all scale-95 opacity-0">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400 mb-4"></div>
                <p id="loading-message" class="text-white text-lg font-semibold">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Clear All Confirmation Modal -->
    <div id="clear-confirm-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-md text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-red-400 mb-4">CONFIRM CLEAR ALL DATA</h2>
            <p class="text-lg text-gray-300 mb-6">
                This action will permanently delete ALL your coin collection data.
                To proceed, please type "<span class="font-bold text-red-300">CLEARYES</span>" into the box below.
            </p>
            <input type="text" id="clear-confirm-input" placeholder="Type CLEARYES here"
                   class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 text-white p-3 text-center text-lg uppercase mb-6">
            <div class="flex justify-center space-x-4">
                <button type="button" id="clear-all-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                <button type="button" id="clear-all-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Delete All Data</button>
            </div>
        </div>
    </div>

    <!-- Merge Duplicates Modal -->
    <div id="merge-duplicates-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Compare & Merge Duplicates</h2>
                <button id="close-merge-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div id="merge-modal-content" class="space-y-6">
                <!-- Duplicate coins will be rendered here -->
            </div>
            
            <div class="mt-6 flex justify-end space-x-4">
                <button id="merge-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                <button id="merge-confirm-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition-colors">
                    <i class="ph-bold ph-arrows-merge mr-2"></i>Merge Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Username Setup Modal -->
    <div id="username-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-md transform transition-all scale-95 opacity-0">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-white mb-2">Set Your Username</h2>
                <p class="text-gray-400 text-sm">Choose a unique username to complete your profile. This will be visible to other members.</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-400 mb-2">Username</label>
                    <input type="text" id="username-input" 
                           class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-3 text-white focus:ring-emerald-500 focus:border-emerald-500" 
                           placeholder="Enter username (3-50 characters)"
                           maxlength="50">
                    <p id="username-error" class="text-red-400 text-sm mt-1 hidden"></p>
                    <p class="text-gray-500 text-xs mt-1">Only letters, numbers, underscores, and hyphens allowed</p>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-4">
                <button id="username-submit-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition-colors">
                    Set Username
                </button>
            </div>
        </div>
    </div>

    <!-- User Profile View Modal -->
    <div id="user-profile-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden modal-backdrop p-4">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white" id="user-profile-username">User Profile</h2>
                <button id="close-user-profile-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div id="user-profile-content" class="space-y-6">
                <!-- Profile info and collection will be rendered here -->
            </div>
        </div>
    </div>


<script>
    // --- Backend API Base URL ---
    // This will be updated later with your actual Render backend URL
    const API_BASE_URL = 'https://mycoinshelf.onrender.com/api';

    // --- PWA & Offline Support ---
    let isOnline = navigator.onLine;
    let offlineDBReady = false;

    // Initialize offline database
    async function initOfflineDB() {
        try {
            await offlineDB.init();
            offlineDBReady = true;
            console.log('Offline database initialized');
            
            // Load cached data if offline
            if (!isOnline) {
                await loadCachedData();
            }
        } catch (error) {
            console.error('Failed to initialize offline database:', error);
        }
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                console.log('Service Worker registered:', registration);
                
                // Check for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // New update available
                            showOfflineNotification('New version available! Refresh to update.', 'info');
                        }
                    });
                });
            } catch (error) {
                console.error('Service Worker registration failed:', error);
            }
        });
    }

    // Monitor online/offline status
    window.addEventListener('online', async () => {
        isOnline = true;
        updateOnlineStatus();
        showOfflineNotification('Back online! Syncing changes...', 'success');
        await syncPendingOperations();
    });

    window.addEventListener('offline', () => {
        isOnline = false;
        updateOnlineStatus();
        showOfflineNotification('You are offline. Changes will sync when you reconnect.', 'warning');
    });

    // Update online status indicator
    function updateOnlineStatus() {
        const statusIndicator = document.getElementById('online-status-indicator');
        if (statusIndicator) {
            if (isOnline) {
                statusIndicator.innerHTML = '<i class="ph-bold ph-wifi text-emerald-400" title="Online"></i>';
                statusIndicator.classList.remove('text-red-400');
                statusIndicator.classList.add('text-emerald-400');
            } else {
                statusIndicator.innerHTML = '<i class="ph-bold ph-wifi-slash text-red-400" title="Offline"></i>';
                statusIndicator.classList.remove('text-emerald-400');
                statusIndicator.classList.add('text-red-400');
            }
        }
    }

    // Show offline notification
    function showOfflineNotification(message, type = 'info') {
        // Create or update notification element
        let notification = document.getElementById('offline-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'offline-notification';
            notification.className = 'fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg border max-w-sm';
            document.body.appendChild(notification);
        }

        const colors = {
            success: 'bg-emerald-600 border-emerald-500 text-white',
            warning: 'bg-amber-600 border-amber-500 text-white',
            info: 'bg-blue-600 border-blue-500 text-white',
            error: 'bg-red-600 border-red-500 text-white'
        };

        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg border max-w-sm ${colors[type]}`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="ph-bold ${type === 'success' ? 'ph-check-circle' : type === 'warning' ? 'ph-warning' : 'ph-info'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>
        `;

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Offline-aware fetch wrapper
    async function offlineFetch(url, options = {}) {
        const isAPIRequest = url.includes('/api/');
        
        try {
            const response = await fetch(url, options);
            
            // Cache successful GET responses
            if (response.ok && options.method === 'GET' && isAPIRequest && offlineDBReady) {
                try {
                    const data = await response.clone().json();
                    await offlineDB.cacheAPIResponse(url, data);
                } catch (e) {
                    // If response is not JSON, skip caching
                    console.log('Response is not JSON, skipping cache');
                }
            }
            
            return response;
        } catch (error) {
            // If offline and it's a GET request, try cache
            if (!isOnline && options.method === 'GET' && isAPIRequest && offlineDBReady) {
                const cached = await offlineDB.getCachedAPIResponse(url);
                if (cached && cached.data) {
                    console.log('Serving from cache:', url);
                    return new Response(JSON.stringify(cached.data), {
                        status: 200,
                        statusText: 'OK',
                        headers: { 'Content-Type': 'application/json' }
                    });
                }
            }
            
            // For POST/PUT/DELETE requests, queue for sync
            if (!isOnline && ['POST', 'PUT', 'DELETE'].includes(options.method) && isAPIRequest && offlineDBReady) {
                await queueOperationForSync(url, options);
                
                // Also save to local DB if it's a collection/wishlist item
                if (options.body && (url.includes('/coins') || url.includes('/wishlist'))) {
                    try {
                        const bodyData = JSON.parse(options.body);
                        if (options.method === 'POST' && url.includes('/coins')) {
                            await saveCollectionItemOffline(bodyData);
                        } else if (options.method === 'POST' && url.includes('/wishlist')) {
                            await offlineDB.saveWishlistItem(bodyData);
                        }
                    } catch (e) {
                        console.log('Could not save to offline DB:', e);
                    }
                }
                
                return new Response(JSON.stringify({ 
                    message: 'Queued for sync when online',
                    queued: true 
                }), {
                    status: 202,
                    statusText: 'Accepted',
                    headers: { 'Content-Type': 'application/json' }
                });
            }
            
            throw error;
        }
    }

    // Queue operation for sync
    async function queueOperationForSync(url, options) {
        if (!offlineDBReady) return;
        
        try {
            const body = options.body ? JSON.parse(options.body) : null;
            await offlineDB.addToSyncQueue({
                url: url,
                method: options.method,
                headers: options.headers,
                body: body,
                type: url.includes('/coins') ? 'collection' : url.includes('/wishlist') ? 'wishlist' : 'other'
            });
            console.log('Operation queued for sync:', url);
        } catch (error) {
            console.error('Failed to queue operation:', error);
        }
    }

    // Sync pending operations
    async function syncPendingOperations() {
        if (!isOnline || !offlineDBReady) return;
        
        try {
            const queue = await offlineDB.getSyncQueue();
            if (queue.length === 0) return;
            
            console.log(`Syncing ${queue.length} pending operations...`);
            showOfflineNotification(`Syncing ${queue.length} pending changes...`, 'info');
            
            const token = getAuthToken();
            if (!token) {
                console.log('Not authenticated, skipping sync');
                return;
            }
            
            for (const item of queue) {
                try {
                    const response = await fetch(item.url, {
                        method: item.method,
                        headers: {
                            ...item.headers,
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: item.body ? JSON.stringify(item.body) : undefined
                    });
                    
                    if (response.ok) {
                        await offlineDB.removeFromSyncQueue(item.id);
                        console.log('Synced operation:', item.url);
                    } else {
                        item.attempts = (item.attempts || 0) + 1;
                        if (item.attempts >= 3) {
                            await offlineDB.removeFromSyncQueue(item.id);
                            console.error('Failed to sync after 3 attempts:', item.url);
                        }
                    }
                } catch (error) {
                    console.error('Error syncing operation:', error);
                    item.attempts = (item.attempts || 0) + 1;
                }
            }
            
            const remaining = await offlineDB.getSyncQueue();
            if (remaining.length === 0) {
                showOfflineNotification('All changes synced successfully!', 'success');
            } else {
                showOfflineNotification(`${remaining.length} items failed to sync`, 'error');
            }
        } catch (error) {
            console.error('Error syncing pending operations:', error);
        }
    }

            // Load cached data when offline
    async function loadCachedData() {
        if (!offlineDBReady) return;
        
        try {
            // Load cached collection
            const cachedCollection = await offlineDB.getCollectionItems();
            if (cachedCollection.length > 0) {
                collectionData = cachedCollection;
                console.log('Loaded cached collection:', cachedCollection.length, 'items');
                // Trigger UI update
                renderAllViews();
            }
            
            // Load cached wishlist
            const cachedWishlist = await offlineDB.getWishlistItems();
            if (cachedWishlist.length > 0) {
                console.log('Loaded cached wishlist:', cachedWishlist.length, 'items');
            }
        } catch (error) {
            console.error('Error loading cached data:', error);
        }
    }

    // Save collection item to offline DB
    async function saveCollectionItemOffline(item) {
        if (!offlineDBReady) return;
        try {
            await offlineDB.saveCollectionItem(item);
        } catch (error) {
            console.error('Error saving to offline DB:', error);
        }
    }

    // Initialize offline support on load
    initOfflineDB();
    updateOnlineStatus();

    // --- SPA Routing for Pretty URLs ---
    const pathToSection = {
      '/': 'content-home',
      '/auth': 'content-auth',
      '/about': 'content-about',
      '/dashboard': 'content-dashboard',
      '/collection': 'content-collection',
      '/map': 'content-map',
      '/members': 'content-members',
      '/catalogue': 'content-catalogue',
      '/wishlist': 'content-wishlist',
      '/missing': 'content-missing',
      '/profile': 'content-profile',
      '/settings': 'content-settings',
    };

    function handleHistoryNavigation(path) {
      // Check if path matches /@username pattern
      const usernameMatch = path.match(/^\/@([^\/]+)$/);
      if (usernameMatch) {
        const username = usernameMatch[1];
        showView('content-user-profile');
        renderUserProfilePage(username);
        return;
      }
      
      const sectionId = pathToSection[path] || 'content-home';
      showView(sectionId);
    }

    // --- Data Store ---
    let collectionData = []; // This will be populated from the backend
    let publicCollectionData = []; // New: To store data for public view

    // List of all countries (you can expand this as needed)
    const ALL_COUNTRIES = [
        "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Aruba", "Australia", "Austria", "Azerbaijan",
        "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bermuda", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi",
        "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Cayman Islands", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)", "Congo (Kinshasa)", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czechia (Czech Republic)",
        "Denmark", "Djibouti", "Dominica", "Dominican Republic",
        "East Timor (Timor-Leste)", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia",
        "Fiji", "Finland", "France",
        "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana",
        "Haiti", "Honduras", "Hungary",
        "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Isle of Man", "Israel", "Italy", "Ivory Coast",
        "Jamaica", "Japan", "Jordan",
        "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan",
        "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
        "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar (Burma)",
        "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia (Macedonia)", "Norway",
        "Oman",
        "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
        "Qatar",
        "Romania", "Russia", "Rwanda",
        "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
        "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu",
        "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan",
        "Vanuatu", "Vatican City", "Venezuela", "Vietnam",
        "Yemen",
        "Zambia", "Zimbabwe"
    ].sort();


    // --- UTILS ---
    let chartInstance = null; // To store the Chart.js instance for dashboard chart
    let valueByYearChart = null; // To store the Chart.js instance for value by year chart
    let geoChart = null; // To store the Google GeoChart instance
    
    // --- 3D Map Variables ---
    let is3DMode = false;
    let map3dInstance = null;
    // No API Token needed for Globe.gl!

    // Debounce function to limit how often a function is called
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // Map for standardizing country names for Google Charts GeoChart
    const countryAliasMap = {
        "united states of america": "United States", "usa": "United States", "uk": "United Kingdom",
        "britain": "United Kingdom", "russia": "Russia", "china": "China", "india": "India",
        "japan": "Japan", "germany": "Germany", "deutschland": "Germany", "france": "France",
        "italy": "Italy", "brazil": "Brazil", "brasil": "Brazil", "south africa": "South Africa",
        "eswatini": "Eswatini", "swaziland": "Eswatini", "rome": "Italy", "constantinople": "Turkey", "nicomedia": "Turkey",
        "antioch": "Syria", "ancient greece": "Greece", "seleucid": "Syria", "ussr": "Russia",
        "yugoslavia": "Serbia", "east germany": "Germany", "german democratic republic": "Germany",
        "phillipines": "Philippines",
        "cape verde": "Cabo Verde", "cabo verde": "Cabo Verde",
        "congo": "Congo (Kinshasa)", "democratic republic of the congo": "Congo (Kinshasa)", "congo-kinshasa": "Congo (Kinshasa)", "dr congo": "Congo (Kinshasa)", "drc": "Congo (Kinshasa)",
        "republic of the congo": "Congo (Brazzaville)", "congo-brazzaville": "Congo (Brazzaville)", "roc": "Congo (Brazzaville)",
    };

    /**
     * Gets the standardized country name for Google GeoChart.
     * @param {string} countryName - The country name from your data.
     * @returns {string} The standardized country name or the original if no alias found.
     */
    function getGeoChartCountryName(countryName) {
        if (!countryName) return "";
        const normalized = countryName.toLowerCase().trim();
        return countryAliasMap[normalized] || countryName;
    }

    /**
     * Retrieves the geographic region for a given country.
     * @param {string} countryName The country name.
     * @returns {string} The region name, or 'Other' if not found.
     */
    function getRegionForCountry(countryName) {
        const countryToRegionMap = {
            "south africa": "Africa", "eswatini": "Africa", "kenya": "Africa", "central african states": "Africa",
            "mauritius": "Africa", "ghana": "Africa", "rwanda": "Africa", "zimbabwe": "Africa",
            "tanzania": "Africa", "mozambique": "Africa", "botswana": "Africa", "zambia": "Africa",
            "eritrea": "Africa", "somalia": "Africa", "sudan": "Africa", "malawi": "Africa",
            "ethiopia": "Africa", "nigeria": "Africa", "egypt": "Africa", "algeria": "Africa", "angola": "Africa",
            "benin": "Africa", "burkina faso": "Africa", "burundi": "Africa", "cabo verde": "Africa",
            "cameroon": "Africa", "chad": "Africa", "comoros": "Africa", "congo (brazzaville)": "Africa",
            "congo (kinshasa)": "Africa", "djibouti": "Africa", "equatorial guinea": "Africa",
            "gabon": "Africa", "gambia": "Africa", "guinea": "Africa", "guinea-bissau": "Africa",
            "lesotho": "Africa", "liberia": "Africa", "libya": "Africa", "liechtenstein": "Europe", "madagascar": "Africa",
            "mali": "Africa", "mauritania": "Africa", "morocco": "Africa", "niger": "Africa",
            "sao tome and principe": "Africa", "senegal": "Africa", "sierra leone": "Africa",
            "south sudan": "Africa", "togo": "Africa", "uganda": "Africa",

            "taiwan": "Asia", "india": "Asia", "china": "Asia", "japan": "Asia", "philippines": "Asia",
            "united arab emirates": "Asia", "israel": "Asia", "vietnam": "Asia", "bangladesh": "Asia",
            "mongolia": "Asia", "myanmar (burma)": "Asia", "cambodia": "Asia", "lebanon": "Asia",
            "uzbekistan": "Asia", "indonesia": "Asia", "laos": "Asia", "nepal": "Asia",
            "sri lanka": "Asia", "iran": "Asia", "pakistan": "Asia", "jordan": "Asia",
            "kazakhstan": "Asia", "kuwait": "Asia", "kyrgyzstan": "Asia", "malaysia": "Asia",
            "maldives": "Asia", "north korea": "Asia", "oman": "Asia", "palestine": "Asia",
            "qatar": "Asia", "saudi arabia": "Asia", "singapore": "Asia", "south korea": "Asia",
            "syria": "Asia", "tajikistan": "Asia", "turkey": "Asia", "turkmenistan": "Asia",
            "yemen": "Asia", "afghanistan": "Asia", "azerbaijan": "Asia", "bahrain": "Asia",
            "brunei": "Asia", "east timor (timor-leste)": "Asia", "georgia": "Asia",
            "iraq": "Asia",

            "netherlands": "Europe", "united kingdom": "Europe", "belgium": "Europe",
            "eu": "Europe", "ireland": "Europe", "spain": "Europe", "portugal": "Europe",
            "isle of man": "Europe", "germany": "Europe", "bulgaria": "Europe",
            "france": "Europe", "croatia": "Europe", "moldova": "Europe",
            "ukraine": "Europe", "denmark": "Europe", "finland": "Europe",
            "norway": "Europe", "san marino": "Europe", "switzerland": "Europe",
            "belarus": "Europe", "albania": "Europe",
            "andorra": "Europe", "austria": "Europe", "bosnia and herzegovina": "Europe",
            "czechia (czech republic)": "Europe", "estonia": "Europe",
            "greece": "Europe", "hungary": "Europe", "iceland": "Europe",
            "italy": "Europe", "latvia": "Europe", "lithuania": "Europe",
            "luxembourg": "Europe", "malta": "Europe",
            "monaco": "Europe", "montenegro": "Europe", "north macedonia (macedonia)": "Europe",
            "poland": "Europe", "romania": "Europe", "serbia": "Europe",
            "slovakia": "Europe", "slovenia": "Europe", "sweden": "Europe",
            "vatican city": "Europe", "russia": "Europe",

            "canada": "North America", "united states": "North America", "mexico": "North America",
            "antigua and barbuda": "North America", "bahamas": "North America", "barbados": "North America",
            "belize": "North America", "costa rica": "North America", "cuba": "North America",
            "dominica": "North America", "dominican republic": "North America", "el salvador": "North America",
            "grenada": "North America", "guatemala": "North America", "haiti": "North America",
            "honduras": "North America", "jamaica": "North America", "nicaragua": "North America",
            "panama": "North America", "saint kitts and nevis": "North America", "saint lucia": "North America",
            "saint vincent and the grenadines": "North America", "trinidad and tobago": "North America",

            "brazil": "South America", "argentina": "South America", "peru": "South America",
            "colombia": "South America", "chile": "South America", "bolivia": "South America",
            "ecuador": "South America", "guyana": "South America", "paraguay": "South America",
            "suriname": "South America", "uruguay": "South America", "venezuela": "South America",

            "australia": "Oceania", "new zealand": "Oceania", "fiji": "Oceania",
            "kiribati": "Oceania", "marshall islands": "Oceania", "micronesia": "Oceania",
            "nauru": "Oceania", "palau": "Oceania", "papua new guinea": "Oceania",
            "samoa": "Oceania", "solomon islands": "Oceania", "tonga": "Oceania",
            "tuvalu": "Oceania", "vanuatu": "Oceania",

            "siscia": "Ancient", "consz": "Ancient", "rome": "Ancient", "nicomedia": "Ancient",
            "constantinople": "Ancient", "mediolanum (milan)": "Ancient", "antioch": "Ancient",
            "ancient greece": "Ancient", "?": "Ancient",
            "thessalonica": "Ancient", "ussr": "Ancient", "yugoslavia": "Ancient",
            "rhodesia": "Ancient", "czechoslovakia": "Ancient", "east germany": "Ancient",
            "german democratic republic": "Ancient",
        };
        const normalizedCountry = countryName.toLowerCase().trim();
        return countryToRegionMap[normalizedCountry] || "Other";
    }

    // --- SECURITY UTILITIES ---
    // Escape HTML to prevent XSS attacks
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // Render username with crown icon for developer
    function renderUsername(username, includeAt = true) {
        if (!username) return '';
        const escapedUsername = escapeHtml(username);
        const isDeveloper = username === 'OscarBrimelow';
        const prefix = includeAt ? '@' : '';
        
        if (isDeveloper) {
            return `${prefix}${escapedUsername} <i class="ph-bold ph-crown text-purple-400 ml-1 inline-block" title="Developer"></i>`;
        }
        return `${prefix}${escapedUsername}`;
    }

    // Sanitize input by trimming and escaping
    function sanitizeInput(input) {
        if (typeof input !== 'string') return input;
        return escapeHtml(input.trim());
    }

    // Validate email format
    function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // Validate password strength
    function validatePassword(password) {
        if (!password) return { valid: false, message: 'Password is required' };
        if (password.length < 6) return { valid: false, message: 'Password must be at least 6 characters long' };
        return { valid: true, message: '' };
    }

    // Validate URL format
    function validateUrl(url) {
        if (!url) return true; // URL is optional
        try {
            new URL(url);
            return true;
        } catch {
            return false;
        }
    }

    // Sanitize text content for safe display (prevents XSS)
    function safeSetTextContent(element, text) {
        if (element) {
            element.textContent = text || '';
        }
    }

    // Safe innerHTML with sanitization
    function safeSetInnerHTML(element, html) {
        if (element && html) {
            // Basic sanitization - escape all HTML
            element.textContent = html;
        }
    }

    // --- LOADING STATE MANAGEMENT ---
    function setLoadingState(elementId, isLoading, loadingText = 'Loading...') {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        if (isLoading) {
            element.disabled = true;
            const originalText = element.dataset.originalText || element.textContent;
            element.dataset.originalText = originalText;
            element.innerHTML = `<span class="inline-flex items-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${loadingText}</span>`;
        } else {
            element.disabled = false;
            const originalText = element.dataset.originalText;
            if (originalText) {
                element.textContent = originalText;
                delete element.dataset.originalText;
            }
        }
    }

    // Custom confirmation modal instead of alert/confirm
    function showCustomConfirm(message, onConfirmCallback) {
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok');
        const confirmCancelBtn = document.getElementById('confirm-cancel');

        // Reset previous listeners
        confirmOkBtn.replaceWith(confirmOkBtn.cloneNode(true));
        confirmCancelBtn.replaceWith(confirmCancelBtn.cloneNode(true));
        const newConfirmOkBtn = document.getElementById('confirm-ok');
        const newConfirmCancelBtn = document.getElementById('confirm-cancel');


        // Use textContent instead of innerText for security (prevents XSS)
        safeSetTextContent(confirmMessage, message);
        confirmModal.classList.remove('hidden');
        confirmModal.classList.add('flex');
        setTimeout(() => {
            confirmModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            confirmModal.querySelector('div').classList.add('scale-100', 'opacity-100');
        }, 10);

        const handleConfirm = () => {
            onConfirmCallback();
            closeModal(confirmModal, confirmModal.querySelector('div'));
        };

        const handleCancel = () => {
            closeModal(confirmModal, confirmModal.querySelector('div'));
        };

        newConfirmOkBtn.addEventListener('click', handleConfirm);
        newConfirmCancelBtn.addEventListener('click', handleCancel);
    }

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => {
            modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('div').classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function closeModal(modalElement, modalContentElement) {
        modalContentElement.classList.remove('scale-100', 'opacity-100');
        modalContentElement.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modalElement.classList.add('hidden');
            modalElement.classList.remove('flex');
        }, 300);
    }

    // --- Data Operations (interacting with Flask Backend) ---
    function getAuthToken() {
        return localStorage.getItem('jwt_token') || sessionStorage.getItem('jwt_token');
    }

    function isAuthenticated() {
        return !!getAuthToken();
    }

    // Fetches collection data from the backend
    async function loadCollectionFromBackend() {
        if (!isAuthenticated()) {
            console.log('Not authenticated, clearing collection data and rendering views.');
            collectionData = []; // Clear data if not authenticated
            renderAllViews();
            return;
        }
        console.log('Authenticated, attempting to load collection data from backend...');
        showLoading('Loading your collection...');
        try {
            const response = await offlineFetch(`${API_BASE_URL}/coins`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            if (!response.ok) {
                if (response.status === 401) { // Unauthorized, token expired or invalid
                    console.warn('Authentication failed during collection load (401 Unauthorized).');
                    handleUnauthorized(true); // Silent mode for initial load
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            collectionData = await response.json();
            
            // Save to offline DB if online
            if (isOnline && offlineDBReady) {
                try {
                    for (const item of collectionData) {
                        item.synced = true; // Mark as synced
                        await saveCollectionItemOffline(item);
                    }
                } catch (e) {
                    console.error('Error saving collection to offline DB:', e);
                }
            }
            
            // Normalize is_favorite to boolean for all items
            collectionData = collectionData.map(item => {
                // Handle all possible formats from backend
                const rawValue = item.is_favorite;
                const isFavorite = rawValue === true || rawValue === 'true' || rawValue === 1 || rawValue === 'True' || rawValue === 'TRUE' || String(rawValue).toLowerCase() === 'true';
                const normalizedValue = !!isFavorite;
                if (normalizedValue !== rawValue) {
                    console.log(`Normalized is_favorite for item ${item.id}: ${rawValue} (${typeof rawValue}) -> ${normalizedValue}`);
                }
                return {
                    ...item,
                    is_favorite: normalizedValue // Ensure it's a strict boolean
                };
            });
            console.log("Collection data loaded from backend:", collectionData);
            // Log favorites count
            const favoritesCount = collectionData.filter(item => item.is_favorite === true).length;
            console.log(`Found ${favoritesCount} favorited items out of ${collectionData.length} total`);
            console.log("Number of items in collection:", collectionData.length);

            // Update collection statistics
            updateCollectionStats();

            // Region and isHistorical are now calculated by the backend upon add/update.
            // We just ensure the data is present in case older data exists or for consistency.
            collectionData.forEach(item => {
                // Always ensure region is correct based on country (fixes incorrect regions like "Germany")
                const correctRegion = getRegionForCountry(item.country);
                if (!item.region || item.region === "" || item.region !== correctRegion) {
                    item.region = correctRegion;
                }
                // If isHistorical is not explicitly set by backend or is missing
                if (typeof item.isHistorical === 'undefined' || item.isHistorical === null) {
                    const historicalCountries = ["ussr", "yugoslavia", "rhodesia", "czechoslovakia", "east germany", "german democratic republic", "roman empire", "ancient greece", "seleucid", "siscia", "consz", "nicomedia", "constantinople", "rome", "thessalonica"];
                    const yearInput = item.year;
                    const parsedYear = yearInput ? parseInt(yearInput) : null;
                    item.isHistorical = historicalCountries.includes((item.country || '').toLowerCase()) || (parsedYear !== null && parsedYear < 1900 && parsedYear !== 0);
                }
            });
            renderAllViews(); // Re-render UI with fresh data
        }
        catch (error) {
            console.error("Error loading collection from backend:", error);
            showCustomConfirm('Failed to load collection. Please try logging in again or check backend server.', () => {});
            collectionData = []; // Clear local data on load error
            renderAllViews();
        } finally {
            hideLoading();
        }
    }

    // New function to fetch public collection data
    async function loadPublicCollectionFromBackend(public_id) {
        try {
            const response = await fetch(`${API_BASE_URL}/public_coins/${public_id}`);
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error("Public collection not found or invalid URL.");
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            publicCollectionData = await response.json();
            console.log("Public collection data loaded:", publicCollectionData);
            renderPublicCollection();
        } catch (error) {
            console.error("Error loading public collection:", error);
            const publicStatusDiv = document.getElementById('public-collection-status');
            if (publicStatusDiv) {
                publicStatusDiv.innerHTML = `<p class="text-xl text-red-400">Error loading public collection: ${error.message}</p>`;
            }
            document.getElementById('public-collection-summary').classList.add('hidden');
            document.getElementById('public-collection-table-body').innerHTML = '';
            document.getElementById('public-collection-title').innerText = 'Public Collection (Not Found)';
        }
    }

    // Toggle between image URL and file upload
    function toggleImageInput(mode) {
        const urlToggle = document.getElementById('image-url-toggle');
        const uploadToggle = document.getElementById('image-upload-toggle');
        const urlInput = document.getElementById('image-url-input');
        const uploadInput = document.getElementById('image-upload-input');
        
        if (!urlToggle || !uploadToggle || !urlInput || !uploadInput) return;
        
        if (mode === 'url') {
            urlToggle.classList.remove('bg-gray-700', 'text-gray-300');
            urlToggle.classList.add('bg-emerald-600', 'text-white');
            uploadToggle.classList.remove('bg-emerald-600', 'text-white');
            uploadToggle.classList.add('bg-gray-700', 'text-gray-300');
            urlInput.classList.remove('hidden');
            uploadInput.classList.add('hidden');
            clearImagePreview();
        } else {
            uploadToggle.classList.remove('bg-gray-700', 'text-gray-300');
            uploadToggle.classList.add('bg-emerald-600', 'text-white');
            urlToggle.classList.remove('bg-emerald-600', 'text-white');
            urlToggle.classList.add('bg-gray-700', 'text-gray-300');
            uploadInput.classList.remove('hidden');
            urlInput.classList.add('hidden');
            const localImagePath = document.getElementById('localImagePath');
            if (localImagePath) localImagePath.value = '';
        }
    }

    // Handle image file selection
    function setupImageUpload() {
        const fileInput = document.getElementById('imageFileInput');
        const clearBtn = document.getElementById('clear-image-btn');
        const fileName = document.getElementById('image-file-name');
        
        if (!fileInput) return;
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showCustomConfirm('File size must be less than 5MB', () => {});
                fileInput.value = '';
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showCustomConfirm('Please select an image file', () => {});
                fileInput.value = '';
                return;
            }
            
            // Show file name
            if (fileName) fileName.textContent = file.name;
            if (clearBtn) clearBtn.classList.remove('hidden');
            
            // Convert to base64 and show preview
            const reader = new FileReader();
            reader.onload = (event) => {
                const base64Image = event.target.result;
                showImagePreview(base64Image);
                // Store in localImagePath for form submission
                const localImagePath = document.getElementById('localImagePath');
                if (localImagePath) localImagePath.value = base64Image;
            };
            reader.readAsDataURL(file);
        });
        
        // Clear button
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                fileInput.value = '';
                if (fileName) fileName.textContent = '';
                clearBtn.classList.add('hidden');
                clearImagePreview();
                const localImagePath = document.getElementById('localImagePath');
                if (localImagePath) localImagePath.value = '';
            });
        }
    }

    // Show image preview
    function showImagePreview(imageSrc) {
        const preview = document.getElementById('image-preview');
        const container = document.getElementById('image-preview-container');
        if (preview && container) {
            preview.src = imageSrc;
            container.classList.remove('hidden');
        }
    }

    // Clear image preview
    function clearImagePreview() {
        const preview = document.getElementById('image-preview');
        const container = document.getElementById('image-preview-container');
        if (preview && container) {
            preview.src = '';
            container.classList.add('hidden');
        }
    }

    // Update image preview when URL is entered
    function setupImageUrlPreview() {
        const urlInput = document.getElementById('localImagePath');
        if (!urlInput) return;
        
        urlInput.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url && (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('data:'))) {
                showImagePreview(url);
            } else if (!url) {
                clearImagePreview();
            }
        });
    }

    function clearItemForm() {
        document.getElementById('item-id').value = '';
        document.getElementById('type').value = 'Coin';
        document.getElementById('country').value = '';
        document.getElementById('year').value = '';
        document.getElementById('denomination').value = '';
        document.getElementById('value').value = '';
        document.getElementById('quantity').value = '1';
        document.getElementById('notes').value = '';
        document.getElementById('referenceUrl').value = '';
        document.getElementById('localImagePath').value = '';
        const imageFileInput = document.getElementById('imageFileInput');
        if (imageFileInput) imageFileInput.value = '';
        document.getElementById('weight_grams').value = '';
        document.getElementById('purity_percent').value = '';
        document.getElementById('modal-title').innerText = 'Add New Item';
        
        // Reset image input
        toggleImageInput('url');
        clearImagePreview();
        const fileName = document.getElementById('image-file-name');
        const clearBtn = document.getElementById('clear-image-btn');
        if (fileName) fileName.textContent = '';
        if (clearBtn) clearBtn.classList.add('hidden');
        
        // Hide Numista results
        const resultsDiv = document.getElementById('numista-results');
        if (resultsDiv) {
            resultsDiv.classList.add('hidden');
        }
        
        // Reset form field visibility
        toggleBullionFields();
    }

    function reinitItemForm() {
        const form = document.getElementById('item-form');
        // Check if the form content has been replaced (e.g., by the map's country details)
        if (!document.getElementById('denomination')) {
            form.innerHTML = `
                <input type="hidden" id="item-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="type" class="block text-sm font-medium text-gray-400">Type</label>
                        <select id="type" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option>Coin</option>
                            <option>Banknote</option>
                            <option>Gold Bullion</option>
                            <option>Silver Bullion</option>
                        </select>
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-400">Country</label>
                        <input type="text" id="country" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-400">Year</label>
                        <input type="number" id="year" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                     <div>
                        <label for="value" class="block text-sm font-medium text-gray-400">Estimated Value (USD)</label>
                        <input type="number" step="0.01" id="value" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-400">Quantity</label>
                        <input type="number" id="quantity" min="1" value="1" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="denomination" class="block text-sm font-medium text-gray-400">Denomination</label>
                        <input type="text" id="denomination" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-400">Notes</label>
                        <textarea id="notes" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="referenceUrl" class="block text-sm font-medium text-gray-400">Reference URL (eBay, etc.)</label>
                        <input type="text" id="referenceUrl" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="localImagePath" class="block text-sm font-medium text-gray-400">Local Image Path</label>
                        <input type="text" id="localImagePath" placeholder="e.g., C:\Users\YourName\Pictures\Coins\my_coin.jpg" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <!-- --- Bullion Fields (hidden by default, shown for Gold/Silver Bullion) --- -->
                    <div id="bullion-fields" class="md:col-span-2" style="display:none;">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="weight_grams" class="block text-sm font-medium text-gray-400">Weight (grams)</label>
                                <input type="number" id="weight_grams" step="0.01" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                            <div>
                                <label for="purity_percent" class="block text-sm font-medium text-gray-400">Purity (%)</label>
                                <input type="number" id="purity_percent" step="0.01" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button type="button" id="cancel-btn" class="mr-4 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition-colors">Cancel</button>
                    <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-md transition-colors">Save Item</button>
                </div>
            `;
            attachFormEventListeners(); // Re-attach event listeners after recreating elements
        }
        document.getElementById('modal-title').innerText = 'Add New Item'; // Reset title
    }

    function attachFormEventListeners() {
        const form = document.getElementById('item-form');
        const modalElement = document.getElementById('item-modal');
        const modalContentElement = modalElement.querySelector('div');

        // Remove existing listeners by replacing buttons with clones
        const oldCancelBtn = document.getElementById('cancel-btn');
        if (oldCancelBtn) { // Check if element exists before replacing
            const newCancelBtn = oldCancelBtn.cloneNode(true);
            oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
            newCancelBtn.addEventListener('click', () => closeModal(modalElement, modalContentElement));
        }


        const oldSubmitBtn = form.querySelector('button[type="submit"]');
        if (oldSubmitBtn) { // Check if element exists before replacing
            const newSubmitBtn = oldSubmitBtn.cloneNode(true);
            oldSubmitBtn.parentNode.replaceChild(newSubmitBtn, oldSubmitBtn);
            newSubmitBtn.addEventListener('click', handleFormSubmission);
        }
        
        // Attach bullion event listeners
        attachBullionEventListeners();
        
        // Attach Numista search button
        const searchBtn = document.getElementById('search-numista-btn');
        if (searchBtn) {
            searchBtn.addEventListener('click', handleNumistaSearch);
        }
    }
    
    async function handleNumistaSearch() {
        const query = document.getElementById('denomination').value.trim();
        const itemType = document.getElementById('type').value.toLowerCase();
        const resultsDiv = document.getElementById('numista-results');
        
        if (!query) {
            showCustomConfirm('Please enter a search term in the denomination field.', () => {});
            return;
        }
        
        // Show loading state
        resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-400">Searching...</div>';
        resultsDiv.classList.remove('hidden');
        
        try {
            const token = getAuthToken();
            if (!token) {
                showCustomConfirm('Please sign in to search.', () => {});
                return;
            }
            
            // Map type to Numista format
            const numistaType = itemType.includes('banknote') ? 'banknote' : 'coin';
            
            const response = await fetch(`${API_BASE_URL}/search-numista?q=${encodeURIComponent(query)}&type=${numistaType}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Numista search error: Non-JSON response', text.substring(0, 200));
                resultsDiv.innerHTML = '<div class="p-3 text-center text-yellow-400">Server returned an unexpected response. Please check your backend logs.</div>';
                return;
            }
            
            let data;
            try {
                data = await response.json();
            } catch (e) {
                console.error('Numista search error: SyntaxError parsing JSON', e);
                resultsDiv.innerHTML = '<div class="p-3 text-center text-yellow-400">Server returned invalid JSON. Please check your backend logs.</div>';
                return;
            }
            
            if (data.error) {
                resultsDiv.innerHTML = `<div class="p-3 text-center text-yellow-400">${data.error}</div>`;
            } else if (data.results && data.results.length > 0) {
                let html = '<div class="p-2 text-xs text-gray-400 border-b border-gray-600">Search Results (click to select):</div>';
                data.results.forEach((result, index) => {
                    html += `
                        <div class="p-2 hover:bg-gray-600 cursor-pointer border-b border-gray-600 last:border-b-0 transition-colors" data-index="${index}">
                            <div class="font-semibold text-white">${escapeHtml(result.title || result.denomination || query)}</div>
                            ${result.country ? `<div class="text-xs text-gray-400">Country: ${escapeHtml(result.country)}</div>` : ''}
                            ${result.year ? `<div class="text-xs text-gray-400">Year: ${result.year}</div>` : ''}
                            ${result.denomination && result.denomination !== result.title ? `<div class="text-xs text-gray-400">Denomination: ${escapeHtml(result.denomination)}</div>` : ''}
                            ${result.composition ? `<div class="text-xs text-gray-500">Composition: ${escapeHtml(result.composition)}</div>` : ''}
                            ${result.url ? `<div class="text-xs text-emerald-400 mt-1"><a href="${result.url}" target="_blank" class="hover:underline" onclick="event.stopPropagation()">View on Numista ‚Üí</a></div>` : ''}
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
                
                // Add click handlers to results
                resultsDiv.querySelectorAll('[data-index]').forEach(item => {
                    item.addEventListener('click', () => {
                        const result = data.results[parseInt(item.dataset.index)];
                        populateFormFromNumistaResult(result);
                        resultsDiv.classList.add('hidden');
                    });
                });
            } else {
                resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-400">No results found. Try a different search term.</div>';
            }
        } catch (error) {
            console.error('Numista search error:', error);
            resultsDiv.innerHTML = '<div class="p-3 text-center text-red-400">Search failed. Please try again or fill in manually.</div>';
        }
    }
    
    function populateFormFromNumistaResult(result) {
        if (result.country) {
            document.getElementById('country').value = result.country;
        }
        if (result.year) {
            document.getElementById('year').value = result.year;
        }
        if (result.denomination) {
            document.getElementById('denomination').value = result.denomination;
        } else if (result.title) {
            // Use title as denomination if denomination not available
            document.getElementById('denomination').value = result.title;
        }
        if (result.type) {
            const typeMap = {
                'coin': 'Coin',
                'banknote': 'Banknote'
            };
            const mappedType = typeMap[result.type.toLowerCase()] || result.type;
            document.getElementById('type').value = mappedType;
        }
        if (result.url) {
            document.getElementById('referenceUrl').value = result.url;
        }
        
        // Auto-populate image URL from Numista
        // Prefer obverse_thumbnail, then reverse_thumbnail, then image_url
        const imageUrl = result.obverse_thumbnail || result.reverse_thumbnail || result.image_url || '';
        if (imageUrl) {
            document.getElementById('localImagePath').value = imageUrl;
        }
        
        // Add additional details to notes if available
        let notes = document.getElementById('notes').value;
        if (result.description && !notes) {
            notes = result.description;
        }
        if (result.composition && notes) {
            notes += `\nComposition: ${result.composition}`;
        } else if (result.composition) {
            notes = `Composition: ${result.composition}`;
        }
        if (result.weight && notes) {
            notes += `\nWeight: ${result.weight}${result.weight.includes('g') ? '' : 'g'}`;
        } else if (result.weight) {
            notes = `Weight: ${result.weight}${result.weight.includes('g') ? '' : 'g'}`;
        }
        if (notes) {
            document.getElementById('notes').value = notes.trim();
        }
        
        // Trigger bullion fields update if type changed
        const typeValue = document.getElementById('type').value;
        if (typeValue === 'Gold Bullion' || typeValue === 'Silver Bullion') {
            document.getElementById('bullion-fields').style.display = 'block';
        }
    }

    async function handleFormSubmission(e) {
        e.preventDefault();
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to save items.', () => {});
            return;
        }

        const submitBtn = e.target.closest('form')?.querySelector('button[type="submit"]');
        if (submitBtn) {
            setLoadingState(submitBtn.id || 'submit-btn', true, 'Saving...');
        }

        // Validation (before async operations)
        const itemId = document.getElementById('item-id').value;
        const countryValue = sanitizeInput(document.getElementById('country').value);
        const typeValue = document.getElementById('type').value;
        const isBullion = (typeValue === 'Gold Bullion' || typeValue === 'Silver Bullion');

        // Validation: Country is required
        if (!countryValue) {
            if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
            showCustomConfirm('Country is a required field.', () => {});
            return;
        }

        // Validation: Denomination required for non-bullion items
        const denominationValue = sanitizeInput(document.getElementById('denomination').value);
        if (!isBullion && !denominationValue) {
            if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
            showCustomConfirm('Country and Denomination are required fields.', () => {});
            return;
        }

        // Validation: Year must be valid if provided
        const yearValue = document.getElementById('year').value;
        let year = null;
        if (yearValue) {
            year = parseInt(yearValue);
            if (isNaN(year) || year < 0 || year > new Date().getFullYear() + 10) {
                if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
                showCustomConfirm('Please enter a valid year.', () => {});
                return;
            }
        }

        // Validation: Quantity must be positive
        const quantityValue = parseInt(document.getElementById('quantity').value) || 1;
        if (quantityValue < 1) {
            if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
            showCustomConfirm('Quantity must be at least 1.', () => {});
            return;
        }

        // Validation: Value must be non-negative
        const valueValue = parseFloat(document.getElementById('value').value) || 0;
        if (valueValue < 0) {
            if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
            showCustomConfirm('Value cannot be negative.', () => {});
            return;
        }

        // Validation: Reference URL format
        const referenceUrlValue = sanitizeInput(document.getElementById('referenceUrl').value);
        if (referenceUrlValue && !validateUrl(referenceUrlValue)) {
            if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
            showCustomConfirm('Please enter a valid URL for the reference link.', () => {});
            return;
        }

        // Validation: Weight and purity for bullion
        const weightGrams = document.getElementById('weight_grams').value;
        const purityPercent = document.getElementById('purity_percent').value;
        if (isBullion) {
            if (weightGrams && (parseFloat(weightGrams) <= 0 || parseFloat(weightGrams) > 100000)) {
                if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
                showCustomConfirm('Please enter a valid weight in grams (0-100000).', () => {});
                return;
            }
            if (purityPercent && (parseFloat(purityPercent) <= 0 || parseFloat(purityPercent) > 100)) {
                if (submitBtn) setLoadingState(submitBtn.id || 'submit-btn', false);
                showCustomConfirm('Please enter a valid purity percentage (0-100).', () => {});
                return;
            }
        }

        // Get image - either from URL input or file upload
        let imagePath = sanitizeInput(document.getElementById('localImagePath').value);
        // If no image provided, use placeholder
        if (!imagePath) {
            imagePath = "https://placehold.co/300x300/1f2937/d1d5db?text=No+Image";
        }

        const itemData = {
            type: typeValue,
            country: countryValue,
            year: year,
            denomination: isBullion ? typeValue : denominationValue,
            value: valueValue,
            quantity: quantityValue,
            notes: sanitizeInput(document.getElementById('notes').value),
            referenceUrl: referenceUrlValue,
            localImagePath: imagePath,
            weight_grams: weightGrams ? parseFloat(weightGrams) : null,
            purity_percent: purityPercent ? parseFloat(purityPercent) : null
        };

        const method = itemId ? 'PUT' : 'POST';
        const url = itemId ? `${API_BASE_URL}/coins/${itemId}` : `${API_BASE_URL}/coins`;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(itemData)
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            showCustomConfirm(result.message || 'Item saved successfully!', () => {});
            loadCollectionFromBackend(); // Reload data after successful save
        } catch (error) {
            console.error("Error saving item:", error);
            // Sanitize error message to prevent XSS
            const errorMessage = error.message || 'An unexpected error occurred';
            showCustomConfirm(`Failed to save item: ${escapeHtml(errorMessage)}. Please check your connection and try again.`, () => {});
        } finally {
            if (submitBtn) {
                setLoadingState(submitBtn.id || 'submit-btn', false);
            }
            closeModal(document.getElementById('item-modal'), document.getElementById('item-modal').querySelector('div'));
            clearItemForm();
        }
    }

    // --- HOMEPAGE RENDERING ---
    function renderHome() {
        // Content is static, no dynamic rendering needed here.
    }


    // --- DASHBOARD RENDERING ---
    function renderDashboard() {
        const dashboardDiv = document.getElementById('content-dashboard');
        // Get the inner div where content will be rendered
        const dashboardContentWrapper = dashboardDiv.querySelector('.max-w-7xl.mx-auto');

        if (!isAuthenticated()) {
            dashboardContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view your dashboard.</p></div>`;
            return;
        }
        
        dashboardContentWrapper.innerHTML = `
            <h2 class="text-3xl font-bold text-white mb-6">Dashboard Overview</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Total Items</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-items">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Total Value</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-value">$0.00</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Unique Countries</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-unique-countries">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Wishlist Items</h3>
                    <p class="text-4xl font-bold text-pink-400" id="dashboard-wishlist-count">0</p>
                    <p class="text-sm text-gray-400 mt-2" id="dashboard-wishlist-comparison" style="display: none;"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Combined Collection Highlights and Top 5 Countries -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-emerald-400 mb-4">Collection Overview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold text-blue-400 mb-2">Collection Highlights</h4>
                            <div id="collection-highlights" class="text-gray-300 text-sm leading-relaxed">
                                <!-- Highlights will be rendered here -->
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-yellow-400 mb-2">Top 5 Countries by Items</h4>
                            <ul id="top-countries-list" class="list-disc list-inside text-gray-300">
                                <!-- Top countries will be rendered here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Items by Region (Pie Chart) -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Items by Region</h3>
                    <div style="position: relative; height:320px; width:100%;">
                        <canvas id="chart-by-region-pie" height="320"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Items by Type (Pie Chart) -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Items by Type</h3>
                    <div style="position: relative; height:320px; width:100%;">
                        <canvas id="chart-by-type" height="320"></canvas>
                    </div>
                </div>
                <!-- Value by Region (Bar Chart) -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Value by Region</h3>
                    <div style="position: relative; height:320px; width:100%;">
                        <canvas id="chart-by-value-region" height="320"></canvas>
                    </div>
                </div>
            </div>

            <!-- New Chart: Value Distribution by Year/Decade -->
            <div class="grid grid-cols-1 mt-6">
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Value Distribution by Year/Decade</h3>
                    <div style="position: relative; height:320px; width:100%;">
                        <canvas id="chart-value-by-year" height="320"></canvas>
                    </div>
                </div>
            </div>
        `;

        // Update dashboard stats
        const totalItems = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const totalValue = collectionData.reduce((sum, item) => {
            return sum + (getItemValueInCurrency(item, currencySetting) * (item.quantity || 1));
        }, 0);
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        document.getElementById('dashboard-total-items').innerText = totalItems;
        document.getElementById('dashboard-total-value').innerText = formatCurrency(totalValue, currencySetting);
        document.getElementById('dashboard-unique-countries').innerText = uniqueCountries;
        
        // Load wishlist count for dashboard (with comparison)
        loadWishlistCountForDashboard();

        // Render additional dashboard content
        renderCollectionHighlights();
        renderTop5Countries();

        // Render Charts
        renderChartByType();
        renderChartByValueRegion();
        renderChartByRegionPie();
        renderChartValueByYear(); // New chart render call
    }

    function renderCollectionHighlights() {
        const highlightsDiv = document.getElementById('collection-highlights');
        if (collectionData.length === 0) {
            highlightsDiv.innerHTML = '<p>No items in collection yet. Start adding items to see highlights!</p>';
            return;
        }

        const oldestItem = collectionData.reduce((oldest, current) => {
            if (current.year && (!oldest || current.year < oldest.year)) {
                return current;
            }
            return oldest;
        }, null);

        const newestItem = collectionData.reduce((newest, current) => {
            if (current.year && (!newest || current.year > newest.year)) {
                return current;
            }
            return newest;
        }, null);

            // For highest value, use calculated value for bullion (including quantity)
    const highestValueItem = collectionData.reduce((highest, current) => {
        const currentValue = getItemValueInCurrency(current, currencySetting) * (current.quantity || 1);
        const highestValue = highest ? getItemValueInCurrency(highest, currencySetting) * (highest.quantity || 1) : 0;
        if (!highest || currentValue > highestValue) {
            return current;
        }
        return highest;
    }, null);

            let highlightsHtml = '<ul class="space-y-2">';
    // Sum quantities for total items (not just count rows)
    const totalItemsCount = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
    highlightsHtml += `<li><strong>Total Items:</strong> ${totalItemsCount}</li>`;
    const totalValue = collectionData.reduce((sum, item) => {
        return sum + (getItemValueInCurrency(item, currencySetting) * (item.quantity || 1));
    }, 0);
    highlightsHtml += `<li><strong>Total Estimated Value:</strong> ${formatCurrency(totalValue, currencySetting)}</li>`;
        highlightsHtml += `<li><strong>Unique Countries Represented:</strong> ${new Set(collectionData.map(item => item.country)).size}</li>`;

        if (oldestItem) {
            highlightsHtml += `<li><strong>Oldest Item:</strong> ${oldestItem.denomination} from ${oldestItem.country} (${oldestItem.year})</li>`;
        }
        if (newestItem) {
            highlightsHtml += `<li><strong>Newest Item:</strong> ${newestItem.denomination} from ${newestItem.country} (${newestItem.year})</li>`;
        }
            if (highestValueItem) {
        const highestValue = getItemValueInCurrency(highestValueItem, currencySetting) * (highestValueItem.quantity || 1);
        highlightsHtml += `<li><strong>Highest Value Item:</strong> ${highestValueItem.denomination} from ${highestValueItem.country} (${formatCurrency(highestValue, currencySetting)})</li>`;
    }
        highlightsHtml += '</ul>';
        highlightsDiv.innerHTML = highlightsHtml;
    }

    function renderTop5Countries() {
        const topCountriesList = document.getElementById('top-countries-list');
        topCountriesList.innerHTML = ''; // Clear previous list

        if (collectionData.length === 0) {
            topCountriesList.innerHTML = '<li>No data to show. Add items to see top countries.</li>';
            return;
        }

        const countryItemCounts = collectionData.reduce((acc, item) => {
            acc[item.country] = (acc[item.country] || 0) + (item.quantity || 1);
            return acc;
        }, {});

        const sortedCountries = Object.entries(countryItemCounts)
            .sort(([, countA], [, countB]) => countB - countA)
            .slice(0, 5); // Get top 5

        if (sortedCountries.length > 0) {
            sortedCountries.forEach(([country, count]) => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="font-medium">${country}:</span> ${count} items`;
                topCountriesList.appendChild(li);
            });
        } else {
            topCountriesList.innerHTML = '<li>No data to show.</li>';
        }
    }


    function renderChartByType() {
        const ctx = document.getElementById('chart-by-type').getContext('2d');
        if (Chart.getChart('chart-by-type')) { // Use Chart.getChart to destroy specific chart instances
            Chart.getChart('chart-by-type').destroy();
        }

        const typeCounts = collectionData.reduce((acc, item) => {
            acc[item.type] = (acc[item.type] || 0) + (item.quantity || 1);
            return acc;
        }, {});

        new Chart(ctx, { // Assign to chartInstance
            type: 'pie',
            data: {
                labels: Object.keys(typeCounts),
                datasets: [{
                    data: Object.values(typeCounts),
                    backgroundColor: [
                        '#34D399', // Emerald
                        '#60A5FA', // Blue
                        '#FCD34D', // Yellow
                        '#FB7185'  // Rose
                    ],
                    borderColor: '#111827',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db' // Light gray for legend text
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937', // Dark background for tooltip
                        borderColor: '#4b5563', // Border for tooltip
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                    }
                }
            }
        });
    }

    function renderChartByValueRegion() {
        const ctx = document.getElementById('chart-by-value-region').getContext('2d');
        if (Chart.getChart('chart-by-value-region')) {
            Chart.getChart('chart-by-value-region').destroy();
        }

        const regionValues = collectionData.reduce((acc, item) => {
            const region = item.region || 'Unknown';
            acc[region] = (acc[region] || 0) + (getItemValueInCurrency(item, currencySetting) * (item.quantity || 1));
            return acc;
        }, {});

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(regionValues),
                datasets: [{
                    label: 'Total Value (USD)',
                    data: Object.values(regionValues),
                    backgroundColor: '#34D399', // Emerald
                    borderColor: '#111827',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#d1d5db' },
                        grid: { color: '#374151' }
                    },
                    y: {
                        ticks: {
                            color: '#d1d5db',
                            callback: function(value) {
                                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
                            }
                        },
                        grid: { color: '#374151' }
                    }
                }
            }
        });
    }

    function renderChartByRegionPie() {
        const ctx = document.getElementById('chart-by-region-pie').getContext('2d');
        if (Chart.getChart('chart-by-region-pie')) {
            Chart.getChart('chart-by-region-pie').destroy();
        }

        const regionCounts = collectionData.reduce((acc, item) => {
            acc[item.region] = (acc[item.region] || 0) + (item.quantity || 1);
            return acc;
        }, {});

        const chartColors = [
            '#8b5cf6', '#60A5FA', '#FCD34D', '#34D399', '#FB7185', '#a855f7', '#ec4899', '#eab308',
            '#facc15', '#6ee7b7', '#93c5fd', '#f87171', '#fb923c', '#c084fc', '#fde047'
        ];

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(regionCounts),
                datasets: [{
                    data: Object.values(regionCounts),
                    backgroundColor: chartColors,
                    borderColor: '#111827',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                    }
                },
                onClick: (event, elements, chart) => {
                    if (elements.length > 0) {
                        const firstElement = elements[0];
                        const label = chart.data.labels[firstElement.index];
                        // If it's a region click, show region details (this was already there)
                        showRegionDetails(label);
                    }
                }
            }
        });
    }

    // New Chart: Value Distribution by Year/Decade
    function renderChartValueByYear() {
        const ctx = document.getElementById('chart-value-by-year').getContext('2d');
        if (Chart.getChart('chart-value-by-year')) { // Use Chart.getChart to destroy specific chart instances
            Chart.getChart('chart-value-by-year').destroy();
        }

        const yearValues = {};
        collectionData.forEach(item => {
            if (item.year) {
                const decade = Math.floor(item.year / 10) * 10;
                yearValues[decade] = (yearValues[decade] || 0) + (getItemValueInCurrency(item, currencySetting) * (item.quantity || 1));
            }
        });

        // Sort by year/decade
        const sortedYears = Object.keys(yearValues).sort((a, b) => parseInt(a) - parseInt(b));
        const sortedValues = sortedYears.map(year => yearValues[year]);

        valueByYearChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedYears.map(year => `${year}s`),
                datasets: [{
                    label: 'Total Value (USD)',
                    data: sortedValues,
                    backgroundColor: '#FCD34D', // Yellow
                    borderColor: '#111827',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#d1d5db' },
                        grid: { color: '#374151' }
                    },
                    y: {
                        ticks: {
                            color: '#d1d5db',
                            callback: function(value) {
                                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
                            }
                        },
                        grid: { color: '#374151' }
                    }
                }
            }
        });
    }

    // Function to show country details in a modal
    function showCountryDetailsModal(countryName) {
        const countryDetailsModal = document.getElementById('country-details-modal');
        const countryDetailsTitle = document.getElementById('country-details-title');
        const countryTotalItems = document.getElementById('country-total-items');
        const countryTotalValue = document.getElementById('country-total-value');
        const countryItemsTableBody = document.getElementById('country-items-table-body');

        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to view country details.', () => {});
            return;
        }

        const itemsInCountry = collectionData.filter(item => getGeoChartCountryName(item.country) === countryName);

        // Calculate summary stats for the country
        const totalItemsInCountry = itemsInCountry.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const totalValueInCountry = itemsInCountry.reduce((sum, item) => sum + (getItemValueInCurrency(item, currencySetting) * (item.quantity || 1)), 0);

        safeSetTextContent(countryDetailsTitle, `${escapeHtml(countryName)} Collection Details`);
        safeSetTextContent(countryTotalItems, String(totalItemsInCountry));
        safeSetTextContent(countryTotalValue, formatCurrency(totalValueInCountry, currencySetting));

        itemsInCountry.sort((a, b) => {
            const yearCompare = (a.year || Infinity) - (b.year || Infinity); // Sort by year, N/A last
            if (yearCompare !== 0) return yearCompare;
            return a.denomination.localeCompare(b.denomination);
        });

        const tableRows = itemsInCountry.map(item => `
            <tr class="border-b border-gray-700">
                <td class="p-4">${escapeHtml(item.id)}</td>
                <td class="p-4">${escapeHtml(item.type)}</td>
                <td class="p-4">${item.year ? escapeHtml(String(item.year)) : 'N/A'}</td>
                <td class="p-4">${escapeHtml(item.denomination)}</td>
                <td class="p-4">${item.quantity || 1}</td>
                <td class="p-4">${formatCurrency(getItemValueInCurrency(item, currencySetting) * (item.quantity || 1), currencySetting)}</td>
                <td class="p-4 text-xs">${escapeHtml(item.notes || 'N/A')}</td>
            </tr>
        `).join('');
        const safeCountryName = escapeHtml(countryName);
        countryItemsTableBody.innerHTML = tableRows.length > 0 ? tableRows : `<tr><td colspan="7" class="p-4 text-center text-gray-500">No items found for ${safeCountryName}.</td></tr>`;

        openModal('country-details-modal');
    }


    // --- COLLECTION INTERACTIVITY ---
    // Store current filtered results for export
    let currentFilteredResults = [];

    function initializeFilters() {
        const searchInput = document.getElementById('search-input');
        const regionFilter = document.getElementById('region-filter');
        const typeFilter = document.getElementById('type-filter');
        const clearSearchBtn = document.getElementById('clear-search-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const resultCountBadge = document.getElementById('collection-result-count');

        const updateResultCount = (filteredCount, totalCount) => {
            if (resultCountBadge) {
                if (filteredCount !== totalCount) {
                    resultCountBadge.textContent = `${filteredCount} of ${totalCount}`;
                    resultCountBadge.classList.remove('hidden');
                } else {
                    resultCountBadge.classList.add('hidden');
                }
            }
        };

        const updateClearSearchButton = () => {
            if (clearSearchBtn) {
                if (searchInput.value.trim()) {
                    clearSearchBtn.classList.remove('hidden');
                } else {
                    clearSearchBtn.classList.add('hidden');
                }
            }
        };

        const applyFilters = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRegion = regionFilter.value;
            const selectedType = typeFilter.value;

            // First, sort favorites to top before filtering
            const sortedCollectionData = [...collectionData].sort((a, b) => {
                if (a.is_favorite && !b.is_favorite) return -1;
                if (!a.is_favorite && b.is_favorite) return 1;
                return 0;
            });

            const filtered = sortedCollectionData.filter(item => {
                const matchesSearch = searchTerm === '' ||
                                      String(item.id).toLowerCase().includes(searchTerm) ||
                                      (item.country && item.country.toLowerCase().includes(searchTerm)) || // Added null check
                                      (item.denomination && item.denomination.toLowerCase().includes(searchTerm)) || // Added null check
                                      (item.notes && item.notes.toLowerCase().includes(searchTerm)) ||
                                      (item.year && item.year.toString().includes(searchTerm));
                const matchesRegion = selectedRegion === '' || item.region === selectedRegion;
                const matchesType = selectedType === '' || item.type === selectedType;
                const matchesFavorite = currentFilter !== 'favorites' || (item.is_favorite === true);
                return matchesSearch && matchesRegion && matchesType && matchesFavorite;
            });
            
            currentFilteredResults = filtered; // Store for export
            originalFilteredOrder = [...filtered]; // Store original order
            currentSort = { column: null, direction: null }; // Reset sort when filters change
            updateResultCount(filtered.length, collectionData.length);
            renderCollectionTable(filtered);
            attachSortEventListeners(); // Reattach sort listeners after rendering
        };

        const clearAllFilters = () => {
            searchInput.value = '';
            regionFilter.value = '';
            typeFilter.value = '';
            currentFilter = null;
            const favoritesBtn = document.getElementById('favorites-filter-btn');
            if (favoritesBtn) {
                favoritesBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                favoritesBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            }
            updateClearSearchButton();
            applyFilters();
        };

        const uniqueRegions = [...new Set(collectionData.map(item => item.region))].sort();
        regionFilter.innerHTML = '<option value="">All Regions</option>' + uniqueRegions.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('');

        const uniqueTypes = [...new Set(collectionData.map(item => item.type))].sort();
        typeFilter.innerHTML = '<option value="">All Types</option>' + uniqueTypes.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

        // Event listeners
        const debouncedApplyFilters = debounce(applyFilters, 300);
        searchInput.addEventListener('input', () => {
            updateClearSearchButton();
            debouncedApplyFilters();
        });
        regionFilter.addEventListener('change', applyFilters);
        typeFilter.addEventListener('change', applyFilters);
        
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                updateClearSearchButton();
                applyFilters();
                searchInput.focus();
            });
        }
        
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', clearAllFilters);
        }
        
        // Favorites filter button
        const favoritesBtn = document.getElementById('favorites-filter-btn');
        if (favoritesBtn) {
            favoritesBtn.addEventListener('click', () => {
                if (currentFilter === 'favorites') {
                    // Turn off favorites filter
                    currentFilter = null;
                    favoritesBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                    favoritesBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                } else {
                    // Turn on favorites filter
                    currentFilter = 'favorites';
                    favoritesBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    favoritesBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                }
                applyFilters();
            });
        }

        // Initial update
        updateResultCount(collectionData.length, collectionData.length);
        updateClearSearchButton();
    }

    function initializeActionButtons() {
        // Favorite toggle functionality
        document.querySelectorAll('.favorite-btn').forEach(button => {
            // Remove any existing listeners by cloning the button
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', async (e) => {
                e.stopPropagation();
                e.preventDefault();
                const id = parseInt(newButton.dataset.id);
                const currentFavorite = newButton.dataset.favorite === 'true' || newButton.dataset.favorite === true;
                
                // Disable button during request to prevent double-clicks
                newButton.disabled = true;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/coins/${id}/toggle-favorite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || 'Failed to toggle favorite');
                    }
                    
                    const result = await response.json();
                    // Normalize to strict boolean
                    const newFavoriteStatus = !!(result.is_favorite === true || result.is_favorite === 'true' || result.is_favorite === 1 || result.is_favorite === 'True');
                    
                    console.log('Toggle favorite result:', result, 'Normalized to:', newFavoriteStatus);
                    
                    // Update the item in collectionData
                    const item = collectionData.find(d => d.id === id);
                    if (item) {
                        // Ensure is_favorite is a strict boolean
                        item.is_favorite = newFavoriteStatus;
                        console.log('Updated item is_favorite:', item.id, item.is_favorite, typeof item.is_favorite);
                    }
                    
                    // Re-enable button
                    newButton.disabled = false;
                    
                    // Sort favorites to the top - favorites first, then others
                    const sortedData = [...collectionData].sort((a, b) => {
                        // Favorites first
                        if (a.is_favorite && !b.is_favorite) return -1;
                        if (!a.is_favorite && b.is_favorite) return 1;
                        // Keep original order for items with same favorite status
                        return 0;
                    });
                    
                    // Get current filtered data if filters are active
                    let dataToRender = sortedData;
                    if (currentFilter === 'favorites') {
                        // If favorites filter is active, show only favorites (already sorted to top)
                        dataToRender = sortedData.filter(item => item.is_favorite === true);
                    } else {
                        // Apply other active filters (region, type, search)
                        const searchInput = document.getElementById('search-input');
                        const regionFilter = document.getElementById('region-filter');
                        const typeFilter = document.getElementById('type-filter');
                        
                        if (searchInput || regionFilter || typeFilter) {
                            const searchTerm = searchInput?.value.toLowerCase() || '';
                            const selectedRegion = regionFilter?.value || '';
                            const selectedType = typeFilter?.value || '';
                            
                            dataToRender = sortedData.filter(item => {
                                const matchesSearch = searchTerm === '' ||
                                                      String(item.id).toLowerCase().includes(searchTerm) ||
                                                      (item.country && item.country.toLowerCase().includes(searchTerm)) ||
                                                      (item.denomination && item.denomination.toLowerCase().includes(searchTerm)) ||
                                                      (item.notes && item.notes.toLowerCase().includes(searchTerm)) ||
                                                      (item.year && item.year.toString().includes(searchTerm));
                                const matchesRegion = selectedRegion === '' || item.region === selectedRegion;
                                const matchesType = selectedType === '' || item.type === selectedType;
                                return matchesSearch && matchesRegion && matchesType;
                            });
                        }
                    }
                    
                    // Update currentFilteredResults and originalFilteredOrder
                    currentFilteredResults = [...dataToRender];
                    originalFilteredOrder = [...dataToRender];
                    
                    // Re-render the table (this will create new buttons with correct state from item.is_favorite)
                    renderCollectionTable(dataToRender);
                    
                    // Update result count if the function is available
                    const resultCountBadge = document.getElementById('collection-result-count');
                    if (resultCountBadge) {
                        if (dataToRender.length !== collectionData.length) {
                            resultCountBadge.textContent = `${dataToRender.length} of ${collectionData.length}`;
                            resultCountBadge.classList.remove('hidden');
                        } else {
                            resultCountBadge.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    showCustomConfirm('Failed to update favorite status: ' + error.message, () => {});
                    // Re-enable button on error
                    const button = document.querySelector(`.favorite-btn[data-id="${id}"]`);
                    if (button) button.disabled = false;
                }
            });
        });

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = parseInt(button.dataset.id); // Ensure ID is parsed as integer
                const item = collectionData.find(d => d.id === id);
                if (item) {
                    document.getElementById('item-id').value = item.id;
                    safeSetTextContent(document.getElementById('modal-title'), 'Edit Item');
                    document.getElementById('type').value = item.type;
                    document.getElementById('country').value = item.country;
                    document.getElementById('year').value = item.year;
                    document.getElementById('denomination').value = item.denomination;
                    document.getElementById('value').value = item.value;
                    document.getElementById('quantity').value = item.quantity || 1;
                    document.getElementById('notes').value = item.notes;
                    document.getElementById('referenceUrl').value = item.referenceUrl;
                    document.getElementById('localImagePath').value = item.localImagePath || '';
                    // Set bullion fields if applicable
                    if (item.weight_grams) document.getElementById('weight_grams').value = item.weight_grams;
                    if (item.purity_percent) document.getElementById('purity_percent').value = item.purity_percent;
                    
                    // Handle image preview - determine if it's a URL or base64
                    const imagePath = item.localImagePath || '';
                    if (imagePath) {
                        if (imagePath.startsWith('data:') || imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                            // It's a URL or base64, show preview and set to URL mode
                            toggleImageInput('url');
                            showImagePreview(imagePath);
                        } else {
                            // Might be a base64 without prefix, try showing it
                            toggleImageInput('url');
                            if (imagePath.length > 100) { // Likely base64
                                showImagePreview('data:image/jpeg;base64,' + imagePath);
                            }
                        }
                    } else {
                        toggleImageInput('url');
                        clearImagePreview();
                    }
                    
                    openModal('item-modal'); // Pass modal ID
                }
            });
        });

        // Duplicate item functionality
        document.querySelectorAll('.duplicate-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = parseInt(button.dataset.id);
                const item = collectionData.find(d => d.id === id);
                if (item) {
                    // Clear item ID to create new item
                    document.getElementById('item-id').value = '';
                    safeSetTextContent(document.getElementById('modal-title'), 'Duplicate Item');
                    document.getElementById('type').value = item.type;
                    document.getElementById('country').value = item.country;
                    document.getElementById('year').value = item.year;
                    document.getElementById('denomination').value = item.denomination;
                    document.getElementById('value').value = item.value;
                    document.getElementById('quantity').value = item.quantity || 1;
                    document.getElementById('notes').value = item.notes;
                    document.getElementById('referenceUrl').value = item.referenceUrl;
                    document.getElementById('localImagePath').value = item.localImagePath;
                    // Set bullion fields if applicable
                    if (item.weight_grams) document.getElementById('weight_grams').value = item.weight_grams;
                    if (item.purity_percent) document.getElementById('purity_percent').value = item.purity_percent;
                    openModal('item-modal');
                }
            });
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const idToDelete = parseInt(button.dataset.id);
                showCustomConfirm('Are you sure you want to delete this item?', async () => {
                    if (!isAuthenticated()) {
                        showCustomConfirm('Please sign in to delete items.', () => {});
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/coins/${idToDelete}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                handleUnauthorized();
                                return;
                            }
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        showCustomConfirm(result.message || 'Item deleted successfully!', () => {});
                        loadCollectionFromBackend(); // Reload data after deletion
                    } catch (error) {
                        console.error("Error deleting item:", error);
                        const safeMessage = escapeHtml(error.message || 'An unexpected error occurred');
                        showCustomConfirm(`Failed to delete item: ${safeMessage}. Please check your connection and try again.`, () => {});
                    }
                });
            });
        });
    }

    // --- COLLECTION RENDERING ---
    let currentSort = { column: null, direction: null }; // null = original/unsorted
    let originalFilteredOrder = []; // Store original order for reset
    let currentFilter = null; // Track active filter ('favorites' or null)

    function renderCollection(filteredData = collectionData) {
        console.log('Rendering collection with data:', filteredData);
        console.log('Number of items to render:', filteredData.length);
        const collectionContent = document.getElementById('content-collection');
        const collectionContentWrapper = collectionContent.querySelector('.max-w-7xl.mx-auto');
        if (!collectionContentWrapper) return;

        if (!isAuthenticated()) {
            collectionContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to manage your collection.</p></div>`;
            return;
        }

        collectionContentWrapper.innerHTML = `
            <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="flex items-center space-x-3">
                    <h1 class="text-3xl font-bold text-white">Collection</h1>
                    <span id="collection-result-count" class="px-3 py-1 bg-emerald-600 text-white text-sm rounded-full font-semibold hidden"></span>
                    <div id="collection-stats-badge" class="px-3 py-1 bg-blue-600 text-white text-sm rounded-full font-semibold hidden">
                        <span id="stats-items-count">0</span> items ‚Ä¢ <span id="stats-total-value">$0.00</span>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                    <div class="relative w-full sm:w-auto">
                        <input type="text" id="search-input" placeholder="Search... (Ctrl+F)" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2 pr-8">
                        <button id="clear-search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white hidden" title="Clear search">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                    <select id="region-filter" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2"></select>
                    <select id="type-filter" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2"></select>
                    <button id="favorites-filter-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition-colors text-sm" title="Show only favorites">
                        <i class="ph ph-star mr-1"></i> Favorites
                    </button>
                    <button id="clear-filters-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition-colors text-sm" title="Clear all filters">
                        <i class="ph ph-x-circle mr-1"></i> Clear
                    </button>
                </div>
            </div>
            <div id="bulk-actions-toolbar" class="hidden mb-4 p-3 bg-gray-800 rounded-lg border border-emerald-600 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-white font-semibold" id="bulk-selected-count">0 items selected</span>
                    <button id="select-all-btn" class="text-blue-400 hover:text-blue-300 text-sm">Select All</button>
                    <button id="select-none-btn" class="text-gray-400 hover:text-gray-300 text-sm">Select None</button>
                </div>
                <button id="bulk-delete-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition-colors font-semibold">
                    <i class="ph ph-trash mr-2"></i>Delete Selected
                </button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-full flex flex-col">
                    <div class="flex-1 overflow-y-auto overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
                        <table class="w-full text-left data-table" style="min-width: 100%; table-layout: fixed;">
                            <thead class="bg-gray-700 sticky top-0" style="z-index: 20;">
                                <tr>
                                    <th class="p-2 font-semibold cursor-pointer" data-sort-column="id" style="width: 110px;">
                                        <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-emerald-600 focus:ring-emerald-500 mr-2" title="Select all items">
                                        ID
                                    </th>
                                    <th class="p-2 font-semibold" style="width: 80px;">Image</th>
                                    <th class="p-2 font-semibold" style="width: 100px;">Type</th>
                                    <th class="p-2 font-semibold cursor-pointer" data-sort-column="country" style="width: 140px;">Country</th>
                                    <th class="p-2 font-semibold cursor-pointer" data-sort-column="year" style="width: 80px;">Year</th>
                                    <th class="p-2 font-semibold" style="width: 140px;">Denomination</th>
                                    <th class="p-2 font-semibold cursor-pointer" data-sort-column="quantity" style="width: 60px;">Qty</th>
                                    <th class="p-2 font-semibold cursor-pointer" data-sort-column="value" style="width: 120px;">Value</th>
                                    <th class="p-2 font-semibold" style="width: 200px;">Notes & Ref.</th>
                                    <th class="p-2 font-semibold" style="width: 140px; position: sticky; right: 0; background-color: #374151; z-index: 15;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="collection-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        initializeFilters();
        if (filteredData.length === 0) {
            const tableBody = document.getElementById('collection-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="p-8 text-center text-gray-500">
                        <div class="flex flex-col items-center space-y-4">
                            <i class="ph ph-coin text-4xl"></i>
                            <p class="text-lg">Your collection is empty</p>
                            <p class="text-sm">Click the "Quick Add" button to add your first item!</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            // Sort favorites to top before rendering
            const sortedData = [...filteredData].sort((a, b) => {
                if (a.is_favorite && !b.is_favorite) return -1;
                if (!a.is_favorite && b.is_favorite) return 1;
                return 0;
            });
            originalFilteredOrder = [...sortedData]; // Store original order on initial render
            currentFilteredResults = currentFilteredResults.length > 0 ? currentFilteredResults : [...sortedData]; // Initialize if empty
            renderCollectionTable(sortedData);
        }
        attachSortEventListeners();
        updateCollectionStats();
    };

    function renderCollectionTable(dataToRender) {
        const tableBody = document.getElementById('collection-table-body');
        if (!tableBody) {
            console.error('collection-table-body not found');
            return;
        }
        const tableRows = dataToRender.map(item => {
            // Only use localImagePath if it's a valid URL, not a local file path
            const imageUrl = item.localImagePath && 
                           item.localImagePath !== "https://placehold.co/300x300/1f2937/d1d5db?text=No+Image" &&
                           (item.localImagePath.startsWith('http://') || item.localImagePath.startsWith('https://') || item.localImagePath.startsWith('data:')) 
                           ? item.localImagePath : null;
            // Check if item is favorite - handle all possible formats
            const isFavorite = !!(item.is_favorite === true || item.is_favorite === 'true' || item.is_favorite === 1 || item.is_favorite === 'True' || item.is_favorite);
            console.log('Rendering item:', item.id, 'is_favorite:', item.is_favorite, 'typeof:', typeof item.is_favorite, 'isFavorite:', isFavorite);
            
            return `
            <tr class="border-b border-gray-700" data-item-id="${item.id}">
                <td class="p-2" style="width: 110px;">
                    <input type="checkbox" class="item-checkbox w-4 h-4 rounded border-gray-600 bg-gray-700 text-emerald-600 focus:ring-emerald-500 mr-2" data-item-id="${item.id}" title="Select item">
                    ${item.id}
                </td>
                <td class="p-2" style="width: 80px;">
                    ${imageUrl ? `
                        <div class="relative inline-block">
                            <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(item.denomination)}" 
                                 class="collection-image-zoom w-12 h-12 object-contain rounded bg-gray-700 p-1" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                            <i class="ph ph-image text-gray-600 text-xl hidden" style="display: none;"></i>
                        </div>
                    ` : `
                        <i class="ph ph-image text-gray-600 text-xl"></i>
                    `}
                </td>
                <td class="p-2" style="width: 100px;">${escapeHtml(item.type)}</td>
                <td class="p-2" style="width: 140px;">${escapeHtml(item.country)} ${item.isHistorical ? '<span class="text-xs text-amber-400">(Historical)</span>' : ''}</td>
                <td class="p-2" style="width: 80px;">${item.year || 'N/A'}</td>
                <td class="p-2" style="width: 140px;">${escapeHtml(item.denomination)}</td>
                <td class="p-2" style="width: 60px;">${item.quantity || 1}</td>
                <td class="p-2" style="width: 120px;">${formatCurrency(getItemValueInCurrency(item, currencySetting) * (item.quantity || 1), currencySetting)}</td>
                <td class="p-2" style="width: 200px;">
                    <div class="flex flex-col">
                        <p class="text-xs text-gray-400 truncate" title="${item.notes ? escapeHtml(item.notes) : 'N/A'}">
                            ${escapeHtml(item.notes || 'N/A')}
                        </p>
                        ${item.referenceUrl ? `<a href="${escapeHtml(item.referenceUrl)}" target="_blank" class="text-blue-400 hover:underline text-xs view-reference-link"><i class="ph-bold ph-link-simple-horizontal"></i> Reference Link</a>` : ''}
                    </div>
                </td>
                <td class="p-2" style="width: 140px; position: sticky; right: 0; background-color: #1f2937; z-index: 10;">
                     <button class="favorite-btn ${isFavorite ? 'text-yellow-400' : 'text-gray-400'} hover:text-yellow-300 mr-2 text-xl" data-id="${item.id}" data-favorite="${isFavorite ? 'true' : 'false'}" title="${isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}">${isFavorite ? '‚≠ê' : '‚òÜ'}</button>
                     <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2" data-id="${item.id}" title="Edit Item"><i class="ph ph-pencil-simple"></i></button>
                     <button class="duplicate-btn text-emerald-400 hover:text-emerald-300 mr-2" data-id="${item.id}" title="Duplicate Item"><i class="ph ph-copy"></i></button>
                     <button class="delete-btn text-red-400 hover:text-red-300" data-id="${item.id}" title="Delete Item"><i class="ph ph-trash"></i></button>
                </td>
            </tr>
        `;
        }).join('');
        tableBody.innerHTML = tableRows;

        initializeActionButtons();
        initializeBulkSelection();
        
        // Reattach sort listeners after table is updated
        setTimeout(() => {
            attachSortEventListeners();
        }, 0);
    }

    // --- BULK SELECTION FUNCTIONALITY ---
    function initializeBulkSelection() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const bulkActionsToolbar = document.getElementById('bulk-actions-toolbar');
        const bulkSelectedCount = document.getElementById('bulk-selected-count');
        const selectAllBtn = document.getElementById('select-all-btn');
        const selectNoneBtn = document.getElementById('select-none-btn');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

        const updateBulkToolbar = () => {
            const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
            const count = checkedBoxes.length;
            
            if (!bulkActionsToolbar || !bulkSelectedCount) {
                return; // Elements don't exist, skip
            }
            
            if (count > 0) {
                bulkActionsToolbar.classList.remove('hidden');
                bulkSelectedCount.textContent = `${count} item${count !== 1 ? 's' : ''} selected`;
            } else {
                bulkActionsToolbar.classList.add('hidden');
            }

            // Update select all checkbox state
            if (selectAllCheckbox) {
                if (count === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (count === itemCheckboxes.length) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                    selectAllCheckbox.checked = false;
                }
            }
        };

        // Select all checkbox in header
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', (e) => {
                itemCheckboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
                updateBulkToolbar();
            });
        }

        // Individual item checkboxes
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkToolbar);
            // Prevent row click from toggling checkbox
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });

        // Select All button
        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', () => {
                itemCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                updateBulkToolbar();
            });
        }

        // Select None button
        if (selectNoneBtn) {
            selectNoneBtn.addEventListener('click', () => {
                itemCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                updateBulkToolbar();
            });
        }

        // Bulk delete button
        if (bulkDeleteBtn) {
            bulkDeleteBtn.addEventListener('click', async () => {
                const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
                const selectedIds = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.itemId));
                
                if (selectedIds.length === 0) {
                    showCustomConfirm('Please select items to delete.', () => {});
                    return;
                }

                const itemCount = selectedIds.length;
                showCustomConfirm(
                    `Are you sure you want to delete ${itemCount} item${itemCount !== 1 ? 's' : ''}? This action cannot be undone.`,
                    async () => {
                        if (!isAuthenticated()) {
                            showCustomConfirm('Please sign in to delete items.', () => {});
                            return;
                        }

                        setLoadingState(bulkDeleteBtn.id || 'bulk-delete-btn', true, 'Deleting...');
                        
                        try {
                            let successCount = 0;
                            let errorCount = 0;

                            // Delete items in parallel
                            const deletePromises = selectedIds.map(async (id) => {
                                try {
                                    const response = await fetch(`${API_BASE_URL}/coins/${id}`, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                                    });

                                    if (!response.ok) {
                                        if (response.status === 401) {
                                            handleUnauthorized();
                                            throw new Error('Unauthorized');
                                        }
                                        throw new Error(`Failed to delete item ${id}`);
                                    }
                                    successCount++;
                                } catch (error) {
                                    errorCount++;
                                    console.error(`Error deleting item ${id}:`, error);
                                }
                            });

                            await Promise.all(deletePromises);

                            if (successCount > 0) {
                                showCustomConfirm(
                                    `Successfully deleted ${successCount} item${successCount !== 1 ? 's' : ''}${errorCount > 0 ? `. ${errorCount} item${errorCount !== 1 ? 's' : ''} failed to delete.` : ''}`,
                                    () => {}
                                );
                                loadCollectionFromBackend(); // Reload data after deletion
                            } else {
                                showCustomConfirm('Failed to delete items. Please try again.', () => {});
                            }
                        } catch (error) {
                            console.error("Error during bulk delete:", error);
                            const safeMessage = escapeHtml(error.message || 'An unexpected error occurred');
                            showCustomConfirm(`Failed to delete items: ${safeMessage}. Please check your connection and try again.`, () => {});
                        } finally {
                            setLoadingState(bulkDeleteBtn.id || 'bulk-delete-btn', false);
                        }
                    }
                );
            });
        }

        // Initial update
        updateBulkToolbar();
    }

    // --- COLLECTION STATISTICS ---
    function updateCollectionStats() {
        const statsBadge = document.getElementById('collection-stats-badge');
        const statsItemsCount = document.getElementById('stats-items-count');
        const statsTotalValue = document.getElementById('stats-total-value');

        if (!statsBadge || !statsItemsCount || !statsTotalValue) return;

        const totalItems = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const totalValue = collectionData.reduce((sum, item) => {
            if (item.type === 'Gold Bullion' || item.type === 'Silver Bullion') {
                return sum + (calculateBullionValue(item) * (item.quantity || 1));
            } else {
                return sum + (getItemValueInCurrency(item, currencySetting) * (item.quantity || 1));
            }
        }, 0);

        if (totalItems > 0) {
            safeSetTextContent(statsItemsCount, String(totalItems));
            safeSetTextContent(statsTotalValue, formatCurrency(totalValue, currencySetting));
            statsBadge.classList.remove('hidden');
        } else {
            statsBadge.classList.add('hidden');
        }
    }

    // Store sort handler to allow removal
    let sortHandler = null;
    let sortTableElement = null;
    
    // Update sort indicators on headers
    function updateSortIndicators() {
        console.log('updateSortIndicators called, currentSort:', currentSort);
        const tableBody = document.getElementById('collection-table-body');
        if (!tableBody) {
            console.warn('updateSortIndicators: table body not found');
            return;
        }
        
        const table = tableBody.closest('table');
        if (!table) {
            console.warn('updateSortIndicators: table not found');
            return;
        }
        
        const headers = table.querySelectorAll('th[data-sort-column]');
        console.log('updateSortIndicators: found', headers.length, 'headers');
        
        headers.forEach(header => {
            const column = header.getAttribute('data-sort-column');
            let sortSpan = header.querySelector('.sort-indicator');
            
            // Remove existing indicator
            if (sortSpan) {
                sortSpan.remove();
            }
            
            // Add indicator if this column is being sorted
            if (currentSort.column === column && currentSort.direction !== null) {
                console.log('Adding indicator for column:', column, 'direction:', currentSort.direction);
                const indicator = document.createElement('span');
                indicator.className = 'sort-indicator';
                indicator.textContent = currentSort.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
                indicator.style.color = '#10b981'; // emerald-500
                indicator.style.fontWeight = 'bold';
                indicator.style.marginLeft = '4px';
                indicator.style.display = 'inline-block';
                
                // Simply append to the header - it will appear after the text
                header.appendChild(indicator);
                console.log('Indicator added to header:', column);
            }
        });
    }
    
    function attachSortEventListeners() {
        console.log('=== attachSortEventListeners CALLED ===');
        
        // Remove old listeners from all tables
        if (sortTableElement && sortHandler) {
            sortTableElement.removeEventListener('click', sortHandler);
        }
        
        // Find ALL tables with collection-table-body (there might be multiple)
        const tableBodies = document.querySelectorAll('#collection-table-body');
        console.log('Found', tableBodies.length, 'table body(ies)');
        
        if (tableBodies.length === 0) {
            console.warn('No collection-table-body found, cannot attach sort listeners');
            return;
        }
        
        // Process each table
        tableBodies.forEach((tableBody, bodyIndex) => {
            const table = tableBody.closest('table');
            if (!table) {
                console.warn('Table not found for body', bodyIndex);
                return;
            }
            
            // Find all sortable headers in this table
            const headers = table.querySelectorAll('th[data-sort-column]');
            if (headers.length === 0) {
                console.warn('No sortable headers found in table', bodyIndex);
                return;
            }
            
            console.log(`Table ${bodyIndex}: Found ${headers.length} sortable headers`);
            
            // Use the first table for the delegation handler
            if (bodyIndex === 0) {
                sortTableElement = table;
            }
            
            // Attach listeners directly to each header
            headers.forEach((header, index) => {
                const column = header.getAttribute('data-sort-column');
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.title = `Click to sort by ${column}`;
                
                // Remove old handler if exists
                if (header._sortHandler) {
                    header.removeEventListener('click', header._sortHandler);
                }
                
                // Simple click handler
                const headerClickHandler = function(e) {
                    const target = e.target;
                    
                    // Skip if clicking checkbox or button
                    if (target.type === 'checkbox' || target.tagName === 'BUTTON' || target.closest('input[type="checkbox"]') || target.closest('button')) {
                        return;
                    }
                    
                    console.log('HEADER CLICKED:', column);
                    
                    let direction = 'asc';
                    if (currentSort.column === column) {
                        if (currentSort.direction === 'asc') {
                            direction = 'desc';
                        } else if (currentSort.direction === 'desc') {
                            direction = null;
                        } else {
                            direction = 'asc';
                        }
                    }
                    
                    console.log('SORTING:', column, direction);
                    sortCollection(column, direction);
                    currentSort = { column, direction };
                    // Update indicators after a brief delay to ensure DOM is updated
                    setTimeout(() => {
                        updateSortIndicators();
                    }, 10);
                };
                
                header._sortHandler = headerClickHandler;
                header.addEventListener('click', headerClickHandler);
                console.log(`  ‚úì Attached handler to header ${index}: ${column}`);
            });
        });
        
        // Create delegation handler for table-level backup
        sortHandler = function(event) {
            const clickedElement = event.target;
            
            // Don't trigger if clicking directly on checkbox or its label
            if (clickedElement.type === 'checkbox' || 
                clickedElement.tagName === 'INPUT' || 
                clickedElement.closest('input[type="checkbox"]')) {
                return;
            }
            
            // Find the clicked header
            let header = clickedElement.closest('th[data-sort-column]');
            
            if (!header) {
                return;
            }
            
            const column = header.getAttribute('data-sort-column');
            if (!column) {
                return;
            }
            
            console.log('‚úì Table delegation: Click detected on sortable header:', column);
            
            let direction = 'asc';
            if (currentSort.column === column) {
                if (currentSort.direction === 'asc') {
                    direction = 'desc';
                } else if (currentSort.direction === 'desc') {
                    direction = null;
                } else {
                    direction = 'asc';
                }
            }

            console.log('‚úì Table delegation: Sorting by:', column, 'direction:', direction);
            
            sortCollection(column, direction);
            currentSort = { column, direction };
            setTimeout(() => {
                updateSortIndicators();
            }, 10);
        };
        
        // Attach table-level delegation to first table
        if (sortTableElement) {
            sortTableElement.addEventListener('click', sortHandler);
        }
        
        // Update sort indicators
        updateSortIndicators();
        
        console.log('=== attachSortEventListeners COMPLETE ===');
    }

    function sortCollection(column, direction) {
        console.log('sortCollection called:', column, direction, 'currentSort:', currentSort);
        
        // ALWAYS sort from the original order, not from already-sorted data
        // This ensures clicking again toggles between asc/desc correctly
        let dataToSort;
        if (originalFilteredOrder.length > 0) {
            // Use the original filtered order as the base
            dataToSort = [...originalFilteredOrder];
            console.log('Using originalFilteredOrder, length:', dataToSort.length);
        } else if (currentFilteredResults.length > 0) {
            // If no original order stored, use current filtered results
            dataToSort = [...currentFilteredResults];
            console.log('Using currentFilteredResults, length:', dataToSort.length);
        } else {
            // Fallback to full collection
            dataToSort = [...collectionData];
            console.log('Using collectionData, length:', dataToSort.length);
        }
        
        // If direction is null, restore original order
        if (direction === null) {
            if (originalFilteredOrder.length > 0) {
                renderCollectionTable([...originalFilteredOrder]);
                currentFilteredResults = [...originalFilteredOrder]; // Update filtered results
            } else {
                renderCollectionTable([...dataToSort]);
                currentFilteredResults = [...dataToSort];
            }
            setTimeout(() => {
                updateSortIndicators(); // Clear arrows when returning to original
            }, 50);
            return;
        }

        const sortedData = [...dataToSort].sort((a, b) => {
            let valA, valB;

            if (column === 'value') {
                // For value, use the calculated value including quantity
                valA = getItemValueInCurrency(a, currencySetting) * (a.quantity || 1);
                valB = getItemValueInCurrency(b, currencySetting) * (b.quantity || 1);
            } else if (column === 'year' || column === 'id' || column === 'quantity') {
                // Ensure numbers are treated as numbers and handle N/A/null for sorting
                valA = a[column];
                valB = b[column];
                valA = (valA === null || valA === 'N/A' || valA === undefined || valA === '') ? (direction === 'asc' ? Infinity : -Infinity) : parseFloat(valA);
                valB = (valB === null || valB === 'N/A' || valB === undefined || valB === '') ? (direction === 'asc' ? Infinity : -Infinity) : parseFloat(valB);
            } else if (column === 'country') {
                // String comparison for country
                valA = String(a[column] || '');
                valB = String(b[column] || '');
            } else {
                valA = a[column];
                valB = b[column];
            }

            // Perform comparison
            if (column === 'year' || column === 'value' || column === 'id' || column === 'quantity') {
                return direction === 'asc' ? valA - valB : valB - valA;
            } else { // String comparison (country, etc.)
                return direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
            }
        });
        
        console.log('Sorted data length:', sortedData.length, 'First item:', sortedData[0]);
        renderCollectionTable(sortedData);
        // Update filtered results to the sorted data so next sort works correctly
        currentFilteredResults = [...sortedData];
        
        // Update indicators after table is rendered
        setTimeout(() => {
            updateSortIndicators();
        }, 50);
    }


    // Render Map
    function renderGeoChart() {
        // Check for 3D mode
        if (is3DMode) {
            if (!map3dInstance) {
                map3dInstance = new Map3D('globe-container');
                map3dInstance.init(showCountryDetailsModal);
            }
            map3dInstance.renderData(collectionData);
            // Ensure visibility is correct (in case we switched modes but didn't toggle classes yet, though toggle does it)
            document.getElementById('map-container').classList.add('hidden');
            document.getElementById('globe-container').classList.remove('hidden');
            return;
        }

        console.log('Rendering GeoChart with collection data:', collectionData);
        console.log('Number of items for map:', collectionData.length);
        const mapContentWrapper = document.getElementById('content-map').querySelector('.max-w-7xl.mx-auto');
        if (!mapContentWrapper) {
            console.error('Error: GeoChart content wrapper element not found!');
            return;
        }

        if (!isAuthenticated()) {
            mapContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view the map.</p></div>`;
            return;
        }
        
        // Ensure the map container is present within the wrapper before rendering
        if (!mapContentWrapper.querySelector('#map-wrapper')) {
             mapContentWrapper.innerHTML = `
                <div id="map-wrapper" class="relative h-[95%] w-full rounded-lg border border-gray-700 overflow-hidden">
                    <div class="absolute top-4 right-4 z-10 flex flex-col gap-2">
                        <button id="zoom-in-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md transition-colors border border-gray-600 shadow-lg" title="Zoom In">
                            <i class="ph-bold ph-plus"></i>
                        </button>
                        <button id="zoom-out-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md transition-colors border border-gray-600 shadow-lg" title="Zoom Out">
                            <i class="ph-bold ph-minus"></i>
                        </button>
                        <button id="zoom-reset-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-md transition-colors border border-gray-600 shadow-lg" title="Reset Zoom">
                            <i class="ph-bold ph-arrows-clockwise"></i>
                        </button>
                    </div>
                    <div id="map-container" class="h-full w-full relative transform transition-transform duration-200 origin-center">
                        <div id="geochart-canvas" class="h-full w-full"></div>
                    </div>
                </div>`;
        }

        const mapContainer = document.getElementById('geochart-canvas');


        if (geoChart) {
            geoChart.clearChart();
            mapContainer.innerHTML = '';
        }

        // Suppress Google Maps API key warnings in console
        const originalError = console.error;
        const suppressedPatterns = ['Geocoding Service', 'You must use an API key', 'maps-no-account'];
        console.error = function(...args) {
            const message = args.join(' ');
            if (suppressedPatterns.some(pattern => message.includes(pattern))) {
                return; // Suppress Google Maps API key warnings
            }
            originalError.apply(console, args);
        };
        
        google.charts.load('current', {'packages': ['geochart']});
        google.charts.setOnLoadCallback(() => {
            drawRegionsMap();
            // Restore original console.error after map loads (after a delay to catch all warnings)
            setTimeout(() => {
                console.error = originalError;
            }, 2000);
        });

        function drawRegionsMap() {
            const countryCounts = {};
            collectionData.forEach(item => {
                const geoChartCountry = getGeoChartCountryName(item.country);
                if (geoChartCountry) {
                    countryCounts[geoChartCountry] = (countryCounts[geoChartCountry] || 0) + (item.quantity || 1);
                }
            });

            // If Denmark is collected, also highlight Greenland
            if (countryCounts["Denmark"]) {
                countryCounts["Greenland"] = countryCounts["Denmark"];
            }

            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Country');
            dataTable.addColumn('number', 'Items');
            dataTable.addColumn({ type: 'string', role: 'tooltip', 'p': {'html': true} });

            // Add ALL countries to the dataset so tooltips work for all countries
            // This allows hovering over countries you don't have yet
            const allCountriesSet = new Set(ALL_COUNTRIES.map(c => getGeoChartCountryName(c)));
            allCountriesSet.add("Greenland"); // Add Greenland for special case
            
            // Only add countries with items to the dataTable for coloring
            // Countries with 0 items will use defaultColor (grey) automatically
            allCountriesSet.forEach(country => {
                const itemCount = countryCounts[country] || 0;
                let tooltipContent = `<div class=\"p-2 font-semibold\">${country}</div>`;
                
                if (itemCount > 0) {
                    tooltipContent += `<div class=\"px-2 pb-1\">Items: ${itemCount}</div>`;
                    const itemsInCountry = collectionData.filter(item => getGeoChartCountryName(item.country) === country);
                    tooltipContent += `<div class=\"px-2 text-sm text-gray-400 tooltip-scroll-content\">`;
                    itemsInCountry.forEach(item => {
                        const quantity = item.quantity || 1;
                        const value = getItemValueInCurrency(item, currencySetting) * quantity;
                        tooltipContent += `<div>${item.denomination} (${item.year || 'N/A'}) - ${quantity > 1 ? `${quantity}x ` : ''}${formatCurrency(value, currencySetting)}</div>`;
                    });
                    tooltipContent += `</div>`;
                    // Only add countries with items to the dataTable - they'll be colored
                    dataTable.addRow([country, itemCount, tooltipContent]);
                } else {
                    // For countries with 0 items, we don't add them to dataTable
                    // They'll automatically use defaultColor (grey) and won't show tooltips
                    // This is the desired behavior - grey for uncollected countries
                }
            });

            const maxItems = Math.max(1, ...Object.values(countryCounts));

            const options = {
                colorAxis: {
                    colors: ['#d9f99d', '#65a30d', '#facc15', '#f97316', '#dc2626'],
                    minValue: 1, // Start from 1 - countries with 0 items will use defaultColor
                    maxValue: maxItems,
                },
                backgroundColor: {
                    fill: '#1f2937',
                },
                defaultColor: '#374151', // Dark gray for countries with 0 items (not in dataTable)
                tooltip: {
                    isHtml: true,
                    trigger: 'focus', // Show on hover/focus
                    textStyle: { color: '#d1d5db' },
                },
                keepAspectRatio: true,
                legend: { textStyle: { color: '#d1d5db' } },
                enableRegionInteractivity: true, // Enable hover interactions
            };

            if (!geoChart) {
                geoChart = new google.visualization.GeoChart(mapContainer);
            }

            geoChart.draw(dataTable, options);

            // Add event listener for country click
            google.visualization.events.addListener(geoChart, 'select', () => {
                const selection = geoChart.getSelection();
                if (selection.length > 0) {
                    const selectedCountryName = dataTable.getValue(selection[0].row, 0);
                    showCountryDetailsModal(selectedCountryName);
                }
            });

            window.addEventListener('resize', debounce(() => {
                if (geoChart) {
                    geoChart.draw(dataTable, options);
                }
            }, 250));
        }

        // After rendering the map, render the unrecognized places panel
        renderUnrecognizedPlacesPanel();
        
        // Setup zoom controls after map is drawn
        // Use setTimeout to ensure Google Charts has finished rendering
        setTimeout(() => {
            removeMapZoomControls(); // Remove old listeners if any
            zoomControlsSetup = false; // Reset flag to allow re-setup
            setupMapZoomControls();
        }, 1000); // Increased delay to ensure SVG is fully rendered
    }
    
    // Map zoom functionality
    let mapZoomLevel = 1;
    let panX = 0;
    let panY = 0;
    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 3;
    const ZOOM_STEP = 0.2;
    let zoomControlsSetup = false;
    let isPanning = false;
    let panStartX = 0;
    let panStartY = 0;
    
    // Store event handlers to be able to remove them
    let zoomInHandler, zoomOutHandler, zoomResetHandler, wheelHandler;
    let mouseDownHandler, mouseLeaveHandler, mouseUpHandler, mouseMoveHandler;
    
    function setupMapZoomControls() {
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomResetBtn = document.getElementById('zoom-reset-btn');
        const mapContainer = document.getElementById('map-container');
        
        if (!mapContainer || !zoomInBtn || !zoomOutBtn || !zoomResetBtn) {
            // Try again after a short delay if elements aren't ready
            setTimeout(setupMapZoomControls, 100);
            return;
        }
        
        // Remove old handlers first to prevent duplicates
        if (zoomControlsSetup) {
            removeMapZoomControls();
        }
        
        zoomControlsSetup = true;
        
        console.log('Map zoom controls setup complete');
        
        // Zoom in handler
        zoomInHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            mapZoomLevel = Math.min(mapZoomLevel + ZOOM_STEP, MAX_ZOOM);
            console.log('Zoom in:', mapZoomLevel);
            applyZoom();
        };
        zoomInBtn.addEventListener('click', zoomInHandler);
        
        // Zoom out handler
        zoomOutHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            mapZoomLevel = Math.max(mapZoomLevel - ZOOM_STEP, MIN_ZOOM);
            console.log('Zoom out:', mapZoomLevel);
            applyZoom();
        };
        zoomOutBtn.addEventListener('click', zoomOutHandler);
        
        // Reset zoom handler
        zoomResetHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            mapZoomLevel = 1;
            panX = 0;
            panY = 0;
            console.log('Zoom reset');
            applyZoom();
        };
        zoomResetBtn.addEventListener('click', zoomResetHandler);
        
        // Mouse wheel zoom - attach to map-wrapper to avoid conflicts with Google Charts
        const mapWrapper = document.getElementById('map-wrapper');
        if (mapWrapper) {
            wheelHandler = (e) => {
                // Only zoom if not hovering over buttons
                if (!e.target.closest('#zoom-in-btn, #zoom-out-btn, #zoom-reset-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const delta = e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP;
                    mapZoomLevel = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, mapZoomLevel + delta));
                    applyZoom();
                }
            };
            mapWrapper.addEventListener('wheel', wheelHandler, { passive: false });
        }
        
        // Pan functionality (drag to move when zoomed)
        // Attach to the geochart-canvas div or the SVG directly to intercept events before Google Charts
        const geochartCanvas = document.getElementById('geochart-canvas');
        mouseDownHandler = (e) => {
            // Only pan if clicking on the map, not on buttons
            if (mapZoomLevel > 1 && e.button === 0 && !e.target.closest('#zoom-in-btn, #zoom-out-btn, #zoom-reset-btn')) {
                // Check if we're clicking on the SVG or its children
                const svg = geochartCanvas?.querySelector('svg');
                if (svg && (e.target === svg || svg.contains(e.target))) {
                    isPanning = true;
                    panStartX = e.clientX - panX;
                    panStartY = e.clientY - panY;
                    mapContainer.style.cursor = 'grabbing';
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        };
        if (geochartCanvas) {
            geochartCanvas.addEventListener('mousedown', mouseDownHandler, true); // Use capture phase
        }
        
        mouseLeaveHandler = () => {
            isPanning = false;
            mapContainer.style.cursor = mapZoomLevel > 1 ? 'grab' : 'default';
        };
        mapContainer.addEventListener('mouseleave', mouseLeaveHandler);
        
        mouseUpHandler = () => {
            isPanning = false;
            mapContainer.style.cursor = mapZoomLevel > 1 ? 'grab' : 'default';
        };
        document.addEventListener('mouseup', mouseUpHandler);
        
        mouseMoveHandler = (e) => {
            if (!isPanning || mapZoomLevel <= 1) return;
            e.preventDefault();
            e.stopPropagation();
            panX = e.clientX - panStartX;
            panY = e.clientY - panStartY;
            applyZoom();
        };
        document.addEventListener('mousemove', mouseMoveHandler, true); // Use capture phase
    }
    
    function removeMapZoomControls() {
        if (!zoomControlsSetup) return;
        
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomResetBtn = document.getElementById('zoom-reset-btn');
        const mapContainer = document.getElementById('map-container');
        const mapWrapper = document.getElementById('map-wrapper');
        
        if (zoomInBtn && zoomInHandler) zoomInBtn.removeEventListener('click', zoomInHandler);
        if (zoomOutBtn && zoomOutHandler) zoomOutBtn.removeEventListener('click', zoomOutHandler);
        if (zoomResetBtn && zoomResetHandler) zoomResetBtn.removeEventListener('click', zoomResetHandler);
        if (mapWrapper && wheelHandler) mapWrapper.removeEventListener('wheel', wheelHandler);
        const geochartCanvas = document.getElementById('geochart-canvas');
        if (geochartCanvas && mouseDownHandler) geochartCanvas.removeEventListener('mousedown', mouseDownHandler, true);
        if (mapContainer && mouseLeaveHandler) mapContainer.removeEventListener('mouseleave', mouseLeaveHandler);
        if (mouseUpHandler) document.removeEventListener('mouseup', mouseUpHandler, true);
        if (mouseMoveHandler) document.removeEventListener('mousemove', mouseMoveHandler, true);
        
        // Reset handlers
        zoomInHandler = zoomOutHandler = zoomResetHandler = wheelHandler = null;
        mouseDownHandler = mouseLeaveHandler = mouseUpHandler = mouseMoveHandler = null;
        zoomControlsSetup = false;
    }
    
    function applyZoom() {
        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) {
            console.warn('Map container not found for zoom');
            return;
        }
        
        // Reset pan when zoom is 1 or less
        if (mapZoomLevel <= 1) {
            panX = 0;
            panY = 0;
        }
        
        // Update cursor style based on zoom level
        if (mapZoomLevel > 1) {
            mapContainer.style.cursor = 'grab';
        } else {
            mapContainer.style.cursor = 'default';
        }
        
        // Apply both zoom and pan transforms
        mapContainer.style.transform = `translate(${panX}px, ${panY}px) scale(${mapZoomLevel})`;
        mapContainer.style.transformOrigin = 'center center';
        
        console.log('Zoom applied:', mapZoomLevel, 'Pan:', panX, panY);
    }

    function renderUnrecognizedPlacesPanel() {
        const panel = document.getElementById('unrecognized-places-panel');
        const listDiv = document.getElementById('unrecognized-places-list');
        const statusDiv = document.getElementById('unrecognized-places-status');
        if (!panel || !listDiv || !statusDiv) return;
        if (!isAuthenticated()) {
            listDiv.innerHTML = '';
            statusDiv.innerHTML = '<span class="text-red-400">Please sign in to view unrecognized places.</span>';
            return;
        }
        // Get all unique countries in the collection
        const uniqueCollectionCountries = Array.from(new Set(collectionData.map(item => item.country).filter(Boolean)));
        // Get all recognized countries (after alias mapping)
        const recognizedCountriesSet = new Set(ALL_COUNTRIES.map(c => getGeoChartCountryName(c)));
        // List of unrecognized countries: not in recognizedCountriesSet after alias mapping
        const unrecognized = uniqueCollectionCountries.filter(country => {
            const mapped = getGeoChartCountryName(country);
            return !recognizedCountriesSet.has(mapped);
        });
        if (unrecognized.length === 0) {
            listDiv.innerHTML = '<div class="text-emerald-400">All your collection countries are recognized and shown on the map!</div>';
            statusDiv.innerHTML = '';
        } else {
            listDiv.innerHTML = unrecognized.map(country => {
                // Count how many items for this country
                const count = collectionData.filter(item => item.country === country).length;
                return `<div class="bg-gray-900 border border-yellow-700 rounded px-3 py-2 flex items-center justify-between">
                    <span>${country}</span>
                    <span class="text-xs text-yellow-300 ml-2">${count} item${count > 1 ? 's' : ''}</span>
                </div>`;
            }).join('');
            statusDiv.innerHTML = `<span class="text-yellow-400">${unrecognized.length} place${unrecognized.length > 1 ? 's' : ''} not shown on the map.</span>`;
        }
    }


    // --- MISSING COUNTRIES RENDERING ---
    function renderMissingCountries() {
        const missingCountriesContentWrapper = document.getElementById('content-missing').querySelector('.max-w-7xl.mx-auto');
        const missingCountriesListDiv = missingCountriesContentWrapper.querySelector('#missing-countries-list');
        const missingCountriesStatusDiv = missingCountriesContentWrapper.querySelector('#missing-countries-status');


        if (!isAuthenticated()) {
            missingCountriesContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view missing countries.</p></div>`;
            return;
        }

        // Clear existing content to prevent duplicates on re-render
        missingCountriesListDiv.innerHTML = '';


        const collectedCountriesNormalized = new Set(collectionData.map(item => getGeoChartCountryName(item.country)));
        const missingCountries = ALL_COUNTRIES.filter(country => !collectedCountriesNormalized.has(getGeoChartCountryName(country)));

        if (missingCountries.length === 0) {
            missingCountriesStatusDiv.innerHTML = '<p class="text-2xl text-emerald-400 font-semibold">ü•≥ Congratulations! You have collected items from all tracked countries!</p>';
            missingCountriesListDiv.classList.add('hidden');
        } else {
            missingCountriesStatusDiv.innerHTML = `<p class="text-lg">You still need to collect items from <span class="font-bold text-red-400">${missingCountries.length}</span> countries.</p>`;
            missingCountriesListDiv.classList.remove('hidden');

            missingCountries.forEach(country => {
                const countryElement = document.createElement('div');
                countryElement.className = 'bg-gray-800 p-4 rounded-md shadow-md border border-gray-700 flex items-center justify-between transition-transform transform hover:scale-102';
                countryElement.innerHTML = `
                    <span class="text-gray-200 font-medium">${country}</span>
                    <button class="add-missing-country-btn text-emerald-400 hover:text-emerald-300 transition-colors" data-country="${country}" title="Quick Add Item from ${country}">
                        <i class="ph-bold ph-plus-circle text-xl"></i>
                    </button>
                `;
                missingCountriesListDiv.appendChild(countryElement);
            });

            document.querySelectorAll('.add-missing-country-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const countryToAdd = e.currentTarget.dataset.country;
                    clearItemForm();
                    document.getElementById('country').value = countryToAdd;
                    document.getElementById('modal-title').innerText = `Quick Add Item from ${countryToAdd}`;
                    openModal('item-modal');
                });
            });
        }
    }

    // --- SETTINGS RENDERING ---
    function renderSettings() {
        const settingsDiv = document.getElementById('content-settings');
        const settingsContent = document.getElementById('settings-content');
        const settingsOverlay = document.getElementById('settings-unauthenticated-overlay');
        const htmlElement = document.documentElement; // Get the <html> element

        if (!isAuthenticated()) {
            settingsContent.classList.add('hidden');
            settingsOverlay.classList.remove('hidden');
            return;
        } else {
            settingsContent.classList.remove('hidden');
            settingsOverlay.classList.add('hidden');
        }

        // Initialize theme preference radio buttons
        const currentTheme = localStorage.getItem('theme') || 'dark';
        const themeRadio = document.querySelector(`input[name="theme-preference"][value="${currentTheme}"]`);
        if(themeRadio) themeRadio.checked = true;

        // Add event listener for theme change (if not already attached)
        const themeRadios = document.querySelectorAll('input[name="theme-preference"]');
        themeRadios.forEach(radio => {
            // Remove existing listener to prevent duplicates
            radio.removeEventListener('change', handleThemeChange);
            radio.addEventListener('change', handleThemeChange);
        });

        // Add event listener for password change form (if not already attached)
        const changePasswordForm = document.getElementById('change-password-form');
        if (changePasswordForm) {
            changePasswordForm.removeEventListener('submit', handleChangePassword);
            changePasswordForm.addEventListener('submit', handleChangePassword);
        }

        // Fetch and display public URL on settings load
        fetchPublicUrl();

        // Load and display profile data
        loadProfile();

        // Add event listener for find duplicates button
        const findDuplicatesBtn = document.getElementById('find-duplicates-btn');
        if (findDuplicatesBtn) {
            findDuplicatesBtn.removeEventListener('click', handleFindDuplicates);
            findDuplicatesBtn.addEventListener('click', handleFindDuplicates);
        }

        // Add event listener for profile form
        const profileForm = document.getElementById('profile-form');
        if (profileForm) {
            profileForm.removeEventListener('submit', handleUpdateProfile);
            profileForm.addEventListener('submit', handleUpdateProfile);
        }
        
        // Setup profile picture upload handlers
        setupProfilePictureUpload();
    }

    // --- PROFILE PAGE RENDERING ---
    function renderProfile() {
        const profileDiv = document.getElementById('content-profile');
        const profileContent = document.getElementById('profile-content');
        const profileOverlay = document.getElementById('profile-unauthenticated-overlay');
        const profileLoading = document.getElementById('profile-loading');
        const profileError = document.getElementById('profile-error');

        if (!isAuthenticated()) {
            profileContent.classList.add('hidden');
            profileOverlay.classList.remove('hidden');
            profileLoading.classList.add('hidden');
            profileError.classList.add('hidden');
            return;
        } else {
            profileContent.classList.add('hidden'); // Keep hidden until data loads
            profileOverlay.classList.add('hidden');
            profileLoading.classList.remove('hidden');
            profileError.classList.add('hidden');
        }

        // Load profile data
        loadProfilePage();
    }

    // --- PROFILE FUNCTIONS ---
    async function loadProfile() {
        if (!isAuthenticated()) return;

        try {
            const response = await fetch(`${API_BASE_URL}/profile`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const profile = await response.json();
            
            // Populate profile form fields
            const usernameInput = document.getElementById('profile-username');
            const displayNameInput = document.getElementById('profile-display-name');
            const bioInput = document.getElementById('profile-bio');
            const profilePublicCheckbox = document.getElementById('profile-public');
            const collectionPublicCheckbox = document.getElementById('collection-public');

            if (usernameInput) usernameInput.value = profile.username || '';
            if (displayNameInput) displayNameInput.value = profile.display_name || '';
            if (bioInput) bioInput.value = profile.bio || '';
            if (profilePublicCheckbox) profilePublicCheckbox.checked = profile.profile_public || false;
            if (collectionPublicCheckbox) collectionPublicCheckbox.checked = profile.collection_public || false;
            
            // Handle profile picture
            const profilePicturePreview = document.getElementById('profile-picture-preview');
            const profilePicturePlaceholder = document.getElementById('profile-picture-placeholder');
            const profilePictureInitial = document.getElementById('profile-picture-initial');
            const removeBtn = document.getElementById('profile-picture-remove-btn');
            
            if (profile.profile_picture_url) {
                if (profilePicturePreview) {
                    profilePicturePreview.src = profile.profile_picture_url;
                    profilePicturePreview.classList.remove('hidden');
                }
                if (profilePicturePlaceholder) {
                    profilePicturePlaceholder.classList.add('hidden');
                }
                if (removeBtn) {
                    removeBtn.classList.remove('hidden');
                }
            } else {
                if (profilePicturePreview) {
                    profilePicturePreview.classList.add('hidden');
                }
                if (profilePicturePlaceholder) {
                    profilePicturePlaceholder.classList.remove('hidden');
                }
                if (removeBtn) {
                    removeBtn.classList.add('hidden');
                }
                // Set initial
                if (profilePictureInitial) {
                    const initial = (profile.display_name || profile.username || 'U').charAt(0).toUpperCase();
                    profilePictureInitial.textContent = initial;
                }
            }

        } catch (error) {
            console.error('Error loading profile:', error);
            // Don't show error to user on initial load, just log it
        }
    }

    async function loadProfilePage() {
        if (!isAuthenticated()) return;

        const profileLoading = document.getElementById('profile-loading');
        const profileError = document.getElementById('profile-error');
        const profileErrorMessage = document.getElementById('profile-error-message');
        const profileContent = document.getElementById('profile-content');

        try {
            profileLoading.classList.remove('hidden');
            profileError.classList.add('hidden');

            const response = await fetch(`${API_BASE_URL}/profile`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const profile = await response.json();
            const stats = profile.stats || {};

            // Get current currency setting
            const currentCurrency = localStorage.getItem('currency') || 'USD';
            const convertedTotalValue = convertToCurrency(stats.total_value || 0, 'USD', currentCurrency);

            // Update profile header
            const usernameHeader = document.getElementById('profile-username-header');
            const displayNameHeader = document.getElementById('profile-display-name-header');
            const bioText = document.getElementById('profile-bio-text');
            const profileInitial = document.getElementById('profile-initial');

            if (usernameHeader) {
                usernameHeader.textContent = profile.username || 'User';
            }
            if (displayNameHeader) {
                displayNameHeader.textContent = profile.display_name || '';
                if (!profile.display_name) {
                    displayNameHeader.style.display = 'none';
                } else {
                    displayNameHeader.style.display = 'block';
                }
            }
            if (bioText) {
                bioText.textContent = profile.bio || '';
                if (!profile.bio) {
                    bioText.style.display = 'none';
                } else {
                    bioText.style.display = 'block';
                }
            }
            if (profileInitial) {
                const initial = (profile.display_name || profile.username || 'U').charAt(0).toUpperCase();
                profileInitial.textContent = initial;
            }
            
            // Update profile picture on profile page
            const profilePagePictureContainer = document.getElementById('profile-picture-container');
            if (profilePagePictureContainer && profile.profile_picture_url) {
                // Replace placeholder with actual image
                profilePagePictureContainer.innerHTML = `
                    <img src="${escapeHtml(profile.profile_picture_url)}" alt="${escapeHtml(profile.display_name || profile.username)}" 
                         class="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover border-2 border-gray-600">
                `;
            } else if (profilePagePictureContainer && !profile.profile_picture_url) {
                // Show placeholder if no picture
                const initial = (profile.display_name || profile.username || 'U').charAt(0).toUpperCase();
                profilePagePictureContainer.innerHTML = `
                    <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-gradient-to-br from-emerald-500 to-blue-500 flex items-center justify-center text-white text-4xl md:text-5xl font-bold">
                        <span id="profile-initial">${initial}</span>
                    </div>
                `;
            }

            // Update follower/following counts
            const followersCount = document.getElementById('profile-followers-count');
            const followingCount = document.getElementById('profile-following-count');
            const collectionNumber = document.getElementById('profile-collection-number');

            if (followersCount) followersCount.textContent = stats.follower_count || 0;
            if (followingCount) followingCount.textContent = stats.following_count || 0;
            if (collectionNumber) collectionNumber.textContent = stats.coin_count || 0;

            // Update stats grid
            const statsCollection = document.getElementById('profile-stats-collection');
            const statsValue = document.getElementById('profile-stats-value');
            const statsCountries = document.getElementById('profile-stats-countries');
            const statsWishlist = document.getElementById('profile-stats-wishlist');

            if (statsCollection) statsCollection.textContent = stats.coin_count || 0;
            if (statsValue) statsValue.textContent = formatCurrency(convertedTotalValue, currentCurrency);
            if (statsCountries) statsCountries.textContent = stats.unique_countries || 0;
            if (statsWishlist) statsWishlist.textContent = stats.wishlist_count || 0;

            // Hide loading, show content
            profileLoading.classList.add('hidden');
            profileContent.classList.remove('hidden');

            // Attach event handlers
            attachProfilePageHandlers(profile.username);

        } catch (error) {
            console.error('Error loading profile page:', error);
            profileLoading.classList.add('hidden');
            profileError.classList.remove('hidden');
            if (profileErrorMessage) {
                profileErrorMessage.textContent = error.message || 'Failed to load profile';
            }
        }
    }

    function attachProfilePageHandlers(username) {
        // Edit Profile button - redirects to settings
        const editProfileBtn = document.getElementById('edit-profile-btn');
        if (editProfileBtn) {
            editProfileBtn.removeEventListener('click', () => {});
            editProfileBtn.addEventListener('click', () => {
                showView('content-settings');
            });
        }

        // Settings button - redirects to settings
        const settingsBtn = document.getElementById('profile-settings-btn');
        if (settingsBtn) {
            settingsBtn.removeEventListener('click', () => {});
            settingsBtn.addEventListener('click', () => {
                showView('content-settings');
            });
        }

        // Followers link
        const followersLink = document.getElementById('profile-followers-link');
        if (followersLink) {
            followersLink.removeEventListener('click', () => {});
            followersLink.addEventListener('click', () => {
                showFollowersModal(username);
            });
        }

        // Following link
        const followingLink = document.getElementById('profile-following-link');
        if (followingLink) {
            followingLink.removeEventListener('click', () => {});
            followingLink.addEventListener('click', () => {
                showFollowingModal(username);
            });
        }
    }

    async function handleUpdateProfile(e) {
        e.preventDefault();

        const updateBtn = document.getElementById('update-profile-btn');
        setLoadingState('update-profile-btn', true, 'Updating...');

        try {
            const displayName = document.getElementById('profile-display-name').value;
            const bio = document.getElementById('profile-bio').value;
            const profilePublic = document.getElementById('profile-public').checked;
            const collectionPublic = document.getElementById('collection-public').checked;

            const profilePictureUrl = document.getElementById('profile-picture-input')?.dataset.currentUrl || null;
            
            // Check if token exists before making request
            const token = getAuthToken();
            if (!token) {
                handleUnauthorized();
                return;
            }
            
            const response = await fetch(`${API_BASE_URL}/profile`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    display_name: displayName,
                    bio: bio,
                    profile_picture_url: profilePictureUrl,
                    profile_public: profilePublic,
                    collection_public: collectionPublic
                })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                
                // Try to get error message from response
                let errorMessage = `HTTP error! status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch (e) {
                    // If response is not JSON, use status text
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }

            const result = await response.json();
            showCustomConfirm(result.message || 'Profile updated successfully!', () => {});
            
            // Reload profile to update picture
            loadProfile();
            if (!document.getElementById('content-profile').classList.contains('hidden')) {
                loadProfilePage();
            }

        } catch (error) {
            console.error('Error updating profile:', error);
            showCustomConfirm(`Failed to update profile: ${error.message}`, () => {});
        } finally {
            setLoadingState('update-profile-btn', false);
        }
    }

    function setupProfilePictureUpload() {
        const uploadBtn = document.getElementById('profile-picture-upload-btn');
        const fileInput = document.getElementById('profile-picture-input');
        const removeBtn = document.getElementById('profile-picture-remove-btn');
        const preview = document.getElementById('profile-picture-preview');
        const placeholder = document.getElementById('profile-picture-placeholder');
        
        if (!uploadBtn || !fileInput) {
            console.log('Profile picture upload elements not found');
            return;
        }
        
        // Remove existing listeners to prevent duplicates
        const newUploadBtn = uploadBtn.cloneNode(true);
        uploadBtn.parentNode.replaceChild(newUploadBtn, uploadBtn);
        
        const newFileInput = fileInput.cloneNode(true);
        fileInput.parentNode.replaceChild(newFileInput, fileInput);
        
        // Get fresh references after cloning
        const freshUploadBtn = document.getElementById('profile-picture-upload-btn');
        const freshFileInput = document.getElementById('profile-picture-input');
        
        if (freshUploadBtn && freshFileInput) {
            freshUploadBtn.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Upload button clicked');
                freshFileInput.click();
            });
            
            freshFileInput.addEventListener('change', (e) => {
                console.log('File input changed');
                const file = e.target.files[0];
                if (!file) return;
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    showCustomConfirm('File size must be less than 5MB', () => {});
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showCustomConfirm('Please select an image file', () => {});
                    return;
                }
                
                // Compress and convert to base64
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // Create canvas to compress image
                        const canvas = document.createElement('canvas');
                        const maxWidth = 400;
                        const maxHeight = 400;
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 with compression
                        const base64Image = canvas.toDataURL('image/jpeg', 0.8);
                        
                        // Update preview
                        if (preview) {
                            preview.src = base64Image;
                            preview.classList.remove('hidden');
                        }
                        if (placeholder) {
                            placeholder.classList.add('hidden');
                        }
                        if (removeBtn) {
                            removeBtn.classList.remove('hidden');
                        }
                        
                        // Store in dataset for form submission
                        if (freshFileInput) {
                            freshFileInput.dataset.currentUrl = base64Image;
                        }
                    };
                    img.onerror = () => {
                        showCustomConfirm('Failed to load image. Please try another file.', () => {});
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        if (removeBtn) {
            // Remove existing listener
            const newRemoveBtn = removeBtn.cloneNode(true);
            removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);
            const freshRemoveBtn = document.getElementById('profile-picture-remove-btn');
            
            if (freshRemoveBtn) {
                freshRemoveBtn.addEventListener('click', () => {
                    const currentFileInput = document.getElementById('profile-picture-input');
                    if (preview) {
                        preview.src = '';
                        preview.classList.add('hidden');
                    }
                    if (placeholder) {
                        placeholder.classList.remove('hidden');
                    }
                    freshRemoveBtn.classList.add('hidden');
                    if (currentFileInput) {
                        currentFileInput.value = '';
                        currentFileInput.dataset.currentUrl = null;
                    }
                });
            }
        }
    }

    // --- MEMBERS SEARCH FUNCTIONS ---
    let membersSearchTimeout = null;

    async function renderMembers() {
        const membersList = document.getElementById('members-list');
        const membersLoading = document.getElementById('members-loading');
        const membersEmpty = document.getElementById('members-empty');
        const membersError = document.getElementById('members-error');
        const searchInput = document.getElementById('member-search-input');

        if (!membersList) return;

        // Hide all states initially
        membersList.innerHTML = '';
        membersList.classList.add('hidden');
        membersLoading.classList.remove('hidden');
        membersEmpty.classList.add('hidden');
        membersError.classList.add('hidden');

        try {
            const query = searchInput ? searchInput.value.trim() : '';
            const url = query 
                ? `${API_BASE_URL}/users/search?q=${encodeURIComponent(query)}`
                : `${API_BASE_URL}/users/search`;

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const users = data.users || [];

            membersLoading.classList.add('hidden');

            if (users.length === 0) {
                membersEmpty.classList.remove('hidden');
                return;
            }

            membersList.classList.remove('hidden');
            membersList.innerHTML = users.map(user => {
                const initial = (user.display_name || user.username || 'U').charAt(0).toUpperCase();
                const hasProfilePicture = user.profile_picture_url && user.profile_picture_url.trim() !== '';
                
                return `
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-emerald-500 transition-colors cursor-pointer user-card" data-username="${user.username}">
                    <div class="flex items-start gap-4 mb-4">
                        <!-- Profile Picture -->
                        <div class="flex-shrink-0">
                            ${hasProfilePicture ? `
                                <img src="${escapeHtml(user.profile_picture_url)}" alt="${escapeHtml(user.display_name || user.username)}" 
                                     class="w-16 h-16 rounded-full object-cover border-2 border-gray-600">
                            ` : `
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-emerald-500 to-blue-500 flex items-center justify-center text-white text-xl font-bold">
                                    ${initial}
                                </div>
                            `}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-xl font-bold text-white mb-1 truncate">
                                        ${user.display_name || user.username}
                                    </h3>
                                    <p class="text-sm text-gray-400">${renderUsername(user.username)}</p>
                                </div>
                                <i class="ph-bold ph-arrow-right text-emerald-400 text-xl flex-shrink-0 ml-2"></i>
                            </div>
                        </div>
                    </div>
                    ${user.bio ? `<p class="text-gray-300 text-sm mb-4 line-clamp-2">${escapeHtml(user.bio)}</p>` : ''}
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center text-gray-400">
                            <i class="ph-bold ph-coins mr-2"></i>
                            <span>${user.coin_count || 0} items</span>
                        </div>
                        ${user.collection_public ? `
                            <span class="text-emerald-400 flex items-center">
                                <i class="ph-bold ph-eye mr-1"></i>
                                Public Collection
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
            }).join('');

            // Add click handlers to user cards
            document.querySelectorAll('.user-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const username = e.currentTarget.dataset.username;
                    if (username) {
                        // Navigate to user profile page
                        window.history.pushState({}, '', `/@${username}`);
                        handleHistoryNavigation(`/@${username}`);
                    }
                });
            });

        } catch (error) {
            console.error('Error loading members:', error);
            membersLoading.classList.add('hidden');
            membersError.classList.remove('hidden');
            const errorMessage = document.getElementById('members-error-message');
            if (errorMessage) {
                errorMessage.textContent = error.message || 'Failed to load members';
            }
        }
    }

    async function viewUserProfile(username) {
        const modal = document.getElementById('user-profile-modal');
        const modalContent = document.getElementById('user-profile-content');
        const modalTitle = document.getElementById('user-profile-username');

        if (!modal || !modalContent) return;

        openModal('user-profile-modal');
        modalContent.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400 mx-auto mb-4"></div><p class="text-gray-400">Loading profile...</p></div>';

        try {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (isAuthenticated()) {
                headers['Authorization'] = `Bearer ${getAuthToken()}`;
            }
            const response = await fetch(`${API_BASE_URL}/users/${encodeURIComponent(username)}`, {
                method: 'GET',
                headers: headers
            });

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('User not found or profile is private');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const profile = await response.json();

            if (modalTitle) {
                const displayText = profile.display_name || profile.username;
                if (profile.username === 'OscarBrimelow') {
                    modalTitle.innerHTML = `${escapeHtml(displayText)} <i class="ph-bold ph-crown text-purple-400 ml-1 inline-block" title="Developer"></i>`;
                } else {
                    modalTitle.textContent = displayText;
                }
            }

            const stats = profile.stats || {};
            const collection = profile.collection || [];
            const wishlist = profile.wishlist || [];
            
            // Get current currency setting
            const currentCurrency = localStorage.getItem('currency') || 'USD';
            
            // Convert total value from USD to user's currency
            const convertedTotalValue = convertToCurrency(stats.total_value || 0, 'USD', currentCurrency);
            
            // Convert collection item values
            const convertedCollection = collection.map(item => {
                const convertedValue = convertToCurrency(item.value || 0, 'USD', currentCurrency);
                return { ...item, convertedValue };
            });

            modalContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Profile Info -->
                    <div class="bg-gray-700 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-white mb-2">${profile.display_name || profile.username}</h3>
                                <p class="text-sm text-gray-400 mb-2">${renderUsername(profile.username)}</p>
                                ${profile.bio ? `<p class="text-gray-300 mt-4">${escapeHtml(profile.bio)}</p>` : ''}
                            </div>
                            ${isAuthenticated() ? `
                                <button id="follow-btn" class="ml-4 px-4 py-2 rounded-md transition-colors ${profile.is_following ? 'bg-gray-600 hover:bg-gray-500' : 'bg-emerald-600 hover:bg-emerald-700'} text-white font-semibold" data-username="${escapeHtml(profile.username)}" data-following="${profile.is_following || false}">
                                    ${profile.is_following ? 'Unfollow' : 'Follow'}
                                </button>
                            ` : ''}
                        </div>
                        <div class="flex items-center space-x-6 mt-4">
                            <button id="followers-link" class="text-gray-300 hover:text-white transition-colors cursor-pointer" data-username="${escapeHtml(profile.username)}" data-type="followers">
                                <span class="font-semibold">${profile.stats?.follower_count || 0}</span> <span class="text-sm">Followers</span>
                            </button>
                            <button id="following-link" class="text-gray-300 hover:text-white transition-colors cursor-pointer" data-username="${escapeHtml(profile.username)}" data-type="following">
                                <span class="font-semibold">${profile.stats?.following_count || 0}</span> <span class="text-sm">Following</span>
                            </button>
                            ${isAuthenticated() ? `
                                <button id="compare-collections-btn" class="text-gray-300 hover:text-white transition-colors cursor-pointer" data-username="${escapeHtml(profile.username)}">
                                    <i class="ph ph-compare"></i> <span class="text-sm">Compare Collections</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-sm text-gray-400 mb-1">Collection Items</div>
                            <div class="text-2xl font-bold text-white">${stats.coin_count || 0}</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-sm text-gray-400 mb-1">Total Value</div>
                            <div class="text-2xl font-bold text-emerald-400">${formatCurrency(convertedTotalValue, currentCurrency)}</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-sm text-gray-400 mb-1">Countries</div>
                            <div class="text-2xl font-bold text-white">${stats.unique_countries || 0}</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4 cursor-pointer hover:bg-gray-600 transition-colors" id="wishlist-stat-card" data-wishlist-expanded="false">
                            <div class="text-sm text-gray-400 mb-1 flex items-center justify-between">
                                <span>Wishlist Items</span>
                                ${wishlist.length > 0 ? `<i class="ph-bold ph-caret-down text-pink-400" id="wishlist-toggle-icon"></i>` : ''}
                            </div>
                            <div class="text-2xl font-bold text-pink-400">${stats.wishlist_count || 0}</div>
                            ${(stats.coin_count || 0) > 0 && (stats.wishlist_count || 0) > 0 ? `
                                <div class="text-xs text-gray-500 mt-1">
                                    ${((stats.wishlist_count / stats.coin_count) * 100).toFixed(1)}% of collection size
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Wishlist Items (collapsible) -->
                    <div id="public-wishlist-section" class="hidden">
                        <h3 class="text-xl font-bold text-white mb-4">Wishlist</h3>
                        ${wishlist.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="public-wishlist-items">
                                ${wishlist.map(item => `
                                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-pink-500 transition-colors">
                                        <div class="flex flex-col h-full">
                                            <div class="mb-3 flex justify-center">
                                                ${item.image_url ? `
                                                    <img src="${escapeHtml(item.image_url)}" alt="${escapeHtml(item.denomination || 'Item')}" 
                                                         class="max-w-full h-32 object-contain rounded-md bg-gray-700 p-2" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                    <div class="hidden max-w-full h-32 rounded-md bg-gray-700 p-2 items-center justify-center">
                                                        <i class="ph-bold ph-image text-4xl text-gray-500"></i>
                                                    </div>
                                                ` : `
                                                    <div class="max-w-full h-32 rounded-md bg-gray-700 p-2 flex items-center justify-center">
                                                        <i class="ph-bold ph-image text-4xl text-gray-500"></i>
                                                    </div>
                                                `}
                                            </div>
                                            <h4 class="font-bold text-white text-lg mb-2">${escapeHtml(item.denomination || 'Untitled')}</h4>
                                            ${item.country ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Country:</span> ${escapeHtml(item.country)}</p>` : ''}
                                            ${item.year ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Year:</span> ${escapeHtml(item.year.toString())}</p>` : ''}
                                            ${item.type ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Type:</span> ${escapeHtml(item.type)}</p>` : ''}
                                            ${item.composition ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Composition:</span> ${escapeHtml(item.composition)}</p>` : ''}
                                            ${item.description ? `<p class="text-sm text-gray-400 mt-2 line-clamp-2">${escapeHtml(item.description)}</p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="bg-gray-700 rounded-lg p-6 text-center">
                                <p class="text-gray-400">No items in wishlist yet</p>
                            </div>
                        `}
                    </div>

                    <!-- Collection -->
                    ${profile.collection_public && collection.length > 0 ? `
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-white">Collection</h3>
                                <button id="collection-toggle-btn" class="text-gray-400 hover:text-white transition-colors cursor-pointer" data-collection-expanded="true">
                                    <i class="ph-bold ph-caret-up text-xl" id="collection-toggle-icon"></i>
                                </button>
                            </div>
                            <div id="public-collection-section">
                                <div class="bg-gray-700 rounded-lg overflow-hidden">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left">
                                            <thead class="bg-gray-800">
                                                <tr>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Type</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Country</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Year</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Denomination</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Qty</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Value</th>
                                                </tr>
                                            </thead>
                                            <tbody id="public-collection-table-body">
                                                ${convertedCollection.map(item => `
                                                    <tr class="border-t border-gray-600 collection-item-row" data-search-text="${escapeHtml((item.type || '') + ' ' + (item.country || '') + ' ' + (item.denomination || '') + ' ' + (item.year || '')).toLowerCase()}">
                                                        <td class="p-4 text-sm text-gray-300">${item.type}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.country} ${item.isHistorical ? '<span class="text-xs text-amber-400">(H)</span>' : ''}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.year || 'N/A'}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.denomination}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.quantity || 1}</td>
                                                        <td class="p-4 text-sm text-gray-300">${formatCurrency(item.convertedValue, currentCurrency)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : profile.collection_public ? `
                        <div class="bg-gray-700 rounded-lg p-6 text-center">
                            <p class="text-gray-400">No items in collection yet</p>
                        </div>
                    ` : `
                        <div class="bg-gray-700 rounded-lg p-6 text-center">
                            <p class="text-gray-400">Collection is private</p>
                        </div>
                    `}
                    
                    <!-- Comments Section -->
                    ${profile.collection_public ? `
                        <div>
                            <h3 class="text-xl font-bold text-white mb-4">Comments</h3>
                            <div id="comments-container" class="space-y-4">
                                <!-- Comments will be loaded here -->
                            </div>
                            ${isAuthenticated() ? `
                                <div class="mt-4">
                                    <textarea id="comment-input" placeholder="Add a comment..." class="w-full bg-gray-700 text-white rounded-md p-3 border border-gray-600 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" rows="3"></textarea>
                                    <button id="submit-comment-btn" class="mt-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md transition-colors" data-username="${escapeHtml(profile.username)}">
                                        Post Comment
                                    </button>
                                </div>
                            ` : `
                                <p class="text-gray-400 text-sm mt-4">Sign in to leave a comment</p>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Load comments
            if (profile.collection_public) {
                loadComments(profile.username);
            }
            
            // Attach event handlers
            attachProfileEventHandlers(profile);

            // Use setTimeout to ensure DOM is fully updated before attaching handlers
            setTimeout(() => {
                // Add click handler for wishlist toggle
                const wishlistStatCard = document.getElementById('wishlist-stat-card');
                const wishlistSection = document.getElementById('public-wishlist-section');
                const wishlistToggleIcon = document.getElementById('wishlist-toggle-icon');
                
                if (wishlistStatCard && wishlistSection && wishlist.length > 0) {
                    wishlistStatCard.addEventListener('click', () => {
                        const isExpanded = wishlistStatCard.getAttribute('data-wishlist-expanded') === 'true';
                        
                        if (isExpanded) {
                            wishlistSection.classList.add('hidden');
                            wishlistStatCard.setAttribute('data-wishlist-expanded', 'false');
                            if (wishlistToggleIcon) {
                                wishlistToggleIcon.className = 'ph-bold ph-caret-down text-pink-400';
                            }
                        } else {
                            wishlistSection.classList.remove('hidden');
                            wishlistStatCard.setAttribute('data-wishlist-expanded', 'true');
                            if (wishlistToggleIcon) {
                                wishlistToggleIcon.className = 'ph-bold ph-caret-up text-pink-400';
                            }
                        }
                    });
                }

                // Add click handler for collection toggle
                const collectionToggleBtn = document.getElementById('collection-toggle-btn');
                const collectionSection = document.getElementById('public-collection-section');
                const collectionToggleIcon = document.getElementById('collection-toggle-icon');
                
                console.log('Modal: Setting up collection toggle:', {
                    hasBtn: !!collectionToggleBtn,
                    hasSection: !!collectionSection,
                    hasIcon: !!collectionToggleIcon,
                    collectionLength: collection.length,
                    collectionPublic: profile.collection_public
                });
                
                if (collectionToggleBtn && collectionSection && collection.length > 0) {
                    collectionToggleBtn.addEventListener('click', () => {
                        const isExpanded = collectionToggleBtn.getAttribute('data-collection-expanded') === 'true';
                        
                        if (isExpanded) {
                            collectionSection.classList.add('hidden');
                            collectionToggleBtn.setAttribute('data-collection-expanded', 'false');
                            if (collectionToggleIcon) {
                                collectionToggleIcon.className = 'ph-bold ph-caret-down text-xl';
                            }
                        } else {
                            collectionSection.classList.remove('hidden');
                            collectionToggleBtn.setAttribute('data-collection-expanded', 'true');
                            if (collectionToggleIcon) {
                                collectionToggleIcon.className = 'ph-bold ph-caret-up text-xl';
                            }
                        }
                    });
                    console.log('Modal: Collection toggle handler attached successfully');
                } else {
                    console.warn('Modal: Collection toggle not attached:', {
                        hasBtn: !!collectionToggleBtn,
                        hasSection: !!collectionSection,
                        collectionLength: collection.length
                    });
                }

            }, 200); // Increased delay to ensure DOM is ready

        } catch (error) {
            console.error('Error loading user profile:', error);
            modalContent.innerHTML = `
                <div class="text-center py-8">
                    <i class="ph-bold ph-warning-circle text-6xl text-red-400 mb-4"></i>
                    <p class="text-xl text-red-400 mb-2">Error loading profile</p>
                    <p class="text-gray-500">${escapeHtml(error.message || 'Failed to load user profile')}</p>
                </div>
            `;
        }
    }

    async function renderUserProfilePage(username) {
        const pageContent = document.getElementById('user-profile-page-content');
        if (!pageContent) return;

        pageContent.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400 mx-auto mb-4"></div><p class="text-gray-400">Loading profile...</p></div>';

        try {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (isAuthenticated()) {
                headers['Authorization'] = `Bearer ${getAuthToken()}`;
            }
            const response = await fetch(`${API_BASE_URL}/users/${encodeURIComponent(username)}`, {
                method: 'GET',
                headers: headers
            });

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('User not found or profile is private');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const profile = await response.json();

            const stats = profile.stats || {};
            const collection = profile.collection || [];
            const wishlist = profile.wishlist || [];
            
            // Get current currency setting
            const currentCurrency = localStorage.getItem('currency') || 'USD';
            
            // Convert total value from USD to user's currency
            const convertedTotalValue = convertToCurrency(stats.total_value || 0, 'USD', currentCurrency);
            
            // Convert collection item values
            const convertedCollection = collection.map(item => {
                const convertedValue = convertToCurrency(item.value || 0, 'USD', currentCurrency);
                return { ...item, convertedValue };
            });

            const displayText = profile.display_name || profile.username;
            const titleText = profile.username === 'OscarBrimelow' 
                ? `${escapeHtml(displayText)} <i class="ph-bold ph-crown text-purple-400 ml-1 inline-block" title="Developer"></i>`
                : escapeHtml(displayText);

            const initial = (profile.display_name || profile.username || 'U').charAt(0).toUpperCase();
            const hasProfilePicture = profile.profile_picture_url && profile.profile_picture_url.trim() !== '';

            pageContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Back Button -->
                    <div class="mb-4">
                        <button onclick="window.history.back();" class="text-gray-400 hover:text-white transition-colors flex items-center">
                            <i class="ph-bold ph-arrow-left mr-2"></i> Back
                        </button>
                    </div>

                    <!-- Profile Header -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <div class="flex items-start gap-6 mb-4">
                            <!-- Profile Picture -->
                            <div class="flex-shrink-0">
                                ${hasProfilePicture ? `
                                    <img src="${escapeHtml(profile.profile_picture_url)}" alt="${escapeHtml(displayText)}" 
                                         class="w-24 h-24 rounded-full object-cover border-2 border-gray-600">
                                ` : `
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-br from-emerald-500 to-blue-500 flex items-center justify-center text-white text-3xl font-bold">
                                        ${initial}
                                    </div>
                                `}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h1 class="text-3xl font-bold text-white mb-2">${titleText}</h1>
                                <p class="text-lg text-gray-400 mb-2">${renderUsername(profile.username)}</p>
                                ${profile.bio ? `<p class="text-gray-300 mt-4">${escapeHtml(profile.bio)}</p>` : ''}
                            </div>
                            ${isAuthenticated() ? `
                                <button id="follow-btn" class="ml-4 px-6 py-2 rounded-md transition-colors ${profile.is_following ? 'bg-gray-600 hover:bg-gray-500' : 'bg-emerald-600 hover:bg-emerald-700'} text-white font-semibold" data-username="${escapeHtml(profile.username)}" data-following="${profile.is_following || false}">
                                    ${profile.is_following ? 'Unfollow' : 'Follow'}
                                </button>
                            ` : ''}
                        </div>
                        <div class="flex items-center space-x-6 mt-4">
                            <button id="followers-link" class="text-gray-300 hover:text-white transition-colors cursor-pointer" data-username="${escapeHtml(profile.username)}" data-type="followers">
                                <span class="font-semibold text-xl">${profile.stats?.follower_count || 0}</span> <span class="text-sm">Followers</span>
                            </button>
                            <button id="following-link" class="text-gray-300 hover:text-white transition-colors cursor-pointer" data-username="${escapeHtml(profile.username)}" data-type="following">
                                <span class="font-semibold text-xl">${profile.stats?.following_count || 0}</span> <span class="text-sm">Following</span>
                            </button>
                            ${isAuthenticated() ? `
                                <button id="compare-collections-btn" class="text-gray-300 hover:text-white transition-colors cursor-pointer" data-username="${escapeHtml(profile.username)}">
                                    <i class="ph ph-compare"></i> <span class="text-sm">Compare Collections</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                            <div class="text-sm text-gray-400 mb-1">Collection Items</div>
                            <div class="text-2xl font-bold text-white">${stats.coin_count || 0}</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                            <div class="text-sm text-gray-400 mb-1">Total Value</div>
                            <div class="text-2xl font-bold text-emerald-400">${formatCurrency(convertedTotalValue, currentCurrency)}</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                            <div class="text-sm text-gray-400 mb-1">Countries</div>
                            <div class="text-2xl font-bold text-white">${stats.unique_countries || 0}</div>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 cursor-pointer hover:bg-gray-700 transition-colors" id="wishlist-stat-card" data-wishlist-expanded="false">
                            <div class="text-sm text-gray-400 mb-1 flex items-center justify-between">
                                <span>Wishlist Items</span>
                                ${wishlist.length > 0 ? `<i class="ph-bold ph-caret-down text-pink-400" id="wishlist-toggle-icon"></i>` : ''}
                            </div>
                            <div class="text-2xl font-bold text-pink-400">${stats.wishlist_count || 0}</div>
                            ${(stats.coin_count || 0) > 0 && (stats.wishlist_count || 0) > 0 ? `
                                <div class="text-xs text-gray-500 mt-1">
                                    ${((stats.wishlist_count / stats.coin_count) * 100).toFixed(1)}% of collection size
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Wishlist Items (collapsible) -->
                    <div id="public-wishlist-section" class="hidden">
                        <h3 class="text-xl font-bold text-white mb-4">Wishlist</h3>
                        ${wishlist.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="public-wishlist-items">
                                ${wishlist.map(item => `
                                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-pink-500 transition-colors">
                                        <div class="flex flex-col h-full">
                                            <div class="mb-3 flex justify-center">
                                                ${item.image_url ? `
                                                    <img src="${escapeHtml(item.image_url)}" alt="${escapeHtml(item.denomination || 'Item')}" 
                                                         class="max-w-full h-32 object-contain rounded-md bg-gray-700 p-2" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                    <div class="hidden max-w-full h-32 rounded-md bg-gray-700 p-2 items-center justify-center">
                                                        <i class="ph-bold ph-image text-4xl text-gray-500"></i>
                                                    </div>
                                                ` : `
                                                    <div class="max-w-full h-32 rounded-md bg-gray-700 p-2 flex items-center justify-center">
                                                        <i class="ph-bold ph-image text-4xl text-gray-500"></i>
                                                    </div>
                                                `}
                                            </div>
                                            <h4 class="font-bold text-white text-lg mb-2">${escapeHtml(item.denomination || 'Untitled')}</h4>
                                            ${item.country ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Country:</span> ${escapeHtml(item.country)}</p>` : ''}
                                            ${item.year ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Year:</span> ${escapeHtml(item.year.toString())}</p>` : ''}
                                            ${item.type ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Type:</span> ${escapeHtml(item.type)}</p>` : ''}
                                            ${item.composition ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Composition:</span> ${escapeHtml(item.composition)}</p>` : ''}
                                            ${item.description ? `<p class="text-sm text-gray-400 mt-2 line-clamp-2">${escapeHtml(item.description)}</p>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="bg-gray-800 rounded-lg p-6 text-center border border-gray-700">
                                <p class="text-gray-400">No items in wishlist yet</p>
                            </div>
                        `}
                    </div>

                    <!-- Collection -->
                    ${profile.collection_public && collection.length > 0 ? `
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-white">Collection</h3>
                                <button id="collection-toggle-btn" class="text-gray-400 hover:text-white transition-colors cursor-pointer" data-collection-expanded="true">
                                    <i class="ph-bold ph-caret-up text-xl" id="collection-toggle-icon"></i>
                                </button>
                            </div>
                            <div id="public-collection-section">
                                <div class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left">
                                            <thead class="bg-gray-700">
                                                <tr>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Type</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Country</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Year</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Denomination</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Qty</th>
                                                    <th class="p-4 text-sm font-semibold text-gray-300">Value</th>
                                                </tr>
                                            </thead>
                                            <tbody id="public-collection-table-body">
                                                ${convertedCollection.map(item => `
                                                    <tr class="border-t border-gray-600 collection-item-row" data-search-text="${escapeHtml((item.type || '') + ' ' + (item.country || '') + ' ' + (item.denomination || '') + ' ' + (item.year || '')).toLowerCase()}">
                                                        <td class="p-4 text-sm text-gray-300">${item.type}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.country} ${item.isHistorical ? '<span class="text-xs text-amber-400">(H)</span>' : ''}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.year || 'N/A'}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.denomination}</td>
                                                        <td class="p-4 text-sm text-gray-300">${item.quantity || 1}</td>
                                                        <td class="p-4 text-sm text-gray-300">${formatCurrency(item.convertedValue, currentCurrency)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : profile.collection_public ? `
                        <div class="bg-gray-800 rounded-lg p-6 text-center border border-gray-700">
                            <p class="text-gray-400">No items in collection yet</p>
                        </div>
                    ` : `
                        <div class="bg-gray-800 rounded-lg p-6 text-center border border-gray-700">
                            <p class="text-gray-400">Collection is private</p>
                        </div>
                    `}
                    
                    <!-- Comments Section -->
                    ${profile.collection_public ? `
                        <div>
                            <h3 class="text-xl font-bold text-white mb-4">Comments</h3>
                            <div id="comments-container" class="space-y-4">
                                <!-- Comments will be loaded here -->
                            </div>
                            ${isAuthenticated() ? `
                                <div class="mt-4">
                                    <textarea id="comment-input" placeholder="Add a comment..." class="w-full bg-gray-700 text-white rounded-md p-3 border border-gray-600 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" rows="3"></textarea>
                                    <button id="submit-comment-btn" class="mt-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md transition-colors" data-username="${escapeHtml(profile.username)}">
                                        Post Comment
                                    </button>
                                </div>
                            ` : `
                                <p class="text-gray-400 text-sm mt-4">Sign in to leave a comment</p>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Load comments
            if (profile.collection_public) {
                loadComments(profile.username);
            }
            
            // Attach event handlers
            attachProfileEventHandlers(profile);

            // Use setTimeout to ensure DOM is fully updated before attaching handlers
            setTimeout(() => {
                // Add click handler for wishlist toggle
                const wishlistStatCard = document.getElementById('wishlist-stat-card');
                const wishlistSection = document.getElementById('public-wishlist-section');
                const wishlistToggleIcon = document.getElementById('wishlist-toggle-icon');
                
                if (wishlistStatCard && wishlistSection && wishlist.length > 0) {
                    wishlistStatCard.addEventListener('click', () => {
                        const isExpanded = wishlistStatCard.getAttribute('data-wishlist-expanded') === 'true';
                        
                        if (isExpanded) {
                            wishlistSection.classList.add('hidden');
                            wishlistStatCard.setAttribute('data-wishlist-expanded', 'false');
                            if (wishlistToggleIcon) {
                                wishlistToggleIcon.className = 'ph-bold ph-caret-down text-pink-400';
                            }
                        } else {
                            wishlistSection.classList.remove('hidden');
                            wishlistStatCard.setAttribute('data-wishlist-expanded', 'true');
                            if (wishlistToggleIcon) {
                                wishlistToggleIcon.className = 'ph-bold ph-caret-up text-pink-400';
                            }
                        }
                    });
                }

                // Add click handler for collection toggle
                const collectionToggleBtn = document.getElementById('collection-toggle-btn');
                const collectionSection = document.getElementById('public-collection-section');
                const collectionToggleIcon = document.getElementById('collection-toggle-icon');
                
                console.log('Setting up collection toggle:', {
                    hasBtn: !!collectionToggleBtn,
                    hasSection: !!collectionSection,
                    hasIcon: !!collectionToggleIcon,
                    collectionLength: collection.length,
                    collectionPublic: profile.collection_public
                });
                
                if (collectionToggleBtn && collectionSection && collection.length > 0) {
                    collectionToggleBtn.addEventListener('click', () => {
                        const isExpanded = collectionToggleBtn.getAttribute('data-collection-expanded') === 'true';
                        
                        if (isExpanded) {
                            collectionSection.classList.add('hidden');
                            collectionToggleBtn.setAttribute('data-collection-expanded', 'false');
                            if (collectionToggleIcon) {
                                collectionToggleIcon.className = 'ph-bold ph-caret-down text-xl';
                            }
                        } else {
                            collectionSection.classList.remove('hidden');
                            collectionToggleBtn.setAttribute('data-collection-expanded', 'true');
                            if (collectionToggleIcon) {
                                collectionToggleIcon.className = 'ph-bold ph-caret-up text-xl';
                            }
                        }
                    });
                    console.log('Collection toggle handler attached successfully');
                } else {
                    console.warn('Collection toggle not attached:', {
                        hasBtn: !!collectionToggleBtn,
                        hasSection: !!collectionSection,
                        collectionLength: collection.length
                    });
                }

            }, 200); // Increased delay to ensure DOM is ready

        } catch (error) {
            console.error('Error loading user profile:', error);
            pageContent.innerHTML = `
                <div class="text-center py-8">
                    <i class="ph-bold ph-warning-circle text-6xl text-red-400 mb-4"></i>
                    <p class="text-xl text-red-400 mb-2">Error loading profile</p>
                    <p class="text-gray-500">${escapeHtml(error.message || 'Failed to load user profile')}</p>
                    <button onclick="window.history.back();" class="mt-4 bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md transition-colors">
                        Go Back
                    </button>
                </div>
            `;
        }
    }
    
    // Helper function to load comments
    async function loadComments(username) {
        const commentsContainer = document.getElementById('comments-container');
        if (!commentsContainer) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/comments?collection_owner_username=${encodeURIComponent(username)}`);
            if (!response.ok) throw new Error('Failed to load comments');
            
            const data = await response.json();
            const comments = data.comments || [];
            
            if (comments.length === 0) {
                commentsContainer.innerHTML = '<p class="text-gray-400 text-sm">No comments yet. Be the first to comment!</p>';
            } else {
                commentsContainer.innerHTML = comments.map(comment => `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <span class="font-semibold text-white">${escapeHtml(comment.display_name || comment.username)}</span>
                                <span class="text-gray-400 text-sm ml-2">@${escapeHtml(comment.username)}</span>
                            </div>
                            <span class="text-gray-500 text-xs">${new Date(comment.created_at).toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-300">${escapeHtml(comment.content)}</p>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading comments:', error);
            commentsContainer.innerHTML = '<p class="text-gray-400 text-sm">Failed to load comments</p>';
        }
    }
    
    // Helper function to attach profile event handlers
    function attachProfileEventHandlers(profile) {
        // Follow/Unfollow button
        const followBtn = document.getElementById('follow-btn');
        if (followBtn) {
            followBtn.addEventListener('click', async () => {
                const username = followBtn.dataset.username;
                const isFollowing = followBtn.dataset.following === 'true';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/users/${encodeURIComponent(username)}/follow`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to toggle follow');
                    
                    const result = await response.json();
                    const newFollowingStatus = result.is_following;
                    
                    // Update button
                    followBtn.dataset.following = newFollowingStatus;
                    if (newFollowingStatus) {
                        followBtn.textContent = 'Unfollow';
                        followBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                        followBtn.classList.add('bg-gray-600', 'hover:bg-gray-500');
                    } else {
                        followBtn.textContent = 'Follow';
                        followBtn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
                        followBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                    }
                    
                    // Update follower count
                    const followersLink = document.getElementById('followers-link');
                    if (followersLink) {
                        const currentCount = parseInt(followersLink.querySelector('.font-semibold').textContent);
                        followersLink.querySelector('.font-semibold').textContent = newFollowingStatus ? currentCount + 1 : Math.max(0, currentCount - 1);
                    }
                    
                    showCustomConfirm(result.message, () => {});
                } catch (error) {
                    console.error('Error toggling follow:', error);
                    showCustomConfirm('Failed to update follow status', () => {});
                }
            });
        }
        
        // Followers/Following links
        const followersLink = document.getElementById('followers-link');
        const followingLink = document.getElementById('following-link');
        
        if (followersLink) {
            followersLink.addEventListener('click', () => {
                showFollowersFollowingList(profile.username, 'followers');
            });
        }
        
        if (followingLink) {
            followingLink.addEventListener('click', () => {
                showFollowersFollowingList(profile.username, 'following');
            });
        }
        
        // Compare collections button
        const compareBtn = document.getElementById('compare-collections-btn');
        if (compareBtn) {
            compareBtn.addEventListener('click', () => {
                showCollectionComparison(profile.username);
            });
        }
        
        // Submit comment button
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        if (submitCommentBtn) {
            submitCommentBtn.addEventListener('click', async () => {
                const commentInput = document.getElementById('comment-input');
                const content = commentInput?.value.trim();
                
                if (!content) {
                    showCustomConfirm('Please enter a comment', () => {});
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify({
                            collection_owner_username: profile.username,
                            content: content
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to post comment');
                    
                    commentInput.value = '';
                    showCustomConfirm('Comment posted successfully', () => {});
                    loadComments(profile.username);
                } catch (error) {
                    console.error('Error posting comment:', error);
                    showCustomConfirm('Failed to post comment', () => {});
                }
            });
        }
    }
    
    // Wrapper functions for profile page
    async function showFollowersModal(username) {
        showFollowersFollowingList(username, 'followers');
    }

    async function showFollowingModal(username) {
        showFollowersFollowingList(username, 'following');
    }

    // Show followers/following list modal
    async function showFollowersFollowingList(username, type) {
        try {
            const response = await fetch(`${API_BASE_URL}/users/${encodeURIComponent(username)}/${type}`);
            if (!response.ok) throw new Error(`Failed to load ${type}`);
            
            const data = await response.json();
            const users = data[type] || [];
            
            const modalContent = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">${type === 'followers' ? 'Followers' : 'Following'}</h3>
                        <button id="close-followers-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        ${users.length === 0 ? `
                            <p class="text-gray-400 text-center py-8">No ${type} yet</p>
                        ` : `
                            <div class="space-y-2">
                                ${users.map(user => `
                                    <div class="bg-gray-700 rounded-lg p-3 hover:bg-gray-600 transition-colors cursor-pointer" onclick="window.history.pushState({}, '', '/@${escapeHtml(user.username)}'); handleHistoryNavigation('/@${escapeHtml(user.username)}'); document.getElementById('close-followers-modal')?.click();">
                                        <div class="font-semibold text-white">${escapeHtml(user.display_name || user.username)}</div>
                                        <div class="text-sm text-gray-400">@${escapeHtml(user.username)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[110] flex items-center justify-center modal-backdrop';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Close button
            modal.querySelector('#close-followers-modal')?.addEventListener('click', () => {
                modal.remove();
            });
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        } catch (error) {
            console.error(`Error loading ${type}:`, error);
            showCustomConfirm(`Failed to load ${type}`, () => {});
        }
    }
    
    // Show collection comparison
    async function showCollectionComparison(otherUsername) {
        try {
            const response = await fetch(`${API_BASE_URL}/users/compare?username2=${encodeURIComponent(otherUsername)}`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });
            
            if (!response.ok) throw new Error('Failed to compare collections');
            
            const data = await response.json();
            const user1 = data.user1;
            const user2 = data.user2;
            const currentCurrency = localStorage.getItem('currency') || 'USD';
            
            const user1Value = convertToCurrency(user1.total_value || 0, 'USD', currentCurrency);
            const user2Value = convertToCurrency(user2.total_value || 0, 'USD', currentCurrency);
            
            const modalContent = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700 w-full max-w-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-white">Collection Comparison</h3>
                        <button id="close-comparison-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-white mb-3">${escapeHtml(user1.username)}</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Items:</span>
                                    <span class="text-white font-semibold">${user1.item_count}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Value:</span>
                                    <span class="text-emerald-400 font-semibold">${formatCurrency(user1Value, currentCurrency)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Countries:</span>
                                    <span class="text-white font-semibold">${user1.unique_countries}</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-white mb-3">${escapeHtml(user2.username)}</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Items:</span>
                                    <span class="text-white font-semibold">${user2.item_count}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Total Value:</span>
                                    <span class="text-emerald-400 font-semibold">${formatCurrency(user2Value, currentCurrency)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Countries:</span>
                                    <span class="text-white font-semibold">${user2.unique_countries}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Difference</div>
                            <div class="text-lg font-semibold ${user1.item_count > user2.item_count ? 'text-emerald-400' : user1.item_count < user2.item_count ? 'text-red-400' : 'text-gray-400'}">
                                ${user1.item_count > user2.item_count ? '+' : ''}${user1.item_count - user2.item_count}
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Value Diff</div>
                            <div class="text-lg font-semibold ${user1Value > user2Value ? 'text-emerald-400' : user1Value < user2Value ? 'text-red-400' : 'text-gray-400'}">
                                ${user1Value > user2Value ? '+' : ''}${formatCurrency(user1Value - user2Value, currentCurrency)}
                            </div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="text-xs text-gray-400 mb-1">Countries Diff</div>
                            <div class="text-lg font-semibold ${user1.unique_countries > user2.unique_countries ? 'text-emerald-400' : user1.unique_countries < user2.unique_countries ? 'text-red-400' : 'text-gray-400'}">
                                ${user1.unique_countries > user2.unique_countries ? '+' : ''}${user1.unique_countries - user2.unique_countries}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[110] flex items-center justify-center modal-backdrop';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Close button
            modal.querySelector('#close-comparison-modal')?.addEventListener('click', () => {
                modal.remove();
            });
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        } catch (error) {
            console.error('Error comparing collections:', error);
            showCustomConfirm('Failed to compare collections', () => {});
        }
    }

    // --- DUPLICATE DETECTION FUNCTIONS ---
    let currentDuplicates = [];
    let selectedCoinsForMerge = [];

    async function handleFindDuplicates() {
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to find duplicates.', () => {});
            return;
        }

        const findDuplicatesBtn = document.getElementById('find-duplicates-btn');
        setLoadingState('find-duplicates-btn', true, 'Finding duplicates...');

        try {
            const response = await fetch(`${API_BASE_URL}/coins/duplicates`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            currentDuplicates = data.duplicates || [];
            
            displayDuplicates(currentDuplicates);
        } catch (error) {
            console.error('Error finding duplicates:', error);
            showCustomConfirm(`Failed to find duplicates: ${error.message}`, () => {});
        } finally {
            setLoadingState('find-duplicates-btn', false);
        }
    }

    function displayDuplicates(duplicates) {
        const container = document.getElementById('duplicates-container');
        const list = document.getElementById('duplicates-list');
        const noDuplicatesMsg = document.getElementById('no-duplicates-message');

        if (!container || !list) return;

        list.innerHTML = '';

        if (duplicates.length === 0) {
            container.classList.remove('hidden');
            noDuplicatesMsg.classList.remove('hidden');
            list.classList.add('hidden');
            return;
        }

        noDuplicatesMsg.classList.add('hidden');
        list.classList.remove('hidden');
        container.classList.remove('hidden');

        duplicates.forEach((duplicateGroup, groupIndex) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'bg-gray-700 rounded-lg p-4 border border-gray-600';
            
            const key = duplicateGroup.key;
            const yearDisplay = key.year || 'N/A';
            const totalQuantity = duplicateGroup.coins.reduce((sum, coin) => sum + (coin.quantity || 1), 0);
            
            groupDiv.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-1">
                            ${key.country} - ${yearDisplay} - ${key.denomination}
                        </h4>
                        <p class="text-sm text-gray-400">
                            ${duplicateGroup.count} duplicate${duplicateGroup.count > 1 ? 's' : ''} found (Total quantity: ${totalQuantity})
                        </p>
                    </div>
                    <button class="merge-group-btn bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm" 
                            data-group-index="${groupIndex}">
                        <i class="ph-bold ph-arrows-merge mr-2"></i>Compare & Merge
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${duplicateGroup.coins.map(coin => `
                        <div class="bg-gray-800 p-3 rounded border border-gray-600">
                            <div class="text-xs text-gray-400 mb-1">ID: ${coin.id}</div>
                            <div class="text-sm text-gray-300">Qty: ${coin.quantity || 1}</div>
                            ${coin.value ? `<div class="text-sm text-gray-300">Value: ${formatCurrency(coin.value)}</div>` : ''}
                            ${coin.type ? `<div class="text-sm text-gray-300">Type: ${coin.type}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            list.appendChild(groupDiv);
        });

        // Add event listeners for merge buttons
        document.querySelectorAll('.merge-group-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const groupIndex = parseInt(e.currentTarget.dataset.groupIndex);
                showMergeModal(duplicates[groupIndex]);
            });
        });
    }

    function showMergeModal(duplicateGroup) {
        const modal = document.getElementById('merge-duplicates-modal');
        const modalContent = document.getElementById('merge-modal-content');
        
        if (!modal || !modalContent) return;

        selectedCoinsForMerge = duplicateGroup.coins.map(coin => coin.id);

        const key = duplicateGroup.key;
        const yearDisplay = key.year || 'N/A';
        
        modalContent.innerHTML = `
            <div class="mb-4 p-4 bg-gray-700 rounded-lg">
                <h3 class="text-xl font-semibold text-white mb-2">
                    ${key.country} - ${yearDisplay} - ${key.denomination}
                </h3>
                <p class="text-gray-400">Review the items below and merge them if they are duplicates.</p>
            </div>
            <div class="space-y-4">
                ${duplicateGroup.coins.map((coin, index) => `
                    <div class="border border-gray-600 rounded-lg p-4 bg-gray-700">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <input type="checkbox" 
                                       class="merge-coin-checkbox h-5 w-5 text-emerald-600 focus:ring-emerald-500 border-gray-600 rounded" 
                                       data-coin-id="${coin.id}" 
                                       checked>
                            </div>
                            <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">ID</div>
                                    <div class="text-white font-semibold">${coin.id}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">Type</div>
                                    <div class="text-white">${coin.type || 'N/A'}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">Quantity</div>
                                    <div class="text-white font-semibold">${coin.quantity || 1}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">Value</div>
                                    <div class="text-white">${coin.value ? formatCurrency(coin.value) : 'N/A'}</div>
                                </div>
                                ${coin.notes ? `
                                <div class="md:col-span-2">
                                    <div class="text-sm text-gray-400 mb-1">Notes</div>
                                    <div class="text-white text-sm">${escapeHtml(coin.notes)}</div>
                                </div>
                                ` : ''}
                                ${coin.referenceUrl ? `
                                <div class="md:col-span-2">
                                    <div class="text-sm text-gray-400 mb-1">Reference URL</div>
                                    <a href="${coin.referenceUrl}" target="_blank" class="text-emerald-400 hover:text-emerald-300 text-sm break-all">${coin.referenceUrl}</a>
                                </div>
                                ` : ''}
                                ${coin.localImagePath && coin.localImagePath !== "https://placehold.co/300x300/1f2937/d1d5db?text=No+Image" ? `
                                <div class="md:col-span-2">
                                    <div class="text-sm text-gray-400 mb-1">Image</div>
                                    <img src="${coin.localImagePath}" alt="Coin image" class="max-w-xs rounded border border-gray-600">
                                </div>
                                ` : ''}
                                ${coin.weight_grams ? `
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">Weight (g)</div>
                                    <div class="text-white">${coin.weight_grams}</div>
                                </div>
                                ` : ''}
                                ${coin.purity_percent ? `
                                <div>
                                    <div class="text-sm text-gray-400 mb-1">Purity (%)</div>
                                    <div class="text-white">${coin.purity_percent}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="mt-4 p-4 bg-emerald-900/20 border border-emerald-700 rounded-lg">
                <p class="text-emerald-300 text-sm">
                    <i class="ph-bold ph-info mr-2"></i>
                    Merging will combine quantities and merge notes. The merged coin will keep the highest value and first available image.
                </p>
            </div>
        `;

        // Update selected coins when checkboxes change
        document.querySelectorAll('.merge-coin-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const coinId = parseInt(e.target.dataset.coinId);
                if (e.target.checked) {
                    if (!selectedCoinsForMerge.includes(coinId)) {
                        selectedCoinsForMerge.push(coinId);
                    }
                } else {
                    selectedCoinsForMerge = selectedCoinsForMerge.filter(id => id !== coinId);
                }
            });
        });

        openModal('merge-duplicates-modal');
    }

    async function handleMergeCoins() {
        if (selectedCoinsForMerge.length < 2) {
            showCustomConfirm('Please select at least 2 coins to merge.', () => {});
            return;
        }

        const mergeBtn = document.getElementById('merge-confirm-btn');
        setLoadingState('merge-confirm-btn', true, 'Merging...');

        try {
            const response = await fetch(`${API_BASE_URL}/coins/merge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    coin_ids: selectedCoinsForMerge
                })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            showCustomConfirm(result.message || 'Coins merged successfully!', () => {});
            
            // Close modal and refresh data
            closeModal(document.getElementById('merge-duplicates-modal'), document.getElementById('merge-duplicates-modal').querySelector('div'));
            selectedCoinsForMerge = [];
            
            // Refresh collection and re-find duplicates
            await loadCollectionFromBackend();
            await handleFindDuplicates();
        } catch (error) {
            console.error('Error merging coins:', error);
            showCustomConfirm(`Failed to merge coins: ${error.message}`, () => {});
        } finally {
            setLoadingState('merge-confirm-btn', false);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // --- USERNAME MODAL FUNCTIONS ---
    function showUsernameModal() {
        const modal = document.getElementById('username-modal');
        if (modal) {
            openModal('username-modal');
            const usernameInput = document.getElementById('username-input');
            if (usernameInput) {
                usernameInput.focus();
            }
        }
    }

    async function handleSetUsername() {
        const usernameInput = document.getElementById('username-input');
        const errorElement = document.getElementById('username-error');
        const submitBtn = document.getElementById('username-submit-btn');
        
        if (!usernameInput) return;
        
        const username = usernameInput.value.trim();
        
        // Clear previous errors
        if (errorElement) {
            errorElement.classList.add('hidden');
            errorElement.textContent = '';
        }
        
        // Basic client-side validation
        if (!username) {
            if (errorElement) {
                errorElement.textContent = 'Username is required';
                errorElement.classList.remove('hidden');
            }
            return;
        }
        
        if (username.length < 3) {
            if (errorElement) {
                errorElement.textContent = 'Username must be at least 3 characters';
                errorElement.classList.remove('hidden');
            }
            return;
        }
        
        setLoadingState('username-submit-btn', true, 'Setting username...');
        
        try {
            const response = await fetch(`${API_BASE_URL}/set_username`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({ username })
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to set username');
            }
            
            const result = await response.json();
            showCustomConfirm(result.message || 'Username set successfully!', () => {});
            
            // Close modal
            const modal = document.getElementById('username-modal');
            if (modal) {
                closeModal(modal, modal.querySelector('div'));
            }
            
            // Clear input
            usernameInput.value = '';
            
        } catch (error) {
            console.error('Error setting username:', error);
            if (errorElement) {
                errorElement.textContent = error.message || 'Failed to set username';
                errorElement.classList.remove('hidden');
            }
        } finally {
            setLoadingState('username-submit-btn', false);
        }
    }

    function handleThemeChange(event) {
        const newTheme = event.target.value;
        document.documentElement.classList.remove('light', 'dark');
        document.documentElement.classList.add(newTheme);
        localStorage.setItem('theme', newTheme);
        showCustomConfirm(`Theme set to ${newTheme === 'dark' ? 'Dark Mode' : 'Light Mode'}.`, () => {});
    }

    async function handleChangePassword(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;

        if (!currentPassword || !newPassword || !confirmNewPassword) {
            showCustomConfirm('All password fields are required.', () => {});
            return;
        }

        if (newPassword !== confirmNewPassword) {
            showCustomConfirm('New password and confirmation do not match.', () => {});
            return;
        }

        if (newPassword.length < 6) {
            showCustomConfirm('New password must be at least 6 characters long.', () => {});
            return;
        }

        if (!isAuthenticated()) {
            showCustomConfirm('You must be logged in to change your password.', () => {});
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/change_password`, { // Assuming this endpoint exists on your backend
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to change password.');
            }

            const result = await response.json();
            showCustomConfirm(result.message || 'Password changed successfully!', () => {
                // Clear password fields after success
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';
            });
        } catch (error) {
            console.error("Change password error:", error.message);
            showCustomConfirm(`Failed to change password: ${error.message}`, () => {});
        }
    }

    // New: Public URL functionality
    async function fetchPublicUrl() {
        const publicUrlInput = document.getElementById('public-collection-url');
        const publicUrlStatus = document.getElementById('public-url-status');
        publicUrlInput.value = '';
        publicUrlStatus.innerText = '';

        if (!isAuthenticated()) {
            publicUrlInput.placeholder = "Sign in to generate your public link.";
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/public_collection_link`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    publicUrlStatus.innerText = 'No public link generated yet.';
                    publicUrlInput.placeholder = "Your public collection URL will appear here";
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const fullUrl = `${window.location.origin}/?public=${result.public_id}`; // Construct full URL
            publicUrlInput.value = fullUrl;
            publicUrlStatus.innerText = 'Your public collection link is active.';
            publicUrlStatus.classList.remove('text-red-400');
            publicUrlStatus.classList.add('text-emerald-400');

        } catch (error) {
            console.error("Error fetching public URL:", error);
            publicUrlStatus.innerText = `Error: ${error.message}.`;
            publicUrlStatus.classList.remove('text-emerald-400');
            publicUrlStatus.classList.add('text-red-400');
            publicUrlInput.placeholder = "Could not fetch public URL.";
        }
    }

    async function generatePublicUrl() {
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to generate a public link.', () => {});
            return;
        }
        showCustomConfirm('Generate a new public link? This will make your collection viewable by anyone with the link.', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/generate_public_collection_link`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to generate public link.');
                }

                const result = await response.json();
                const fullUrl = `${window.location.origin}/?public=${result.public_id}`;
                document.getElementById('public-collection-url').value = fullUrl;
                document.getElementById('public-url-status').innerText = 'Public link generated/updated!';
                document.getElementById('public-url-status').classList.remove('text-red-400');
                document.getElementById('public-url-status').classList.add('text-emerald-400');
                showCustomConfirm('Public link generated/updated successfully! Copy it from settings.', () => {});
            } catch (error) {
                console.error("Error generating public URL:", error);
                showCustomConfirm(`Failed to generate public link: ${error.message}`, () => {});
            }
        });
    }

    async function revokePublicUrl() {
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to revoke your public link.', () => {});
            return;
        }
        showCustomConfirm('Are you sure you want to revoke your public link? Your collection will no longer be shareable via URL.', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/revoke_public_collection_link`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to revoke public link.');
                }

                const result = await response.json();
                document.getElementById('public-collection-url').value = '';
                document.getElementById('public-collection-url').placeholder = "Your public collection URL will appear here";
                document.getElementById('public-url-status').innerText = 'Public link revoked.';
                document.getElementById('public-url-status').classList.remove('text-emerald-400');
                document.getElementById('public-url-status').classList.add('text-red-400');
                showCustomConfirm('Public link revoked successfully!', () => {});
            } catch (error) {
                console.error("Error revoking public URL:", error);
                showCustomConfirm(`Failed to revoke public link: ${error.message}`, () => {});
            }
        });
    }

    function copyPublicUrl() {
        const publicUrlInput = document.getElementById('public-collection-url');
        if (publicUrlInput.value) {
            publicUrlInput.select();
            document.execCommand('copy');
            showCustomConfirm('Public URL copied to clipboard!', () => {});
        } else {
            showCustomConfirm('No public URL to copy. Generate one first.', () => {});
        }
    }


    // --- Public Collection View Rendering ---
    function renderPublicCollection() {
        const publicContentView = document.getElementById('content-public-collection');
        const publicTitle = document.getElementById('public-collection-title');
        const publicTotalItems = document.getElementById('public-total-items');
        const publicTotalValue = document.getElementById('public-total-value');
        const publicUniqueCountries = document.getElementById('public-unique-countries');
        const publicTableBody = document.getElementById('public-collection-table-body');
        const publicStatus = document.getElementById('public-collection-status');
        const publicSummary = document.getElementById('public-collection-summary');

        publicStatus.innerText = ''; // Clear previous status messages

        if (publicCollectionData.length === 0) {
            publicTitle.innerText = 'Public Collection (Empty or Not Found)';
            publicTotalItems.innerText = '0';
            publicTotalValue.innerText = '$0.00';
            publicUniqueCountries.innerText = '0';
            publicTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No items available in this public collection.</td></tr>';
            publicSummary.classList.remove('grid');
            publicSummary.classList.add('hidden');
            return;
        }

        publicSummary.classList.add('grid'); // Ensure grid display for summary
        publicSummary.classList.remove('hidden');

        // Assuming publicCollectionData comes with a 'username' or similar property from backend
        // If not, you might need to fetch it separately or pass it with the public data.
        // For now, let's assume `publicCollectionData[0].owner_email` or similar might be available if user data is included.
        // Otherwise, just call it "Shared Collection"
        const ownerName = publicCollectionData[0] ? publicCollectionData[0].owner_email : 'Shared User'; // Placeholder
        publicTitle.innerText = `${ownerName}'s Public Collection`;

        // Sum quantities for total items (not just count rows)
        const totalItems = publicCollectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
        // Multiply value by quantity for accurate total value
        const totalValue = publicCollectionData.reduce((sum, item) => sum + ((item.value || 0) * (item.quantity || 1)), 0);
        const uniqueCountries = new Set(publicCollectionData.map(item => item.country)).size;

        publicTotalItems.innerText = totalItems;
        publicTotalValue.innerText = `$${totalValue.toFixed(2)}`;
        publicUniqueCountries.innerText = uniqueCountries;

        const tableRows = publicCollectionData.map(item => `
            <tr class="border-b border-gray-700">
                <td class="p-4">${item.id}</td>
                <td class="p-4">${item.type}</td>
                <td class="p-4">${item.country} ${item.isHistorical ? '<span class="text-xs text-amber-400">(Historical)</span>' : ''}</td>
                <td class="p-4">${item.year || 'N/A'}</td>
                <td class="p-4">${item.denomination}</td>
                <td class="p-4">${item.quantity || 1}</td>
                <td class="p-4">$${((item.value || 0) * (item.quantity || 1)).toFixed(2)}</td>
                <td class="p-4">
                    <p class="text-xs text-gray-400">${item.notes || 'N/A'}</p>
                    ${item.referenceUrl ? `<a href="${item.referenceUrl}" target="_blank" class="text-blue-400 hover:underline text-xs"><i class="ph-bold ph-link-simple-horizontal"></i> Reference Link</a>` : ''}
                </td>
            </tr>
        `).join('');
        publicTableBody.innerHTML = tableRows;
    }


    // --- NAVIGATION & UI Management ---
    function showView(viewId) {
        document.querySelectorAll('.content-view').forEach(view => {
            view.classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('bg-gray-700', 'text-white');
            link.classList.add('hover:bg-gray-700');
        });
        // Highlight active nav link, but only if it's one of the main ones (not for public view loaded via URL)
        const navLinkId = `nav-${viewId.replace('content-', '')}`;
        const activeNavLink = document.getElementById(navLinkId);
        if (activeNavLink) {
            activeNavLink.classList.add('bg-gray-700', 'text-white');
        }

        renderAllViews();
    }

    function renderAllViews() {
        console.log('Rendering all views. Authenticated:', isAuthenticated());
        // Apply theme on every render to ensure consistency
        applySavedTheme();

        // Check URL for public collection ID
        const urlParams = new URLSearchParams(window.location.search);
        const publicId = urlParams.get('public');

        if (publicId) {
            // If public ID is present, force public collection view
            document.querySelectorAll('.content-view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById('content-public-collection').classList.remove('hidden');
            loadPublicCollectionFromBackend(publicId);
            // Do not update main nav links for public view
            return; // Exit as we are in public view mode
        }


        // No authentication check needed for Home page
        if (!document.getElementById('content-home').classList.contains('hidden')) {
            renderHome();
        }
        
        // No authentication check needed for Auth page
        if (!document.getElementById('content-auth').classList.contains('hidden')) {
            // Auth page is already visible, no need to render anything special
        }

        // For authenticated views, check if authenticated before rendering
        if (isAuthenticated()) {
            if (!document.getElementById('content-dashboard').classList.contains('hidden')) {
                renderDashboard();
            }
            if (!document.getElementById('content-collection').classList.contains('hidden')) {
                renderCollection();
            }
            if (!document.getElementById('content-map').classList.contains('hidden')) {
                renderGeoChart();
            }
            if (!document.getElementById('content-missing').classList.contains('hidden')) {
                renderMissingCountries();
            }
            if (!document.getElementById('content-settings').classList.contains('hidden')) {
                renderSettings();
            }
            if (!document.getElementById('content-profile').classList.contains('hidden')) {
                renderProfile();
            }
        } else {
            // If not authenticated, ensure these views show their respective unauthenticated overlays
            if (!document.getElementById('content-dashboard').classList.contains('hidden')) {
                const dashboardContentWrapper = document.getElementById('content-dashboard').querySelector('.max-w-7xl.mx-auto');
                if (dashboardContentWrapper) {
                    dashboardContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view your dashboard.</p></div>`;
                }
            }
            if (!document.getElementById('content-collection').classList.contains('hidden')) {
                const collectionContentWrapper = document.getElementById('content-collection').querySelector('.max-w-7xl.mx-auto');
                if (collectionContentWrapper) {
                    collectionContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to manage your collection.</p></div>`;
                }
            }
            if (!document.getElementById('content-map').classList.contains('hidden')) {
                const mapContentWrapper = document.getElementById('content-map').querySelector('.max-w-7xl.mx-auto');
                if (mapContentWrapper) {
                    mapContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view the map.</p></div>`;
                }
            }
            if (!document.getElementById('content-missing').classList.contains('hidden')) {
                const missingCountriesContentWrapper = document.getElementById('content-missing').querySelector('.max-w-7xl.mx-auto');
                if (missingCountriesContentWrapper) {
                    missingCountriesContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to view missing countries.</p></div>`;
                }
            }
            // For settings, it has its own internal overlay that renderSettings will handle
            if (!document.getElementById('content-settings').classList.contains('hidden')) {
                renderSettings(); // Calls renderSettings, which handles its own overlay
            }
            // For profile, it has its own internal overlay that renderProfile will handle
            if (!document.getElementById('content-profile').classList.contains('hidden')) {
                renderProfile(); // Calls renderProfile, which handles its own overlay
            }
        }
        
        // Members page doesn't require authentication (public profiles)
        if (!document.getElementById('content-members').classList.contains('hidden')) {
            renderMembers();
        }
        
        // Catalogue page requires authentication
        if (!document.getElementById('content-catalogue').classList.contains('hidden')) {
            if (isAuthenticated()) {
                setupCatalogueSearch();
            } else {
                // Show message if not authenticated
                const catalogueContent = document.getElementById('content-catalogue');
                if (catalogueContent) {
                    const wrapper = catalogueContent.querySelector('.max-w-7xl');
                    if (wrapper) {
                        wrapper.innerHTML = '<div class="text-center py-12"><p class="text-xl text-red-400">Please sign in to search the catalogue.</p></div>';
                    }
                }
            }
        }
        
        // Wishlist page requires authentication
        if (!document.getElementById('content-wishlist').classList.contains('hidden')) {
            if (isAuthenticated()) {
                loadWishlist();
            } else {
                const wishlistContent = document.getElementById('content-wishlist');
                if (wishlistContent) {
                    const wrapper = wishlistContent.querySelector('.max-w-7xl');
                    if (wrapper) {
                        wrapper.innerHTML = '<div class="text-center py-12"><p class="text-xl text-red-400">Please sign in to view your wishlist.</p></div>';
                    }
                }
            }
        }
    }
    
    // Catalogue Search Functionality
    function setupCatalogueSearch() {
        const searchBtn = document.getElementById('catalogue-search-btn');
        const searchInput = document.getElementById('catalogue-search-input');
        
        if (!searchBtn || !searchInput) {
            console.warn('Catalogue search elements not found, skipping setup');
            return;
        }
        
        // Remove existing listeners if any (to prevent duplicates)
        const newSearchBtn = searchBtn.cloneNode(true);
        searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn);
        newSearchBtn.addEventListener('click', handleCatalogueSearch);
        
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        newSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleCatalogueSearch();
            }
        });
    }
    
    async function handleCatalogueSearch() {
        const searchInput = document.getElementById('catalogue-search-input');
        const typeFilter = document.getElementById('catalogue-type-filter');
        const loadingDiv = document.getElementById('catalogue-loading');
        const errorDiv = document.getElementById('catalogue-error');
        const errorMessage = document.getElementById('catalogue-error-message');
        const resultsDiv = document.getElementById('catalogue-results');
        const resultsList = document.getElementById('catalogue-results-list');
        const resultsCount = document.getElementById('catalogue-results-count');
        const noResultsDiv = document.getElementById('catalogue-no-results');
        
        const query = searchInput.value.trim();
        const itemType = typeFilter.value.toLowerCase();
        
        if (!query) {
            showCustomConfirm('Please enter a search term.', () => {});
            return;
        }
        
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to search the catalogue.', () => {});
            return;
        }
        
        // Show loading, hide other states
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        resultsDiv.classList.add('hidden');
        noResultsDiv.classList.add('hidden');
        
        try {
            const token = getAuthToken();
            if (!token) {
                showCustomConfirm('Please sign in to search the catalogue.', () => {});
                loadingDiv.classList.add('hidden');
                return;
            }
            
            const response = await fetch(`${API_BASE_URL}/search-numista?q=${encodeURIComponent(query)}&type=${itemType}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Catalogue search error: Non-JSON response', text.substring(0, 200));
                loadingDiv.classList.add('hidden');
                errorMessage.textContent = 'Server returned an unexpected response. Please check your backend logs.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            let data;
            try {
                data = await response.json();
            } catch (e) {
                console.error('Catalogue search error: SyntaxError parsing JSON', e);
                loadingDiv.classList.add('hidden');
                errorMessage.textContent = 'Server returned invalid JSON. This usually means the Numista API endpoint is incorrect or authentication failed. Please check your backend logs.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            loadingDiv.classList.add('hidden');
            
            if (data.error) {
                errorMessage.textContent = data.error;
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!data.results || data.results.length === 0) {
                noResultsDiv.classList.remove('hidden');
                return;
            }
            
            // Display results
            resultsCount.textContent = `Found ${data.results.length} result${data.results.length > 1 ? 's' : ''}`;
            resultsList.innerHTML = '';
            
            data.results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-emerald-500 transition-colors';
                card.innerHTML = `
                    <div class="flex flex-col h-full">
                        ${result.image_url ? `
                            <div class="mb-3 flex justify-center">
                                <img src="${escapeHtml(result.image_url)}" alt="${escapeHtml(result.title || result.denomination || 'Coin')}" 
                                     class="max-w-full h-32 object-contain rounded-md bg-gray-700 p-2" 
                                     onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                        <h4 class="font-bold text-white text-lg mb-2">${escapeHtml(result.title || result.denomination || 'Untitled')}</h4>
                        ${result.country ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Country:</span> ${escapeHtml(result.country)}</p>` : ''}
                        ${result.year ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Year:</span> ${result.year}</p>` : ''}
                        ${result.denomination && result.denomination !== result.title ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Denomination:</span> ${escapeHtml(result.denomination)}</p>` : ''}
                        ${result.composition ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Composition:</span> ${escapeHtml(result.composition)}</p>` : ''}
                        ${result.weight ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Weight:</span> ${escapeHtml(result.weight)}${result.weight.includes('g') ? '' : 'g'}</p>` : ''}
                        ${result.description ? `<p class="text-xs text-gray-500 mt-2 line-clamp-2">${escapeHtml(result.description.substring(0, 100))}${result.description.length > 100 ? '...' : ''}</p>` : ''}
                        <div class="mt-4 flex flex-col gap-2">
                            <div class="flex gap-2">
                                <button class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm add-to-collection-btn" data-index="${index}">
                                    <i class="ph-bold ph-plus-circle mr-2"></i> Add to Collection
                                </button>
                                <button class="flex-1 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm add-to-wishlist-btn" data-index="${index}">
                                    <i class="ph-bold ph-heart mr-2"></i> Add to Wishlist
                                </button>
                            </div>
                            ${result.url ? `<a href="${result.url}" target="_blank" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm flex items-center justify-center" title="View on Numista">
                                <i class="ph-bold ph-arrow-square-out mr-2"></i> View on Numista
                            </a>` : ''}
                        </div>
                    </div>
                `;
                resultsList.appendChild(card);
            });
            
            // Add click handlers to "Add to Collection" buttons
            resultsList.querySelectorAll('.add-to-collection-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(btn.dataset.index);
                    const result = data.results[index];
                    addCatalogueItemToCollection(result);
                });
            });
            
            // Add click handlers to "Add to Wishlist" buttons
            resultsList.querySelectorAll('.add-to-wishlist-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(btn.dataset.index);
                    const result = data.results[index];
                    addCatalogueItemToWishlist(result);
                });
            });
            
            resultsDiv.classList.remove('hidden');
            
        } catch (error) {
            console.error('Catalogue search error:', error);
            loadingDiv.classList.add('hidden');
            errorMessage.textContent = 'Search failed. Please try again.';
            errorDiv.classList.remove('hidden');
        }
    }
    
    function addCatalogueItemToCollection(result) {
        // Clear the form first
        clearItemForm();
        
        // Populate form with result data
        if (result.country) {
            document.getElementById('country').value = result.country;
        }
        if (result.year) {
            document.getElementById('year').value = result.year;
        }
        if (result.denomination) {
            document.getElementById('denomination').value = result.denomination;
        } else if (result.title) {
            document.getElementById('denomination').value = result.title;
        }
        if (result.type) {
            const typeMap = {
                'coin': 'Coin',
                'banknote': 'Banknote'
            };
            const mappedType = typeMap[result.type.toLowerCase()] || result.type.charAt(0).toUpperCase() + result.type.slice(1);
            document.getElementById('type').value = mappedType;
        }
        if (result.url) {
            document.getElementById('referenceUrl').value = result.url;
        }
        
        // Auto-populate image URL from Numista
        // Prefer obverse_thumbnail, then reverse_thumbnail, then image_url
        const imageUrl = result.obverse_thumbnail || result.reverse_thumbnail || result.image_url || '';
        if (imageUrl) {
            document.getElementById('localImagePath').value = imageUrl;
        }
        
        // Add additional details to notes
        let notes = [];
        if (result.description) {
            notes.push(result.description);
        }
        if (result.composition) {
            notes.push(`Composition: ${result.composition}`);
        }
        if (result.weight) {
            notes.push(`Weight: ${result.weight}${result.weight.includes('g') ? '' : 'g'}`);
        }
        if (result.diameter) {
            notes.push(`Diameter: ${result.diameter}`);
        }
        if (notes.length > 0) {
            document.getElementById('notes').value = notes.join('\n');
        }
        
        // Update modal title
        document.getElementById('modal-title').innerText = 'Add Item from Numista';
        
        // Trigger bullion fields update if type changed
        const typeValue = document.getElementById('type').value;
        if (typeValue === 'Gold Bullion' || typeValue === 'Silver Bullion') {
            document.getElementById('bullion-fields').style.display = 'block';
        }
        
        // Open the modal
        openModal('item-modal');
        
        // Show success message
        showCustomConfirm(`Item "${result.title || result.denomination || 'Item'}" has been added to the form. Please review and save.`, () => {});
    }
    
    // Track ongoing wishlist additions to prevent duplicates
    const wishlistAddInProgress = new Set();
    
    async function addCatalogueItemToWishlist(result) {
        // Create a unique key for this item to prevent duplicate requests
        const itemKey = `${result.country || ''}_${result.denomination || result.title || ''}_${result.year || 'null'}_${result.id || 'null'}`;
        
        // Check if this item is already being added
        if (wishlistAddInProgress.has(itemKey)) {
            console.log('Already adding this item to wishlist, skipping duplicate request');
            return;
        }
        
        try {
            const token = getAuthToken();
            if (!token) {
                showCustomConfirm('Please sign in to add items to your wishlist.', () => {});
                return;
            }
            
            // Mark as in progress
            wishlistAddInProgress.add(itemKey);
            
            // Auto-populate image URL from Numista
            // Prefer obverse_thumbnail, then reverse_thumbnail, then image_url
            const imageUrl = result.obverse_thumbnail || result.reverse_thumbnail || result.image_url || '';
            
            const wishlistData = {
                type: result.type || 'Coin',
                country: result.country || '',
                year: result.year || null,
                denomination: result.denomination || result.title || '',
                notes: result.description || '',
                referenceUrl: result.url || '',
                numista_id: result.id || null,
                description: result.description || '',
                composition: result.composition || '',
                weight: result.weight || '',
                diameter: result.diameter || '',
                image_url: imageUrl
            };
            
            const response = await fetch(`${API_BASE_URL}/wishlist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(wishlistData)
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showCustomConfirm(data.message || 'Item added to wishlist successfully!', () => {});
            } else {
                showCustomConfirm(data.message || 'Failed to add item to wishlist.', () => {});
            }
        } catch (error) {
            console.error('Error adding to wishlist:', error);
            showCustomConfirm('An error occurred while adding to wishlist. Please try again.', () => {});
        } finally {
            // Remove from in-progress set after a delay to allow for UI updates
            setTimeout(() => {
                wishlistAddInProgress.delete(itemKey);
            }, 1000);
        }
    }
    
    // Track if wishlist is currently loading to prevent duplicate loads
    let wishlistLoading = false;
    
    async function loadWishlist() {
        // Prevent multiple simultaneous loads
        if (wishlistLoading) {
            console.log('Wishlist already loading, skipping duplicate request');
            return;
        }
        
        wishlistLoading = true;
        
        const loadingDiv = document.getElementById('wishlist-loading');
        const errorDiv = document.getElementById('wishlist-error');
        const errorMessage = document.getElementById('wishlist-error-message');
        const itemsDiv = document.getElementById('wishlist-items');
        const emptyDiv = document.getElementById('wishlist-empty');
        
        loadingDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
        // Clear existing items completely
        itemsDiv.innerHTML = '';
        emptyDiv.classList.add('hidden');
        
        try {
            const token = getAuthToken();
            if (!token) {
                loadingDiv.classList.add('hidden');
                errorMessage.textContent = 'Please sign in to view your wishlist.';
                errorDiv.classList.remove('hidden');
                wishlistLoading = false;
                return;
            }
            
            const response = await fetch(`${API_BASE_URL}/wishlist`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load wishlist');
            }
            
            const items = await response.json();
            loadingDiv.classList.add('hidden');
            
            if (!items || items.length === 0) {
                emptyDiv.classList.remove('hidden');
                wishlistLoading = false;
                return;
            }
            
            // Use a Set to track unique IDs and prevent duplicate rendering
            const seenIds = new Set();
            const uniqueItems = [];
            
            for (const item of items) {
                if (!seenIds.has(item.id)) {
                    seenIds.add(item.id);
                    uniqueItems.push(item);
                } else {
                    console.warn(`Duplicate item ID ${item.id} detected in wishlist response, skipping`);
                }
            }
            
            // Clear items div again before adding (defensive programming)
            itemsDiv.innerHTML = '';
            
            uniqueItems.forEach(item => {
                const card = document.createElement('div');
                // Add unique data attribute for debugging
                card.setAttribute('data-wishlist-item-id', item.id);
                card.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-emerald-500 transition-colors';
                card.innerHTML = `
                    <div class="flex flex-col h-full">
                            <div class="mb-3 flex justify-center">
                            ${item.image_url ? `
                                <img src="${escapeHtml(item.image_url)}" alt="${escapeHtml(item.denomination || 'Item')}" 
                                     class="max-w-full h-32 object-contain rounded-md bg-gray-700 p-2" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="hidden max-w-full h-32 rounded-md bg-gray-700 p-2 items-center justify-center">
                                    <i class="ph-bold ph-image text-4xl text-gray-500"></i>
                            </div>
                            ` : `
                                <div class="max-w-full h-32 rounded-md bg-gray-700 p-2 flex items-center justify-center">
                                    <i class="ph-bold ph-image text-4xl text-gray-500"></i>
                                </div>
                            `}
                        </div>
                        <h4 class="font-bold text-white text-lg mb-2">${escapeHtml(item.denomination || 'Untitled')}</h4>
                        ${item.country ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Country:</span> ${escapeHtml(item.country)}</p>` : ''}
                        ${item.year ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Year:</span> ${item.year}</p>` : ''}
                        ${item.type ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Type:</span> ${escapeHtml(item.type)}</p>` : ''}
                        ${item.composition ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Composition:</span> ${escapeHtml(item.composition)}</p>` : ''}
                        ${item.weight ? `<p class="text-sm text-gray-400 mb-1"><span class="text-gray-500">Weight:</span> ${escapeHtml(item.weight)}</p>` : ''}
                        ${item.description ? `<p class="text-xs text-gray-500 mt-2 line-clamp-2">${escapeHtml(item.description.substring(0, 100))}${item.description.length > 100 ? '...' : ''}</p>` : ''}
                        <div class="mt-4 flex flex-col gap-2">
                            <button class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm move-to-collection-btn" data-id="${item.id}">
                                <i class="ph-bold ph-arrow-right mr-2"></i> Move to Collection
                            </button>
                            <div class="flex gap-2">
                                <button class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm remove-from-wishlist-btn" data-id="${item.id}">
                                    <i class="ph-bold ph-trash mr-2"></i> Remove
                                </button>
                                ${item.referenceUrl ? `<a href="${item.referenceUrl}" target="_blank" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-sm flex items-center justify-center" title="View on Numista">
                                    <i class="ph-bold ph-arrow-square-out mr-2"></i> View
                                </a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                itemsDiv.appendChild(card);
            });
            
            // Add event listeners only once
            itemsDiv.querySelectorAll('.move-to-collection-btn').forEach(btn => {
                // Remove any existing listeners by cloning
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const itemId = parseInt(newBtn.dataset.id);
                    await moveWishlistItemToCollection(itemId);
                });
            });
            
            itemsDiv.querySelectorAll('.remove-from-wishlist-btn').forEach(btn => {
                // Remove any existing listeners by cloning
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const itemId = parseInt(newBtn.dataset.id);
                    await removeFromWishlist(itemId);
                });
            });
            
        } catch (error) {
            console.error('Error loading wishlist:', error);
            loadingDiv.classList.add('hidden');
            errorMessage.textContent = 'Failed to load wishlist. Please try again.';
            errorDiv.classList.remove('hidden');
        } finally {
            wishlistLoading = false;
        }
    }
    
    async function moveWishlistItemToCollection(itemId) {
        try {
            const token = getAuthToken();
            if (!token) {
                showCustomConfirm('Please sign in to move items.', () => {});
                return;
            }
            
            const response = await fetch(`${API_BASE_URL}/wishlist/${itemId}/move-to-collection`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showCustomConfirm(data.message || 'Item moved to collection successfully!', () => {
                    loadWishlist(); // Reload wishlist
                    // Reload collection if collection page is visible
                    if (!document.getElementById('content-collection').classList.contains('hidden')) {
                        loadCollectionFromBackend();
                    }
                });
            } else {
                showCustomConfirm(data.message || 'Failed to move item to collection.', () => {});
            }
        } catch (error) {
            console.error('Error moving to collection:', error);
            showCustomConfirm('An error occurred. Please try again.', () => {});
        }
    }
    
    // Track ongoing deletions to prevent duplicate requests
    const wishlistDeleteInProgress = new Set();
    
    async function removeFromWishlist(itemId) {
        // Prevent duplicate delete requests
        if (wishlistDeleteInProgress.has(itemId)) {
            console.log(`Already deleting wishlist item ${itemId}, skipping duplicate request`);
            return;
        }
        
        if (!confirm('Are you sure you want to remove this item from your wishlist?')) {
            return;
        }
        
        wishlistDeleteInProgress.add(itemId);
        
        try {
            const token = getAuthToken();
            if (!token) {
                showCustomConfirm('Please sign in to remove items.', () => {});
                wishlistDeleteInProgress.delete(itemId);
                return;
            }
            
            console.log(`Deleting wishlist item ID: ${itemId}`);
            
            const response = await fetch(`${API_BASE_URL}/wishlist/${itemId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                console.log(`Successfully deleted wishlist item ID: ${itemId}`);
                showCustomConfirm(data.message || 'Item removed from wishlist successfully!', () => {
                    loadWishlist(); // Reload wishlist
                });
            } else {
                console.error(`Failed to delete wishlist item ${itemId}:`, data.message);
                showCustomConfirm(data.message || 'Failed to remove item from wishlist.', () => {});
            }
        } catch (error) {
            console.error('Error removing from wishlist:', error);
            showCustomConfirm('An error occurred. Please try again.', () => {});
        } finally {
            // Remove from in-progress set after a delay
            setTimeout(() => {
                wishlistDeleteInProgress.delete(itemId);
            }, 1000);
        }
    }
    
    async function loadWishlistCountForDashboard() {
        try {
            const token = getAuthToken();
            const wishlistCountElement = document.getElementById('dashboard-wishlist-count');
            if (!token || !wishlistCountElement) {
                if (wishlistCountElement) wishlistCountElement.innerText = '0';
                return;
            }
            
            const response = await fetch(`${API_BASE_URL}/wishlist`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                const items = await response.json();
                const count = items ? items.length : 0;
                wishlistCountElement.innerText = count;
                
                // Update comparison info if available
                const totalItems = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
                if (totalItems > 0 && count > 0) {
                    const wishlistCard = wishlistCountElement.closest('.bg-gray-800');
                    if (wishlistCard) {
                        // Check if comparison text already exists
                        let comparisonText = wishlistCard.querySelector('.wishlist-comparison');
                        if (!comparisonText) {
                            comparisonText = document.createElement('p');
                            comparisonText.className = 'text-sm text-gray-400 mt-2 wishlist-comparison';
                            wishlistCard.appendChild(comparisonText);
                        }
                        const percentage = ((count / totalItems) * 100).toFixed(1);
                        comparisonText.innerText = `${percentage}% of collection size`;
                    }
                }
            } else {
                wishlistCountElement.innerText = '0';
            }
        } catch (error) {
            console.error('Error loading wishlist count:', error);
            const wishlistCountElement = document.getElementById('dashboard-wishlist-count');
            if (wishlistCountElement) wishlistCountElement.innerText = '0';
        }
    }

    function handleUnauthorized(silent = false) {
        console.warn('Handling unauthorized state: session expired or invalid.');
        sessionStorage.removeItem('jwt_token');
        if (!silent) {
            showCustomConfirm('Your session has expired or is invalid. Please log in again.', () => {});
        }
        updateAuthUI(false);
        collectionData = []; // Clear data on logout/unauthorized
        history.replaceState(null, '', window.location.pathname); // Clear public URL param
        showView('content-home'); // Redirect to home page
    }

    function updateAuthUI(loggedIn) {
        console.log('Updating Auth UI. Logged In:', loggedIn);
        const sidebarSignInBtn = document.getElementById('sidebar-signin-btn');
        const sidebarLogoutBtn = document.getElementById('sidebar-logout-btn');
        const quickAddBtn = document.getElementById('quick-add-btn');
        const importDataBtn = document.getElementById('import-data-btn');
        const exportDataBtn = document.getElementById('export-data-btn'); // New
        const clearAllBtn = document.getElementById('clear-all-btn'); // Get clear all button
        const shareCollectionBtn = document.getElementById('share-collection-btn'); // New

        if (loggedIn) {
            if (sidebarSignInBtn) sidebarSignInBtn.classList.add('hidden');
            if (sidebarLogoutBtn) sidebarLogoutBtn.classList.remove('hidden');
            if (quickAddBtn) quickAddBtn.classList.remove('hidden'); // Show Quick Add
            if (importDataBtn) importDataBtn.classList.remove('hidden'); // Show Import Data
            if (exportDataBtn) exportDataBtn.classList.remove('hidden'); // Show Export Data
            if (clearAllBtn) clearAllBtn.classList.remove('hidden'); // Show Clear All
            if (shareCollectionBtn) shareCollectionBtn.classList.remove('hidden'); // Show Share Collection
        } else {
            if (sidebarSignInBtn) sidebarSignInBtn.classList.remove('hidden');
            if (sidebarLogoutBtn) sidebarLogoutBtn.classList.add('hidden');
            if (quickAddBtn) quickAddBtn.classList.add('hidden'); // Hide Quick Add
            if (importDataBtn) importDataBtn.classList.add('hidden'); // Hide Import Data
            if (exportDataBtn) exportDataBtn.classList.add('hidden'); // Hide Export Data
            if (clearAllBtn) clearAllBtn.classList.add('hidden'); // Hide Clear All
            if (shareCollectionBtn) shareCollectionBtn.classList.add('hidden'); // Hide Share Collection
        }
        // Also update settings view authentication state
        const settingsContent = document.getElementById('settings-content');
        const settingsOverlay = document.getElementById('settings-unauthenticated-overlay');
        if (settingsContent && settingsOverlay) {
            if (loggedIn) {
                settingsContent.classList.remove('hidden');
                settingsOverlay.classList.add('hidden');
            } else {
                settingsContent.classList.add('hidden');
                settingsOverlay.classList.remove('hidden');
            }
        }
    }

    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.classList.remove('light', 'dark');
            document.documentElement.classList.add(savedTheme);
        } else {
            // Default to dark if no theme is saved
            document.documentElement.classList.add('dark');
        }
    }


    // --- GLOBAL UI Elements ---
    const sidebar = document.getElementById('sidebar');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');
    // We target document.body for overflow-hidden to prevent background scroll when sidebar is open
    // const appContent = document.getElementById('app-content'); // No longer directly used for overflow control

    // Function to toggle sidebar visibility
    function toggleSidebar() {
        console.log('Toggling sidebar...');
        sidebar.classList.toggle('-translate-x-full'); // Toggle sidebar's off-screen state
        mobileSidebarOverlay.classList.toggle('hidden'); // Toggle overlay visibility
        document.body.classList.toggle('overflow-hidden'); // Toggle body scroll
        sidebar.classList.toggle('open'); // Add/remove 'open' class for media query targeting
    }

    // --- Loading Functions ---
    function showLoading(message = 'Loading...') {
        const loadingModal = document.getElementById('loading-modal');
        const loadingMessage = document.getElementById('loading-message');
        if (loadingMessage) loadingMessage.textContent = message;
        if (loadingModal) {
            loadingModal.classList.remove('hidden');
            loadingModal.classList.add('flex');
            loadingModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            loadingModal.querySelector('div').classList.add('scale-100', 'opacity-100');
        }
    }

    function hideLoading() {
        const loadingModal = document.getElementById('loading-modal');
        if (loadingModal) {
            loadingModal.querySelector('div').classList.remove('scale-100', 'opacity-100');
            loadingModal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                loadingModal.classList.add('hidden');
                loadingModal.classList.remove('flex');
            }, 200);
        }
    }

    // --- Swipe Gesture Functions ---
    function setupSwipeGestures() {
        // Only setup swipe gestures on mobile devices
        if (window.innerWidth < 768) {
            const appContent = document.getElementById('app-content');
            if (appContent && typeof Hammer !== 'undefined') {
                const hammer = new Hammer(appContent);
                
                // Configure recognizers
                hammer.get('swipe').set({ direction: Hammer.DIRECTION_HORIZONTAL });
                
                // Handle swipe left (next section)
                hammer.on('swipeleft', () => {
                    const currentView = getCurrentView();
                    const nextView = getNextView(currentView);
                    if (nextView) {
                        showView(nextView);
                    }
                });
                
                // Handle swipe right (previous section)
                hammer.on('swiperight', () => {
                    const currentView = getCurrentView();
                    const prevView = getPreviousView(currentView);
                    if (prevView) {
                        showView(prevView);
                    }
                });
                
                console.log('Swipe gestures enabled for mobile');
            }
        }
    }

    function getCurrentView() {
        const views = ['content-home', 'content-auth', 'content-dashboard', 'content-collection', 'content-map', 'content-members', 'content-catalogue', 'content-missing', 'content-settings', 'content-about'];
        for (const view of views) {
            const element = document.getElementById(view);
            if (element && !element.classList.contains('hidden')) {
                return view;
            }
        }
        return 'content-home';
    }

    function getNextView(currentView) {
        const views = ['content-home', 'content-auth', 'content-dashboard', 'content-collection', 'content-map', 'content-members', 'content-catalogue', 'content-missing', 'content-settings', 'content-about'];
        const currentIndex = views.indexOf(currentView);
        if (currentIndex === -1 || currentIndex === views.length - 1) {
            return null; // Already at the end
        }
        return views[currentIndex + 1];
    }

    function getPreviousView(currentView) {
        const views = ['content-home', 'content-auth', 'content-dashboard', 'content-collection', 'content-map', 'content-members', 'content-catalogue', 'content-missing', 'content-settings', 'content-about'];
        const currentIndex = views.indexOf(currentView);
        if (currentIndex <= 0) {
            return null; // Already at the beginning
        }
        return views[currentIndex - 1];
    }

    // --- Export Functions ---
    function exportCollectionAsJson(exportFiltered = false) {
        const dataToExport = exportFiltered && currentFilteredResults.length > 0 ? currentFilteredResults : collectionData;
        const jsonString = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = exportFiltered ? 'coinshelf_filtered_collection.json' : 'coinshelf_collection.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        // Count total items including quantities
        const totalItems = dataToExport.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const message = exportFiltered ? `Filtered collection (${totalItems} items) exported as JSON!` : `Collection (${totalItems} items) exported as JSON!`;
        showCustomConfirm(message, () => {});
        closeModal(document.getElementById('export-modal'), document.getElementById('export-modal').querySelector('div'));
    }

    function exportCollectionAsCsv(exportFiltered = false) {
        const dataToExport = exportFiltered && currentFilteredResults.length > 0 ? currentFilteredResults : collectionData;
        if (dataToExport.length === 0) {
            showCustomConfirm('No data to export.', () => {});
            return;
        }

        const headers = ['id', 'type', 'country', 'year', 'denomination', 'value', 'quantity', 'notes', 'referenceUrl', 'localImagePath', 'region', 'isHistorical', 'weight_grams', 'purity_percent'];
        let csv = headers.join(',') + '\n';

        dataToExport.forEach(item => {
            const row = headers.map(header => {
                let value = item[header];
                if (value === null || typeof value === 'undefined') {
                    value = '';
                } else if (typeof value === 'string') {
                    // Escape double quotes and enclose in double quotes if it contains comma or double quote
                    value = `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }).join(',');
            csv += row + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = exportFiltered ? 'coinshelf_filtered_collection.csv' : 'coinshelf_collection.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        // Count total items including quantities
        const totalItems = dataToExport.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const message = exportFiltered ? `Filtered collection (${totalItems} items) exported as CSV!` : `Collection (${totalItems} items) exported as CSV!`;
        showCustomConfirm(message, () => {});
        closeModal(document.getElementById('export-modal'), document.getElementById('export-modal').querySelector('div'));
    }

    function printCollectionReport() {
        // Create a new window or iframe for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>CoinShelf Collection Report</title>');
        // Include minimal styles for printing
        printWindow.document.write('<style>');
        printWindow.document.write('body { font-family: sans-serif; margin: 20px; }');
        printWindow.document.write('h1 { text-align: center; margin-bottom: 20px; }');
        printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }');
        printWindow.document.write('th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }');
        printWindow.document.write('th { background-color: #f2f2f2; }');
        printWindow.document.write('p { margin-bottom: 5px; }');
        printWindow.document.write('</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write('<h1>CoinShelf Collection Report</h1>');

        if (collectionData.length === 0) {
            printWindow.document.write('<p>No items in your collection to print.</p>');
        } else {
            // Summary - sum quantities for total items, multiply value by quantity
            const totalItems = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
            const totalValue = collectionData.reduce((sum, item) => sum + ((item.value || 0) * (item.quantity || 1)), 0);
            const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

            printWindow.document.write('<h2>Summary</h2>');
            printWindow.document.write(`<p><strong>Total Items:</strong> ${totalItems}</p>`);
            printWindow.document.write(`<p><strong>Total Estimated Value:</strong> $${totalValue.toFixed(2)}</p>`);
            printWindow.document.write(`<p><strong>Unique Countries:</strong> ${uniqueCountries}</p>`);

            // Detailed table
            printWindow.document.write('<h2>Detailed Collection</h2>');
            printWindow.document.write('<table>');
            printWindow.document.write('<thead><tr><th>Type</th><th>Country</th><th>Year</th><th>Denomination</th><th>Value</th><th>Notes</th></tr></thead>');
            printWindow.document.write('<tbody>');
            collectionData.forEach(item => {
                printWindow.document.write(`
                    <tr>
                        <td>${item.type}</td>
                        <td>${item.country}</td>
                        <td>${item.year || 'N/A'}</td>
                        <td>${item.denomination}</td>
                        <td>$${(item.value || 0).toFixed(2)}</td>
                        <td>${item.notes || 'N/A'}</td>
                    </tr>
                `);
            });
            printWindow.document.write('</tbody></table>');
        }

        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        closeModal(document.getElementById('export-modal'), document.getElementById('export-modal').querySelector('div'));
    }

    function exportCollectionAsExcel() {
        if (collectionData.length === 0) {
            showCustomConfirm('No data to export.', () => {});
            return;
        }

        // Prepare data for Excel
        const excelData = collectionData.map(item => ({
            'ID': item.id,
            'Type': item.type,
            'Country': item.country,
            'Year': item.year || 'N/A',
            'Denomination': item.denomination,
            'Quantity': item.quantity || 1,
            'Value (USD)': item.value || 0,
            'Notes': item.notes || '',
            'Reference URL': item.referenceUrl || '',
            'Region': item.region || '',
            'Historical': item.isHistorical ? 'Yes' : 'No',
            'Weight (g)': item.weight_grams || '',
            'Purity (%)': item.purity_percent || ''
        }));

        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);

        // Add summary information - sum quantities for total items, multiply value by quantity
        const totalItems = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const totalValue = collectionData.reduce((sum, item) => sum + ((item.value || 0) * (item.quantity || 1)), 0);
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        // Add summary to the top of the sheet
        XLSX.utils.sheet_add_aoa(ws, [
            ['CoinShelf Collection Report'],
            [''],
            [`Total Items: ${totalItems}`],
            [`Total Value: $${totalValue.toFixed(2)}`],
            [`Unique Countries: ${uniqueCountries}`],
            [''],
            ['Collection Details:']
        ], { origin: 'A1' });

        // Adjust column widths
        const colWidths = [
            { wch: 5 },  // ID
            { wch: 12 }, // Type
            { wch: 15 }, // Country
            { wch: 8 },  // Year
            { wch: 15 }, // Denomination
            { wch: 10 }, // Quantity
            { wch: 12 }, // Value
            { wch: 30 }, // Notes
            { wch: 40 }, // Reference URL
            { wch: 12 }, // Region
            { wch: 10 }, // Historical
            { wch: 12 }, // Weight
            { wch: 12 }  // Purity
        ];
        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, 'Collection');

        // Generate and download file
        XLSX.writeFile(wb, 'coinshelf_collection.xlsx');
        showCustomConfirm('Collection exported as Excel!', () => {});
        closeModal(document.getElementById('export-modal'), document.getElementById('export-modal').querySelector('div'));
    }

    function exportCollectionAsPdf() {
        if (collectionData.length === 0) {
            showCustomConfirm('No data to export.', () => {});
            return;
        }

        // Create new PDF document
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Add title
        doc.setFontSize(20);
        doc.text('CoinShelf Collection Report', 20, 20);

        // Add summary - sum quantities for total items, multiply value by quantity
        doc.setFontSize(12);
        const totalItems = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const totalValue = collectionData.reduce((sum, item) => sum + ((item.value || 0) * (item.quantity || 1)), 0);
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        doc.text(`Total Items: ${totalItems}`, 20, 35);
        doc.text(`Total Value: $${totalValue.toFixed(2)}`, 20, 45);
        doc.text(`Unique Countries: ${uniqueCountries}`, 20, 55);

        // Prepare table data
        const tableData = collectionData.map(item => [
            item.id,
            item.type,
            item.country,
            item.year || 'N/A',
            item.denomination,
            item.quantity || 1,
            `$${(item.value || 0).toFixed(2)}`,
            item.notes || ''
        ]);

        // Add table
        doc.autoTable({
            startY: 70,
            head: [['ID', 'Type', 'Country', 'Year', 'Denomination', 'Qty', 'Value', 'Notes']],
            body: tableData,
            theme: 'grid',
            headStyles: { fillColor: [16, 185, 129] }, // emerald color
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 10 }, // ID
                1: { cellWidth: 20 }, // Type
                2: { cellWidth: 25 }, // Country
                3: { cellWidth: 15 }, // Year
                4: { cellWidth: 25 }, // Denomination
                5: { cellWidth: 10 }, // Qty
                6: { cellWidth: 15 }, // Value
                7: { cellWidth: 'auto' } // Notes
            }
        });

        // Save the PDF
        doc.save('coinshelf_collection.pdf');
        showCustomConfirm('Collection exported as PDF!', () => {});
        closeModal(document.getElementById('export-modal'), document.getElementById('export-modal').querySelector('div'));
    }


    // --- EVENT LISTENERS ---
    function attachGlobalEventListeners() {
        console.log('Attaching global event listeners...');

        // Navigation links
        const navHome = document.getElementById('nav-home');
        if (navHome) {
            console.log('Found nav-home');
            navHome.addEventListener('click', (e) => { e.preventDefault(); showView('content-home'); });
        } else { console.error('nav-home not found!'); }

        const navDashboard = document.getElementById('nav-dashboard');
        if (navDashboard) {
            console.log('Found nav-dashboard');
            navDashboard.addEventListener('click', (e) => { e.preventDefault(); showView('content-dashboard'); });
        } else { console.error('nav-dashboard not found!'); }

        const navCollection = document.getElementById('nav-collection');
        if (navCollection) {
            console.log('Found nav-collection');
            navCollection.addEventListener('click', (e) => { e.preventDefault(); showView('content-collection'); });
        } else { console.error('nav-collection not found!'); }

        const navMap = document.getElementById('nav-map');
        if (navMap) {
            console.log('Found nav-map');
            navMap.addEventListener('click', (e) => { e.preventDefault(); showView('content-map'); });
        } else { console.error('nav-map not found!'); }

        const navMembers = document.getElementById('nav-members');
        if (navMembers) {
            console.log('Found nav-members');
            navMembers.addEventListener('click', (e) => { e.preventDefault(); showView('content-members'); });
        } else { console.error('nav-members not found!'); }

        const navCatalogue = document.getElementById('nav-catalogue');
        if (navCatalogue) {
            console.log('Found nav-catalogue');
            navCatalogue.addEventListener('click', (e) => { e.preventDefault(); showView('content-catalogue'); });
        } else { console.error('nav-catalogue not found!'); }

        const navWishlist = document.getElementById('nav-wishlist');
        if (navWishlist) {
            console.log('Found nav-wishlist');
            navWishlist.addEventListener('click', (e) => { e.preventDefault(); showView('content-wishlist'); });
        } else { console.error('nav-wishlist not found!'); }

        const navMissing = document.getElementById('nav-missing');
        if (navMissing) {
            console.log('Found nav-missing');
            navMissing.addEventListener('click', (e) => { e.preventDefault(); showView('content-missing'); });
        } else { console.error('nav-missing not found!'); }

        const navProfile = document.getElementById('nav-profile');
        if (navProfile) {
            console.log('Found nav-profile');
            navProfile.addEventListener('click', (e) => { e.preventDefault(); showView('content-profile'); });
        } else { console.error('nav-profile not found!'); }

        const navSettings = document.getElementById('nav-settings');
        if (navSettings) {
            console.log('Found nav-settings');
            navSettings.addEventListener('click', (e) => { e.preventDefault(); showView('content-settings'); });
        } else { console.error('nav-settings not found!'); }

        const navAbout = document.getElementById('nav-about');
        if (navAbout) {
            console.log('Found nav-about');
            navAbout.addEventListener('click', (e) => { e.preventDefault(); showView('content-about'); });
        } else { console.error('nav-about not found!'); }


        // Homepage buttons
        const homeSignupBtn = document.getElementById('home-signup-btn');
        if (homeSignupBtn) {
            console.log('Found home-signup-btn');
            homeSignupBtn.addEventListener('click', () => {
                console.log('home-signup-btn clicked');
                // Navigate to auth page
                window.history.pushState({}, '', '/auth');
                handleHistoryNavigation('/auth');
            });
        } else {
            console.error('home-signup-btn not found!');
        }

        const homeLearnMoreBtn = document.getElementById('home-learn-more-btn');
        if (homeLearnMoreBtn) {
            console.log('Found home-learn-more-btn');
            homeLearnMoreBtn.addEventListener('click', () => {
                console.log('home-learn-more-btn clicked');
                // Navigate to about page
                window.history.pushState({}, '', '/about');
                handleHistoryNavigation('/about');
            });
        } else {
            console.error('home-learn-more-btn not found!');
        }


        // Quick Add button
        const quickAddBtn = document.getElementById('quick-add-btn');
        if (quickAddBtn) {
            console.log('Found quick-add-btn');
            quickAddBtn.addEventListener('click', () => {
                console.log('Quick Add button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to add new items.', () => {});
                    return;
                }
                clearItemForm();
                openModal('item-modal');
                if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });
        } else {
            console.error('quick-add-btn not found!');
        }

        // Import Data button
        const importDataBtn = document.getElementById('import-data-btn');
        if (importDataBtn) {
            console.log('Found import-data-btn');
            importDataBtn.addEventListener('click', () => {
                console.log('Import Data button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to import data.', () => {});
                    return;
                }
                document.getElementById('import-json-data').value = ''; // Clear previous data
                openModal('import-modal');
                if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });
        } else {
            console.error('import-data-btn not found!');
        }

        // Export Data button
        const exportDataBtn = document.getElementById('export-data-btn');
        if (exportDataBtn) {
            console.log('Found export-data-btn');
            exportDataBtn.addEventListener('click', () => {
                console.log('Export Data button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to export data.', () => {});
                    return;
                }
                openModal('export-modal'); // Open the new export options modal
                if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });
        } else {
            console.error('export-data-btn not found!');
        }

        // New: Share Collection button
        const shareCollectionBtn = document.getElementById('share-collection-btn');
        if (shareCollectionBtn) {
            console.log('Found share-collection-btn');
            shareCollectionBtn.addEventListener('click', () => {
                console.log('Share Collection button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to share your collection.', () => {});
                    return;
                }
                showView('content-settings'); // Go to settings page
                // Optionally scroll to the public link section in settings
                setTimeout(() => {
                    document.getElementById('generate-public-url-btn').scrollIntoView({ behavior: 'smooth' });
                }, 100);
                 if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });
        } else { console.error('share-collection-btn not found!'); }


        // Handle import submission
        const importSubmitBtn = document.getElementById('import-submit-btn');
        if (importSubmitBtn) {
            console.log('Found import-submit-btn');
            importSubmitBtn.addEventListener('click', async () => {
                console.log('Import submit button clicked');
                const jsonData = document.getElementById('import-json-data').value;
                let itemsToImport;
                try {
                    itemsToImport = JSON.parse(jsonData);
                    if (!Array.isArray(itemsToImport)) {
                        throw new Error("Pasted data is not a JSON array.");
                    }
                } catch (error) {
                    showCustomConfirm(`Invalid JSON data: ${error.message}. Please paste a valid JSON array of coin objects.`, () => {});
                    return;
                }

                if (itemsToImport.length === 0) {
                    showCustomConfirm('No items found in the pasted data.', () => {});
                    return;
                }

                showCustomConfirm(`Are you sure you want to import ${itemsToImport.length} items? This will add them to your collection.`, async () => {
                    if (!isAuthenticated()) {
                        showCustomConfirm('Please sign in to import data.', () => {});
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/coins/bulk_upload`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getAuthToken()}`
                            },
                            body: JSON.stringify(itemsToImport)
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                handleUnauthorized();
                                return;
                            }
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        let message = result.message || 'Import process completed.';
                        if (result.errors && result.errors.length > 0) {
                            message += ` Some items had errors: ${result.errors.map(err => err.substring(0, 50) + "...").join('; ')}`; // Truncate errors for message box
                        }
                        showCustomConfirm(message, () => {});
                        loadCollectionFromBackend(); // Reload data after successful import
                    } catch (error) {
                        console.error("Error during bulk import:", error);
                        const safeMessage = escapeHtml(error.message || 'An unexpected error occurred');
                        showCustomConfirm(`Failed to import data: ${safeMessage}. Please check your connection and try again.`, () => {});
                    } finally {
                        closeModal(document.getElementById('import-modal'), document.getElementById('import-modal').querySelector('div'));
                    }
                });
            });
        } else { console.error('import-submit-btn not found!'); }

        const importCancelBtn = document.getElementById('import-cancel-btn');
        if (importCancelBtn) {
            console.log('Found import-cancel-btn');
            importCancelBtn.addEventListener('click', () => {
                console.log('Import cancel button clicked');
                closeModal(document.getElementById('import-modal'), document.getElementById('import-modal').querySelector('div'));
            });
        } else { console.error('import-cancel-btn not found!'); }

        // Enhanced Import Functionality
        setupImportTabs();
        setupFileUploads();
        setupTemplateDownloads();

        // Donation Modal Buttons
        const showDonateBtn = document.getElementById('show-donate-modal');
        if (showDonateBtn) {
            showDonateBtn.addEventListener('click', () => {
                openModal('donate-modal');
            });
        }
        // About page donation button
        const showDonateBtnAbout = document.getElementById('show-donate-modal-about');
        if (showDonateBtnAbout) {
            showDonateBtnAbout.addEventListener('click', () => {
                openModal('donate-modal');
            });
        }
        // Dashboard donation button
        const showDonateBtnDashboard = document.getElementById('show-donate-modal-dashboard');
        if (showDonateBtnDashboard) {
            showDonateBtnDashboard.addEventListener('click', () => {
                openModal('donate-modal');
            });
        }
        // Collection donation button
        const showDonateBtnCollection = document.getElementById('show-donate-modal-collection');
        if (showDonateBtnCollection) {
            showDonateBtnCollection.addEventListener('click', () => {
                openModal('donate-modal');
            });
        }
        // Map donation button
        const showDonateBtnMap = document.getElementById('show-donate-modal-map');
        if (showDonateBtnMap) {
            showDonateBtnMap.addEventListener('click', () => {
                openModal('donate-modal');
            });
        }
        // Missing Countries donation button
        const showDonateBtnMissing = document.getElementById('show-donate-modal-missing');
        if (showDonateBtnMissing) {
            showDonateBtnMissing.addEventListener('click', () => {
                openModal('donate-modal');
            });
        }
        // Settings donation button
        const showDonateBtnSettings = document.getElementById('show-donate-modal-settings');
        if (showDonateBtnSettings) {
            showDonateBtnSettings.addEventListener('click', () => {
                openModal('donate-modal');
            });
        }

        const closeDonateBtn = document.getElementById('close-donate-modal');
        if (closeDonateBtn) {
            closeDonateBtn.addEventListener('click', () => {
                closeModal(document.getElementById('donate-modal'), document.getElementById('donate-modal').querySelector('div'));
            });
        }

        const closeDonateBtn2 = document.getElementById('close-donate-btn');
        if (closeDonateBtn2) {
            closeDonateBtn2.addEventListener('click', () => {
                closeModal(document.getElementById('donate-modal'), document.getElementById('donate-modal').querySelector('div'));
            });
        }

        const closeCryptoBtn = document.getElementById('close-crypto-modal');
        if (closeCryptoBtn) {
            closeCryptoBtn.addEventListener('click', () => {
                closeModal(document.getElementById('crypto-modal'), document.getElementById('crypto-modal').querySelector('div'));
            });
        }

        const closeCryptoBtn2 = document.getElementById('close-crypto-btn');
        if (closeCryptoBtn2) {
            closeCryptoBtn2.addEventListener('click', () => {
                closeModal(document.getElementById('crypto-modal'), document.getElementById('crypto-modal').querySelector('div'));
            });
        }

        // Merge Duplicates Modal Buttons
        const closeMergeModalBtn = document.getElementById('close-merge-modal');
        if (closeMergeModalBtn) {
            closeMergeModalBtn.addEventListener('click', () => {
                const mergeModal = document.getElementById('merge-duplicates-modal');
                closeModal(mergeModal, mergeModal.querySelector('div'));
                selectedCoinsForMerge = [];
            });
        }

        const mergeCancelBtn = document.getElementById('merge-cancel-btn');
        if (mergeCancelBtn) {
            mergeCancelBtn.addEventListener('click', () => {
                const mergeModal = document.getElementById('merge-duplicates-modal');
                closeModal(mergeModal, mergeModal.querySelector('div'));
                selectedCoinsForMerge = [];
            });
        }

        const mergeConfirmBtn = document.getElementById('merge-confirm-btn');
        if (mergeConfirmBtn) {
            mergeConfirmBtn.addEventListener('click', handleMergeCoins);
        }

        // Add click handler for merge modal backdrop
        const mergeModalElement = document.getElementById('merge-duplicates-modal');
        if (mergeModalElement) {
            mergeModalElement.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(this, modalContent);
                    selectedCoinsForMerge = [];
                }
            });
        }

        // Username Modal Buttons
        const usernameSubmitBtn = document.getElementById('username-submit-btn');
        if (usernameSubmitBtn) {
            usernameSubmitBtn.addEventListener('click', handleSetUsername);
        }

        // Allow Enter key to submit username
        const usernameInput = document.getElementById('username-input');
        if (usernameInput) {
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSetUsername();
                }
            });
        }

        // Members Search
        const memberSearchInput = document.getElementById('member-search-input');
        if (memberSearchInput) {
            memberSearchInput.addEventListener('input', (e) => {
                // Debounce search
                clearTimeout(membersSearchTimeout);
                membersSearchTimeout = setTimeout(() => {
                    renderMembers();
                }, 500); // Wait 500ms after user stops typing
            });

            // Allow Enter key to search immediately
            memberSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(membersSearchTimeout);
                    renderMembers();
                }
            });
        }

        // User Profile Modal
        const closeUserProfileModalBtn = document.getElementById('close-user-profile-modal');
        if (closeUserProfileModalBtn) {
            closeUserProfileModalBtn.addEventListener('click', () => {
                const modal = document.getElementById('user-profile-modal');
                closeModal(modal, modal.querySelector('div'));
            });
        }

        // Add click handler for user profile modal backdrop
        const userProfileModalElement = document.getElementById('user-profile-modal');
        if (userProfileModalElement) {
            userProfileModalElement.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(this, modalContent);
                }
            });
        }

        // Export Modal Buttons
        const exportJsonBtn = document.getElementById('export-json-btn');
        if (exportJsonBtn) {
            console.log('Found export-json-btn');
            exportJsonBtn.addEventListener('click', exportCollectionAsJson);
        } else { console.error('export-json-btn not found!'); }

        const exportCsvBtn = document.getElementById('export-csv-btn');
        if (exportCsvBtn) {
            console.log('Found export-csv-btn');
            exportCsvBtn.addEventListener('click', exportCollectionAsCsv);
        } else { console.error('export-csv-btn not found!'); }

        const exportPrintBtn = document.getElementById('export-print-btn');
        if (exportPrintBtn) {
            console.log('Found export-print-btn');
            exportPrintBtn.addEventListener('click', printCollectionReport);
        } else { console.error('export-print-btn not found!'); }

        const exportExcelBtn = document.getElementById('export-excel-btn');
        if (exportExcelBtn) {
            console.log('Found export-excel-btn');
            exportExcelBtn.addEventListener('click', exportCollectionAsExcel);
        } else { console.error('export-excel-btn not found!'); }

        const exportPdfBtn = document.getElementById('export-pdf-btn');
        if (exportPdfBtn) {
            console.log('Found export-pdf-btn');
            exportPdfBtn.addEventListener('click', exportCollectionAsPdf);
        } else { console.error('export-pdf-btn not found!'); }

        const exportCancelBtn = document.getElementById('export-cancel-btn');
        if (exportCancelBtn) {
            console.log('Found export-cancel-btn');
            exportCancelBtn.addEventListener('click', () => closeModal(document.getElementById('export-modal'), document.getElementById('export-modal').querySelector('div')));
        } else { console.error('export-cancel-btn not found!'); }


        // Clear All Items button and modal logic
        const clearAllBtn = document.getElementById('clear-all-btn');
        const clearConfirmModal = document.getElementById('clear-confirm-modal');
        const clearConfirmInput = document.getElementById('clear-confirm-input');
        const clearAllConfirmBtn = document.getElementById('clear-all-confirm-btn');
        const clearAllCancelBtn = document.getElementById('clear-all-cancel-btn');

        if (clearAllBtn) {
            console.log('Found clear-all-btn');
            clearAllBtn.addEventListener('click', () => {
                console.log('Clear All button clicked');
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to clear items.', () => {});
                    return;
                }
                clearConfirmInput.value = ''; // Clear input field
                openModal('clear-confirm-modal');
                if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });
        } else { console.error('clear-all-btn not found!'); }

        if (clearAllConfirmBtn) {
            console.log('Found clear-all-confirm-btn');
            clearAllConfirmBtn.addEventListener('click', async () => {
                console.log('Clear All confirm button clicked');
                if (clearConfirmInput.value.trim() === 'CLEARYES') {
                    if (!isAuthenticated()) {
                        showCustomConfirm('Please sign in to clear items.', () => {});
                        closeModal(clearConfirmModal, clearConfirmModal.querySelector('div'));
                        return;
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/coins/clear_all`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${getAuthToken()}`
                            }
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                handleUnauthorized();
                                return;
                            }
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        showCustomConfirm(result.message || 'All items deleted successfully!', () => {});
                        collectionData = []; // Clear local data
                        renderAllViews(); // Re-render UI
                    } catch (error) {
                        console.error("Error clearing all items:", error);
                        showCustomConfirm(`Failed to clear all items: ${error.message}. Please ensure the backend is running and you are logged in.`, () => {});
                    } finally {
                        closeModal(clearConfirmModal, clearConfirmModal.querySelector('div'));
                    }
                } else {
                    showCustomConfirm('Incorrect confirmation phrase. Please type "CLEARYES" exactly to proceed.', () => {});
                }
            });
        } else { console.error('clear-all-confirm-btn not found!'); }

        if (clearAllCancelBtn) {
            console.log('Found clear-all-cancel-btn');
            clearAllCancelBtn.addEventListener('click', () => {
                console.log('Clear All cancel button clicked');
                closeModal(clearConfirmModal, clearConfirmModal.querySelector('div'));
            });
        } else { console.error('clear-all-cancel-btn not found!'); }


        // New: Public URL buttons
        const generatePublicUrlBtn = document.getElementById('generate-public-url-btn');
        if (generatePublicUrlBtn) {
            generatePublicUrlBtn.addEventListener('click', generatePublicUrl);
        } else { console.error('generate-public-url-btn not found!'); }

        const revokePublicUrlBtn = document.getElementById('revoke-public-url-btn');
        if (revokePublicUrlBtn) {
            revokePublicUrlBtn.addEventListener('click', revokePublicUrl);
        } else { console.error('revoke-public-url-btn not found!'); }

        const copyPublicUrlBtn = document.getElementById('copy-public-url-btn');
        if (copyPublicUrlBtn) {
            copyPublicUrlBtn.addEventListener('click', copyPublicUrl);
        } else { console.error('copy-public-url-btn not found!'); }

        // About page signup button
        const aboutSignupBtn = document.getElementById('about-signup-btn');
        if (aboutSignupBtn) {
            console.log('Found about-signup-btn');
            aboutSignupBtn.addEventListener('click', () => {
                console.log('about-signup-btn clicked');
                if (window.innerWidth < 768 && sidebar && sidebar.classList.contains('-translate-x-full')) {
                    toggleSidebar(); // Open sidebar if closed
                }
                const loginEmailInput = document.getElementById('login-email');
                if (loginEmailInput) loginEmailInput.focus();
            });
        } else {
            console.error('about-signup-btn not found!');
        }


        // Modal close listeners (click outside or ESC)
        const itemModal = document.getElementById('item-modal');
        const importModal = document.getElementById('import-modal');
        const exportModal = document.getElementById('export-modal'); // New modal
        const countryDetailsModal = document.getElementById('country-details-modal');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const clearConfirmModalElement = document.getElementById('clear-confirm-modal');

        if (itemModal) {
            itemModal.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(this, modalContent);
                    reinitItemForm();
                }
            });
        } else { console.error('item-modal not found!'); }


        if (importModal) {
            importModal.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(this, modalContent);
                }
            });
        } else { console.error('import-modal not found!'); }

        if (exportModal) { // New modal
            exportModal.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(this, modalContent);
                }
            });
        } else { console.error('export-modal not found!'); }


        if (countryDetailsModal) {
            countryDetailsModal.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(this, modalContent);
                }
            });
            document.getElementById('country-details-close-btn').addEventListener('click', () => {
                closeModal(countryDetailsModal, countryDetailsModal.querySelector('div'));
            });
        } else { console.error('country-details-modal not found!'); }


        if (clearConfirmModalElement) {
            clearConfirmModalElement.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(this, modalContent);
                }
            });
        } else { console.error('clear-confirm-modal not found!'); }


        if (customConfirmModal) {
            customConfirmModal.addEventListener('click', function(event) {
                const modalContent = this.querySelector('div');
                if (!modalContent.contains(event.target)) {
                    closeModal(customConfirmModal, customConfirmModal.querySelector('div'));
                }
            });
        } else { console.error('custom-confirm-modal not found!'); }


        document.addEventListener('keydown', function(event) {
            // Don't trigger shortcuts when user is typing in input fields
            const activeElement = document.activeElement;
            const isInputFocused = activeElement && (
                activeElement.tagName === 'INPUT' || 
                activeElement.tagName === 'TEXTAREA' || 
                activeElement.isContentEditable
            );

            // Keyboard shortcuts (only when not typing in inputs)
            if (!isInputFocused || event.ctrlKey || event.metaKey) {
                // Ctrl+N or Cmd+N: New item
                if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                    event.preventDefault();
                    if (isAuthenticated()) {
                        const quickAddBtn = document.getElementById('quick-add-btn');
                        if (quickAddBtn) quickAddBtn.click();
                    }
                }
                // Ctrl+F or Cmd+F: Focus search
                if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
                    event.preventDefault();
                    const searchInput = document.getElementById('search-input');
                    if (searchInput) {
                        searchInput.focus();
                        searchInput.select();
                    }
                }
                // Ctrl+S or Cmd+S: Save item (when in item modal)
                if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                    const itemModal = document.getElementById('item-modal');
                    if (itemModal && !itemModal.classList.contains('hidden')) {
                        event.preventDefault();
                        const submitBtn = document.querySelector('#item-modal button[type="submit"]');
                        if (submitBtn) submitBtn.click();
                    }
                }
            }

            // Escape key handling
            if (event.key === 'Escape') {
                if (itemModal && !itemModal.classList.contains('hidden')) {
                    closeModal(itemModal, itemModal.querySelector('div'));
                    reinitItemForm();
                }
                if (importModal && !importModal.classList.contains('hidden')) {
                    closeModal(importModal, importModal.querySelector('div'));
                }
                if (exportModal && !exportModal.classList.contains('hidden')) { // Close export modal
                    closeModal(exportModal, exportModal.querySelector('div'));
                }
                if (countryDetailsModal && !countryDetailsModal.classList.contains('hidden')) {
                    closeModal(countryDetailsModal, countryDetailsModal.querySelector('div'));
                }
                if (customConfirmModal && !customConfirmModal.classList.contains('hidden')) {
                    closeModal(customConfirmModal, customConfirmModal.querySelector('div'));
                }
                 if (clearConfirmModalElement && !clearConfirmModalElement.classList.contains('hidden')) {
                    closeModal(clearConfirmModalElement, clearConfirmModalElement.querySelector('div'));
                }
                // Close sidebar if open on mobile
                if (window.innerWidth < 768 && sidebar && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            }
        });

        // Event listener for mobile menu toggle button
        if (mobileMenuToggle) { // Ensure button exists
            console.log('Found mobile-menu-toggle');
            mobileMenuToggle.addEventListener('click', toggleSidebar);
        } else { console.error('mobile-menu-toggle not found!'); }

        // Event listener for overlay to close sidebar
        if (mobileSidebarOverlay) { // Ensure overlay exists
            console.log('Found mobile-sidebar-overlay');
            mobileSidebarOverlay.addEventListener('click', toggleSidebar);
        } else { console.error('mobile-sidebar-overlay not found!'); }


        // Close sidebar if screen resizes to desktop and is currently open
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // md breakpoint for Tailwind
                if (sidebar && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            }
        });

        // When a nav link is clicked (on mobile), close the sidebar
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 768 && sidebar && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });
        });


        attachFormEventListeners(); // Attach event listeners for the item form

        // --- AUTH PAGE FUNCTIONALITY ---
        // Function to setup authentication page
        function setupAuthPage() {
            let isSignUpMode = false;

            // Toggle between Sign In and Sign Up
            const authToggleBtn = document.getElementById('auth-toggle-btn');
            const authForm = document.getElementById('auth-form');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const authPageTitle = document.getElementById('auth-page-title');
            const authToggleText = document.getElementById('auth-toggle-text');
            const authPasswordContainer = document.getElementById('auth-password-container');
            const authRememberContainer = document.getElementById('auth-remember-container');
            const authForgotPasswordContainer = document.getElementById('auth-forgot-password-container');

            if (authToggleBtn) {
                authToggleBtn.addEventListener('click', () => {
                    isSignUpMode = !isSignUpMode;
                    
                    if (isSignUpMode) {
                        authPageTitle.textContent = 'Sign Up';
                        authSubmitBtn.textContent = 'Sign Up';
                        authToggleText.textContent = 'Already have an account?';
                        authToggleBtn.textContent = 'Sign In';
                        authPasswordContainer.style.display = 'block';
                        authRememberContainer.style.display = 'none';
                        authForgotPasswordContainer.style.display = 'none';
                    } else {
                        authPageTitle.textContent = 'Sign In';
                        authSubmitBtn.textContent = 'Sign In';
                        authToggleText.textContent = 'Don\'t have an account?';
                        authToggleBtn.textContent = 'Sign Up';
                        authPasswordContainer.style.display = 'block';
                        authRememberContainer.style.display = 'flex';
                        authForgotPasswordContainer.style.display = 'block';
                    }
                });
            }

            // Auth form submission
            if (authForm) {
                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('auth-email').value.trim();
                    const password = document.getElementById('auth-password').value;
                    const rememberMe = document.getElementById('auth-remember-me')?.checked || false;

                    // Validation
                    if (!email) {
                        showCustomConfirm('Please enter your email address.', () => {});
                        return;
                    }

                    if (!validateEmail(email)) {
                        showCustomConfirm('Please enter a valid email address.', () => {});
                        return;
                    }

                    if (!password) {
                        showCustomConfirm('Please enter your password.', () => {});
                        return;
                    }

                    if (isSignUpMode) {
                        const passwordValidation = validatePassword(password);
                        if (!passwordValidation.valid) {
                            showCustomConfirm(passwordValidation.message, () => {});
                            return;
                        }
                    }

                    // Set loading state
                    if (authSubmitBtn) setLoadingState('auth-submit-btn', true, isSignUpMode ? 'Creating account...' : 'Signing in...');

                    try {
                        const endpoint = isSignUpMode ? '/register' : '/login';
                        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.message || (isSignUpMode ? 'Sign-up failed' : 'Login failed'));
                        }

                        const result = await response.json();

                        if (isSignUpMode) {
                            showCustomConfirm('Account created successfully! Please sign in.', () => {
                                // Switch to sign in mode
                                isSignUpMode = false;
                                authPageTitle.textContent = 'Sign In';
                                authSubmitBtn.textContent = 'Sign In';
                                authToggleText.textContent = 'Don\'t have an account?';
                                authToggleBtn.textContent = 'Sign Up';
                                authRememberContainer.style.display = 'flex';
                                authForgotPasswordContainer.style.display = 'block';
                                document.getElementById('auth-password').value = '';
                            });
                        } else {
                            // Store token
                            if (rememberMe) {
                                localStorage.setItem('jwt_token', result.token);
                                sessionStorage.removeItem('jwt_token');
                            } else {
                                sessionStorage.setItem('jwt_token', result.token);
                                localStorage.removeItem('jwt_token');
                            }

                            // Check if user needs to set username
                            if (result.needs_username) {
                                showUsernameModal();
                            } else {
                                showCustomConfirm('Signed in successfully!', () => {});
                            }

                            updateAuthUI(true);
                            loadCollectionFromBackend();
                            window.history.pushState({}, '', '/dashboard');
                            handleHistoryNavigation('/dashboard');
                        }

                    } catch (error) {
                        console.error(`${isSignUpMode ? 'Sign-up' : 'Login'} error:`, error.message);
                        showCustomConfirm(escapeHtml(error.message || `${isSignUpMode ? 'Sign-up' : 'Login'} failed. Please try again.`), () => {});
                    } finally {
                        if (authSubmitBtn) setLoadingState('auth-submit-btn', false);
                    }
                });
            }

            // Back to home button
            const authBackToHome = document.getElementById('auth-back-to-home');
            if (authBackToHome) {
                authBackToHome.addEventListener('click', () => {
                    window.history.pushState({}, '', '/');
                    handleHistoryNavigation('/');
                });
            }

            // Forgot password button
            const authForgotPasswordBtn = document.getElementById('auth-forgot-password-btn');
            if (authForgotPasswordBtn) {
                authForgotPasswordBtn.addEventListener('click', () => {
                    // You can implement password reset functionality here later
                    showCustomConfirm('Password reset functionality coming soon!', () => {});
                });
            }
        }

        setupAuthPage();

        // --- SIDEBAR SIGN IN BUTTON ---
        const sidebarSignInBtn = document.getElementById('sidebar-signin-btn');
        if (sidebarSignInBtn) {
            sidebarSignInBtn.addEventListener('click', () => {
                // Navigate to auth page
                window.history.pushState({}, '', '/auth');
                handleHistoryNavigation('/auth');
                // Close sidebar on mobile after navigation
                if (window.innerWidth < 768 && sidebar && sidebar.classList.contains('open')) {
                    toggleSidebar();
                }
            });
        }

        // --- SIDEBAR LOGOUT BUTTON ---
        const sidebarLogoutBtn = document.getElementById('sidebar-logout-btn');
        if (sidebarLogoutBtn) {
            sidebarLogoutBtn.addEventListener('click', () => {
                localStorage.removeItem('jwt_token');
                sessionStorage.removeItem('jwt_token');
                updateAuthUI(false);
                collectionData = []; // Clear data when logged out
                history.replaceState(null, '', window.location.pathname); // Clear public URL param on logout
                renderAllViews();
                showCustomConfirm('Signed out successfully!', () => {});
            });
        }

        // Currency update button
        const updateCurrencyBtn = document.getElementById('update-currency-btn');
        if (updateCurrencyBtn) {
            updateCurrencyBtn.addEventListener('click', updateSitewideCurrency);
        } else { console.error('update-currency-btn not found during attachGlobalEventListeners!'); }
    }

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded. Starting app initialization...');
        applySavedTheme(); // Apply theme immediately on load
        loadSavedPrices(); // Load saved metal prices
        attachGlobalEventListeners();
        setupSwipeGestures(); // Setup mobile swipe gestures
        setupImageUpload(); // Setup image upload functionality
        setupImageUrlPreview(); // Setup image URL preview

        const urlParams = new URLSearchParams(window.location.search);
        const publicId = urlParams.get('public');

        if (publicId) {
            // If public ID is present, render public collection view directly
            updateAuthUI(false); // Ensure logged out state for public view
            showView('content-public-collection'); // This will trigger loading public data
        } else {
            // Otherwise, proceed with normal authenticated app flow
            updateAuthUI(isAuthenticated()); // Update UI based on initial token presence
            loadCollectionFromBackend(); // Attempt to load data if already authenticated
            showView('content-home'); // Default view on load is now the home page
        }
        console.log('App initialization completed successfully.');
    });

    // --- Metal Prices State ---
    let metalPrices = { 
        gold_usd_per_oz: 2300, 
        silver_usd_per_oz: 29.5,
        gold_zar_per_oz: 42000, // Approximate ZAR conversion
        silver_zar_per_oz: 540   // Approximate ZAR conversion
    };
    let lastPriceUpdate = 0;
    let isFetchingPrices = false; // Prevent multiple simultaneous requests
    const PRICE_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes in milliseconds
    
    // --- Currency and Unit Settings ---
    let currencySetting = localStorage.getItem('currency') || 'USD';
    let weightUnitSetting = localStorage.getItem('weightUnit') || 'oz';
    let zarExchangeRate = parseFloat(localStorage.getItem('zarExchangeRate')) || 18.25; // USD to ZAR rate

    // --- Fetch Metal Prices (with caching) ---
    async function fetchMetalPrices(forceRefresh = false) {
        const now = Date.now();
        
        // Ensure metalPrices object exists and has default values
        if (!metalPrices || typeof metalPrices !== 'object') {
            metalPrices = { 
                gold_usd_per_oz: 2300, 
                silver_usd_per_oz: 29.5,
                gold_zar_per_oz: 2300 * zarExchangeRate,
                silver_zar_per_oz: 29.5 * zarExchangeRate
            };
        }
        
        // Check if we have cached prices that are still valid
        const timeSinceLastUpdate = now - lastPriceUpdate;
        console.log(`Cache check: ${timeSinceLastUpdate}ms since last update, cache duration: ${PRICE_CACHE_DURATION}ms`);
        
        if (!forceRefresh && timeSinceLastUpdate < PRICE_CACHE_DURATION && metalPrices.gold_usd_per_oz > 0 && metalPrices.silver_usd_per_oz > 0) {
            console.log('‚úÖ Using cached metal prices (last updated:', new Date(lastPriceUpdate).toLocaleTimeString(), ')');
            renderBullionSection();
            return;
        }

        // Prevent multiple simultaneous requests
        if (isFetchingPrices) {
            console.log('‚è≥ Metal prices fetch already in progress, skipping...');
            return;
        }

        isFetchingPrices = true;
        try {
            console.log('üîÑ Fetching fresh metal prices...');
            const res = await fetch(`${API_BASE_URL}/prices/metals`);
            if (res.ok) {
                const data = await res.json();
                metalPrices = {
                    gold_usd_per_oz: data.gold_usd_per_oz || 2300,
                    silver_usd_per_oz: data.silver_usd_per_oz || 29.5,
                    gold_zar_per_oz: data.gold_zar_per_oz || (data.gold_usd_per_oz ? data.gold_usd_per_oz * zarExchangeRate : 0),
                    silver_zar_per_oz: data.silver_zar_per_oz || (data.silver_usd_per_oz ? data.silver_usd_per_oz * zarExchangeRate : 0)
                };
                lastPriceUpdate = now;
                console.log(`Metal prices updated: Gold $${metalPrices.gold_usd_per_oz}/oz, Silver $${metalPrices.silver_usd_per_oz}/oz (Source: ${data.source || 'unknown'})`);
            } else {
                console.warn('Failed to fetch metal prices, using fallback values');
                metalPrices = { 
                    gold_usd_per_oz: 2300, 
                    silver_usd_per_oz: 29.5,
                    gold_zar_per_oz: 2300 * zarExchangeRate,
                    silver_zar_per_oz: 29.5 * zarExchangeRate
                };
            }
        } catch (error) {
            console.error('Error fetching metal prices:', error);
            metalPrices = { 
                gold_usd_per_oz: 2300, 
                silver_usd_per_oz: 29.5,
                gold_zar_per_oz: 2300 * zarExchangeRate,
                silver_zar_per_oz: 29.5 * zarExchangeRate
            };
        } finally {
            isFetchingPrices = false; // Reset the flag
        }
        renderBullionSection();
    }

    // --- Currency Helper Functions ---
    function getCurrencySymbol(currency) {
        return currency === 'USD' ? '$' : 'R';
    }

    function formatCurrency(amount, currency) {
        const symbol = getCurrencySymbol(currency);
        return `${symbol}${amount.toFixed(2)}`;
    }

    // --- Currency Conversion Functions ---
    function convertToCurrency(value, fromCurrency, toCurrency) {
        if (fromCurrency === toCurrency) return value;
        
        // Ensure zarExchangeRate is available
        if (!zarExchangeRate || isNaN(zarExchangeRate)) {
            console.warn('ZAR exchange rate not available, using fallback rate of 18.25');
            zarExchangeRate = 18.25;
        }
        
        if (fromCurrency === 'USD' && toCurrency === 'ZAR') {
            return value * zarExchangeRate;
        } else if (fromCurrency === 'ZAR' && toCurrency === 'USD') {
            return value / zarExchangeRate;
        }
        
        return value; // Fallback
    }

    function getItemValueInCurrency(item, targetCurrency) {
        let baseValue;
        
        if (item.type === 'Gold Bullion' || item.type === 'Silver Bullion') {
            // For bullion, calculate the USD value first, then convert
            if (!item.weight_grams || !item.purity_percent) return 0;
            
            // Ensure metalPrices is available
            if (!metalPrices || !metalPrices.gold_usd_per_oz || !metalPrices.silver_usd_per_oz) {
                console.warn('Metal prices not available, using fallback values');
                const fallbackGoldPrice = 2300;
                const fallbackSilverPrice = 29.5;
                const price = item.type === 'Gold Bullion' ? fallbackGoldPrice : fallbackSilverPrice;
                baseValue = ((item.weight_grams / 31.1035) * (item.purity_percent / 100) * price) || 0;
            } else {
                const price = item.type === 'Gold Bullion' ? metalPrices.gold_usd_per_oz : metalPrices.silver_usd_per_oz;
                baseValue = ((item.weight_grams / 31.1035) * (item.purity_percent / 100) * price) || 0;
            }
        } else {
            // For regular items, assume the stored value is in USD
            baseValue = item.value || 0;
        }
        
        return convertToCurrency(baseValue, 'USD', targetCurrency);
    }

    // --- Calculate Bullion Value ---
    function calculateBullionValue(item) {
        if (!item.weight_grams || !item.purity_percent) return 0;
        
        let price;
        if (currencySetting === 'USD') {
            price = item.type === 'Gold Bullion' ? metalPrices.gold_usd_per_oz : metalPrices.silver_usd_per_oz;
        } else if (currencySetting === 'ZAR') {
            price = item.type === 'Gold Bullion' ? metalPrices.gold_zar_per_oz : metalPrices.silver_zar_per_oz;
        }
        
        return ((item.weight_grams / 31.1035) * (item.purity_percent / 100) * price) || 0;
    }

    // --- Render Bullion Section ---
    function renderBullionSection() {
        const wrapper = document.getElementById('bullion-section');
        if (!wrapper) return;
        const bullionItems = collectionData.filter(item => item.type === 'Gold Bullion' || item.type === 'Silver Bullion');
        
        // Check if we have any bullion items to show
        if (bullionItems.length === 0) {
            wrapper.innerHTML = '';
            return;
        }
        
        let html = `<div class="mb-4 p-4 bg-gray-800 rounded-lg border border-gray-700">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold text-yellow-400">Bullion / Gold / Silver</h2>
                <button onclick="fetchMetalPrices(true)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm mr-2">
                    <i class="ph-bold ph-arrows-clockwise mr-1"></i>Auto Update
                </button>
            </div>
            <div class="flex flex-wrap gap-6 mb-3 text-sm">
                <span class="text-gray-300">Gold Price: <span class="font-bold text-yellow-400">${getCurrencySymbol(currencySetting)}${getCurrentPrice('gold', currencySetting, weightUnitSetting)}</span> ${currencySetting}/${weightUnitSetting}</span>
                <span class="text-gray-300">Silver Price: <span class="font-bold text-gray-400">${getCurrencySymbol(currencySetting)}${getCurrentPrice('silver', currencySetting, weightUnitSetting)}</span> ${currencySetting}/${weightUnitSetting}</span>
                <button onclick="showManualPriceModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                    <i class="ph-bold ph-pencil-simple mr-1"></i>Update Prices
                </button>
            </div>`;
        
        if (bullionItems.length > 0) {
            html += `<div class="overflow-x-auto">
                <table class="w-full text-left data-table">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="p-2">Notes</th>
                            <th class="p-2">Type</th>
                            <th class="p-2">Weight (g)</th>
                            <th class="p-2">Purity (%)</th>
                            <th class="p-2">Year</th>
                            <th class="p-2">Value</th>
                            <th class="p-2">Quantity</th>
                            <th class="p-2">Reference</th>
                            <th class="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bullionItems.map(item => `
                            <tr class="border-b border-gray-600">
                                <td class="p-2">${item.notes || '-'}</td>
                                <td class="p-2">${item.type}</td>
                                <td class="p-2">${item.weight_grams || '-'}</td>
                                <td class="p-2">${item.purity_percent || '-'}</td>
                                <td class="p-2">${item.year || '-'}</td>
                                <td class="p-2 font-bold text-emerald-400">${formatCurrency(getItemValueInCurrency(item, currencySetting) * (item.quantity || 1), currencySetting)}</td>
                                <td class="p-2">
                                    <input type="number" 
                                           min="1" 
                                           value="${item.quantity || 1}" 
                                           class="w-16 bg-gray-700 border-gray-600 rounded px-2 py-1 text-center text-white focus:ring-emerald-500 focus:border-emerald-500"
                                           onchange="updateBullionQuantity(${item.id}, this.value)"
                                           title="Click to edit quantity">
                                </td>
                                <td class="p-2">${item.referenceUrl ? `<a href="${item.referenceUrl}" target="_blank" class="text-blue-400 hover:text-blue-300">Link</a>` : '-'}</td>
                                <td class="p-2">
                                    <button onclick="editBullionItem(${item.id})" class="text-blue-400 hover:text-blue-300 mr-2" title="Edit Bullion">
                                        <i class="ph ph-pencil-simple"></i>
                                    </button>
                                    <button onclick="deleteBullionItem(${item.id})" class="text-red-400 hover:text-red-300" title="Delete Bullion">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
        }
        
        html += `</div>`;
        wrapper.innerHTML = html;
    }

    // --- Update Form for Bullion ---
    function toggleBullionFields() {
        const type = document.getElementById('type').value;
        const show = (type === 'Gold Bullion' || type === 'Silver Bullion');
        const bullionFields = document.getElementById('bullion-fields');
        const denominationField = document.getElementById('denomination').parentElement;
        const valueField = document.getElementById('value').parentElement;
        
        if (bullionFields) bullionFields.style.display = show ? '' : 'none';
        if (denominationField) denominationField.style.display = show ? 'none' : '';
        if (valueField) valueField.style.display = show ? 'none' : '';
        
        // For bullion, set denomination to the type (e.g., "Gold Bullion")
        if (show && document.getElementById('denomination')) {
            document.getElementById('denomination').value = type;
        }
    }

    // Add event listener when the type field exists
    function attachBullionEventListeners() {
        const typeField = document.getElementById('type');
        if (typeField) {
            typeField.addEventListener('change', toggleBullionFields);
            toggleBullionFields(); // Initialize on load
        }
    }

    // --- Patch Collection Rendering ---
    function renderCollection(filteredData = collectionData) {
        console.log('Rendering collection with data:', filteredData);
        console.log('Number of items to render:', filteredData.length);
        
        // Render bullion section above collection
        let wrapper = document.getElementById('bullion-section');
        if (!wrapper) {
            const parent = document.getElementById('content-collection');
            wrapper = document.createElement('div');
            wrapper.id = 'bullion-section';
            parent.insertBefore(wrapper, parent.firstChild);
        }
        
        // Only fetch prices if we don't have them cached or if cache is expired
        fetchMetalPrices(false); // Use cached prices if available
        
        // Force render the bullion section
        renderBullionSection();
        
        // Now call the original renderCollection logic
        const collectionContent = document.getElementById('content-collection');
        const collectionContentWrapper = collectionContent.querySelector('.max-w-7xl.mx-auto');
        if (!collectionContentWrapper) return;

        if (!isAuthenticated()) {
            collectionContentWrapper.innerHTML = `<div class="unauthenticated-overlay"><p class="text-xl text-red-400">Please sign in to manage your collection.</p></div>`;
            return;
        }

        collectionContentWrapper.innerHTML = `
            <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-4 sm:space-y-0 sm:space-x-4">
                <h1 class="text-3xl font-bold text-white">Collection</h1>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                    <div class="relative w-full sm:w-auto">
                        <input type="text" id="search-input" placeholder="Search... (Ctrl+F)" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2 pr-8">
                        <button id="clear-search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white hidden" title="Clear search">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
                    <select id="region-filter" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2"></select>
                    <select id="type-filter" class="bg-gray-800 border-gray-600 rounded-md focus:ring-emerald-500 focus:border-emerald-500 w-full sm:w-auto p-2"></select>
                    <button id="favorites-filter-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition-colors text-sm" title="Show only favorites">
                        <i class="ph ph-star mr-1"></i> Favorites
                    </button>
                    <button id="clear-filters-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition-colors text-sm" title="Clear all filters">
                        <i class="ph ph-x-circle mr-1"></i> Clear
                    </button>
                </div>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-full flex flex-col">
                    <div class="flex-1 overflow-y-auto overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
                        <table class="w-full text-left data-table min-w-max"> <!-- min-w-max to prevent crushing columns -->
                            <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="id">ID</th>
                                    <th class="p-4 font-semibold">Photo</th>
                                    <th class="p-4 font-semibold">Type</th>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="country">Country</th>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="year">Year</th>
                                    <th class="p-4 font-semibold">Denomination</th>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="quantity">Qty</th>
                                    <th class="p-4 font-semibold cursor-pointer" data-sort-column="value">Value</th>
                                    <th class="p-4 font-semibold">Notes & Ref.</th>
                                    <th class="p-4 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="collection-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        initializeFilters();
        if (filteredData.length === 0) {
            const tableBody = document.getElementById('collection-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="p-8 text-center text-gray-500">
                        <div class="flex flex-col items-center space-y-4">
                            <i class="ph ph-coin text-4xl"></i>
                            <p class="text-lg">Your collection is empty</p>
                            <p class="text-sm">Click the "Quick Add" button to add your first item!</p>
                        </div>
                    </td>
                </tr>
            `;
        } else {
            // Sort favorites to top before rendering
            const sortedData = [...filteredData].sort((a, b) => {
                if (a.is_favorite && !b.is_favorite) return -1;
                if (!a.is_favorite && b.is_favorite) return 1;
                return 0;
            });
            renderCollectionTable(sortedData);
        }
        attachSortEventListeners();
    }

    // --- Manual Price Update Modal ---
    function showManualPriceModal() {
        const modalHtml = `
            <div id="price-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg mx-4">
                    <h3 class="text-xl font-bold text-white mb-4">Update Metal Prices</h3>
                    
                    <!-- Currency and Unit Settings -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Currency</label>
                            <select id="price-currency" class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="USD" ${currencySetting === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="ZAR" ${currencySetting === 'ZAR' ? 'selected' : ''}>ZAR (South African Rand)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Weight Unit</label>
                            <select id="price-weight-unit" class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="oz" ${weightUnitSetting === 'oz' ? 'selected' : ''}>Ounces (oz)</option>
                                <option value="g" ${weightUnitSetting === 'g' ? 'selected' : ''}>Grams (g)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Exchange Rate (for ZAR) -->
                    <div id="exchange-rate-section" class="mb-4" style="display: ${currencySetting === 'ZAR' ? 'block' : 'none'};">
                        <label class="block text-sm font-medium text-gray-300 mb-2">USD to ZAR Exchange Rate</label>
                        <input type="number" id="zar-exchange-rate" step="0.01" value="${zarExchangeRate}" 
                               class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <!-- Price Inputs -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Gold Price</label>
                            <input type="number" id="manual-gold-price" step="0.01" 
                                   value="${getCurrentPrice('gold', currencySetting, weightUnitSetting)}" 
                                   class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Silver Price</label>
                            <input type="number" id="manual-silver-price" step="0.01" 
                                   value="${getCurrentPrice('silver', currencySetting, weightUnitSetting)}" 
                                   class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closePriceModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md">Cancel</button>
                        <button onclick="updateManualPrices()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-md">Update Prices</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Add event listeners for currency/unit changes
        document.getElementById('price-currency').addEventListener('change', updatePriceLabels);
        document.getElementById('price-weight-unit').addEventListener('change', updatePriceLabels);
    }

    function closePriceModal() {
        const modal = document.getElementById('price-modal');
        if (modal) modal.remove();
    }

    // --- Price Conversion Helper Functions ---
    function getCurrentPrice(metal, currency, unit) {
        const ozToGram = 31.1035; // 1 ounce = 31.1035 grams
        
        let basePrice;
        if (currency === 'USD') {
            basePrice = metal === 'gold' ? metalPrices.gold_usd_per_oz : metalPrices.silver_usd_per_oz;
        } else if (currency === 'ZAR') {
            basePrice = metal === 'gold' ? metalPrices.gold_zar_per_oz : metalPrices.silver_zar_per_oz;
        }
        
        // Handle undefined/null values - return default prices
        if (!basePrice || isNaN(basePrice) || basePrice <= 0) {
            // Default fallback prices
            basePrice = metal === 'gold' ? 2300 : 29.5;
        }
        
        if (unit === 'g') {
            return (basePrice / ozToGram).toFixed(2);
        }
        return basePrice.toFixed(2);
    }

    function updatePriceLabels() {
        const currency = document.getElementById('price-currency').value;
        const unit = document.getElementById('price-weight-unit').value;
        const exchangeRateSection = document.getElementById('exchange-rate-section');
        
        // Show/hide exchange rate section
        exchangeRateSection.style.display = currency === 'ZAR' ? 'block' : 'none';
        
        // Update labels (simplified)
        const goldLabel = document.querySelector('label[for="manual-gold-price"]');
        const silverLabel = document.querySelector('label[for="manual-silver-price"]');
        
        if (goldLabel) goldLabel.textContent = 'Gold Price';
        if (silverLabel) silverLabel.textContent = 'Silver Price';
        
        // Update input values
        const goldInput = document.getElementById('manual-gold-price');
        const silverInput = document.getElementById('manual-silver-price');
        
        if (goldInput) goldInput.value = getCurrentPrice('gold', currency, unit);
        if (silverInput) silverInput.value = getCurrentPrice('silver', currency, unit);
    }

    function updateManualPrices() {
        const currency = document.getElementById('price-currency').value;
        const unit = document.getElementById('price-weight-unit').value;
        const goldPrice = parseFloat(document.getElementById('manual-gold-price').value);
        const silverPrice = parseFloat(document.getElementById('manual-silver-price').value);
        const zarRate = parseFloat(document.getElementById('zar-exchange-rate').value) || zarExchangeRate;
        
        if (isNaN(goldPrice) || isNaN(silverPrice) || goldPrice <= 0 || silverPrice <= 0) {
            showCustomConfirm('Please enter valid prices greater than 0.', () => {});
            return;
        }
        
        const ozToGram = 31.1035;
        
        // Convert to base prices (USD per ounce)
        let goldUsdPerOz, silverUsdPerOz;
        
        if (currency === 'USD') {
            goldUsdPerOz = unit === 'g' ? goldPrice * ozToGram : goldPrice;
            silverUsdPerOz = unit === 'g' ? silverPrice * ozToGram : silverPrice;
        } else if (currency === 'ZAR') {
            const goldUsdPerUnit = unit === 'g' ? goldPrice * ozToGram : goldPrice;
            const silverUsdPerUnit = unit === 'g' ? silverPrice * ozToGram : silverPrice;
            goldUsdPerOz = goldUsdPerUnit / zarRate;
            silverUsdPerOz = silverUsdPerUnit / zarRate;
        }
        
        // Update all price formats
        metalPrices.gold_usd_per_oz = goldUsdPerOz;
        metalPrices.silver_usd_per_oz = silverUsdPerOz;
        metalPrices.gold_zar_per_oz = goldUsdPerOz * zarRate;
        metalPrices.silver_zar_per_oz = silverUsdPerOz * zarRate;
        
        // Update settings
        currencySetting = currency;
        weightUnitSetting = unit;
        zarExchangeRate = zarRate;
        
        // Save to localStorage
        localStorage.setItem('currency', currency);
        localStorage.setItem('weightUnit', unit);
        localStorage.setItem('zarExchangeRate', zarRate.toString());
        localStorage.setItem('metalPrices', JSON.stringify({
            gold_usd_per_oz: goldUsdPerOz,
            silver_usd_per_oz: silverUsdPerOz,
            gold_zar_per_oz: metalPrices.gold_zar_per_oz,
            silver_zar_per_oz: metalPrices.silver_zar_per_oz,
            lastUpdate: Date.now()
        }));
        
        lastPriceUpdate = Date.now();
        
        closePriceModal();
        renderBullionSection();
        showCustomConfirm('Metal prices updated successfully!', () => {});
    }

    // --- Load saved prices on startup ---
    function loadSavedPrices() {
        const saved = localStorage.getItem('metalPrices');
        if (saved) {
            try {
                const savedPrices = JSON.parse(saved);
                metalPrices.gold_usd_per_oz = savedPrices.gold_usd_per_oz || 2300;
                metalPrices.silver_usd_per_oz = savedPrices.silver_usd_per_oz || 29.5;
                metalPrices.gold_zar_per_oz = savedPrices.gold_zar_per_oz || (2300 * zarExchangeRate);
                metalPrices.silver_zar_per_oz = savedPrices.silver_zar_per_oz || (29.5 * zarExchangeRate);
                lastPriceUpdate = savedPrices.lastUpdate || 0;
                console.log('Loaded saved metal prices:', metalPrices);
            } catch (e) {
                console.error('Error loading saved prices:', e);
            }
        }
    }

    // --- Sitewide Currency Management ---
    function updateSitewideCurrency() {
        const selectedCurrency = document.querySelector('input[name="currency-preference"]:checked').value;
        
        if (selectedCurrency !== currencySetting) {
            currencySetting = selectedCurrency;
            localStorage.setItem('currency', currencySetting);
            
            // Update all displays that show currency
            renderAllViews();
            
            showCustomConfirm(`Currency updated to ${currencySetting}. All values will now display in ${currencySetting}.`, () => {});
        } else {
            showCustomConfirm('Currency setting is already set to your selection.', () => {});
        }
    }

    function applySitewideCurrency() {
        try {
            // Update all value displays throughout the app
            if (document.getElementById('dashboard-total-value')) {
                const totalValue = collectionData.reduce((sum, item) => {
                    return sum + (getItemValueInCurrency(item, currencySetting) * (item.quantity || 1));
                }, 0);
                document.getElementById('dashboard-total-value').innerText = formatCurrency(totalValue, currencySetting);
            }
            
            // Update collection table values
            const valueCells = document.querySelectorAll('.data-table td:nth-child(7)');
            valueCells.forEach(cell => {
                const itemId = cell.closest('tr').dataset.itemId;
                if (itemId) {
                    const item = collectionData.find(coin => coin.id === parseInt(itemId));
                    if (item) {
                        cell.textContent = formatCurrency(getItemValueInCurrency(item, currencySetting) * (item.quantity || 1), currencySetting);
                    }
                }
            });
            
            // Update bullion section
            renderBullionSection();
            
            // Re-render dashboard highlights
            renderCollectionHighlights();
        } catch (error) {
            console.error('Error in applySitewideCurrency:', error);
        }
    }

    // --- Bullion Edit and Delete Functions ---
    function editBullionItem(itemId) {
        const item = collectionData.find(coin => coin.id === itemId);
        if (!item) {
            showCustomConfirm('Item not found.', () => {});
            return;
        }

        // Open the item modal and populate with bullion data
        document.getElementById('item-id').value = item.id;
        document.getElementById('type').value = item.type;
        document.getElementById('country').value = item.country || '';
        document.getElementById('year').value = item.year || '';
        document.getElementById('denomination').value = item.denomination || '';
        document.getElementById('value').value = item.value || '';
        document.getElementById('quantity').value = item.quantity || 1;
        document.getElementById('notes').value = item.notes || '';
        document.getElementById('referenceUrl').value = item.referenceUrl || '';
        document.getElementById('localImagePath').value = item.localImagePath || '';
        document.getElementById('weight_grams').value = item.weight_grams || '';
        document.getElementById('purity_percent').value = item.purity_percent || '';
        
        // Update form visibility for bullion
        toggleBullionFields();
        
        // Update modal title
        document.getElementById('modal-title').innerText = 'Edit Bullion Item';
        
        // Show the modal
        const modal = document.getElementById('item-modal');
        const modalContent = modal.querySelector('div');
        modal.classList.remove('hidden');
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }

    async function deleteBullionItem(itemId) {
        const item = collectionData.find(coin => coin.id === itemId);
        if (!item) {
            showCustomConfirm('Item not found.', () => {});
            return;
        }

        // Show confirmation dialog
        showCustomConfirm(
            `Are you sure you want to delete this ${item.type} item? This action cannot be undone.`,
            async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/coins/${itemId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            handleUnauthorized();
                            return;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    showCustomConfirm(result.message || 'Bullion item deleted successfully!', () => {});
                    loadCollectionFromBackend(); // Reload data after deletion
                } catch (error) {
                    console.error("Error deleting bullion item:", error);
                    const safeMessage = escapeHtml(error.message || 'An unexpected error occurred');
                    showCustomConfirm(`Failed to delete item: ${safeMessage}. Please check your connection and try again.`, () => {});
                }
            }
        );
    }

    // --- Patch Dashboard/Highlights ---
    const origRenderCollectionHighlights = renderCollectionHighlights;
    function renderCollectionHighlights() {
        // Sum quantities for total items (not just count rows)
        const totalItemsCount = collectionData.reduce((sum, item) => sum + (item.quantity || 1), 0);
        let highlightsHtml = `<li><strong>Total Items:</strong> ${totalItemsCount}</li>`;
        highlightsHtml += `<li><strong>Total Estimated Value:</strong> $${collectionData.reduce((sum, item) => {
            const itemValue = item.type === 'Gold Bullion' || item.type === 'Silver Bullion' 
                ? calculateBullionValue(item) 
                : (item.value || 0);
            return sum + (itemValue * (item.quantity || 1));
        }, 0).toFixed(2)}</li>`;
        highlightsHtml += `<li><strong>Unique Countries Represented:</strong> ${new Set(collectionData.map(item => item.country)).size}</li>`;
        document.getElementById('collection-highlights').innerHTML = highlightsHtml;
    }

    // --- Update Bullion Quantity Function ---
    async function updateBullionQuantity(itemId, newQuantity) {
        const item = collectionData.find(coin => coin.id === itemId);
        if (!item) {
            showCustomConfirm('Item not found.', () => {});
            return;
        }

        const quantity = parseInt(newQuantity);
        if (isNaN(quantity) || quantity < 1) {
            showCustomConfirm('Quantity must be a number greater than 0.', () => {});
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/coins/${itemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    type: item.type,
                    country: item.country,
                    year: item.year,
                    denomination: item.denomination,
                    value: item.value,
                    quantity: quantity,
                    notes: item.notes,
                    referenceUrl: item.referenceUrl,
                    localImagePath: item.localImagePath,
                    weight_grams: item.weight_grams,
                    purity_percent: item.purity_percent
                })
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            // Update the local data
            item.quantity = quantity;
            
            // Reload collection to update all displays
            loadCollectionFromBackend();
            
            showCustomConfirm('Quantity updated successfully!', () => {});
        } catch (error) {
            console.error("Error updating quantity:", error);
            showCustomConfirm(`Failed to update quantity: ${error.message}`, () => {});
        }
    }

    // --- Forgot Password Functionality ---
    
    // Forgot Password Modal - Create inside DOMContentLoaded to ensure DOM is ready
    let forgotPasswordModal;
    document.addEventListener('DOMContentLoaded', () => {
        forgotPasswordModal = document.createElement('div');
        forgotPasswordModal.id = 'forgot-password-modal';
        forgotPasswordModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
        forgotPasswordModal.innerHTML = `
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Reset Password</h3>
                <button id="close-forgot-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="forgot-password-step1">
                <p class="text-gray-300 mb-4">Enter your email address and we'll send you a password reset link.</p>
                <form id="forgot-password-form" class="space-y-4">
                    <input type="email" id="forgot-email" placeholder="Enter your email" 
                           class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" required>
                    <button type="submit" id="send-reset-btn" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">
                        Send Reset Link
                    </button>
                </form>
            </div>
            <div id="forgot-password-step2" class="hidden">
                <p class="text-green-400 mb-4">‚úÖ Reset link sent! Check your email and click the link to reset your password.</p>
                <button id="close-forgot-success" 
                        class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">
                    Close
                </button>
            </div>
        </div>
    `;
        document.body.appendChild(forgotPasswordModal);

        // Forgot Password Event Listeners
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        if (forgotPasswordBtn) {
            forgotPasswordBtn.addEventListener('click', () => {
                if (forgotPasswordModal) {
                    forgotPasswordModal.classList.remove('hidden');
                    const step1 = document.getElementById('forgot-password-step1');
                    const step2 = document.getElementById('forgot-password-step2');
                    const forgotEmail = document.getElementById('forgot-email');
                    if (step1) step1.classList.remove('hidden');
                    if (step2) step2.classList.add('hidden');
                    if (forgotEmail) forgotEmail.value = '';
                }
            });
        }

        const closeForgotModal = document.getElementById('close-forgot-modal');
        if (closeForgotModal) {
            closeForgotModal.addEventListener('click', () => {
                if (forgotPasswordModal) forgotPasswordModal.classList.add('hidden');
            });
        }

        const closeForgotSuccess = document.getElementById('close-forgot-success');
        if (closeForgotSuccess) {
            closeForgotSuccess.addEventListener('click', () => {
                if (forgotPasswordModal) forgotPasswordModal.classList.add('hidden');
            });
        }

        // Close modal when clicking outside
        if (forgotPasswordModal) {
            forgotPasswordModal.addEventListener('click', (e) => {
                if (e.target === forgotPasswordModal) {
                    forgotPasswordModal.classList.add('hidden');
                }
            });
        }
    });

    // Handle forgot password form submission - moved inside DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('forgot-email').value;
                const sendResetBtn = document.getElementById('send-reset-btn');
                
                if (!email) {
                    showCustomConfirm('Please enter your email address.', () => {});
                    return;
                }

                // Disable button and show loading
                sendResetBtn.disabled = true;
                sendResetBtn.textContent = 'Sending...';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/forgot_password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email: email })
                    });

                    const result = await response.json();
                    
                    if (response.ok) {
                        // Show success step
                        document.getElementById('forgot-password-step1').classList.add('hidden');
                        document.getElementById('forgot-password-step2').classList.remove('hidden');
                    } else {
                        showCustomConfirm(result.message || 'Failed to send reset email. Please try again.', () => {});
                    }
                } catch (error) {
                    console.error('Error sending reset email:', error);
                    showCustomConfirm('Network error. Please check your connection and try again.', () => {});
                } finally {
                    // Re-enable button
                    sendResetBtn.disabled = false;
                    sendResetBtn.textContent = 'Send Reset Link';
                }
            });
        }
    });

    // Check for reset token in URL (for password reset page)
    function checkForResetToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (token) {
            // Show reset password form
            showResetPasswordForm(token);
        }
    }

    function showResetPasswordForm(token) {
        // Create reset password modal
        const resetModal = document.createElement('div');
        resetModal.id = 'reset-password-modal';
        resetModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        resetModal.innerHTML = `
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">Set New Password</h3>
                    <button id="close-reset-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="reset-password-form" class="space-y-4">
                    <input type="hidden" id="reset-token" value="${token}">
                    <div>
                        <label for="new-password-reset" class="block text-sm font-medium text-gray-400">New Password</label>
                        <input type="password" id="new-password-reset" placeholder="Enter new password" 
                               class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" 
                               minlength="6" required>
                    </div>
                    <div>
                        <label for="confirm-password-reset" class="block text-sm font-medium text-gray-400">Confirm New Password</label>
                        <input type="password" id="confirm-password-reset" placeholder="Confirm new password" 
                               class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" 
                               minlength="6" required>
                    </div>
                    <button type="submit" id="reset-password-btn" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">
                        Reset Password
                    </button>
                </form>
            </div>
        `;
        document.body.appendChild(resetModal);

        // Close button
        document.getElementById('close-reset-modal').addEventListener('click', () => {
            resetModal.remove();
        });

        // Handle form submission
        document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('new-password-reset').value;
            const confirmPassword = document.getElementById('confirm-password-reset').value;
            const resetBtn = document.getElementById('reset-password-btn');
            
            if (newPassword !== confirmPassword) {
                showCustomConfirm('Passwords do not match.', () => {});
                return;
            }
            
            if (newPassword.length < 6) {
                showCustomConfirm('Password must be at least 6 characters long.', () => {});
                return;
            }

            // Disable button and show loading
            resetBtn.disabled = true;
            resetBtn.textContent = 'Resetting...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/reset_password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        token: token,
                        new_password: newPassword 
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showCustomConfirm('‚úÖ Password reset successfully! You can now log in with your new password.', () => {
                        resetModal.remove();
                        // Clear the token from URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    });
                } else {
                    showCustomConfirm(result.message || 'Failed to reset password. Please try again.', () => {});
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                showCustomConfirm('Network error. Please check your connection and try again.', () => {});
            } finally {
                // Re-enable button
                resetBtn.disabled = false;
                resetBtn.textContent = 'Reset Password';
            }
        });
    }

    // Check for reset token on page load
    checkForResetToken();

    document.addEventListener('DOMContentLoaded', () => {
      const exportMapBtn = document.getElementById('export-map-btn');
      if (exportMapBtn) {
        exportMapBtn.addEventListener('click', () => {
          // Find the SVG inside the map
          const svg = document.querySelector('#geochart-canvas svg');
          if (!svg) {
            showCustomConfirm('Map image not found. Please make sure the map is visible.', () => {});
            return;
          }
          // Serialize SVG
          const serializer = new XMLSerializer();
          const svgString = serializer.serializeToString(svg);
          // Create image
          const img = new Image();
          const svgBlob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
          const url = URL.createObjectURL(svgBlob);
          img.onload = function() {
            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = svg.width.baseVal.value || 1200;
            canvas.height = svg.height.baseVal.value || 600;
            const ctx = canvas.getContext('2d');
            // Fill background (optional, white)
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            // Download PNG
            const pngUrl = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = 'coinshelf_map.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };
          img.onerror = function() {
            showCustomConfirm('Failed to export map image.', () => {});
          };
          img.src = url;
        });
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Setup collapsible navigation sections
      document.querySelectorAll('.nav-section-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
          const section = this.getAttribute('data-section');
          const content = document.querySelector(`.nav-section-content[data-section="${section}"]`);
          const icon = this.querySelector(`i[data-icon="${section}"]`);
          
          if (content) {
            content.classList.toggle('collapsed');
            this.classList.toggle('collapsed');
            if (icon) {
              icon.style.transform = content.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0deg)';
            }
          }
        });
      });
      
      // Expand all sections by default
      document.querySelectorAll('.nav-section-content').forEach(content => {
        content.classList.remove('collapsed');
      });
      
      // Intercept nav link clicks for SPA routing
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          const href = this.getAttribute('href');
          if (href.startsWith('/')) {
            e.preventDefault();
            window.history.pushState({}, '', href);
            handleHistoryNavigation(href);
          }
        });
      });
      // On initial load, show correct section
      handleHistoryNavigation(window.location.pathname);
    });

    // Listen for browser navigation (back/forward)
    window.addEventListener('popstate', () => {
      handleHistoryNavigation(window.location.pathname);
    });

    // --- After successful login, redirect to dashboard ---
    // In the login form submit event listener, after successful login:
    // ... existing code ...
    // Instead of just showCustomConfirm and updateAuthUI, do:
    // window.history.pushState({}, '', '/dashboard');
    // handleHistoryNavigation('/dashboard');
    // ... existing code ...

    // Remove all hash-based navigation logic and ensure showView is only called via handleHistoryNavigation.
    // ... existing code ...

    // --- Enhanced Import Functions ---
    
    function setupImportTabs() {
        const tabs = ['json', 'csv', 'excel', 'template', 'popular-sites'];
        
        tabs.forEach(tabId => {
            const tabBtn = document.getElementById(`tab-${tabId}`);
            const tabContent = document.getElementById(`${tabId}-tab`);
            
            if (tabBtn && tabContent) {
                tabBtn.addEventListener('click', () => {
                    // Hide all tabs
                    tabs.forEach(id => {
                        const btn = document.getElementById(`tab-${id}`);
                        const content = document.getElementById(`${id}-tab`);
                        if (btn) {
                            btn.classList.remove('border-indigo-500', 'text-indigo-400');
                            btn.classList.add('border-transparent', 'text-gray-400');
                        }
                        if (content) content.classList.add('hidden');
                    });
                    
                    // Show selected tab
                    tabBtn.classList.remove('border-transparent', 'text-gray-400');
                    tabBtn.classList.add('border-indigo-500', 'text-indigo-400');
                    tabContent.classList.remove('hidden');
                });
            }
        });
    }
    
    function setupFileUploads() {
        // CSV file upload
        const csvFileInput = document.getElementById('csv-file-input');
        if (csvFileInput) {
            csvFileInput.addEventListener('change', handleCsvFileUpload);
        }
        
        // Excel file upload
        const excelFileInput = document.getElementById('excel-file-input');
        if (excelFileInput) {
            excelFileInput.addEventListener('change', handleExcelFileUpload);
        }
        
        // Load example JSON
        const loadExampleBtn = document.getElementById('load-example-json');
        if (loadExampleBtn) {
            loadExampleBtn.addEventListener('click', loadExampleJson);
        }
    }
    
    function setupTemplateDownloads() {
        // CSV template downloads
        const csvTemplateBtns = ['download-csv-template', 'download-csv-template-2'];
        csvTemplateBtns.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', downloadCsvTemplate);
            }
        });
        
        // Excel template downloads
        const excelTemplateBtns = ['download-excel-template', 'download-excel-template-2'];
        excelTemplateBtns.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', downloadExcelTemplate);
            }
        });
        
        // JSON example copy
        const copyJsonBtn = document.getElementById('copy-json-example');
        if (copyJsonBtn) {
            copyJsonBtn.addEventListener('click', copyJsonExample);
        }
        
        // Import guide
        const importGuideBtn = document.getElementById('show-import-guide');
        if (importGuideBtn) {
            importGuideBtn.addEventListener('click', showImportGuide);
        }
    }
    
    function handleCsvFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const csvContent = e.target.result;
            const preview = document.getElementById('csv-preview');
            const previewContent = document.getElementById('csv-preview-content');
            
            if (preview && previewContent) {
                previewContent.textContent = csvContent.substring(0, 500) + (csvContent.length > 500 ? '...' : '');
                preview.classList.remove('hidden');
            }
            
            // Parse CSV and prepare for import
            const items = parseCsvToJson(csvContent);
            if (items && items.length > 0) {
                // Detect format for better user feedback
                const lines = csvContent.split(/\r?\n/).filter(line => line.trim());
                if (lines.length > 0) {
                    function parseCSVLine(line) {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim());
                        return result;
                    }
                    
                    const headers = parseCSVLine(lines[0]);
                    const format = detectCsvFormat(headers);
                    
                    let message = `CSV file loaded with ${items.length} items.`;
                    if (format !== 'standard') {
                        const formatNames = {
                            'numista': 'Numista',
                            'ucoin': 'UCoin',
                            'colnect': 'Colnect'
                        };
                        message += ` Detected ${formatNames[format]} format.`;
                    }
                    message += ' Ready to import?';
                    
                    showCustomConfirm(message, async () => {
                        await importItems(items);
                    });
                } else {
                    showCustomConfirm(`CSV file loaded with ${items.length} items. Ready to import?`, async () => {
                        await importItems(items);
                    });
                }
            }
        };
        reader.readAsText(file);
    }
    
    function handleExcelFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // For Excel files, we'll show a message that this feature requires additional processing
        showCustomConfirm('Excel file import requires additional processing. For now, please convert your Excel file to CSV format or use the JSON import method.', () => {});
    }
    
    function detectCsvFormat(headers) {
        const headerLower = headers.map(h => h.toLowerCase().trim());
        
        // Detect Numista format
        if (headerLower.includes('reference number') || headerLower.includes('reference') || 
            (headerLower.includes('country') && headerLower.includes('denomination') && headerLower.includes('composition'))) {
            return 'numista';
        }
        
        // Detect UCoin format
        if (headerLower.includes('material') && headerLower.includes('weight') && 
            (headerLower.includes('diameter') || headerLower.includes('size'))) {
            return 'ucoin';
        }
        
        // Detect Colnect format
        if (headerLower.includes('catalog code') || headerLower.includes('catalogcode') ||
            (headerLower.includes('series') && headerLower.includes('catalog'))) {
            return 'colnect';
        }
        
        return 'standard';
    }
    
    function mapCsvRowToItem(row, headers, format) {
        const headerLower = headers.map(h => h.toLowerCase().trim());
        const item = { type: 'Coin' }; // Default type
        
        // Helper function to get value by header name (case-insensitive)
        const getValue = (searchHeaders) => {
            for (const searchHeader of searchHeaders) {
                const index = headerLower.indexOf(searchHeader.toLowerCase());
                if (index !== -1 && row[index]) {
                    return row[index].trim();
                }
            }
            return null;
        };
        
        if (format === 'numista') {
            // Numista format mapping
            item.country = getValue(['country', 'issuer', 'issuing country']);
            item.denomination = getValue(['denomination', 'title', 'value']);
            item.year = getValue(['year', 'issue year', 'date']) ? parseInt(getValue(['year', 'issue year', 'date'])) : null;
            item.referenceUrl = getValue(['reference number', 'reference', 'numista id']) ? 
                `https://en.numista.com/catalogue/pieces${getValue(['reference number', 'reference', 'numista id'])}.html` : null;
            
            // Composition can help determine if it's bullion
            const composition = getValue(['composition', 'material', 'metal']);
            if (composition) {
                const compLower = composition.toLowerCase();
                if (compLower.includes('gold') || compLower.includes('au')) {
                    item.type = 'Gold Bullion';
                } else if (compLower.includes('silver') || compLower.includes('ag')) {
                    item.type = 'Silver Bullion';
                }
                item.notes = composition;
            }
            
            // Weight and diameter
            const weight = getValue(['weight', 'weight (g)', 'weight grams']);
            if (weight) {
                const weightNum = parseFloat(weight);
                if (!isNaN(weightNum)) {
                    item.weight_grams = weightNum;
                }
            }
            
            const diameter = getValue(['diameter', 'size', 'diameter (mm)']);
            if (diameter && !item.notes) {
                item.notes = `Diameter: ${diameter}`;
            }
            
            // Value/Price
            const value = getValue(['purchase price', 'value', 'price', 'estimated value']);
            if (value) {
                const valueNum = parseFloat(value);
                if (!isNaN(valueNum)) {
                    item.value = valueNum;
                }
            }
            
            // Notes
            const notes = getValue(['notes', 'comment', 'comments', 'grade']);
            if (notes && !item.notes) {
                item.notes = notes;
            } else if (notes && item.notes) {
                item.notes = `${item.notes}. ${notes}`;
            }
            
            item.quantity = 1;
            
        } else if (format === 'ucoin') {
            // UCoin format mapping
            item.country = getValue(['country', 'issuing country']);
            item.denomination = getValue(['denomination', 'value', 'title']);
            item.year = getValue(['year', 'date', 'issue year']) ? parseInt(getValue(['year', 'date', 'issue year'])) : null;
            
            // Material helps determine type
            const material = getValue(['material', 'composition', 'metal']);
            if (material) {
                const matLower = material.toLowerCase();
                if (matLower.includes('gold') || matLower.includes('au')) {
                    item.type = 'Gold Bullion';
                } else if (matLower.includes('silver') || matLower.includes('ag')) {
                    item.type = 'Silver Bullion';
                }
                if (!item.notes) {
                    item.notes = `Material: ${material}`;
                }
            }
            
            // Weight
            const weight = getValue(['weight', 'weight (g)', 'weight grams']);
            if (weight) {
                const weightNum = parseFloat(weight);
                if (!isNaN(weightNum)) {
                    item.weight_grams = weightNum;
                }
            }
            
            // Diameter
            const diameter = getValue(['diameter', 'size', 'diameter (mm)']);
            if (diameter) {
                if (!item.notes) {
                    item.notes = `Diameter: ${diameter}`;
                } else {
                    item.notes = `${item.notes}, Diameter: ${diameter}`;
                }
            }
            
            // Value
            const value = getValue(['value', 'price', 'estimated value', 'purchase price']);
            if (value) {
                const valueNum = parseFloat(value);
                if (!isNaN(valueNum)) {
                    item.value = valueNum;
                }
            }
            
            // Notes and catalog code
            const notes = getValue(['notes', 'comment', 'comments']);
            const catalogCode = getValue(['catalog code', 'catalogcode', 'reference']);
            if (catalogCode) {
                item.referenceUrl = `https://ucoin.net/catalogue/${catalogCode}`;
            }
            if (notes) {
                if (!item.notes) {
                    item.notes = notes;
                } else {
                    item.notes = `${item.notes}. ${notes}`;
                }
            }
            
            item.quantity = 1;
            
        } else if (format === 'colnect') {
            // Colnect format mapping
            item.country = getValue(['country', 'issuing country']);
            item.denomination = getValue(['denomination', 'value', 'title', 'face value']);
            item.year = getValue(['year', 'date', 'issue year']) ? parseInt(getValue(['year', 'date', 'issue year'])) : null;
            
            // Catalog code
            const catalogCode = getValue(['catalog code', 'catalogcode', 'code', 'item code']);
            if (catalogCode) {
                item.referenceUrl = `https://colnect.com/en/coins/list/country/${item.country || ''}/year/${item.year || ''}`;
                if (!item.notes) {
                    item.notes = `Catalog: ${catalogCode}`;
                }
            }
            
            // Series
            const series = getValue(['series', 'theme']);
            if (series && !item.notes) {
                item.notes = `Series: ${series}`;
            } else if (series) {
                item.notes = `${item.notes}, Series: ${series}`;
            }
            
            // Value
            const value = getValue(['value', 'price', 'estimated value', 'grade']);
            if (value) {
                const valueNum = parseFloat(value);
                if (!isNaN(valueNum)) {
                    item.value = valueNum;
                } else if (!item.notes) {
                    item.notes = `Grade: ${value}`;
                }
            }
            
            // Comments
            const comments = getValue(['comments', 'comment', 'notes', 'description']);
            if (comments) {
                if (!item.notes) {
                    item.notes = comments;
                } else {
                    item.notes = `${item.notes}. ${comments}`;
                }
            }
            
            item.quantity = 1;
            
        } else {
            // Standard format - direct mapping
            headers.forEach((header, index) => {
                let value = row[index] ? row[index].trim() : null;
                
                // Convert numeric values
                if (['year', 'value', 'quantity', 'weight_grams', 'purity_percent'].includes(header.toLowerCase())) {
                    value = value ? parseFloat(value) || null : null;
                }
                
                item[header.toLowerCase().replace(/\s+/g, '_')] = value;
            });
            
            // Map standard field names
            if (!item.country && item.country_name) item.country = item.country_name;
            if (!item.denomination && item.denom) item.denomination = item.denom;
            if (!item.type) item.type = 'Coin';
            if (!item.quantity) item.quantity = 1;
        }
        
        return item;
    }
    
    function parseCsvToJson(csvContent) {
        try {
            // Handle different line endings and CSV parsing with quotes
            const lines = csvContent.split(/\r?\n/).filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSV file must have at least a header row and one data row');
            }
            
            // Simple CSV parser that handles quoted fields
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }
            
            const headers = parseCSVLine(lines[0]);
            const format = detectCsvFormat(headers);
            const items = [];
            
            console.log(`Detected CSV format: ${format}`);
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const row = parseCSVLine(lines[i]);
                if (row.length === 0) continue;
                
                const item = mapCsvRowToItem(row, headers, format);
                
                // Validate required fields
                if (item.country && item.denomination) {
                    items.push(item);
                }
            }
            
            if (items.length === 0) {
                throw new Error('No valid items found in CSV file. Please check that the file has the required columns: country, denomination');
            }
            
            // Show format detection message
            if (format !== 'standard') {
                const formatNames = {
                    'numista': 'Numista',
                    'ucoin': 'UCoin',
                    'colnect': 'Colnect'
                };
                console.log(`Successfully detected ${formatNames[format]} format and parsed ${items.length} items`);
            }
            
            return items;
        } catch (error) {
            showCustomConfirm(`Error parsing CSV: ${error.message}`, () => {});
            return null;
        }
    }
    
    function loadExampleJson() {
        const exampleJson = [
            {
                "type": "Coin",
                "country": "United States",
                "denomination": "1 Dollar",
                "year": 2020,
                "value": 1.00,
                "notes": "Sacagawea dollar"
            },
            {
                "type": "Banknote",
                "country": "Canada",
                "denomination": "5 Dollars",
                "year": 2018,
                "value": 3.75,
                "notes": "Polymer banknote"
            },
            {
                "type": "Gold Bullion",
                "country": "United States",
                "denomination": "Gold Bullion",
                "value": 1950.00,
                "weight_grams": 31.1,
                "purity_percent": 99.9,
                "notes": "1 oz American Eagle"
            }
        ];
        
        document.getElementById('import-json-data').value = JSON.stringify(exampleJson, null, 2);
    }
    
    function downloadCsvTemplate() {
        const csvContent = `type,country,denomination,year,value,quantity,notes,referenceUrl,weight_grams,purity_percent
Coin,United States,1 Dollar,2020,1.00,1,Sacagawea dollar,,,
Banknote,Canada,5 Dollars,2018,3.75,1,Polymer banknote,,,
Gold Bullion,United States,Gold Bullion,,1950.00,1,1 oz American Eagle,,31.1,99.9
Silver Bullion,Canada,Silver Bullion,,25.00,1,1 oz Maple Leaf,,31.1,99.9`;
        
        downloadFile(csvContent, 'coinshelf_template.csv', 'text/csv');
    }
    
    function downloadExcelTemplate() {
        // For now, we'll create a CSV file that can be opened in Excel
        downloadCsvTemplate();
    }
    
    function copyJsonExample() {
        const exampleJson = `[
  {
    "type": "Coin",
    "country": "United States",
    "denomination": "1 Dollar",
    "year": 2020,
    "value": 1.00,
    "notes": "Sacagawea dollar"
  },
  {
    "type": "Gold Bullion",
    "country": "United States",
    "denomination": "Gold Bullion",
    "value": 1950.00,
    "weight_grams": 31.1,
    "purity_percent": 99.9,
    "notes": "1 oz American Eagle"
  }
]`;
        
        navigator.clipboard.writeText(exampleJson).then(() => {
            showCustomConfirm('JSON example copied to clipboard!', () => {});
        }).catch(() => {
            showCustomConfirm('Failed to copy to clipboard. Please copy manually.', () => {});
        });
    }
    
    function showImportGuide() {
        const guide = `
üìã CoinShelf Import Guide

1. CHOOSE YOUR METHOD:
   ‚Ä¢ JSON: Paste formatted data directly.
   ‚Ä¢ CSV: Upload a spreadsheet file
   ‚Ä¢ Excel: Upload Excel files (coming soon)
   ‚Ä¢ Templates: Download ready-to-use templates

2. REQUIRED FIELDS:
   ‚Ä¢ type: "Coin", "Banknote", "Gold Bullion", or "Silver Bullion"
   ‚Ä¢ country: Country name
   ‚Ä¢ denomination: Value/description

3. OPTIONAL FIELDS:
   ‚Ä¢ year: Year minted/issued
   ‚Ä¢ value: Estimated value in USD
   ‚Ä¢ quantity: Number of items
   ‚Ä¢ notes: Additional notes
   ‚Ä¢ referenceUrl: Reference link
   ‚Ä¢ weight_grams: Weight for bullion
   ‚Ä¢ purity_percent: Purity for bullion

4. TIPS:
   ‚Ä¢ Use templates for correct formatting
   ‚Ä¢ Validate your data before importing
   ‚Ä¢ Start with a small test import
   ‚Ä¢ Backup your data before large imports

Need help? Check the templates tab for examples!
        `;
        
        showCustomConfirm(guide, () => {});
    }
    
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    async function importItems(items) {
        if (!isAuthenticated()) {
            showCustomConfirm('Please sign in to import data.', () => {});
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/coins/bulk_upload`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(items)
            });

            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            let message = result.message || 'Import completed successfully!';
            if (result.errors && result.errors.length > 0) {
                message += ` Some items had errors: ${result.errors.map(err => err.substring(0, 50) + "...").join('; ')}`;
            }
            showCustomConfirm(message, () => {});
            loadCollectionFromBackend();
        } catch (error) {
            console.error("Error during import:", error);
            showCustomConfirm(`Failed to import data: ${error.message}`, () => {});
        } finally {
            closeModal(document.getElementById('import-modal'), document.getElementById('import-modal').querySelector('div'));
        }
    }

    // --- Donation Functions ---
    
    function copyToClipboard(text, method) {
        navigator.clipboard.writeText(text).then(() => {
            showCustomConfirm(`${method} address copied to clipboard!`, () => {});
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showCustomConfirm(`${method} address copied to clipboard!`, () => {});
            } catch (err) {
                showCustomConfirm(`Failed to copy ${method} address. Please copy manually: ${text}`, () => {});
            }
            document.body.removeChild(textArea);
        });
    }
    
    function showCryptoAddresses() {
        closeModal(document.getElementById('donate-modal'), document.getElementById('donate-modal').querySelector('div'));
        setTimeout(() => {
            openModal('crypto-modal');
        }, 300);
    }

    // --- 3D Map Initialization & Toggle ---
    document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('toggle-map-mode-btn');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                is3DMode = !is3DMode;
                const map2d = document.getElementById('map-container');
                const map3d = document.getElementById('globe-container');
                const icon = document.getElementById('map-toggle-icon');
                
                if (is3DMode) {
                    // Hide 2D, Show 3D
                    map2d.style.display = 'none';
                    map3d.style.display = 'block';
                    map3d.classList.remove('hidden'); // Ensure class doesn't conflict
                    
                    icon.classList.remove('ph-globe');
                    icon.classList.add('ph-map-trifold');
                    
                    // Init 3D Map
                    if (!map3dInstance && window.Map3D) {
                        map3dInstance = new Map3D('globe-container');
                        map3dInstance.init((countryName) => {
                            showCountryDetailsModal(countryName);
                        });
                    }
                    if (map3dInstance) {
                        // If data is loaded, render it
                        if (typeof collectionData !== 'undefined') {
                            map3dInstance.renderData(collectionData);
                        }
                        // Force resize
                        map3dInstance.resize();
                    }
                } else {
                    // Hide 3D, Show 2D
                    map3d.style.display = 'none';
                    map2d.style.display = 'block';
                    
                    icon.classList.remove('ph-map-trifold');
                    icon.classList.add('ph-globe');
                    
                    // Re-draw 2D map
                    renderGeoChart();
                }
            });
        }
    });
</script>

</body>
</html>