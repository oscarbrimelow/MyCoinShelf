<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸª™</text></svg>" type="image/svg+xml">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinShelf - Collection Manager</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom styles for a more polished look */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-900 text-gray-100;
        }
        .container {
            @apply mx-auto p-4;
        }
        .sidebar {
            @apply bg-gray-800 text-gray-200 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out;
            z-index: 1000; /* Ensure sidebar is above content */
        }
        .sidebar-item {
            @apply flex items-center space-x-4 p-2 rounded-md hover:bg-gray-700;
        }
        .sidebar-item.active {
            @apply bg-gray-700 text-white;
        }
        .main-content {
            @apply flex-1 p-6;
        }
        .card {
            @apply bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            @apply w-full p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-500;
        }
        button {
            @apply px-4 py-2 rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-yellow-600 text-white hover:bg-yellow-700 focus:ring-yellow-500;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
        table {
            @apply w-full text-left table-auto;
        }
        th, td {
            @apply px-4 py-2 border-b border-gray-700;
        }
        th {
            @apply bg-gray-700 text-gray-300;
        }
        tr:hover {
            @apply bg-gray-700;
        }
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50;
        }
        .modal-content {
            @apply bg-gray-800 p-8 rounded-lg shadow-xl max-w-lg w-full;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dark .chartjs-tooltip {
            background-color: #1f2937 !important;
            border: 1px solid #4b5563 !important;
            color: #d1d5db !important;
        }
        .dark .chartjs-tooltip-header {
            color: #d1d5db !important;
        }
        .dark .chartjs-tooltip-body {
            color: #d1d5db !important;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body>

<div class="flex h-screen overflow-hidden">
    <div id="sidebar" class="sidebar">
        <div class="text-white text-2xl font-bold px-4 mb-6">CoinShelf</div>
        <nav>
            <a href="#" id="home-link" class="sidebar-item" onclick="showView('content-home'); return false;">
                <i class="ph-fill ph-house text-xl"></i>
                <span>Home</span>
            </a>
            <a href="#" id="dashboard-link" class="sidebar-item" onclick="showView('content-dashboard'); renderDashboardStats(); return false;">
                <i class="ph-fill ph-chart-bar text-xl"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" id="collection-link" class="sidebar-item" onclick="showView('content-collection'); renderCollectionTable(); return false;">
                <i class="ph-fill ph-coin text-xl"></i>
                <span>Collection</span>
            </a>
            <a href="#" id="bullion-link" class="sidebar-item" onclick="showView('content-bullion'); fetchLiveMetalPrices(); renderBullionCollection(); return false;">
                <i class="ph-fill ph-sparkle text-xl"></i>
                <span>Bullion</span>
            </a>
            <a href="#" id="world-map-link" class="sidebar-item" onclick="showView('content-world-map'); drawRegionsMap(); return false;">
                <i class="ph-fill ph-map-pin text-xl"></i>
                <span>World Map</span>
            </a>
            <a href="#" id="missing-countries-link" class="sidebar-item" onclick="showView('content-missing-countries'); renderMissingCountries(); return false;">
                <i class="ph-fill ph-question text-xl"></i>
                <span>Missing Countries</span>
            </a>
            <a href="#" id="account-settings-link" class="sidebar-item" onclick="showView('content-account-settings'); fetchPublicUrl(); return false;">
                <i class="ph-fill ph-gear text-xl"></i>
                <span>Account Settings</span>
            </a>
        </nav>
        <div class="absolute bottom-0 left-0 w-full p-4">
            <button id="quick-add-btn" class="btn-primary w-full mb-2" onclick="showModal('add-item-modal');">Quick Add Item</button>
            <button id="import-data-btn" class="btn-secondary w-full mb-2" onclick="showModal('import-modal');">Import Data</button>
            <button id="export-data-btn" class="btn-secondary w-full mb-2" onclick="showModal('export-modal');">Export Data</button>
            <button id="clear-all-btn" class="btn-danger w-full mb-2" onclick="showModal('clear-all-modal');">Clear All Items</button>
            <button id="share-collection-btn" class="btn-secondary w-full" onclick="showModal('public-link-modal');">Share Collection</button>
        </div>
    </div>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-gray-800 p-4 flex justify-between items-center shadow-md">
            <button id="sidebar-toggle" class="text-gray-400 focus:outline-none md:hidden">
                <i class="ph-bold ph-list text-2xl"></i>
            </button>
            <h1 class="text-white text-3xl font-extrabold tracking-tight">CoinShelf</h1>
            <div id="auth-buttons" class="space-x-4">
                <button id="signin-btn" class="btn-secondary" onclick="showView('content-signin'); return false;">Sign In</button>
                <button id="signup-btn" class="btn-primary" onclick="showView('content-signup'); return false;">Sign Up</button>
                <button id="logout-btn" class="btn-danger hidden" onclick="logout(); return false;">Sign Out</button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 bg-gray-900">
            <section id="content-home" class="view">
                <div class="container text-center py-16">
                    <h2 class="text-5xl font-extrabold text-white mb-6">Welcome to CoinShelf</h2>
                    <p class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto">Your personal digital vault for managing and exploring your precious coin and banknote collection. Organize your treasures, track their value, and discover new countries to collect!</p>
                    <p class="text-md text-gray-400 mb-10">Crafted with passion by Oscar Brimelow.</p>
                    <div class="space-x-4">
                        <a href="https://www.instagram.com/oscarbrimelow/" target="_blank" class="text-yellow-400 hover:text-yellow-300 text-lg">Follow on Instagram</a>
                    </div>
                    <div class="mt-12 space-x-4">
                        <button class="btn-primary text-lg px-8 py-4" onclick="showView('content-signup');">Get Started - Sign Up</button>
                        <button class="btn-secondary text-lg px-8 py-4" onclick="showView('content-dashboard');">Learn More (Go to Dashboard)</button>
                    </div>
                </div>
            </section>

            <section id="content-dashboard" class="view hidden fade-in">
                <h2 class="text-3xl font-bold text-white mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Items</p>
                            <p id="dashboard-total-items" class="text-white text-3xl font-bold">0</p>
                        </div>
                        <i class="ph-fill ph-coins text-5xl text-yellow-500"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Value</p>
                            <p id="dashboard-total-value" class="text-white text-3xl font-bold">$0.00</p>
                        </div>
                        <i class="ph-fill ph-currency-usd text-5xl text-emerald-500"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Unique Countries</p>
                            <p id="dashboard-unique-countries" class="text-white text-3xl font-bold">0</p>
                        </div>
                        <i class="ph-fill ph-globe-hemisphere-west text-5xl text-blue-500"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold text-gray-300 mb-4">Items by Type</h3>
                        <div style="position: relative; height:320px; width:100%;">
                            <canvas id="chart-by-type" height="320"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold text-gray-300 mb-4">Value by Region</h3>
                        <div style="position: relative; height:320px; width:100%;">
                            <canvas id="chart-by-value-region" height="320"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 mt-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold text-gray-300 mb-4">Value Distribution by Year/Decade</h3>
                        <div style="position: relative; height:320px; width:100%;">
                            <canvas id="chart-value-by-year" height="320"></canvas>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-2xl font-bold text-white mb-4">Collection Highlights</h3>
                    <div id="collection-highlights" class="card">
                        <p>No items in collection yet. Start adding items to see highlights!</p>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-2xl font-bold text-white mb-4">Top 5 Countries by Value</h3>
                    <div id="top-5-countries" class="card">
                        <p>No items in collection yet to determine top countries.</p>
                    </div>
                </div>
            </section>

            <section id="content-collection" class="view hidden fade-in">
                <h2 class="text-3xl font-bold text-white mb-6">Your Collection</h2>
                <button class="btn-primary mb-4" onclick="showModal('add-item-modal');">Add New Item</button>
                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-700">
                    <table id="collection-table" class="min-w-full">
                        <thead>
                            <tr>
                                <th class="w-1/12">ID</th>
                                <th class="w-1/12">Type</th>
                                <th class="w-2/12">Country</th>
                                <th class="w-1/12">Year</th>
                                <th class="w-1/12">Denomination</th>
                                <th class="w-1/12">Value (USD)</th>
                                <th class="w-2/12">Notes & Ref.</th>
                                <th class="w-2/12">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="collection-table-body">
                            <tr>
                                <td colspan="8" class="text-center py-4 text-gray-400">No items in your collection yet. Add some!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="content-bullion" class="view hidden fade-in">
                <h2 class="text-3xl font-bold text-white mb-6">Your Bullion Collection</h2>

                <div class="card mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Current Live Metal Prices</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-400 text-sm">Gold Price (USD/gram)</p>
                            <p id="gold-price" class="text-white text-2xl font-bold">Loading...</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">Silver Price (USD/gram)</p>
                            <p id="silver-price" class="text-white text-2xl font-bold">Loading...</p>
                        </div>
                    </div>
                    <p class="text-gray-500 text-xs mt-2">Prices updated every 5 minutes from a free API.</p>
                </div>

                <button class="btn-primary mb-4" onclick="showModal('add-item-modal'); showBullionTypeFields();">Add New Bullion Item</button>
                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-700">
                    <table id="bullion-collection-table" class="min-w-full">
                        <thead>
                            <tr>
                                <th class="w-1/12">ID</th>
                                <th class="w-1/12">Type</th>
                                <th class="w-1/12">Weight (g)</th>
                                <th class="w-1/12">Purity (%)</th>
                                <th class="w-1/12">Year</th>
                                <th class="w-2/12">Calculated Value (USD)</th>
                                <th class="w-2/12">Name/Notes</th>
                                <th class="w-2/12">Reference Link</th>
                                <th class="w-1/12">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bullion-collection-table-body">
                            <tr>
                                <td colspan="9" class="text-center py-4 text-gray-400">No bullion items in your collection yet. Add some!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="content-world-map" class="view hidden fade-in">
                <h2 class="text-3xl font-bold text-white mb-6">World Map of Your Collection</h2>
                <div id="regions-chart" class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700" style="width: 100%; height: 500px;"></div>

                <div id="country-details-modal" class="modal hidden">
                    <div class="modal-content">
                        <h3 id="country-details-title" class="text-2xl font-bold text-white mb-4"></h3>
                        <p class="text-gray-300 mb-4"><span id="country-details-items"></span> items from this country.</p>
                        <div class="overflow-x-auto rounded-lg shadow-md border border-gray-700">
                            <table class="min-w-full">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Year</th>
                                        <th>Denomination</th>
                                        <th>Value</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="country-details-table-body">
                                    </tbody>
                            </table>
                        </div>
                        <button class="btn-secondary mt-4" onclick="closeModal('country-details-modal');">Close</button>
                    </div>
                </div>
            </section>

            <section id="content-missing-countries" class="view hidden fade-in">
                <h2 class="text-3xl font-bold text-white mb-6">Countries to Collect</h2>
                <div id="missing-countries-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-400 col-span-full">Loading missing countries...</p>
                </div>
            </section>

            <section id="content-account-settings" class="view hidden fade-in">
                <h2 class="text-3xl font-bold text-white mb-6">Account Settings</h2>

                <div class="card mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Change Password</h3>
                    <p id="password-change-message" class="text-red-400 text-sm mb-4"></p>
                    <div class="space-y-4">
                        <div>
                            <label for="current-password" class="block text-gray-400 text-sm font-bold mb-2">Current Password:</label>
                            <input type="password" id="current-password" placeholder="Enter current password">
                        </div>
                        <div>
                            <label for="new-password" class="block text-gray-400 text-sm font-bold mb-2">New Password:</label>
                            <input type="password" id="new-password" placeholder="Enter new password">
                        </div>
                        <div>
                            <label for="confirm-new-password" class="block text-gray-400 text-sm font-bold mb-2">Confirm New Password:</label>
                            <input type="password" id="confirm-new-password" placeholder="Confirm new password">
                        </div>
                        <button class="btn-primary" onclick="changePassword();">Update Password</button>
                    </div>
                </div>

                <div class="card mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Theme Preference</h3>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="theme" value="dark" class="form-radio text-yellow-500" checked>
                            <span class="ml-2 text-gray-300">Dark Mode</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="theme" value="light" class="form-radio text-yellow-500">
                            <span class="ml-2 text-gray-300">Light Mode</span>
                        </label>
                    </div>
                </div>

                <div class="card mb-6">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Public Collection Link</h3>
                    <p class="text-gray-400 text-sm mb-2">Share a read-only view of your collection with others. Generate a unique URL below.</p>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="public-collection-url" class="flex-1" readonly placeholder="Your public collection URL will appear here">
                        <button class="btn-secondary" onclick="copyPublicUrl();">Copy</button>
                    </div>
                    <p id="public-url-status" class="text-sm mt-2 text-red-400"></p>
                    <div class="mt-4 space-x-2">
                        <button class="btn-primary" onclick="generatePublicLink();">Generate/Update Public Link</button>
                        <button class="btn-danger" onclick="revokePublicLink();">Revoke Public Link</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-bold text-gray-300 mb-4">Danger Zone</h3>
                    <button class="btn-danger" onclick="showModal('clear-all-modal');">Delete All Collection Data</button>
                </div>
            </section>

            <section id="content-signin" class="view hidden fade-in">
                <div class="max-w-md mx-auto card">
                    <h2 class="text-3xl font-bold text-white mb-6 text-center">Sign In</h2>
                    <p id="signin-message" class="text-red-400 text-sm mb-4 text-center"></p>
                    <div class="space-y-4">
                        <div>
                            <label for="signin-email" class="block text-gray-400 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="signin-email" placeholder="your@example.com">
                        </div>
                        <div>
                            <label for="signin-password" class="block text-gray-400 text-sm font-bold mb-2">Password:</label>
                            <input type="password" id="signin-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <button class="btn-primary w-full" onclick="signIn();">Sign In</button>
                    </div>
                    <p class="text-center text-gray-400 text-sm mt-4">Don't have an account? <a href="#" onclick="showView('content-signup'); return false;" class="text-yellow-400 hover:underline">Sign Up</a></p>
                </div>
            </section>

            <section id="content-signup" class="view hidden fade-in">
                <div class="max-w-md mx-auto card">
                    <h2 class="text-3xl font-bold text-white mb-6 text-center">Sign Up</h2>
                    <p id="signup-message" class="text-red-400 text-sm mb-4 text-center"></p>
                    <div class="space-y-4">
                        <div>
                            <label for="signup-email" class="block text-gray-400 text-sm font-bold mb-2">Email:</label>
                            <input type="email" id="signup-email" placeholder="your@example.com">
                        </div>
                        <div>
                            <label for="signup-password" class="block text-gray-400 text-sm font-bold mb-2">Password:</label>
                            <input type="password" id="signup-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <div>
                            <label for="signup-confirm-password" class="block text-gray-400 text-sm font-bold mb-2">Confirm Password:</label>
                            <input type="password" id="signup-confirm-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <button class="btn-primary w-full" onclick="signUp();">Sign Up</button>
                    </div>
                    <p class="text-center text-gray-400 text-sm mt-4">Already have an account? <a href="#" onclick="showView('content-signin'); return false;" class="text-yellow-400 hover:underline">Sign In</a></p>
                </div>
            </section>

            <section id="content-public-collection" class="view hidden fade-in">
                <h2 id="public-collection-title" class="text-3xl font-bold text-white mb-6">Public Collection</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Items</p>
                            <p id="public-total-items" class="text-white text-3xl font-bold">0</p>
                        </div>
                        <i class="ph-fill ph-coins text-5xl text-yellow-500"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Value</p>
                            <p id="public-total-value" class="text-white text-3xl font-bold">$0.00</p>
                        </div>
                        <i class="ph-fill ph-currency-usd text-5xl text-emerald-500"></i>
                    </div>
                    <div class="card flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Unique Countries</p>
                            <p id="public-unique-countries" class="text-white text-3xl font-bold">0</p>
                        </div>
                        <i class="ph-fill ph-globe-hemisphere-west text-5xl text-blue-500"></i>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-700">
                    <table id="public-collection-table" class="min-w-full">
                        <thead>
                            <tr>
                                <th class="w-1/12">Type</th>
                                <th class="w-2/12">Country</th>
                                <th class="w-1/12">Year</th>
                                <th class="w-1/12">Denomination</th>
                                <th class="w-1/12">Value (USD)</th>
                                <th class="w-2/12">Notes & Ref.</th>
                            </tr>
                        </thead>
                        <tbody id="public-collection-table-body">
                            <tr>
                                <td colspan="6" class="text-center py-4 text-gray-400">Loading public collection...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>
</div>

<div id="add-item-modal" class="modal hidden fade-in">
    <div class="modal-content">
        <h3 id="item-modal-title" class="text-2xl font-bold text-white mb-4">Add New Item</h3>
        <p id="item-modal-message" class="text-red-400 text-sm mb-4"></p>
        <form id="item-form" class="space-y-4">
            <div>
                <label for="item-type" class="block text-gray-400 text-sm font-bold mb-2">Type:</label>
                <select id="item-type" required onchange="toggleBullionFields();">
                    <option value="Coin">Coin</option>
                    <option value="Banknote">Banknote</option>
                    <option value="Gold Bullion">Gold Bullion</option>
                    <option value="Silver Bullion">Silver Bullion</option>
                </select>
            </div>
            <div id="bullion-fields" class="hidden space-y-4">
                <div>
                    <label for="item-weight" class="block text-gray-400 text-sm font-bold mb-2">Weight (grams):</label>
                    <input type="number" id="item-weight" step="0.01" placeholder="e.g., 31.1">
                </div>
                <div>
                    <label for="item-purity" class="block text-gray-400 text-sm font-bold mb-2">Purity (%):</label>
                    <input type="number" id="item-purity" step="0.01" min="0" max="100" placeholder="e.g., 99.99">
                </div>
                <div class="flex items-center justify-between bg-gray-700 p-3 rounded-md">
                    <label class="block text-gray-400 text-sm font-bold">Calculated Bullion Value:</label>
                    <span id="calculated-bullion-value" class="text-white font-bold">$0.00</span>
                </div>
            </div>
            <div>
                <label for="item-country" class="block text-gray-400 text-sm font-bold mb-2">Country:</label>
                <input type="text" id="item-country" placeholder="e.g., United States" list="country-suggestions" required>
                <datalist id="country-suggestions"></datalist>
            </div>
            <div>
                <label for="item-year" class="block text-gray-400 text-sm font-bold mb-2">Year:</label>
                <input type="number" id="item-year" placeholder="e.g., 1900">
            </div>
            <div>
                <label for="item-denomination" class="block text-gray-400 text-sm font-bold mb-2">Denomination:</label>
                <input type="text" id="item-denomination" placeholder="e.g., 1 Dollar">
            </div>
            <div id="manual-value-field">
                <label for="item-value" class="block text-gray-400 text-sm font-bold mb-2">Estimated Value (USD):</label>
                <input type="number" id="item-value" step="0.01" placeholder="e.g., 150.00">
            </div>
            <div>
                <label for="item-notes" class="block text-gray-400 text-sm font-bold mb-2">Notes:</label>
                <textarea id="item-notes" rows="3" placeholder="e.g., Rare variety, good condition"></textarea>
            </div>
            <div>
                <label for="item-reference" class="block text-gray-400 text-sm font-bold mb-2">Reference URL (eBay, etc.):</label>
                <input type="url" id="item-reference" placeholder="https://www.ebay.com/itm/...">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="btn-secondary" onclick="closeModal('add-item-modal');">Cancel</button>
                <button type="submit" class="btn-primary">Save Item</button>
            </div>
        </form>
    </div>
</div>

<div id="import-modal" class="modal hidden fade-in">
    <div class="modal-content">
        <h3 class="text-2xl font-bold text-white mb-4">Import Collection Data</h3>
        <p class="text-gray-400 text-sm mb-4">Paste your coin collection data as a JSON array below. Ensure it's correctly formatted.</p>
        <textarea id="import-json-data" class="w-full h-48 p-3 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder='[{"type": "Coin", "country": "USA", ...}]'></textarea>
        <p id="import-message" class="text-red-400 text-sm mt-2"></p>
        <div class="flex justify-end space-x-2 mt-4">
            <button class="btn-secondary" onclick="closeModal('import-modal');">Cancel</button>
            <button class="btn-primary" onclick="importCollection();">Upload & Import</button>
        </div>
    </div>
</div>

<div id="export-modal" class="modal hidden fade-in">
    <div class="modal-content">
        <h3 class="text-2xl font-bold text-white mb-4">Export Collection Data</h3>
        <p class="text-gray-400 text-sm mb-4">Choose your desired export format:</p>
        <div class="flex justify-center space-x-4 mt-4">
            <button class="btn-primary" onclick="exportCollection('json');">Export as JSON</button>
            <button class="btn-primary" onclick="exportCollection('csv');">Export as CSV</button>
            <button class="btn-primary" onclick="exportCollection('print');">Print Report</button>
        </div>
        <div class="flex justify-end mt-6">
            <button class="btn-secondary" onclick="closeModal('export-modal');">Cancel</button>
        </div>
    </div>
</div>

<div id="clear-all-modal" class="modal hidden fade-in">
    <div class="modal-content">
        <h3 class="text-2xl font-bold text-white mb-4">CONFIRM CLEAR ALL DATA</h3>
        <p class="text-red-400 text-sm mb-4">This action will permanently delete ALL your coin collection data. To proceed, please type "CLEARYES" into the box below.</p>
        <input type="text" id="clear-confirm-input" placeholder="Type CLEARYES to confirm">
        <p id="clear-confirm-message" class="text-red-400 text-sm mt-2"></p>
        <div class="flex justify-end space-x-2 mt-4">
            <button class="btn-secondary" onclick="closeModal('clear-all-modal');">Cancel</button>
            <button class="btn-danger" onclick="confirmClearAllData();">Delete All Data</button>
        </div>
    </div>
</div>

<div id="custom-confirm-modal" class="modal hidden fade-in">
    <div class="modal-content">
        <p id="custom-confirm-message" class="text-lg text-white mb-4 text-center"></p>
        <div class="flex justify-center space-x-4">
            <button class="btn-primary" onclick="closeCustomConfirm();">OK</button>
        </div>
    </div>
</div>

<div id="public-link-modal" class="modal hidden fade-in">
    <div class="modal-content">
        <h3 class="text-2xl font-bold text-white mb-4">Public Collection Link</h3>
        <p class="text-gray-400 text-sm mb-2">Share a read-only view of your collection with others. Generate a unique URL below.</p>
        <div class="flex items-center space-x-2">
            <input type="text" id="modal-public-collection-url" class="flex-1" readonly placeholder="Your public collection URL will appear here">
            <button class="btn-secondary" onclick="copyPublicUrl();">Copy</button>
        </div>
        <p id="modal-public-url-status" class="text-sm mt-2 text-red-400"></p>
        <div class="mt-4 space-x-2 flex justify-end">
            <button class="btn-primary" onclick="generatePublicLink();">Generate/Update Link</button>
            <button class="btn-danger" onclick="revokePublicLink();">Revoke Link</button>
            <button class="btn-secondary" onclick="closeModal('public-link-modal');">Close</button>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://127.0.0.1:5000/api'; // Replace with your Render.com backend URL in production
    let collectionData = []; // Array to hold coin/banknote/bullion data
    let currentEditItemId = null; // To keep track of the item being edited
    let metalPrices = { gold: 0, silver: 0 }; // Store fetched metal prices

    // --- HELPER FUNCTIONS ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => {
            view.classList.add('hidden');
            view.classList.remove('fade-in');
        });
        document.getElementById(viewId).classList.remove('hidden');
        document.getElementById(viewId).classList.add('fade-in');

        // Update active sidebar link
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.classList.remove('active');
        });
        const activeLink = document.querySelector(`#${viewId.replace('content-', '')}-link`);
        if (activeLink) {
            activeLink.classList.add('active');
        }

        // Hide sidebar on mobile after clicking a link
        if (window.innerWidth < 768) { // Assuming md breakpoint is 768px
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }
    }

    function showModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        // Clear add/edit item form fields on close
        if (modalId === 'add-item-modal') {
            document.getElementById('item-form').reset();
            currentEditItemId = null;
            document.getElementById('item-modal-title').innerText = 'Add New Item';
            document.getElementById('item-modal-message').innerText = '';
            toggleBullionFields(); // Hide bullion fields
        } else if (modalId === 'import-modal') {
            document.getElementById('import-json-data').value = '';
            document.getElementById('import-message').innerText = '';
        } else if (modalId === 'clear-all-modal') {
            document.getElementById('clear-confirm-input').value = '';
            document.getElementById('clear-confirm-message').innerText = '';
        } else if (modalId === 'public-link-modal') {
            fetchPublicUrl(); // Refresh public URL status
        }
    }

    function showCustomConfirm(message, callback) {
        const modal = document.getElementById('custom-confirm-modal');
        document.getElementById('custom-confirm-message').innerText = message;
        modal.classList.remove('hidden');
        modal.callback = callback; // Attach callback to the modal element
    }

    function closeCustomConfirm() {
        const modal = document.getElementById('custom-confirm-modal');
        modal.classList.add('hidden');
        if (modal.callback) {
            modal.callback(); // Execute the stored callback
            modal.callback = null; // Clear the callback
        }
    }

    // Authentication
    function getAuthToken() {
        return localStorage.getItem('authToken');
    }

    function setAuthToken(token) {
        localStorage.setItem('authToken', token);
        updateAuthUI(true);
    }

    function removeAuthToken() {
        localStorage.removeItem('authToken');
        updateAuthUI(false);
    }

    function isAuthenticated() {
        return !!getAuthToken();
    }

    function updateAuthUI(loggedIn) {
        const authButtons = document.getElementById('auth-buttons');
        const signInBtn = document.getElementById('signin-btn');
        const signUpBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');

        if (loggedIn) {
            signInBtn.classList.add('hidden');
            signUpBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            // Show authenticated sections
            document.querySelectorAll('.view').forEach(view => {
                if (!view.id.includes('public-collection')) { // Keep public view hidden unless accessed directly
                    view.classList.add('hidden');
                }
            });
            showView('content-dashboard'); // Default to dashboard on login
            // Update quick action buttons visibility
            document.getElementById('quick-add-btn').classList.remove('hidden');
            document.getElementById('import-data-btn').classList.remove('hidden');
            document.getElementById('export-data-btn').classList.remove('hidden');
            document.getElementById('clear-all-btn').classList.remove('hidden');
            document.getElementById('share-collection-btn').classList.remove('hidden');

        } else {
            signInBtn.classList.remove('hidden');
            signUpBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            // Hide authenticated sections, show home
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            showView('content-home');
            // Update quick action buttons visibility
            document.getElementById('quick-add-btn').classList.add('hidden');
            document.getElementById('import-data-btn').classList.add('hidden');
            document.getElementById('export-data-btn').classList.add('hidden');
            document.getElementById('clear-all-btn').classList.add('hidden');
            document.getElementById('share-collection-btn').classList.add('hidden');
        }
    }

    async function signIn() {
        const email = document.getElementById('signin-email').value;
        const password = document.getElementById('signin-password').value;
        const messageDiv = document.getElementById('signin-message');
        messageDiv.innerText = '';

        if (!email || !password) {
            messageDiv.innerText = 'Please enter both email and password.';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Login failed.');
            }

            const result = await response.json();
            setAuthToken(result.access_token);
            await loadCollectionFromBackend();
            showCustomConfirm('Signed in successfully!', () => {});
        } catch (error) {
            console.error("Sign-in error:", error.message);
            showCustomConfirm(`Sign-in failed: ${error.message}`, () => {});
        }
    }

    async function signUp() {
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;
        const messageDiv = document.getElementById('signup-message');
        messageDiv.innerText = '';

        if (!email || !password || !confirmPassword) {
            messageDiv.innerText = 'Please fill in all fields.';
            return;
        }
        if (password !== confirmPassword) {
            messageDiv.innerText = 'Passwords do not match.';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Registration failed.');
            }

            const result = await response.json();
            showCustomConfirm('Account created successfully! Please sign in.', () => {
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
                document.getElementById('signup-confirm-password').value = '';
                showView('content-signin');
            });
        } catch (error) {
            console.error("Sign-up error:", error.message);
            showCustomConfirm(`Sign-up failed: ${error.message}`, () => {});
        }
    }

    function logout() {
        removeAuthToken();
        collectionData = []; // Clear data when logged out
        history.replaceState(null, '', window.location.pathname); // Clear public URL param on logout
        renderAllViews();
        showCustomConfirm('Signed out successfully!', () => {});
    }

    // --- CRUD OPERATIONS ---
    async function loadCollectionFromBackend() {
        if (!isAuthenticated()) {
            collectionData = [];
            renderAllViews();
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/collection`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    showCustomConfirm('Session expired or invalid. Please sign in again.', () => { removeAuthToken(); });
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            collectionData = await response.json();
            renderAllViews();
            console.log('Collection loaded:', collectionData);
        } catch (error) {
            console.error("Error loading collection:", error);
            showCustomConfirm(`Failed to load collection: ${error.message}`, () => {});
        }
    }

    async function addOrUpdateItem(event) {
        event.preventDefault(); // Prevent default form submission
        const messageDiv = document.getElementById('item-modal-message');
        messageDiv.innerText = '';

        if (!isAuthenticated()) {
            messageDiv.innerText = 'You must be logged in to add or edit items.';
            return;
        }

        const itemType = document.getElementById('item-type').value;
        const country = document.getElementById('item-country').value;
        const year = document.getElementById('item-year').value;
        const denomination = document.getElementById('item-denomination').value;
        let value = parseFloat(document.getElementById('item-value').value);
        const notes = document.getElementById('item-notes').value;
        const reference = document.getElementById('item-reference').value;
        const weight = parseFloat(document.getElementById('item-weight').value);
        const purity = parseFloat(document.getElementById('item-purity').value);

        if (!itemType || !country) {
            messageDiv.innerText = 'Type and Country are required fields.';
            return;
        }

        let item = {
            type: itemType,
            country: country,
            year: year ? parseInt(year) : null,
            denomination: denomination,
            notes: notes,
            reference_link: reference
        };

        if (itemType === 'Gold Bullion' || itemType === 'Silver Bullion') {
            if (isNaN(weight) || isNaN(purity) || purity < 0 || purity > 100) {
                messageDiv.innerText = 'For bullion, weight and purity (0-100%) are required.';
                return;
            }
            item.weight_grams = weight;
            item.purity_percent = purity;
            // Calculate value based on live prices
            if (itemType === 'Gold Bullion' && metalPrices.gold > 0) {
                item.value = (weight * (purity / 100) * metalPrices.gold).toFixed(2);
            } else if (itemType === 'Silver Bullion' && metalPrices.silver > 0) {
                item.value = (weight * (purity / 100) * metalPrices.silver).toFixed(2);
            } else {
                item.value = value ? value.toFixed(2) : null; // Fallback to manual if no live price
                showCustomConfirm("Live metal prices not available, using estimated value if provided.", () => {});
            }
        } else {
            if (isNaN(value)) {
                messageDiv.innerText = 'Estimated Value (USD) is required for Coin/Banknote.';
                return;
            }
            item.value = value.toFixed(2);
        }

        const method = currentEditItemId ? 'PUT' : 'POST';
        const url = currentEditItemId ? `${API_BASE_URL}/collection/${currentEditItemId}` : `${API_BASE_URL}/collection`;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(item)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to save item.');
            }

            await loadCollectionFromBackend(); // Reload collection to update UI
            closeModal('add-item-modal');
            showCustomConfirm(`Item ${currentEditItemId ? 'updated' : 'added'} successfully!`, () => {});
        } catch (error) {
            console.error("Save item error:", error.message);
            messageDiv.innerText = `Error: ${error.message}`;
        }
    }

    async function editItem(itemId) {
        currentEditItemId = itemId;
        const item = collectionData.find(i => i.id === itemId);
        if (item) {
            document.getElementById('item-modal-title').innerText = 'Edit Item';
            document.getElementById('item-type').value = item.type;
            document.getElementById('item-country').value = item.country;
            document.getElementById('item-year').value = item.year || '';
            document.getElementById('item-denomination').value = item.denomination || '';
            document.getElementById('item-value').value = item.value || '';
            document.getElementById('item-notes').value = item.notes || '';
            document.getElementById('item-reference').value = item.reference_link || '';

            // Handle bullion specific fields
            if (item.type === 'Gold Bullion' || item.type === 'Silver Bullion') {
                document.getElementById('item-weight').value = item.weight_grams || '';
                document.getElementById('item-purity').value = item.purity_percent || '';
                toggleBullionFields(true); // Show bullion fields
                updateCalculatedBullionValue();
            } else {
                toggleBullionFields(false); // Hide bullion fields
            }
            showModal('add-item-modal');
        }
    }

    async function deleteItem(itemId) {
        if (!isAuthenticated()) {
            showCustomConfirm('You must be logged in to delete items.', () => {});
            return;
        }

        if (!confirm('Are you sure you want to delete this item?')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/collection/${itemId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete item.');
            }

            await loadCollectionFromBackend(); // Reload collection to update UI
            showCustomConfirm('Item deleted successfully!', () => {});
        } catch (error) {
            console.error("Delete item error:", error.message);
            showCustomConfirm(`Failed to delete item: ${error.message}`, () => {});
        }
    }

    async function importCollection() {
        const jsonData = document.getElementById('import-json-data').value;
        const messageDiv = document.getElementById('import-message');
        messageDiv.innerText = '';

        if (!isAuthenticated()) {
            messageDiv.innerText = 'You must be logged in to import data.';
            return;
        }

        try {
            const items = JSON.parse(jsonData);
            if (!Array.isArray(items)) {
                throw new Error('Invalid JSON format. Expected an array of items.');
            }

            const response = await fetch(`${API_BASE_URL}/collection/import`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify(items)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to import data.');
            }

            await loadCollectionFromBackend();
            closeModal('import-modal');
            showCustomConfirm('Collection imported successfully!', () => {});
        } catch (error) {
            console.error("Import error:", error.message);
            messageDiv.innerText = `Error: ${error.message}`;
        }
    }

    function exportCollection(format) {
        if (!isAuthenticated()) {
            showCustomConfirm('You must be logged in to export data.', () => {});
            return;
        }

        if (collectionData.length === 0) {
            showCustomConfirm('No data to export.', () => {});
            return;
        }

        let data, filename, mimeType;

        if (format === 'json') {
            data = JSON.stringify(collectionData, null, 2);
            filename = 'collection.json';
            mimeType = 'application/json';
        } else if (format === 'csv') {
            // Basic CSV conversion for demonstration; might need more robust handling
            const headers = Object.keys(collectionData[0]).join(',');
            const rows = collectionData.map(item => Object.values(item).join(','));
            data = `${headers}\n${rows.join('\n')}`;
            filename = 'collection.csv';
            mimeType = 'text/csv';
        } else if (format === 'print') {
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>CoinShelf Collection Report</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: sans-serif; margin: 20px; }');
            printWindow.document.write('h1 { text-align: center; margin-bottom: 20px; }');
            printWindow.document.write('table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }');
            printWindow.document.write('th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }');
            printWindow.document.write('th { background-color: #f2f2f2; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>CoinShelf Collection Report</h1>');
            printWindow.document.write('<p><strong>Total Items:</strong> ' + collectionData.length + '</p>');
            printWindow.document.write('<p><strong>Total Value:</strong> $' + collectionData.reduce((sum, item) => sum + (item.value || 0), 0).toFixed(2) + '</p>');
            printWindow.document.write('<table><thead><tr>');
            // Dynamically add headers based on available keys
            const allKeys = new Set();
            collectionData.forEach(item => {
                Object.keys(item).forEach(key => allKeys.add(key));
            });
            const orderedKeys = Array.from(allKeys).sort((a, b) => {
                const order = ['id', 'type', 'country', 'year', 'denomination', 'weight_grams', 'purity_percent', 'value', 'notes', 'reference_link']; // Define preferred order
                return order.indexOf(a) - order.indexOf(b);
            });
            orderedKeys.forEach(key => printWindow.document.write(`<th>${key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</th>`));
            printWindow.document.write('</tr></thead><tbody>');
            collectionData.forEach(item => {
                printWindow.document.write('<tr>');
                orderedKeys.forEach(key => {
                    let displayValue = item[key] !== undefined && item[key] !== null ? item[key] : '';
                    if (key === 'value' && displayValue !== '') {
                        displayValue = `$${parseFloat(displayValue).toFixed(2)}`;
                    } else if (key === 'purity_percent' && displayValue !== '') {
                        displayValue = `${parseFloat(displayValue).toFixed(2)}%`;
                    } else if (key === 'reference_link' && displayValue !== '') {
                         displayValue = `<a href="${displayValue}" target="_blank" class="text-blue-600 hover:underline">Link</a>`;
                    }
                    printWindow.document.write(`<td>${displayValue}</td>`);
                });
                printWindow.document.write('</tr>');
            });
            printWindow.document.write('</tbody></table></body></html>');
            printWindow.document.close();
            printWindow.print();
            closeModal('export-modal');
            return;
        }

        const blob = new Blob([data], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        closeModal('export-modal');
        showCustomConfirm(`Collection exported as ${filename}!`, () => {});
    }

    async function confirmClearAllData() {
        const confirmInput = document.getElementById('clear-confirm-input').value;
        const messageDiv = document.getElementById('clear-confirm-message');
        messageDiv.innerText = '';

        if (!isAuthenticated()) {
            messageDiv.innerText = 'You must be logged in to clear data.';
            return;
        }

        if (confirmInput !== 'CLEARYES') {
            messageDiv.innerText = 'Please type "CLEARYES" to confirm.';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/collection/clear`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to clear all data.');
            }

            collectionData = []; // Clear local data
            renderAllViews();
            closeModal('clear-all-modal');
            showCustomConfirm('All collection data has been deleted.', () => {});
        } catch (error) {
            console.error("Clear all data error:", error.message);
            messageDiv.innerText = `Error: ${error.message}`;
        }
    }

    // --- RENDERING FUNCTIONS ---
    function renderAllViews() {
        renderDashboardStats();
        renderCollectionTable();
        renderBullionCollection(); // Render bullion
        drawRegionsMap(); // Update world map
        renderMissingCountries(); // Update missing countries
    }

    function renderCollectionTable() {
        const tableBody = document.getElementById('collection-table-body');
        tableBody.innerHTML = ''; // Clear existing rows

        const nonBullionItems = collectionData.filter(item => item.type !== 'Gold Bullion' && item.type !== 'Silver Bullion');

        if (nonBullionItems.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-400">No coin or banknote items in your collection yet. Add some!</td></tr>';
            return;
        }

        nonBullionItems.forEach(item => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.type}</td>
                <td>${item.country}</td>
                <td>${item.year || ''}</td>
                <td>${item.denomination || ''}</td>
                <td>$${parseFloat(item.value || 0).toFixed(2)}</td>
                <td>${item.notes || ''} ${item.reference_link ? `<a href="${item.reference_link}" target="_blank" class="text-blue-400 hover:underline">Ref</a>` : ''}</td>
                <td class="whitespace-nowrap">
                    <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editItem(${item.id})">
                        <i class="ph-fill ph-pencil-simple text-xl"></i>
                    </button>
                    <button class="text-red-400 hover:text-red-300" onclick="deleteItem(${item.id})">
                        <i class="ph-fill ph-trash text-xl"></i>
                    </button>
                </td>
            `;
        });
    }

    function renderBullionCollection() {
        const tableBody = document.getElementById('bullion-collection-table-body');
        tableBody.innerHTML = ''; // Clear existing rows

        const bullionItems = collectionData.filter(item => item.type === 'Gold Bullion' || item.type === 'Silver Bullion');

        if (bullionItems.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-400">No bullion items in your collection yet. Add some!</td></tr>';
            return;
        }

        bullionItems.forEach(item => {
            let calculatedValue = 0;
            if (item.type === 'Gold Bullion' && metalPrices.gold > 0) {
                calculatedValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.gold);
            } else if (item.type === 'Silver Bullion' && metalPrices.silver > 0) {
                calculatedValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.silver);
            } else {
                calculatedValue = item.value || 0; // Fallback to stored value if live prices not available
            }

            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.type}</td>
                <td>${item.weight_grams ? item.weight_grams.toFixed(2) : ''} g</td>
                <td>${item.purity_percent ? item.purity_percent.toFixed(2) : ''}%</td>
                <td>${item.year || ''}</td>
                <td>$${calculatedValue.toFixed(2)}</td>
                <td>${item.notes || ''}</td>
                <td>${item.reference_link ? `<a href="${item.reference_link}" target="_blank" class="text-blue-400 hover:underline">Link</a>` : ''}</td>
                <td class="whitespace-nowrap">
                    <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editItem(${item.id})">
                        <i class="ph-fill ph-pencil-simple text-xl"></i>
                    </button>
                    <button class="text-red-400 hover:text-red-300" onclick="deleteItem(${item.id})">
                        <i class="ph-fill ph-trash text-xl"></i>
                    </button>
                </td>
            `;
        });
    }

    function renderDashboardStats() {
        const totalItems = collectionData.length;
        const totalValue = collectionData.reduce((sum, item) => {
            let itemValue = parseFloat(item.value || 0);
            if (item.type === 'Gold Bullion' && metalPrices.gold > 0) {
                itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.gold);
            } else if (item.type === 'Silver Bullion' && metalPrices.silver > 0) {
                itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.silver);
            }
            return sum + itemValue;
        }, 0);
        const uniqueCountries = new Set(collectionData.map(item => item.country)).size;

        document.getElementById('dashboard-total-items').innerText = totalItems;
        document.getElementById('dashboard-total-value').innerText = `$${totalValue.toFixed(2)}`;
        document.getElementById('dashboard-unique-countries').innerText = uniqueCountries;

        // Render additional dashboard content
        renderCollectionHighlights();
        renderTop5Countries();

        // Render Charts
        renderChartByType();
        renderChartByValueRegion();
        renderChartByRegionPie();
        renderChartValueByYear(); // New chart render call
    }

    function renderCollectionHighlights() {
        const highlightsDiv = document.getElementById('collection-highlights');
        if (collectionData.length === 0) {
            highlightsDiv.innerHTML = '<p>No items in collection yet. Start adding items to see highlights!</p>';
            return;
        }

        const oldestItem = collectionData.reduce((oldest, current) => {
            if (current.year && (!oldest || current.year < oldest.year)) {
                return current;
            }
            return oldest;
        }, null);

        const newestItem = collectionData.reduce((newest, current) => {
            if (current.year && (!newest || current.year > newest.year)) {
                return current;
            }
            return newest;
        }, null);

        const highestValueItem = collectionData.reduce((highest, current) => {
            let currentValue = parseFloat(current.value || 0);
            if (current.type === 'Gold Bullion' && metalPrices.gold > 0) {
                currentValue = (current.weight_grams * (current.purity_percent / 100) * metalPrices.gold);
            } else if (current.type === 'Silver Bullion' && metalPrices.silver > 0) {
                currentValue = (current.weight_grams * (current.purity_percent / 100) * metalPrices.silver);
            }

            let highestValue = parseFloat(highest ? (highest.value || 0) : 0);
            if (highest && highest.type === 'Gold Bullion' && metalPrices.gold > 0) {
                highestValue = (highest.weight_grams * (highest.purity_percent / 100) * metalPrices.gold);
            } else if (highest && highest.type === 'Silver Bullion' && metalPrices.silver > 0) {
                highestValue = (highest.weight_grams * (highest.purity_percent / 100) * metalPrices.silver);
            }


            if (currentValue > highestValue) {
                return current;
            }
            return highest;
        }, null);


        let highlightsHtml = '<ul class="list-disc pl-5 space-y-2 text-gray-300">';
        if (oldestItem) {
            highlightsHtml += `<li><strong>Oldest Item:</strong> ${oldestItem.year || 'N/A'} - ${oldestItem.denomination || 'N/A'} from ${oldestItem.country || 'N/A'}</li>`;
        }
        if (newestItem) {
            highlightsHtml += `<li><strong>Newest Item:</strong> ${newestItem.year || 'N/A'} - ${newestItem.denomination || 'N/A'} from ${newestItem.country || 'N/A'}</li>`;
        }
        if (highestValueItem) {
            let highestValueDisplay = highestValueItem.value || 0;
            if (highestValueItem.type === 'Gold Bullion' && metalPrices.gold > 0) {
                highestValueDisplay = (highestValueItem.weight_grams * (highestValueItem.purity_percent / 100) * metalPrices.gold);
            } else if (highestValueItem.type === 'Silver Bullion' && metalPrices.silver > 0) {
                highestValueDisplay = (highestValueItem.weight_grams * (highestValueItem.purity_percent / 100) * metalPrices.silver);
            }
            highlightsHtml += `<li><strong>Highest Value Item:</strong> $${parseFloat(highestValueDisplay).toFixed(2)} - ${highestValueItem.denomination || 'N/A'} from ${highestValueItem.country || 'N/A'} (${highestValueItem.year || 'N/A'})</li>`;
        }
        highlightsHtml += '</ul>';
        highlightsDiv.innerHTML = highlightsHtml;
    }

    function renderTop5Countries() {
        const top5Div = document.getElementById('top-5-countries');
        if (collectionData.length === 0) {
            top5Div.innerHTML = '<p>No items in collection yet to determine top countries.</p>';
            return;
        }

        const countryValues = {};
        collectionData.forEach(item => {
            let itemValue = parseFloat(item.value || 0);
            if (item.type === 'Gold Bullion' && metalPrices.gold > 0) {
                itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.gold);
            } else if (item.type === 'Silver Bullion' && metalPrices.silver > 0) {
                itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.silver);
            }
            countryValues[item.country] = (countryValues[item.country] || 0) + itemValue;
        });

        const sortedCountries = Object.entries(countryValues).sort(([, a], [, b]) => b - a);
        let top5Html = '<ul class="list-decimal pl-5 space-y-2 text-gray-300">';
        sortedCountries.slice(0, 5).forEach(([country, value]) => {
            top5Html += `<li>${country}: $${value.toFixed(2)}</li>`;
        });
        top5Html += '</ul>';
        top5Div.innerHTML = top5Html;
    }

    // Chart.js Instances
    let chartByTypeInstance = null;
    let chartByValueRegionInstance = null;
    let chartValueByYearInstance = null; // New chart instance

    function renderChartByType() {
        const ctx = document.getElementById('chart-by-type').getContext('2d');
        if (chartByTypeInstance) {
            chartByTypeInstance.destroy();
        }

        const itemTypes = {};
        collectionData.forEach(item => {
            itemTypes[item.type] = (itemTypes[item.type] || 0) + 1;
        });

        chartByTypeInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(itemTypes),
                datasets: [{
                    data: Object.values(itemTypes),
                    backgroundColor: ['#FCD34D', '#34D399', '#60A5FA', '#F87171'], // Yellow, Green, Blue, Red
                    borderColor: '#111827',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                    }
                }
            }
        });
    }

    function renderChartByValueRegion() {
        const ctx = document.getElementById('chart-by-value-region').getContext('2d');
        if (chartByValueRegionInstance) {
            chartByValueRegionInstance.destroy();
        }

        const countryValues = {};
        collectionData.forEach(item => {
            let itemValue = parseFloat(item.value || 0);
            if (item.type === 'Gold Bullion' && metalPrices.gold > 0) {
                itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.gold);
            } else if (item.type === 'Silver Bullion' && metalPrices.silver > 0) {
                itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.silver);
            }
            countryValues[item.country] = (countryValues[item.country] || 0) + itemValue;
        });

        const sortedCountries = Object.entries(countryValues).sort(([, a], [, b]) => b - a);
        const top10Countries = sortedCountries.slice(0, 10);

        chartByValueRegionInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top10Countries.map(([country]) => country),
                datasets: [{
                    label: 'Total Value (USD)',
                    data: top10Countries.map(([, value]) => value),
                    backgroundColor: '#60A5FA', // Blue
                    borderColor: '#111827',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#d1d5db'
                        },
                        grid: {
                            color: '#4b5563'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#d1d5db'
                        },
                        grid: {
                            color: '#4b5563'
                        }
                    }
                }
            }
        });
    }

    // New Chart: Value Distribution by Year/Decade
    function renderChartValueByYear() {
        const ctx = document.getElementById('chart-value-by-year').getContext('2d');
        if (chartValueByYearInstance) {
            chartValueByYearInstance.destroy();
        }

        const yearValues = {};
        collectionData.forEach(item => {
            if (item.year) {
                const decade = Math.floor(item.year / 10) * 10;
                let itemValue = parseFloat(item.value || 0);
                if (item.type === 'Gold Bullion' && metalPrices.gold > 0) {
                    itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.gold);
                } else if (item.type === 'Silver Bullion' && metalPrices.silver > 0) {
                    itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.silver);
                }
                yearValues[decade] = (yearValues[decade] || 0) + itemValue;
            }
        });

        // Sort by year/decade
        const sortedYears = Object.keys(yearValues).sort((a, b) => parseInt(a) - parseInt(b));
        const sortedValues = sortedYears.map(year => yearValues[year]);

        chartValueByYearInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedYears.map(year => `${year}s`),
                datasets: [{
                    label: 'Total Value (USD)',
                    data: sortedValues,
                    backgroundColor: '#FCD34D', // Yellow
                    borderColor: '#111827',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        position: 'nearest',
                        backgroundColor: '#1f2937',
                        borderColor: '#4b5563',
                        borderWidth: 1,
                        titleColor: '#d1d5db',
                        bodyColor: '#d1d5db',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 8,
                        padding: 12,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#d1d5db'
                        },
                        grid: {
                            color: '#4b5563'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#d1d5db'
                        },
                        grid: {
                            color: '#4b5563'
                        }
                    }
                }
            }
        });
    }

    // --- Google Charts for GeoChart ---
    google.charts.load('current', {
        'packages': ['geochart'],
        'mapsApiKey': 'YOUR_Maps_API_KEY' // Replace with your actual API key if needed for higher usage
    });

    let geoChart = null; // To store the Google GeoChart instance

    // Map for standardizing country names for Google Charts GeoChart
    const countryAliasMap = {
        "united states of america": "United States", "usa": "United States", "uk": "United Kingdom",
        "britain": "United Kingdom", "russia": "Russia", "china": "China", "india": "India",
        "japan": "Japan", "germany": "Germany", "deutschland": "Germany", "france": "France",
        "italy": "Italy", "brazil": "Brazil", "brasil": "Brazil", "south africa": "South Africa",
        "eswatini": "Eswatini", "rome": "Italy", "constantinople": "Turkey", "nicomedia": "Turkey",
        "antioch": "Syria", "ancient greece": "Greece", "seleucid": "Syria", "ussr": "Russia",
        "yugoslavia": "Serbia", "east germany": "Germany", "west germany": "Germany",
        "korea, north": "North Korea", "korea, south": "South Korea", "congo (dr)": "Democratic Republic of the Congo",
        "cÃ´te d'ivoire": "Ivory Coast", "czech republic": "Czechia", "democratic republic of the congo": "Democratic Republic of the Congo",
        "falkland islands (malvinas)": "Falkland Islands", "hong kong": "Hong Kong", "iran, islamic republic of": "Iran",
        "macao": "Macau", "macedonia, the former yugoslav republic of": "North Macedonia", "myanmar": "Myanmar (Burma)",
        "palestine, state of": "Palestine", "republic of moldova": "Moldova", "russian federation": "Russia",
        "saint helena, ascension and Tristan da cunha": "Saint Helena, Ascension and Tristan da Cunha",
        "tanzania, united republic of": "Tanzania", "timor-leste": "East Timor", "venezuela, bolivarian republic of": "Venezuela",
        "viet nam": "Vietnam", "virgin islands, british": "British Virgin Islands", "virgin islands, u.s.": "United States Virgin Islands"
    };

    // Full list of countries for data list suggestions (ISO 3166-1 Alpha-2 countries as common names)
    const countries = [
        "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria",
        "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
        "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei Darussalam", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde",
        "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo",
        "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czechia", "Democratic Republic of the Congo", "Denmark", "Djibouti", "Dominica",
        "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia",
        "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea",
        "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel",
        "Italy", "Ivory Coast", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan",
        "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg",
        "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar (Burma)",
        "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia (Macedonia)", "Norway",
        "Oman",
        "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
        "Qatar",
        "Romania", "Russia", "Rwanda",
        "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria",
        "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu",
        "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan",
        "Vanuatu", "Vatican City (Holy See)", "Venezuela", "Vietnam",
        "Yemen",
        "Zambia", "Zimbabwe"
    ];

    const countrySuggestionsDatalist = document.getElementById('country-suggestions');
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        countrySuggestionsDatalist.appendChild(option);
    });

    function drawRegionsMap() {
        // Debounce map rendering
        if (typeof drawRegionsMap.timeout !== 'undefined') {
            clearTimeout(drawRegionsMap.timeout);
        }
        drawRegionsMap.timeout = setTimeout(() => {
            const data = [['Country', 'Number of Items', { role: 'tooltip', type: 'string', p: { html: true } }]];
            const countryCounts = {};
            const countryValues = {}; // To store total value per country

            collectionData.forEach(item => {
                const normalizedCountry = (countryAliasMap[item.country.toLowerCase()] || item.country);
                countryCounts[normalizedCountry] = (countryCounts[normalizedCountry] || 0) + 1;

                let itemValue = parseFloat(item.value || 0);
                if (item.type === 'Gold Bullion' && metalPrices.gold > 0) {
                    itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.gold);
                } else if (item.type === 'Silver Bullion' && metalPrices.silver > 0) {
                    itemValue = (item.weight_grams * (item.purity_percent / 100) * metalPrices.silver);
                }
                countryValues[normalizedCountry] = (countryValues[normalizedCountry] || 0) + itemValue;
            });

            for (const country in countryCounts) {
                const totalCountryValue = countryValues[country] || 0;
                const tooltipHtml = `<div style="padding: 10px; font-family: sans-serif; color: #333;"><strong>${country}</strong><br/>Items: ${countryCounts[country]}<br/>Total Value: $${totalCountryValue.toFixed(2)}</div>`;
                data.push([country, countryCounts[country], tooltipHtml]);
            }

            const chartData = google.visualization.arrayToDataTable(data);

            const options = {
                colorAxis: { colors: ['#60A5FA', '#FCD34D', '#D97706'] }, // Blue for low, Yellow for medium, Orange for high
                backgroundColor: '#1f2937',
                datalessRegionColor: '#4b5563',
                defaultColor: '#9CA3AF',
                legend: 'none',
                tooltip: { isHtml: true, trigger: 'focus' } // Enable HTML tooltips and show on focus/hover
            };

            const chartDiv = document.getElementById('regions-chart');
            if (!chartDiv) {
                console.error("Chart div 'regions-chart' not found.");
                return;
            }

            if (!geoChart) {
                geoChart = new google.visualization.GeoChart(chartDiv);
            }

            google.visualization.events.addListener(geoChart, 'select', () => {
                const selection = geoChart.getSelection();
                if (selection.length > 0) {
                    const selectedRow = selection[0].row;
                    const selectedCountry = chartData.getValue(selectedRow, 0);
                    showRegionDetails(selectedCountry);
                }
            });

            geoChart.draw(chartData, options);
        }, 300); // Debounce by 300ms
    }

    function showRegionDetails(countryName) {
        const modal = document.getElementById('country-details-modal');
        const title = document.getElementById('country-details-title');
        const itemsCount = document.getElementById('country-details-items');
        const tableBody = document.getElementById('country-details-table-body');

        title.innerText = countryName;
        tableBody.innerHTML = ''; // Clear previous items

        const itemsFromCountry = collectionData.filter(item => (countryAliasMap[item.country.toLowerCase()] || item.country) === countryName);
        itemsCount.innerText = itemsFromCountry.length;

        if (itemsFromCountry.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No items from this country.</td></tr>';
        } else {
            itemsFromCountry.forEach(item => {
                let itemValueDisplay = parseFloat(item.value || 0).toFixed(2);
                if (item.type === 'Gold Bullion' && metalPrices.gold > 0) {
                    itemValueDisplay = (item.weight_grams * (item.purity_percent / 100) * metalPrices.gold).toFixed(2);
                } else if (item.type === 'Silver Bullion' && metalPrices.silver > 0) {
                    itemValueDisplay = (item.weight_grams * (item.purity_percent / 100) * metalPrices.silver).toFixed(2);
                }
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.type}</td>
                    <td>${item.year || ''}</td>
                    <td>${item.denomination || ''}</td>
                    <td>$${itemValueDisplay}</td>
                    <td>${item.notes || ''}</td>
                    <td class="whitespace-nowrap">
                        <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editItem(${item.id})">
                            <i class="ph-fill ph-pencil-simple text-xl"></i>
                        </button>
                        <button class="text-red-400 hover:text-red-300" onclick="deleteItem(${item.id})">
                            <i class="ph-fill ph-trash text-xl"></i>
                        </button>
                    </td>
                `;
            });
        }
        showModal('country-details-modal');
    }

    function renderMissingCountries() {
        const missingCountriesDiv = document.getElementById('missing-countries-list');
        missingCountriesDiv.innerHTML = '';

        const collectedCountries = new Set(collectionData.map(item => (countryAliasMap[item.country.toLowerCase()] || item.country)));
        const missing = countries.filter(country => !collectedCountries.has(country));

        if (missing.length === 0) {
            missingCountriesDiv.innerHTML = '<p class="text-gray-400 col-span-full">Congratulations! You have items from every country in our list!</p>';
            return;
        }

        missing.forEach(country => {
            const countryCard = document.createElement('div');
            countryCard.className = 'card flex items-center justify-between p-4';
            countryCard.innerHTML = `
                <span class="text-gray-300 font-semibold">${country}</span>
                <button class="btn-primary btn-sm" onclick="quickAddItemToCountry('${country}')">Add Item</button>
            `;
            missingCountriesDiv.appendChild(countryCard);
        });
    }

    function quickAddItemToCountry(country) {
        showModal('add-item-modal');
        document.getElementById('item-country').value = country;
    }

    // --- Public Collection Link ---
    async function fetchPublicUrl() {
        const publicUrlInput = document.getElementById('public-collection-url');
        const publicUrlStatus = document.getElementById('public-url-status');
        const modalPublicUrlInput = document.getElementById('modal-public-collection-url');
        const modalPublicUrlStatus = document.getElementById('modal-public-url-status');

        publicUrlInput.value = '';
        publicUrlStatus.innerText = '';
        modalPublicUrlInput.value = '';
        modalPublicUrlStatus.innerText = '';

        if (!isAuthenticated()) {
            publicUrlInput.placeholder = "Sign in to generate your public link.";
            modalPublicUrlInput.placeholder = "Sign in to generate your public link.";
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/public_collection_link`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });

            if (!response.ok) {
                if (response.status === 404) {
                    publicUrlStatus.innerText = 'No public link generated yet.';
                    publicUrlInput.placeholder = "Your public collection URL will appear here";
                    modalPublicUrlStatus.innerText = 'No public link generated yet.';
                    modalPublicUrlInput.placeholder = "Your public collection URL will appear here";
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const fullUrl = `${window.location.origin}/?public=${result.public_id}`; // Construct full URL
            publicUrlInput.value = fullUrl;
            publicUrlStatus.innerText = 'Your public collection link is active.';
            publicUrlStatus.classList.remove('text-red-400');
            publicUrlStatus.classList.add('text-emerald-400');

            modalPublicUrlInput.value = fullUrl;
            modalPublicUrlStatus.innerText = 'Your public collection link is active.';
            modalPublicUrlStatus.classList.remove('text-red-400');
            modalPublicUrlStatus.classList.add('text-emerald-400');

        } catch (error) {
            console.error("Fetch public URL error:", error.message);
            publicUrlStatus.innerText = `Failed to fetch public link: ${error.message}`;
            publicUrlStatus.classList.remove('text-emerald-400');
            publicUrlStatus.classList.add('text-red-400');

            modalPublicUrlStatus.innerText = `Failed to fetch public link: ${error.message}`;
            modalPublicUrlStatus.classList.remove('text-emerald-400');
            modalPublicUrlStatus.classList.add('text-red-400');
        }
    }

    async function generatePublicLink() {
        const publicUrlStatus = document.getElementById('public-url-status');
        publicUrlStatus.innerText = '';
        const modalPublicUrlStatus = document.getElementById('modal-public-url-status');
        modalPublicUrlStatus.innerText = '';

        if (!isAuthenticated()) {
            showCustomConfirm('You must be logged in to generate a public link.', () => {});
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/public_collection_link`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to generate public link.');
            }

            await fetchPublicUrl(); // Refresh the URL display
            showCustomConfirm('Public link generated/updated successfully!', () => {});
        } catch (error) {
            console.error("Generate public URL error:", error.message);
            showCustomConfirm(`Failed to generate public link: ${error.message}`, () => {});
        }
    }

    async function revokePublicLink() {
        const publicUrlStatus = document.getElementById('public-url-status');
        publicUrlStatus.innerText = '';
        const modalPublicUrlStatus = document.getElementById('modal-public-url-status');
        modalPublicUrlStatus.innerText = '';

        if (!isAuthenticated()) {
            showCustomConfirm('You must be logged in to revoke a public link.', () => {});
            return;
        }

        if (!confirm('Are you sure you want to revoke your public collection link?')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/public_collection_link`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to revoke public link.');
            }

            document.getElementById('public-collection-url').value = '';
            document.getElementById('public-collection-url').placeholder = "Your public collection URL will appear here";
            publicUrlStatus.innerText = 'Public link revoked.';
            publicUrlStatus.classList.remove('text-emerald-400');
            publicUrlStatus.classList.add('text-red-400');

            document.getElementById('modal-public-collection-url').value = '';
            document.getElementById('modal-public-collection-url').placeholder = "Your public collection URL will appear here";
            modalPublicUrlStatus.innerText = 'Public link revoked.';
            modalPublicUrlStatus.classList.remove('text-emerald-400');
            modalPublicUrlStatus.classList.add('text-red-400');

            showCustomConfirm('Public link revoked successfully!', () => {});
        } catch (error) {
            console.error("Revoke public URL error:", error.message);
            showCustomConfirm(`Failed to revoke public link: ${error.message}`, () => {});
        }
    }

    function copyPublicUrl() {
        const publicUrlInput = document.getElementById('public-collection-url');
        publicUrlInput.select();
        publicUrlInput.setSelectionRange(0, 99999); // For mobile devices
        document.execCommand('copy');
        showCustomConfirm('Public URL copied to clipboard!', () => {});
    }

    async function loadPublicCollection(publicId) {
        try {
            const response = await fetch(`${API_BASE_URL}/public_collection/${publicId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    document.getElementById('public-collection-title').innerText = 'Public Collection Not Found';
                    document.getElementById('public-collection-table-body').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-400">The public collection ID is invalid or does not exist.</td></tr>';
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const publicCollectionData = await response.json();
            console.log("Public collection data:", publicCollectionData);

            // Populate public dashboard stats
            const totalItems = publicCollectionData.length;
            const totalValue = publicCollectionData.reduce((sum, item) => parseFloat(item.value || 0) + sum, 0);
            const uniqueCountries = new Set(publicCollectionData.map(item => item.country)).size;

            document.getElementById('public-total-items').innerText = totalItems;
            document.getElementById('public-total-value').innerText = `$${totalValue.toFixed(2)}`;
            document.getElementById('public-unique-countries').innerText = uniqueCountries;

            // Render public collection table
            const tableBody = document.getElementById('public-collection-table-body');
            tableBody.innerHTML = '';
            if (publicCollectionData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-400">This public collection is empty.</td></tr>';
            } else {
                publicCollectionData.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.type}</td>
                        <td>${item.country}</td>
                        <td>${item.year || ''}</td>
                        <td>${item.denomination || ''}</td>
                        <td>$${parseFloat(item.value || 0).toFixed(2)}</td>
                        <td>${item.notes || ''} ${item.reference_link ? `<a href="${item.reference_link}" target="_blank" class="text-blue-400 hover:underline">Ref</a>` : ''}</td>
                    `;
                });
            }
        } catch (error) {
            console.error("Error loading public collection:", error);
            document.getElementById('public-collection-title').innerText = 'Error Loading Public Collection';
            document.getElementById('public-collection-table-body').innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-400">Failed to load public collection: ${error.message}</td></tr>`;
        }
    }


    // --- Bullion Specific Functions ---
    function toggleBullionFields() {
        const itemType = document.getElementById('item-type').value;
        const bullionFields = document.getElementById('bullion-fields');
        const manualValueField = document.getElementById('manual-value-field');

        if (itemType === 'Gold Bullion' || itemType === 'Silver Bullion') {
            bullionFields.classList.remove('hidden');
            manualValueField.classList.add('hidden'); // Hide manual value for bullion
            document.getElementById('item-value').removeAttribute('required'); // No longer required for bullion
            document.getElementById('item-weight').setAttribute('required', 'required');
            document.getElementById('item-purity').setAttribute('required', 'required');
        } else {
            bullionFields.classList.add('hidden');
            manualValueField.classList.remove('hidden'); // Show manual value for coins/banknotes
            document.getElementById('item-value').setAttribute('required', 'required'); // Required for coins/banknotes
            document.getElementById('item-weight').removeAttribute('required');
            document.getElementById('item-purity').removeAttribute('required');
        }
    }

    function showBullionTypeFields() {
        document.getElementById('item-type').value = 'Gold Bullion'; // Default to Gold Bullion when adding from bullion section
        toggleBullionFields();
    }

    // Event listeners for calculating bullion value in the modal
    document.getElementById('item-weight').addEventListener('input', debounce(updateCalculatedBullionValue, 500));
    document.getElementById('item-purity').addEventListener('input', debounce(updateCalculatedBullionValue, 500));
    document.getElementById('item-type').addEventListener('change', () => {
        toggleBullionFields(); // Ensure fields hide/show correctly
        updateCalculatedBullionValue(); // Recalculate if type changes
    });


    function updateCalculatedBullionValue() {
        const itemType = document.getElementById('item-type').value;
        const weight = parseFloat(document.getElementById('item-weight').value);
        const purity = parseFloat(document.getElementById('item-purity').value);
        const calculatedValueSpan = document.getElementById('calculated-bullion-value');

        if (isNaN(weight) || isNaN(purity) || purity < 0 || purity > 100) {
            calculatedValueSpan.innerText = '$0.00';
            return;
        }

        let calculatedValue = 0;
        if (itemType === 'Gold Bullion' && metalPrices.gold > 0) {
            calculatedValue = (weight * (purity / 100) * metalPrices.gold);
        } else if (itemType === 'Silver Bullion' && metalPrices.silver > 0) {
            calculatedValue = (weight * (purity / 100) * metalPrices.silver);
        }

        calculatedValueSpan.innerText = `$${calculatedValue.toFixed(2)}`;
    }

    // Fetch Live Metal Prices
    async function fetchLiveMetalPrices() {
        const goldPriceElem = document.getElementById('gold-price');
        const silverPriceElem = document.getElementById('silver-price');

        goldPriceElem.innerText = 'Loading...';
        silverPriceElem.innerText = 'Loading...';

        // Using GoldAPI.io for live prices. You might need to sign up for a free API key.
        // Replace 'YOUR_GOLDAPI_API_KEY' with your actual API key.
        // For a simple free option, you might need to find one that doesn't require keys or has a very generous free tier.
        // Example with a placeholder API key:
        const GOLD_API_KEY = 'YOUR_GOLDAPI_API_KEY'; // <<< IMPORTANT: Replace with your actual GoldAPI.io API Key
        const GOLD_API_URL = `https://www.goldapi.io/api/XAU/USD`; // Gold (XAU) in USD per troy ounce
        const SILVER_API_URL = `https://www.goldapi.io/api/XAG/USD`; // Silver (XAG) in USD per troy ounce

        // Fallback for demo if no API key is available or API fails
        const fallbackGoldPricePerGram = 70.00; // Example: $70 per gram
        const fallbackSilverPricePerGram = 0.90; // Example: $0.90 per gram

        try {
            // Fetch Gold Price
            const goldResponse = await fetch(GOLD_API_URL, {
                headers: { 'x-access-token': GOLD_API_KEY, 'Content-Type': 'application/json' }
            });
            const goldData = await goldResponse.json();
            if (goldResponse.ok && goldData.price) {
                // GoldAPI.io typically gives price per troy ounce. 1 troy ounce = 31.1035 grams
                metalPrices.gold = goldData.price / 31.1035;
                goldPriceElem.innerText = `$${metalPrices.gold.toFixed(2)}`;
            } else {
                console.warn('Failed to fetch live gold price from API. Using fallback.');
                goldPriceElem.innerText = `$${fallbackGoldPricePerGram.toFixed(2)} (Fallback)`;
                metalPrices.gold = fallbackGoldPricePerGram;
            }

            // Fetch Silver Price
            const silverResponse = await fetch(SILVER_API_URL, {
                headers: { 'x-access-token': GOLD_API_KEY, 'Content-Type': 'application/json' }
            });
            const silverData = await silverResponse.json();
            if (silverResponse.ok && silverData.price) {
                metalPrices.silver = silverData.price / 31.1035;
                silverPriceElem.innerText = `$${metalPrices.silver.toFixed(2)}`;
            } else {
                console.warn('Failed to fetch live silver price from API. Using fallback.');
                silverPriceElem.innerText = `$${fallbackSilverPricePerGram.toFixed(2)} (Fallback)`;
                metalPrices.silver = fallbackSilverPricePerGram;
            }

            // After fetching prices, re-render the dashboard and bullion collection to update values
            renderAllViews(); // This will also call renderDashboardStats and renderBullionCollection
            updateCalculatedBullionValue(); // Update value in add/edit modal if open

        } catch (error) {
            console.error("Error fetching live metal prices:", error);
            goldPriceElem.innerText = `$${fallbackGoldPricePerGram.toFixed(2)} (Fallback)`;
            silverPriceElem.innerText = `$${fallbackSilverPricePerGram.toFixed(2)} (Fallback)`;
            metalPrices.gold = fallbackGoldPricePerGram;
            metalPrices.silver = fallbackSilverPricePerGram;
            showCustomConfirm('Failed to fetch live metal prices. Using estimated fallback prices.', () => {});
            renderAllViews(); // Still render with fallback
        }
    }

    // Fetch prices every 5 minutes (300,000 milliseconds)
    setInterval(fetchLiveMetalPrices, 300000);

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded. Starting app initialization...');
        applySavedTheme(); // Apply theme immediately on load
        attachGlobalEventListeners();
        fetchLiveMetalPrices(); // Initial fetch of metal prices

        const urlParams = new URLSearchParams(window.location.search);
        const publicId = urlParams.get('public');

        if (publicId) {
            // If public ID is present, render public collection view directly
            updateAuthUI(false); // Ensure logged out state for public view
            showView('content-public-collection'); // This will trigger loading public data
            loadPublicCollection(publicId);
        } else {
            // Otherwise, proceed with normal authenticated app flow
            updateAuthUI(isAuthenticated()); // Update UI based on initial token presence
            loadCollectionFromBackend(); // Attempt to load data if already authenticated
            showView('content-home'); // Default view on load is now the home page
        }
        console.log('App initialization completed successfully.');
    });

    // Toggle sidebar visibility on mobile
    document.getElementById('sidebar-toggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('-translate-x-full');
    });

    // Attach global event listeners (e.g., form submissions)
    function attachGlobalEventListeners() {
        // Add/Edit Item Form Submission
        const itemForm = document.getElementById('item-form');
        if (itemForm) {
            itemForm.addEventListener('submit', addOrUpdateItem);
        } else { console.error('item-form not found during attachGlobalEventListeners!'); }

        // Theme preference radio buttons
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                applyTheme(event.target.value);
                saveTheme(event.target.value);
            });
        });

        // Sign In button (for when user directly clicks it)
        const signinBtn = document.getElementById('signin-btn');
        if (signinBtn) {
            // No direct listener needed here as it's handled by onclick in HTML
        } else { console.error('signin-btn not found during attachGlobalEventListeners!'); }

        // Sign Up button
        const signupBtn = document.getElementById('signup-btn');
        if (signupBtn) {
             // No direct listener needed here as it's handled by onclick in HTML
        } else { console.error('signup-btn not found during attachGlobalEventListeners!'); }

        // Logout button
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                removeAuthToken();
                collectionData = []; // Clear data when logged out
                history.replaceState(null, '', window.location.pathname); // Clear public URL param on logout
                renderAllViews();
                showCustomConfirm('Signed out successfully!', () => {});
            });
        } else { console.error('logout-btn not found during attachGlobalEventListeners!'); }
    }

    // --- THEME MANAGEMENT ---
    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
        applyTheme(savedTheme);
        document.querySelector(`input[name="theme"][value="${savedTheme}"]`).checked = true;
    }

    function applyTheme(theme) {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
        } else {
            document.documentElement.classList.remove('dark');
            document.documentElement.classList.add('light');
        }
    }

    function saveTheme(theme) {
        localStorage.setItem('theme', theme);
    }


</script>

</body>
</html>
