<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸª™</text></svg>" type="image/svg+xml">
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinShelf - Collection Manager</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom styles for a more polished look */
        body {
            background-color: #111827; /* Dark gray background */
            color: #d1d5db; /* Light gray text */
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Custom scrollbar for a modern feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Custom scrollbar for specific elements */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }


        /* General styles for containers, no specific map library styles needed here */
        #map-container {
            width: 100%;
            /* min-height can be adjusted based on desired aspect ratio. 500px is a good start. */
            min-height: 500px;
            display: flex; /* Flex to center content if needed, though GeoChart fills its container */
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            overflow: hidden; /* Hide any overflow from the chart */
        }
        /* Make sure Google Charts fits its container */
        #map-container > div {
            width: 100% !important;
            height: 100% !important;
        }

        /* --- Google Charts Tooltip Custom Styles --- */
        /* This targets the main tooltip container, typically generated by Google Charts */
        .google-visualization-tooltip {
            background-color: #1f2937 !important; /* Dark background */
            border: 1px solid #4b5563 !important; /* Darker border */
            color: #d1d5db !important; /* Light text */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4) !important; /* Soft shadow */
            border-radius: 0.5rem !important; /* Rounded corners */
            padding: 0.75rem 1rem !important; /* Padding inside */
            font-family: 'Inter', sans-serif !important; /* Match app font */
            font-size: 0.875rem !important; /* Standard text size */
            line-height: 1.5 !important; /* Better line spacing */
        }
        /* Style for text within the tooltip */
        .google-visualization-tooltip p {
            margin-bottom: 0.25rem !important;
        }
        /* Style for headers within the tooltip if any */
        .google-visualization-tooltip h3 {
            color: #34D399 !important; /* Highlight color for headers, e.g., emerald */
            font-size: 1.125rem !important; /* Slightly larger heading */
            margin-bottom: 0.5rem !important;
        }
        /* Style for scrollable content within tooltip */
        .google-visualization-tooltip .tooltip-scroll-content {
            max-height: 100px; /* Limit height */
            overflow-y: auto; /* Enable scroll if content overflows */
            padding-right: 5px; /* Space for scrollbar */
        }
        /* Custom scrollbar for tooltip content */
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar {
            width: 6px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track */
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb {
            background: #60a5fa; /* Blue thumb */
            border-radius: 3px;
        }
        .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-thumb:hover {
            background: #3b82f6; /* Darker blue on hover */
        }

        /* Table hover effect */
        .data-table tbody tr:hover {
            background-color: #1f2937;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Chart.js tooltip custom styles */
        .chartjs-tooltip {
            background: #1f2937 !important;
            border: 1px solid #4b5563 !important;
            border-radius: 0.5rem !important;
            color: #d1d5db !important;
        }

        /* Overlay for unauthenticated state */
        .unauthenticated-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9); /* Same as body bg with transparency */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 20;
            border-radius: 0.5rem; /* Match card styling */
        }

        /* Ensure main content takes full height to allow its own scrolling */
        #main-content-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow-y: auto; /* This allows the main content to scroll independently */
        }
        
        /* On small screens, hide the fixed sidebar to allow full width for content */
        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%); /* Hidden by default */
            }
            #sidebar.open {
                transform: translateX(0); /* Shown when open */
            }
            /* Main content takes full width on mobile */
            .md\:ml-64 { /* Override Tailwind's md:ml-64 on mobile */
                margin-left: 0 !important;
            }
        }

        /* Keyframe for subtle bounce animation */
        @keyframes bounce-slow {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px); /* Smaller bounce */
            }
        }

        .animate-bounce-slow {
            animation: bounce-slow 3s infinite ease-in-out; /* Slower and smoother */
        }
        
        /* For light mode */
        html.light body {
            background-color: #f3f4f6; /* Light gray */
            color: #1f2937; /* Dark text */
        }
        html.light #sidebar {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light #sidebar .border-b, html.light #sidebar .border-t {
            border-color: #e5e7eb;
        }
        html.light #sidebar h1 {
            color: #1f2937;
        }
        html.light #sidebar .nav-link {
            color: #4b5563;
        }
        html.light #sidebar .nav-link:hover {
            background-color: #f3f4f6;
        }
        html.light #sidebar .nav-link.bg-gray-700 { /* Active link */
            background-color: #e5e7eb;
            color: #1f2937;
        }
        html.light .bg-gray-800 { /* Main content cards */
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light .bg-gray-700 { /* Inputs, table headers, etc. */
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        html.light input, html.light select, html.light textarea {
            background-color: #f9fafb;
            border-color: #d1d5db;
            color: #1f2937;
        }
        html.light .text-gray-300 { /* General text */
            color: #374151;
        }
        html.light .text-gray-400 { /* Secondary text */
            color: #6b7280;
        }
        html.light .text-gray-500 { /* Placeholder text */
            color: #9ca3af;
        }
        html.light .data-table tbody tr:hover {
            background-color: #f3f4f6;
        }
        html.light #map-container {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light .google-visualization-tooltip {
            background-color: #ffffff !important;
            border-color: #e5e7eb !important;
            color: #1f2937 !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
        }
        html.light .google-visualization-tooltip .tooltip-scroll-content::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        html.light .chartjs-tooltip {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            color: #1f2937 !important;
        }
        html.light #auth-status {
            color: #374151;
        }
        html.light #home-signup-btn, html.light #home-learn-more-btn {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        html.light #main-content-area header {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        html.light #main-content-area header h1, html.light #main-content-area header button {
            color: #1f2937;
        }
        html.light .unauthenticated-overlay {
            background-color: rgba(243, 244, 246, 0.9);
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <div id="app-content" class="flex flex-col md:flex-row min-h-screen bg-gray-900 text-gray-300">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-gray-800 border-r border-gray-700 flex flex-col
                                  transform -translate-x-full md:translate-x-0 md:flex-shrink-0 transition-transform duration-300 ease-in-out">
            <div class="h-16 flex items-center justify-center border-b border-gray-700 flex-shrink-0">
                <i class="ph-bold ph-coins text-3xl text-emerald-400"></i>
                <h1 class="text-xl font-bold ml-2">CoinShelf by Oscar</h1>
            </div>
            <div class="flex-grow overflow-y-auto">
                <nav class="p-4">
                    <a href="#" id="nav-home" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md bg-gray-700 text-white">
                        <i class="ph-bold ph-house-simple mr-3"></i> Home
                    </a>
                    <a href="#" id="nav-dashboard" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                        <i class="ph-bold ph-chart-pie-slice mr-3"></i> Dashboard
                    </a>
                    <a href="#" id="nav-collection" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                        <i class="ph-bold ph-list-dashes mr-3"></i> Collection
                        
<a href="#" id="nav-bullion" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                    <i class="ph-bold ph-banknote mr-3"></i> Bullion
                </a>
                        
                    </a>
                    <a href="#" id="nav-map" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                        <i class="ph-bold ph-map-trifold mr-3"></i> World Map
                    </a>
                    <a href="#" id="nav-missing" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                        <i class="ph-bold ph-flag mr-3"></i> Missing Countries
                    </a>
                    <a href="#" id="nav-settings" class="nav-link flex items-center px-4 py-2 mb-2 rounded-md hover:bg-gray-700">
                        <i class="ph-bold ph-gear mr-3"></i> Account Settings
                    </a>
                </nav>
            </div>
            <div class="p-4 border-t border-gray-700 flex flex-col space-y-3 flex-shrink-0">
                <button id="quick-add-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-plus-circle mr-2"></i> Quick Add Item
                </button>
                 <button id="import-data-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-upload-simple mr-2"></i> Import Data
                </button>
                <button id="export-data-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-download-simple mr-2"></i> Export Data
                </button>
                 <button id="clear-all-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-trash-simple mr-2"></i> Clear All Items
                </button>
                <button id="share-collection-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors">
                    <i class="ph-bold ph-share-network mr-2"></i> Share Collection
                </button>
            </div>

            <div class="p-4 border-t border-gray-700 mt-auto flex-shrink-0">
                <div id="auth-status" class="text-center text-sm mb-2"></div>
                <div id="auth-form-container">
                    <form id="login-form" class="space-y-3">
                        <input type="email" id="login-email" placeholder="Email" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <input type="password" id="login-password" placeholder="Password" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <button type="submit" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Sign In</button>
                        <button type="button" id="signup-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Sign Up</button>
                    </form>
                    <button type="button" id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm mt-3 hidden transition-colors">Sign Out</button>
                </div>
            </div>
        </aside>

        <main id="main-content-area" class="flex-1 flex flex-col md:ml-64">
            <header class="bg-gray-800 p-4 md:hidden flex items-center justify-between border-b border-gray-700 flex-shrink-0">
                <button id="mobile-menu-toggle" class="text-white text-2xl focus:outline-none">
                    <i class="ph-bold ph-list"></i>
                </button>
                <h1 class="text-xl font-bold text-white">CoinShelf</h1>
                <div class="w-8"></div> </header>

            <div id="content-home" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative">
                <div class="max-w-7xl mx-auto h-full flex flex-col items-center justify-center text-center py-12 px-4">
                    <i class="ph-bold ph-coins text-8xl text-emerald-400 mb-8 animate-bounce-slow"></i>
                    <h2 class="text-5xl font-bold text-white mb-6 leading-tight">Welcome to CoinShelf</h2>
                    <p class="text-xl text-gray-300 mb-8 max-w-2xl">
                        Your personal digital vault for managing and exploring your precious coin and banknote collection.
                        Organize your treasures, track their value, and discover new countries to collect!
                    </p>
                    <p class="text-md text-gray-400 mb-2">
                        Crafted with passion by <span class="font-semibold text-emerald-300">Oscar Brimelow</span>.
                    </p>
                    <p class="text-md text-gray-400 mb-10 flex items-center">
                        <a href="https://www.instagram.com/oscarbrimelow/" target="_blank" class="text-pink-400 hover:text-pink-300 transition-colors flex items-center">
                            <i class="ph-bold ph-instagram-logo text-xl mr-2"></i> Follow on Instagram
                        </a>
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="home-signup-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md text-lg transition-colors shadow-lg">
                            Get Started - Sign Up
                        </button>
                        <button id="home-learn-more-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-md text-lg transition-colors shadow-lg">
                            Learn More (Go to Dashboard)
                        </button>
                    </div>
                </div>
            </div>

            <div id="content-dashboard" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
                <div class="max-w-7xl mx-auto">
                    </div>
            </div>

            <div id="content-collection" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    </div>
            </div>

<div id="content-bullion" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
            <div class="max-w-7xl mx-auto">
                <h2 class="text-3xl font-bold text-white mb-6">Bullion Collection</h2>

                <div id="bullion-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Bullion Items</h3>
                        <p class="text-4xl font-bold text-emerald-400" id="bullion-total-items">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Purchase Value</h3>
                        <p class="text-4xl font-bold text-emerald-400" id="bullion-total-purchase-value">$0.00</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-300">Total Current Market Value</h3>
                        <p class="text-4xl font-bold text-emerald-400" id="bullion-total-current-value">$0.00</p>
                    </div>
                </div>

                <div class="flex justify-end mb-6">
                    <button id="add-bullion-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md flex items-center transition-colors">
                        <i class="ph-bold ph-plus-circle mr-2"></i> Add Bullion Item
                    </button>
                </div>

                <div class="flex-1 flex overflow-hidden">
                    <div class="w-full flex flex-col">
                        <div class="flex-1 overflow-y-auto overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
                            <table class="w-full text-left data-table min-w-max">
                                <thead class="bg-gray-700 sticky top-0">
                                    <tr>
                                        <th class="p-4 font-semibold">Material</th>
                                        <th class="p-4 font-semibold">Weight (oz)</th>
                                        <th class="p-4 font-semibold">Purity (%)</th>
                                        <th class="p-4 font-semibold">Year</th>
                                        <th class="p-4 font-semibold">Name/Notes</th>
                                        <th class="p-4 font-semibold">Purchase Price</th>
                                        <th class="p-4 font-semibold">Current Value</th>
                                        <th class="p-4 font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bullion-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="bullion-collection-status" class="text-gray-400 mt-6 text-center text-lg"></div>
            </div>
        </div>

            <div id="content-map" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto h-full">
                    <div id="map-container" class="h-[95%] w-full rounded-lg border border-gray-700">
                        <div id="geochart-canvas"></div>
                    </div>
                </div>
            </div>

            <div id="content-missing" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Countries to Collect</h2>
                    <div id="missing-countries-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                        </div>
                    <div id="missing-countries-status" class="text-gray-400 mt-6 text-center"></div>
                </div>
            </div>

            <div id="content-settings" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto relative hidden">
                <div class="max-w-3xl mx-auto bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h2 class="text-3xl font-bold text-white mb-6">Account Settings</h2>
                    <div id="settings-unauthenticated-overlay" class="unauthenticated-overlay ${isAuthenticated() ? 'hidden' : ''}">
                        <p class="text-xl text-red-400">Please sign in to manage your account settings.</p>
                    </div>
                    <div id="settings-content" class="${isAuthenticated() ? '' : 'hidden'}">
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Change Password</h3>
                            <form id="change-password-form" class="space-y-4">
                                <div>
                                    <label for="current-password" class="block text-sm font-medium text-gray-400">Current Password</label>
                                    <input type="password" id="current-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-gray-400">New Password</label>
                                    <input type="password" id="new-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label for="confirm-new-password" class="block text-sm font-medium text-gray-400">Confirm New Password</label>
                                    <input type="password" id="confirm-new-password" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                                </div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Change Password</button>
                                <div id="password-change-status" class="mt-2 text-sm"></div>
                            </form>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold text-gray-300 mb-4">Delete Account</h3>
                            <p class="text-gray-400 mb-4">
                                Permanently delete your account and all associated data. This action cannot be undone.
                            </p>
                            <button id="delete-account-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">Delete Account</button>
                            <div id="delete-account-status" class="mt-2 text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-public-collection" class="content-view flex-grow p-4 sm:p-6 overflow-y-auto hidden relative">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-white mb-6">Public Collection View</h2>
                    <div id="public-collection-details" class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700 mb-6">
                        <p class="text-lg text-gray-300" id="public-collection-owner">Loading...</p>
                        <p class="text-sm text-gray-500" id="public-collection-status"></p>
                    </div>

                    <div id="public-collection-coins" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        </div>
                    <div id="public-collection-bullion" class="mt-8">
                        <h3 class="text-2xl font-bold text-gray-300 mb-4">Bullion Items</h3>
                        <div class="flex-1 overflow-hidden">
                            <div class="w-full flex flex-col">
                                <div class="flex-1 overflow-y-auto overflow-x-auto bg-gray-800 rounded-lg border border-gray-700">
                                    <table class="w-full text-left data-table min-w-max">
                                        <thead class="bg-gray-700 sticky top-0">
                                            <tr>
                                                <th class="p-4 font-semibold">Material</th>
                                                <th class="p-4 font-semibold">Weight (oz)</th>
                                                <th class="p-4 font-semibold">Purity (%)</th>
                                                <th class="p-4 font-semibold">Year</th>
                                                <th class="p-4 font-semibold">Name/Notes</th>
                                                <th class="p-4 font-semibold">Current Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="public-bullion-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="public-bullion-collection-status" class="text-gray-400 mt-6 text-center text-lg"></div>
                    </div>
                    <div id="public-collection-empty" class="hidden text-center text-gray-400 text-lg mt-12">
                        This collection is empty or private.
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="coin-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden modal-backdrop">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h3 id="coin-modal-title" class="text-2xl font-bold text-white mb-4">Add New Coin</h3>
            <form id="coin-form" class="space-y-4">
                <div>
                    <label for="coin-name" class="block text-sm font-medium text-gray-400">Coin Name/Denomination</label>
                    <input type="text" id="coin-name" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="coin-country" class="block text-sm font-medium text-gray-400">Country</label>
                    <input type="text" id="coin-country" list="countries-list" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                    <datalist id="countries-list"></datalist>
                </div>
                <div>
                    <label for="coin-year" class="block text-sm font-medium text-gray-400">Year</label>
                    <input type="number" id="coin-year" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="coin-metal" class="block text-sm font-medium text-gray-400">Metal</label>
                    <input type="text" id="coin-metal" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="coin-purchase-price" class="block text-sm font-medium text-gray-400">Purchase Price (USD)</label>
                    <input type="number" step="0.01" id="coin-purchase-price" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="coin-quantity" class="block text-sm font-medium text-gray-400">Quantity</label>
                    <input type="number" id="coin-quantity" value="1" min="1" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="coin-notes" class="block text-sm font-medium text-gray-400">Notes</label>
                    <textarea id="coin-notes" rows="3" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-coin-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
                    <button type="submit" id="save-coin-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Save Coin</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bullion-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden modal-backdrop">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h3 id="bullion-modal-title" class="text-2xl font-bold text-white mb-4">Add New Bullion Item</h3>
            <form id="bullion-form" class="space-y-4">
                <div>
                    <label for="bullion-material" class="block text-sm font-medium text-gray-400">Material</label>
                    <select id="bullion-material" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">Select Material</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                    </select>
                </div>
                <div>
                    <label for="bullion-weight" class="block text-sm font-medium text-gray-400">Weight (troy oz)</label>
                    <input type="number" step="0.01" id="bullion-weight" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="bullion-purity" class="block text-sm font-medium text-gray-400">Purity (%)</label>
                    <input type="number" step="0.1" id="bullion-purity" max="100" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="bullion-year" class="block text-sm font-medium text-gray-400">Year (Optional)</label>
                    <input type="number" id="bullion-year" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="bullion-name-notes" class="block text-sm font-medium text-gray-400">Name/Notes (Optional)</label>
                    <input type="text" id="bullion-name-notes" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="bullion-purchase-price" class="block text-sm font-medium text-gray-400">Purchase Price (USD)</label>
                    <input type="number" step="0.01" id="bullion-purchase-price" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400">Estimated Current Value (USD)</label>
                    <p id="bullion-current-value-display" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-sm text-white">$0.00</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-bullion-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
                    <button type="submit" id="save-bullion-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Save Bullion</button>
                </div>
            </form>
        </div>
    </div>

    <div id="custom-confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden modal-backdrop">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center">
            <p id="custom-confirm-message" class="text-white text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-confirm-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
                <button id="custom-confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">OK</button>
            </div>
        </div>
    </div>

    <div id="quick-add-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden modal-backdrop">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm border border-gray-700 text-center">
            <h3 class="text-2xl font-bold text-white mb-4">Quick Add</h3>
            <p class="text-white text-lg mb-6">What would you like to add?</p>
            <div class="flex flex-col space-y-4">
                <button id="quick-add-coin-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md transition-colors">
                    <i class="ph-bold ph-coin mr-2"></i> Coin
                </button>
                <button id="quick-add-bullion-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md transition-colors">
                    <i class="ph-bold ph-banknote mr-2"></i> Bullion
                </button>
                <button type="button" id="cancel-quick-add-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="share-link-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden modal-backdrop">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h3 class="text-2xl font-bold text-white mb-4">Share Your Collection</h3>
            <p class="text-gray-300 mb-4">Anyone with this link can view your collection. This link is public!</p>
            <div class="flex items-center space-x-2 mb-4">
                <input type="text" id="public-collection-url-input" readonly class="flex-grow bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-sm focus:ring-emerald-500 focus:border-emerald-500 cursor-text">
                <button id="copy-public-url-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    Copy
                </button>
            </div>
            <p id="public-url-status" class="text-sm text-gray-400 mb-4"></p>
            <button id="close-share-modal-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Close</button>
        </div>
    </div>


    <script>
    // --- Configuration ---
    const API_BASE_URL = 'https://mycoinshelf.onrender.com/api'; // Or your deployed backend URL

    // --- DOM Elements ---
    const loginForm = document.getElementById('login-form');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const authStatus = document.getElementById('auth-status');
    const authFormContainer = document.getElementById('auth-form-container');

    const homeSignupBtn = document.getElementById('home-signup-btn');
    const homeLearnMoreBtn = document.getElementById('home-learn-more-btn');

    const navLinks = document.querySelectorAll('.nav-link');
    const contentViewElements = document.querySelectorAll('.content-view');

    const coinModal = document.getElementById('coin-modal');
    const coinModalTitle = document.getElementById('coin-modal-title');
    const coinForm = document.getElementById('coin-form');
    const cancelCoinBtn = document.getElementById('cancel-coin-btn');
    const saveCoinBtn = document.getElementById('save-coin-btn');
    const coinNameInput = document.getElementById('coin-name');
    const coinCountryInput = document.getElementById('coin-country');
    const coinYearInput = document.getElementById('coin-year');
    const coinMetalInput = document.getElementById('coin-metal');
    const coinPurchasePriceInput = document.getElementById('coin-purchase-price');
    const coinQuantityInput = document.getElementById('coin-quantity');
    const coinNotesInput = document.getElementById('coin-notes');
    const coinTableBody = document.getElementById('coin-table-body'); // Assuming you have this in collection view
    const collectionStatus = document.getElementById('collection-status'); // Assuming you have this

    const dashboardTotalValueElement = document.getElementById('dashboard-total-value');
    const dashboardTotalCoinsElement = document.getElementById('dashboard-total-coins');
    const dashboardChartCanvas = document.getElementById('dashboard-chart');
    let dashboardChart; // To hold the Chart.js instance

    const collectionTotalItemsElement = document.getElementById('collection-total-items');
    const collectionTotalPurchaseValueElement = document.getElementById('collection-total-purchase-value');
    const collectionTotalCurrentValueElement = document.getElementById('collection-total-current-value');
    const quickAddBtn = document.getElementById('quick-add-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const exportDataBtn = document.getElementById('export-data-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');

    const mapContainer = document.getElementById('map-container');
    const geochartCanvas = document.getElementById('geochart-canvas');

    const missingCountriesList = document.getElementById('missing-countries-list');
    const missingCountriesStatus = document.getElementById('missing-countries-status');

    const changePasswordForm = document.getElementById('change-password-form');
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const confirmNewPasswordInput = document.getElementById('confirm-new-password');
    const passwordChangeStatus = document.getElementById('password-change-status');
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const deleteAccountStatus = document.getElementById('delete-account-status');
    const settingsUnauthenticatedOverlay = document.getElementById('settings-unauthenticated-overlay');
    const settingsContent = document.getElementById('settings-content');

    const customConfirmModal = document.getElementById('custom-confirm-modal');
    const customConfirmMessage = document.getElementById('custom-confirm-message');
    const customConfirmOkBtn = document.getElementById('custom-confirm-ok');
    const customConfirmCancelBtn = document.getElementById('custom-confirm-cancel');
    let customConfirmCallback; // To store the callback for the custom confirmation

    const quickAddModal = document.getElementById('quick-add-modal');
    const quickAddCoinBtn = document.getElementById('quick-add-coin-btn');
    const quickAddBullionBtn = document.getElementById('quick-add-bullion-btn');
    const cancelQuickAddBtn = document.getElementById('cancel-quick-add-btn');

    const shareCollectionBtn = document.getElementById('share-collection-btn');
    const shareLinkModal = document.getElementById('share-link-modal');
    const publicCollectionUrlInput = document.getElementById('public-collection-url-input');
    const copyPublicUrlBtn = document.getElementById('copy-public-url-btn');
    const publicUrlStatus = document.getElementById('public-url-status');
    const closeShareModalBtn = document.getElementById('close-share-modal-btn');

    const publicCollectionDetails = document.getElementById('public-collection-details');
    const publicCollectionOwner = document.getElementById('public-collection-owner');
    const publicCollectionStatus = document.getElementById('public-collection-status');
    const publicCollectionCoinsDiv = document.getElementById('public-collection-coins');
    const publicCollectionBullionDiv = document.getElementById('public-collection-bullion');
    const publicBullionTableBody = document.getElementById('public-bullion-table-body');
    const publicBullionCollectionStatus = document.getElementById('public-bullion-collection-status');
    const publicCollectionEmpty = document.getElementById('public-collection-empty');

    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');

    // Theme Toggle
    const themeToggle = document.createElement('button'); // Create the button
    themeToggle.id = 'theme-toggle';
    themeToggle.className = 'w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md text-sm mt-3 transition-colors flex items-center justify-center';
    themeToggle.innerHTML = '<i class="ph-bold ph-moon-stars mr-2"></i> Toggle Theme';
    // Append it below the logout button or login/signup form
    if (authFormContainer) {
        authFormContainer.parentNode.insertBefore(themeToggle, authFormContainer.nextSibling);
    }

    // --- Data Storage ---
    let userCoins = [];
    let bullionCollection = [];
    let spotPrices = { gold_usd_oz: 0, silver_usd_oz: 0 }; // Store fetched spot prices
    let geoChart; // Google GeoChart instance

    // List of all countries (you can expand this as needed)
    const ALL_COUNTRIES = [
        "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria",
        "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia",
        "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia",
        "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo (Brazzaville)",
        "Congo (Kinshasa)", "Costa Rica", "Croatia", "Cuba", "Cyprus", "Czechia", "Denmark", "Djibouti", "Dominica", "Dominican Republic",
        "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France",
        "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti",
        "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Ivory Coast", "Jamaica",
        "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho",
        "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta",
        "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco",
        "Mozambique", "Myanmar", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria",
        "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay",
        "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia",
        "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia",
        "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea",
        "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania",
        "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda",
        "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City",
        "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
    ];

    // Populate the datalist for coin-country input
    const countriesDatalist = document.getElementById('countries-list');
    ALL_COUNTRIES.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        countriesDatalist.appendChild(option);
    });

    // --- Utility Functions ---
    function isAuthenticated() {
        return localStorage.getItem('access_token') !== null;
    }

    function getToken() {
        return localStorage.getItem('access_token');
    }

    function showCustomConfirm(message, callback) {
        customConfirmMessage.textContent = message;
        customConfirmModal.classList.remove('hidden');
        customConfirmCallback = callback; // Store the callback
    }

    function hideCustomConfirm() {
        customConfirmModal.classList.add('hidden');
        customConfirmCallback = null;
    }

    // Function to show a specific content view and hide others
    function showView(viewId) {
        contentViewElements.forEach(view => {
            view.classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');

        // Update active navigation link
        navLinks.forEach(link => {
            link.classList.remove('bg-gray-700', 'text-white');
            link.classList.add('hover:bg-gray-700');
        });
        const activeNavLink = document.getElementById(`nav-${viewId.replace('content-', '')}`);
        if (activeNavLink) {
            activeNavLink.classList.add('bg-gray-700', 'text-white');
            activeNavLink.classList.remove('hover:bg-gray-700');
        }

        // Close mobile sidebar if open
        sidebar.classList.remove('open');
        mobileSidebarOverlay.classList.add('hidden');
    }

    function resetForms() {
        coinForm.reset();
        coinForm.dataset.editId = ''; // Clear edit ID
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
        confirmNewPasswordInput.value = '';
        passwordChangeStatus.textContent = '';

        // Reset bullion form
        document.getElementById('bullion-form').reset();
        document.getElementById('bullion-form').dataset.editId = '';
        document.getElementById('bullion-current-value-display').textContent = '$0.00';
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }

    // --- Authentication UI Update ---
    function updateAuthUI(loggedIn) {
        if (loggedIn) {
            authStatus.textContent = `Logged in as: ${localStorage.getItem('user_email')}`;
            authStatus.classList.remove('text-red-400');
            authStatus.classList.add('text-emerald-400');
            loginForm.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            // Show authenticated content sections
            document.querySelectorAll('[id^="content-"]:not(#content-home)').forEach(el => {
                if (!el.id.includes('public-collection')) { // Keep public collection hidden unless accessed by URL
                    el.classList.remove('hidden');
                }
            });

            // Update settings view based on authentication
            if (settingsUnauthenticatedOverlay && settingsContent) {
                settingsUnauthenticatedOverlay.classList.add('hidden');
                settingsContent.classList.remove('hidden');
            }

            // Hide share collection button if public collection is not enabled/created
            // This will be updated after fetching public collection status
            shareCollectionBtn.classList.add('hidden');

        } else {
            authStatus.textContent = 'Not logged in.';
            authStatus.classList.remove('text-emerald-400');
            authStatus.classList.add('text-red-400');
            loginForm.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            // Hide authenticated content sections, show home
            document.querySelectorAll('[id^="content-"]:not(#content-home):not(#content-public-collection)').forEach(el => {
                el.classList.add('hidden');
            });
            showView('content-home'); // Always go to home when logged out

            if (settingsUnauthenticatedOverlay && settingsContent) {
                settingsUnauthenticatedOverlay.classList.remove('hidden');
                settingsContent.classList.add('hidden');
            }

            // Hide share collection button when logged out
            shareCollectionBtn.classList.add('hidden');
        }
    }

    // --- Theme Management ---
    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.documentElement.classList.remove('dark');
            themeToggle.innerHTML = '<i class="ph-bold ph-sun mr-2"></i> Toggle Theme (Light)';
        } else {
            document.documentElement.classList.add('dark');
            themeToggle.innerHTML = '<i class="ph-bold ph-moon-stars mr-2"></i> Toggle Theme (Dark)';
        }
    }

    function toggleTheme() {
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            themeToggle.innerHTML = '<i class="ph-bold ph-sun mr-2"></i> Toggle Theme (Light)';
        } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            themeToggle.innerHTML = '<i class="ph-bold ph-moon-stars mr-2"></i> Toggle Theme (Dark)';
        }
    }


    // --- API Calls (Coins) ---
    async function fetchCoins() {
        const token = getToken();
        if (!token) return;

        try {
            const response = await fetch(`${API_BASE_URL}/coins`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                if (response.status === 401) {
                    console.warn("Unauthorized. Token might be expired or invalid.");
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user_email');
                    updateAuthUI(false);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            userCoins = await response.json();
            renderCollection();
            renderDashboard();
            renderMap();
            renderMissingCountries();
            updateCollectionSummary();
        } catch (error) {
            console.error('Error fetching coins:', error);
            collectionStatus.textContent = 'Error loading collection.';
        }
    }

    async function saveCoin(coinData) {
        const token = getToken();
        if (!token) return;

        const isEdit = coinData.id;
        const method = isEdit ? 'PUT' : 'POST';
        const url = isEdit ? `${API_BASE_URL}/coins/${coinData.id}` : `${API_BASE_URL}/coins`;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(coinData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            showCustomConfirm(result.message, () => {
                coinModal.classList.add('hidden');
                fetchCoins(); // Refresh the list
            });
        } catch (error) {
            console.error('Error saving coin:', error);
            showCustomConfirm(`Error saving coin: ${error.message}`, () => {});
        }
    }

    async function deleteCoin(coinId) {
        const token = getToken();
        if (!token) return;

        showCustomConfirm('Are you sure you want to delete this coin?', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/coins/${coinId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showCustomConfirm(result.message, () => {
                    fetchCoins(); // Refresh the list
                });
            } catch (error) {
                console.error('Error deleting coin:', error);
                showCustomConfirm(`Error deleting coin: ${error.message}`, () => {});
            }
            hideCustomConfirm(); // Ensure modal is hidden after action
        });
    }

    // --- API Calls (Bullion) ---
    async function fetchBullion() {
        const token = getToken();
        if (!token) return;

        try {
            const response = await fetch(`${API_BASE_URL}/bullion`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (!response.ok) {
                if (response.status === 401) {
                    console.warn("Unauthorized. Token might be expired or invalid.");
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user_email');
                    updateAuthUI(false);
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            bullionCollection = await response.json();
            renderBullionCollection();
            updateBullionSummary();
            renderDashboard(); // Re-render dashboard to update bullion value
        } catch (error) {
            console.error('Error fetching bullion:', error);
            document.getElementById('bullion-collection-status').textContent = 'Error loading bullion collection.';
        }
    }

    async function saveBullionItem(itemData) {
        const token = getToken();
        if (!token) return;

        const isEdit = itemData.id;
        const method = isEdit ? 'PUT' : 'POST';
        const url = isEdit ? `${API_BASE_URL}/bullion/${itemData.id}` : `${API_BASE_URL}/bullion`;

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(itemData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            showCustomConfirm(result.message, () => {
                document.getElementById('bullion-modal').classList.add('hidden');
                fetchBullion(); // Refresh the list
            });
        } catch (error) {
            console.error('Error saving bullion item:', error);
            showCustomConfirm(`Error saving bullion item: ${error.message}`, () => {});
        }
    }

    async function deleteBullionItem(itemId) {
        const token = getToken();
        if (!token) return;

        showCustomConfirm('Are you sure you want to delete this bullion item?', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/bullion/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showCustomConfirm(result.message, () => {
                    fetchBullion(); // Refresh the list
                });
            } catch (error) {
                console.error('Error deleting bullion item:', error);
                showCustomConfirm(`Error deleting bullion item: ${error.message}`, () => {});
            }
            hideCustomConfirm(); // Ensure modal is hidden after action
        });
    }

    async function fetchSpotPrices() {
        try {
            const response = await fetch(`${API_BASE_URL}/spot_prices`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            spotPrices = await response.json();
            console.log("Fetched spot prices:", spotPrices);
            // After fetching spot prices, re-calculate and display current values
            updateBullionCurrentValueDisplay(); // For the modal if open
            updateBullionSummary(); // For the main summary
            renderBullionCollection(); // To update current value column
            renderDashboard(); // To update dashboard current value
        } catch (error) {
            console.error('Error fetching spot prices:', error);
            // Optionally, display a message to the user that spot prices could not be loaded
            // For now, it will just use default 0 values.
        }
    }

    // --- Public Collection API Calls ---
    async function fetchPublicCollection(publicId) {
        try {
            publicCollectionStatus.textContent = 'Loading public collection...';
            publicCollectionEmpty.classList.add('hidden');
            publicCollectionDetails.classList.remove('hidden'); // Show details while loading

            const response = await fetch(`${API_BASE_URL}/public_collection/${publicId}`);
            if (!response.ok) {
                publicCollectionOwner.textContent = 'Collection not found or private.';
                publicCollectionStatus.textContent = '';
                publicCollectionEmpty.classList.remove('hidden');
                publicCollectionCoinsDiv.innerHTML = ''; // Clear previous coins
                publicBullionTableBody.innerHTML = ''; // Clear previous bullion
                publicCollectionDetails.classList.add('hidden'); // Hide details if not found
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const publicData = await response.json();
            publicCollectionOwner.textContent = `Collection by: ${publicData.user_email}`;
            publicCollectionStatus.textContent = ''; // Clear loading message

            // Render public coins
            publicCollectionCoinsDiv.innerHTML = '';
            if (publicData.coins && publicData.coins.length > 0) {
                publicData.coins.forEach(coin => {
                    const card = `
                        <div class="bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700">
                            <h4 class="text-xl font-semibold text-white">${coin.name} (${coin.year})</h4>
                            <p class="text-gray-400">Country: ${coin.country}</p>
                            <p class="text-gray-400">Metal: ${coin.metal}</p>
                            <p class="text-gray-400">Quantity: ${coin.quantity}</p>
                            <p class="text-gray-400">Notes: ${coin.notes || 'N/A'}</p>
                        </div>
                    `;
                    publicCollectionCoinsDiv.innerHTML += card;
                });
            } else {
                publicCollectionCoinsDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">No coins in this collection.</p>';
            }

            // Render public bullion
            publicBullionTableBody.innerHTML = '';
            if (publicData.bullion && publicData.bullion.length > 0) {
                publicData.bullion.forEach(item => {
                    const row = `
                        <tr>
                            <td class="p-4">${item.material}</td>
                            <td class="p-4">${item.weight_oz}</td>
                            <td class="p-4">${item.purity_percent}%</td>
                            <td class="p-4">${item.year || 'N/A'}</td>
                            <td class="p-4">${item.notes || 'N/A'}</td>
                            <td class="p-4">${formatCurrency(item.current_value_usd)}</td>
                        </tr>
                    `;
                    publicBullionTableBody.innerHTML += row;
                });
                publicBullionCollectionStatus.textContent = '';
            } else {
                publicBullionCollectionStatus.textContent = 'No bullion items in this collection.';
            }

            // Hide empty message if either coins or bullion exist
            if (publicData.coins.length > 0 || publicData.bullion.length > 0) {
                publicCollectionEmpty.classList.add('hidden');
            } else {
                publicCollectionEmpty.classList.remove('hidden');
            }

        } catch (error) {
            console.error('Error fetching public collection:', error);
            publicCollectionOwner.textContent = 'Failed to load collection.';
            publicCollectionStatus.textContent = 'Please try again later or check the link.';
            publicCollectionEmpty.classList.remove('hidden');
            publicCollectionCoinsDiv.innerHTML = '';
            publicBullionTableBody.innerHTML = '';
            publicCollectionDetails.classList.add('hidden');
        }
    }


    async function generatePublicCollectionLink() {
        const token = getToken();
        if (!token) {
            showCustomConfirm('You must be logged in to share your collection.', () => {});
            return;
        }

        try {
            publicUrlStatus.textContent = 'Generating link...';
            publicCollectionUrlInput.value = '';

            const response = await fetch(`${API_BASE_URL}/public_collection/generate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const publicLink = `${window.location.origin}${window.location.pathname}?public=${data.public_id}`;
            publicCollectionUrlInput.value = publicLink;
            publicUrlStatus.textContent = 'Link generated!';
            publicCollectionUrlInput.select(); // Select the text for easy copying

            // Show the share collection button on the sidebar when logged in and public collection is enabled
            shareCollectionBtn.classList.remove('hidden');

        } catch (error) {
            console.error('Error generating public link:', error);
            publicUrlStatus.textContent = `Error: ${error.message}`;
            shareCollectionBtn.classList.add('hidden'); // Hide if generation failed
        }
    }

    async function togglePublicCollectionStatus(enable) {
        const token = getToken();
        if (!token) return;

        try {
            const endpoint = enable ? 'enable' : 'disable';
            const response = await fetch(`${API_BASE_URL}/public_collection/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            showCustomConfirm(data.message, () => {
                // After enabling/disabling, re-evaluate visibility of share button
                if (isAuthenticated()) {
                    checkPublicCollectionStatus(); // Check if public collection exists for this user
                }
            });

        } catch (error) {
            console.error(`Error toggling public collection status to ${enable}:`, error);
            showCustomConfirm(`Error: ${error.message}`, () => {});
        }
    }

    // Check if the user has a public collection created
    async function checkPublicCollectionStatus() {
        const token = getToken();
        if (!token) {
            shareCollectionBtn.classList.add('hidden'); // Ensure hidden if not logged in
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/public_collection/status`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 404) { // No public collection exists for this user
                    shareCollectionBtn.classList.add('hidden');
                    return;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.is_public) {
                shareCollectionBtn.classList.remove('hidden');
            } else {
                shareCollectionBtn.classList.add('hidden');
            }

        } catch (error) {
            console.error('Error checking public collection status:', error);
            shareCollectionBtn.classList.add('hidden'); // Hide button on error
        }
    }


    // --- Render Functions (Coins) ---
    function renderCollection() {
        const tbody = document.getElementById('coin-table-body'); // Make sure you have this in your HTML
        if (!tbody) {
            console.error("Coin table body not found!");
            return;
        }
        tbody.innerHTML = '';
        if (userCoins.length === 0) {
            collectionStatus.textContent = 'No coins in your collection yet. Add some!';
            return;
        }
        collectionStatus.textContent = '';
        userCoins.forEach(coin => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td class="p-4">${coin.name}</td>
                <td class="p-4">${coin.country}</td>
                <td class="p-4">${coin.year}</td>
                <td class="p-4">${coin.metal}</td>
                <td class="p-4">${formatCurrency(coin.purchase_price)}</td>
                <td class="p-4">${coin.quantity}</td>
                <td class="p-4">${coin.notes || 'N/A'}</td>
                <td class="p-4 text-right">
                    <button class="edit-coin-btn bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-md text-sm mr-2" data-id="${coin.id}">
                        <i class="ph-bold ph-pencil"></i>
                    </button>
                    <button class="delete-coin-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-md text-sm" data-id="${coin.id}">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                </td>
            `;
        });
    }

    function updateCollectionSummary() {
        const totalCoins = userCoins.reduce((sum, coin) => sum + coin.quantity, 0);
        const totalPurchaseValue = userCoins.reduce((sum, coin) => sum + (coin.purchase_price * coin.quantity), 0);
        
        collectionTotalItemsElement.textContent = totalCoins;
        collectionTotalPurchaseValueElement.textContent = formatCurrency(totalPurchaseValue);
        // Current value for coins is not implemented in backend, so it will be same as purchase for now
        collectionTotalCurrentValueElement.textContent = formatCurrency(totalPurchaseValue);
    }

    function showCoinModal(coin = null) {
        resetForms(); // Clear form first
        if (coin) {
            coinModalTitle.textContent = 'Edit Coin';
            coinNameInput.value = coin.name;
            coinCountryInput.value = coin.country;
            coinYearInput.value = coin.year;
            coinMetalInput.value = coin.metal;
            coinPurchasePriceInput.value = coin.purchase_price;
            coinQuantityInput.value = coin.quantity;
            coinNotesInput.value = coin.notes;
            coinForm.dataset.editId = coin.id; // Store ID for editing
        } else {
            coinModalTitle.textContent = 'Add New Coin';
        }
        coinModal.classList.remove('hidden');
    }

    // --- Render Functions (Bullion) ---
    function renderBullionCollection() {
        const bullionTableBody = document.getElementById('bullion-table-body');
        if (!bullionTableBody) {
            console.error("Bullion table body not found!");
            return;
        }
        bullionTableBody.innerHTML = '';
        if (bullionCollection.length === 0) {
            document.getElementById('bullion-collection-status').textContent = 'No bullion items in your collection yet. Add some!';
            return;
        }
        document.getElementById('bullion-collection-status').textContent = '';

        bullionCollection.forEach(item => {
            const row = bullionTableBody.insertRow();
            row.innerHTML = `
                <td class="p-4">${item.material}</td>
                <td class="p-4">${item.weight_oz}</td>
                <td class="p-4">${item.purity_percent}%</td>
                <td class="p-4">${item.year || 'N/A'}</td>
                <td class="p-4">${item.notes || 'N/A'}</td>
                <td class="p-4">${formatCurrency(item.purchase_price_usd)}</td>
                <td class="p-4">${formatCurrency(item.current_value_usd)}</td>
                <td class="p-4 text-right">
                    <button class="edit-bullion-btn bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-md text-sm mr-2" data-id="${item.id}">
                        <i class="ph-bold ph-pencil"></i>
                    </button>
                    <button class="delete-bullion-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-md text-sm" data-id="${item.id}">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                </td>
            `;
        });
    }

    function updateBullionSummary() {
        const totalBullionItems = bullionCollection.length;
        const totalPurchaseValue = bullionCollection.reduce((sum, item) => sum + item.purchase_price_usd, 0);
        const totalCurrentValue = bullionCollection.reduce((sum, item) => sum + item.current_value_usd, 0);

        document.getElementById('bullion-total-items').textContent = totalBullionItems;
        document.getElementById('bullion-total-purchase-value').textContent = formatCurrency(totalPurchaseValue);
        document.getElementById('bullion-total-current-value').textContent = formatCurrency(totalCurrentValue);
    }

    function showBullionModal(item = null) {
        const bullionModal = document.getElementById('bullion-modal');
        const bullionModalTitle = document.getElementById('bullion-modal-title');
        const bullionForm = document.getElementById('bullion-form');
        const bullionMaterialInput = document.getElementById('bullion-material');
        const bullionWeightInput = document.getElementById('bullion-weight');
        const bullionPurityInput = document.getElementById('bullion-purity');
        const bullionYearInput = document.getElementById('bullion-year');
        const bullionNameNotesInput = document.getElementById('bullion-name-notes');
        const bullionPurchasePriceInput = document.getElementById('bullion-purchase-price');
        const bullionCurrentValueDisplay = document.getElementById('bullion-current-value-display');

        resetForms(); // Clear form first

        if (item) {
            bullionModalTitle.textContent = 'Edit Bullion Item';
            bullionMaterialInput.value = item.material;
            bullionWeightInput.value = item.weight_oz;
            bullionPurityInput.value = item.purity_percent;
            bullionYearInput.value = item.year;
            bullionNameNotesInput.value = item.notes;
            bullionPurchasePriceInput.value = item.purchase_price_usd;
            bullionForm.dataset.editId = item.id; // Store ID for editing
        } else {
            bullionModalTitle.textContent = 'Add New Bullion Item';
        }

        updateBullionCurrentValueDisplay(); // Calculate initial value for modal
        bullionModal.classList.remove('hidden');
    }

    function updateBullionCurrentValueDisplay() {
        const bullionMaterialInput = document.getElementById('bullion-material');
        const bullionWeightInput = document.getElementById('bullion-weight');
        const bullionPurityInput = document.getElementById('bullion-purity');
        const bullionCurrentValueDisplay = document.getElementById('bullion-current-value-display');

        const material = bullionMaterialInput.value;
        const weight = parseFloat(bullionWeightInput.value);
        const purity = parseFloat(bullionPurityInput.value);

        let currentValue = 0;
        if (material && !isNaN(weight) && weight > 0 && !isNaN(purity) && purity > 0 && purity <= 100) {
            let spotPricePerOz = 0;
            if (material === 'gold' && spotPrices.gold_usd_oz) {
                spotPricePerOz = spotPrices.gold_usd_oz;
            } else if (material === 'silver' && spotPrices.silver_usd_oz) {
                spotPricePerOz = spotPrices.silver_usd_oz;
            }
            currentValue = (weight * spotPricePerOz * (purity / 100));
        }
        bullionCurrentValueDisplay.textContent = formatCurrency(currentValue);
    }

    // --- Dashboard Rendering ---
    let myDoughnutChart; // Keep a reference to the chart instance

    async function renderDashboard() {
        const dashboardContent = document.querySelector('#content-dashboard .max-w-7xl');
        if (!dashboardContent) {
            console.error("Dashboard content area not found.");
            return;
        }

        dashboardContent.innerHTML = `
            <h2 class="text-3xl font-bold text-white mb-6">Your Dashboard</h2>

            <div id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Total Coins</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-coins">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Total Bullion Items</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-bullion-items">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300">Total Collection Value (Coins + Bullion)</h3>
                    <p class="text-4xl font-bold text-emerald-400" id="dashboard-total-value">$0.00</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300 mb-4">Collection Value by Type</h3>
                    <div class="chart-container">
                        <canvas id="dashboard-chart"></canvas>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300 mb-4">Coins by Country</h3>
                    <div class="chart-container">
                        <canvas id="country-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        `;

        // Update total coins and bullion items
        const totalCoins = userCoins.reduce((sum, coin) => sum + coin.quantity, 0);
        document.getElementById('dashboard-total-coins').textContent = totalCoins;
        document.getElementById('dashboard-total-bullion-items').textContent = bullionCollection.length;

        // Calculate total values
        const totalCoinValue = userCoins.reduce((sum, coin) => sum + (coin.purchase_price * coin.quantity), 0);
        const totalBullionValue = bullionCollection.reduce((sum, item) => sum + item.current_value_usd, 0);
        const grandTotalValue = totalCoinValue + totalBullionValue;
        document.getElementById('dashboard-total-value').textContent = formatCurrency(grandTotalValue);


        // Render Doughnut Chart (Collection Value by Type)
        const ctxDoughnut = document.getElementById('dashboard-chart');
        if (ctxDoughnut) {
            if (myDoughnutChart) {
                myDoughnutChart.destroy(); // Destroy existing chart before creating a new one
            }

            myDoughnutChart = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: ['Coins', 'Bullion'],
                    datasets: [{
                        data: [totalCoinValue, totalBullionValue],
                        backgroundColor: ['#34D399', '#60A5FA'], // Emerald and Blue
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#1f2937' // Light text in dark mode, dark in light mode
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            console.error("Doughnut chart canvas not found.");
        }

        // Render Country Distribution Chart (Bar Chart for Coins)
        const ctxBar = document.getElementById('country-distribution-chart');
        if (ctxBar) {
            const countryCounts = {};
            userCoins.forEach(coin => {
                countryCounts[coin.country] = (countryCounts[coin.country] || 0) + coin.quantity;
            });

            const sortedCountries = Object.entries(countryCounts).sort(([, a], [, b]) => b - a);
            const labels = sortedCountries.map(([country]) => country);
            const data = sortedCountries.map(([, count]) => count);

            if (window.countryChart) { // Destroy previous instance if it exists
                window.countryChart.destroy();
            }

            window.countryChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Coins',
                        data: data,
                        backgroundColor: '#3B82F6', // Blue
                        borderColor: '#2563EB',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#1f2937'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#1f2937' // X-axis label color
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb' // X-axis grid color
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#1f2937' // Y-axis label color
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb' // Y-axis grid color
                            }
                        }
                    }
                }
            });
        } else {
            console.error("Country distribution chart canvas not found.");
        }

    }


    // --- Map Rendering ---
    function renderMap() {
        if (!geochartCanvas) {
            console.error("GeoChart canvas element not found!");
            return;
        }

        google.charts.load('current', {
            'packages': ['geochart']
        });
        google.charts.setOnLoadCallback(drawRegionsMap);

        function drawRegionsMap() {
            const countryCounts = {};
            userCoins.forEach(coin => {
                countryCounts[coin.country] = (countryCounts[coin.country] || 0) + coin.quantity;
            });

            // Convert to data table format
            const data = new google.visualization.DataTable();
            data.addColumn('string', 'Country');
            data.addColumn('number', 'Number of Coins');
            data.addColumn({
                type: 'string',
                role: 'tooltip',
                'p': {
                    'html': true
                }
            }); // Custom HTML tooltip

            // Add collected countries
            for (const country in countryCounts) {
                if (countryCounts.hasOwnProperty(country)) {
                    const count = countryCounts[country];
                    data.addRow([country, count, `<b>${country}</b>: ${count} coins`]);
                }
            }

            const options = {
                colorAxis: {
                    colors: ['#60A5FA', '#3B82F6', '#1D4ED8']
                }, // Blue shades for collected countries
                backgroundColor: {
                    fill: document.documentElement.classList.contains('dark') ? '#1f2937' : '#f3f4f6'
                }, // Match app background
                datalessRegionColor: document.documentElement.classList.contains('dark') ? '#4b5563' : '#d1d5db', // Grey for uncollected
                defaultColor: document.documentElement.classList.contains('dark') ? '#4b5563' : '#d1d5db',
                tooltip: {
                    isHtml: true
                },
                legend: 'none'
            };

            geoChart = new google.visualization.GeoChart(geochartCanvas);
            geoChart.draw(data, options);
        }
    }


    // --- Missing Countries Rendering ---
    function renderMissingCountries() {
        if (!missingCountriesList) {
            console.error("Missing countries list element not found!");
            return;
        }
        missingCountriesList.innerHTML = '';
        const collectedCountries = new Set(userCoins.map(coin => coin.country));
        const missingCountries = ALL_COUNTRIES.filter(country => !collectedCountries.has(country));

        if (missingCountries.length === 0) {
            missingCountriesStatus.textContent = 'You have collected coins from all listed countries! Congratulations!';
            return;
        }
        missingCountriesStatus.textContent = ''; // Clear previous message

        missingCountries.forEach(country => {
            const countryElement = document.createElement('div');
            countryElement.className = 'bg-gray-800 p-3 rounded-md shadow-sm text-center text-gray-300 border border-gray-700';
            countryElement.textContent = country;
            missingCountriesList.appendChild(countryElement);
        });
    }

    // --- All Views Rendering ---
    function renderAllViews() {
        renderCollection();
        renderDashboard();
        renderMap();
        renderMissingCountries();
        updateCollectionSummary();
        updateBullionSummary(); // Ensure bullion summary is also updated
    }


    // --- Event Listeners ---
    function attachGlobalEventListeners() {
        // Navigation
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = link.id.replace('nav-', 'content-');
                showView(viewId);
                // For dashboard, ensure charts are rendered/updated
                if (viewId === 'content-dashboard') {
                    renderDashboard();
                } else if (viewId === 'content-map') {
                    renderMap();
                } else if (viewId === 'content-collection') {
                    renderCollection();
                    updateCollectionSummary();
                } else if (viewId === 'content-bullion') {
                    fetchBullion(); // Ensure bullion data is fresh when navigating
                } else if (viewId === 'content-missing') {
                    renderMissingCountries();
                } else if (viewId === 'content-settings') {
                    // Update overlay visibility when navigating to settings
                    if (isAuthenticated()) {
                        settingsUnauthenticatedOverlay.classList.add('hidden');
                        settingsContent.classList.remove('hidden');
                    } else {
                        settingsUnauthenticatedOverlay.classList.remove('hidden');
                        settingsContent.classList.add('hidden');
                    }
                }
            });
        });

        // Modals
        cancelCoinBtn.addEventListener('click', () => coinModal.classList.add('hidden'));
        coinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const coinData = {
                name: coinNameInput.value,
                country: coinCountryInput.value,
                year: parseInt(coinYearInput.value),
                metal: coinMetalInput.value,
                purchase_price: parseFloat(coinPurchasePriceInput.value),
                quantity: parseInt(coinQuantityInput.value),
                notes: coinNotesInput.value
            };
            const editId = coinForm.dataset.editId;
            if (editId) {
                coinData.id = editId;
            }
            saveCoin(coinData);
        });

        // Quick Add Button
        if (quickAddBtn) {
            quickAddBtn.addEventListener('click', () => {
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to add items to your collection.', () => {});
                    return;
                }
                quickAddModal.classList.remove('hidden');
            });
        }
        if (cancelQuickAddBtn) {
            cancelQuickAddBtn.addEventListener('click', () => quickAddModal.classList.add('hidden'));
        }
        if (quickAddCoinBtn) {
            quickAddCoinBtn.addEventListener('click', () => {
                quickAddModal.classList.add('hidden');
                showCoinModal();
            });
        }
        if (quickAddBullionBtn) {
            quickAddBullionBtn.addEventListener('click', () => {
                quickAddModal.classList.add('hidden');
                showBullionModal();
            });
        }

        // Bullion Modal Event Listeners
        document.getElementById('cancel-bullion-btn').addEventListener('click', () => {
            document.getElementById('bullion-modal').classList.add('hidden');
            resetForms();
        });

        document.getElementById('bullion-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const bullionMaterialInput = document.getElementById('bullion-material');
            const bullionWeightInput = document.getElementById('bullion-weight');
            const bullionPurityInput = document.getElementById('bullion-purity');
            const bullionYearInput = document.getElementById('bullion-year');
            const bullionNameNotesInput = document.getElementById('bullion-name-notes');
            const bullionPurchasePriceInput = document.getElementById('bullion-purchase-price');

            const itemData = {
                material: bullionMaterialInput.value,
                weight_oz: parseFloat(bullionWeightInput.value),
                purity_percent: parseFloat(bullionPurityInput.value),
                year: bullionYearInput.value ? parseInt(bullionYearInput.value) : null,
                notes: bullionNameNotesInput.value,
                purchase_price_usd: parseFloat(bullionPurchasePriceInput.value)
            };

            const editId = document.getElementById('bullion-form').dataset.editId;
            if (editId) {
                itemData.id = editId;
            }
            saveBullionItem(itemData);
        });

        // Live update of current value in modal
        document.getElementById('bullion-material').addEventListener('input', updateBullionCurrentValueDisplay);
        document.getElementById('bullion-weight').addEventListener('input', updateBullionCurrentValueDisplay);
        document.getElementById('bullion-purity').addEventListener('input', updateBullionCurrentValueDisplay);
        
        // Delegation for edit/delete buttons on bullion table
        const bullionTableBody = document.getElementById('bullion-table-body');
        if (bullionTableBody) {
            bullionTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-bullion-btn') || e.target.closest('.edit-bullion-btn')) {
                    const btn = e.target.closest('.edit-bullion-btn');
                    const id = btn.dataset.id;
                    const item = bullionCollection.find(b => b.id == id);
                    if (item) {
                        showBullionModal(item);
                    }
                } else if (e.target.classList.contains('delete-bullion-btn') || e.target.closest('.delete-bullion-btn')) {
                    const btn = e.target.closest('.delete-bullion-btn');
                    const id = btn.dataset.id;
                    deleteBullionItem(id);
                }
            });
        }


        // Delegation for edit/delete buttons on coin table
        const coinTableBody = document.getElementById('coin-table-body');
        if (coinTableBody) {
            coinTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-coin-btn') || e.target.closest('.edit-coin-btn')) {
                    const btn = e.target.closest('.edit-coin-btn');
                    const id = btn.dataset.id;
                    const coin = userCoins.find(c => c.id == id);
                    if (coin) {
                        showCoinModal(coin);
                    }
                } else if (e.target.classList.contains('delete-coin-btn') || e.target.closest('.delete-coin-btn')) {
                    const btn = e.target.closest('.delete-coin-btn');
                    const id = btn.dataset.id;
                    deleteCoin(id);
                }
            });
        }


        // Custom Confirmation Modal buttons
        customConfirmOkBtn.addEventListener('click', () => {
            if (customConfirmCallback) {
                customConfirmCallback();
            }
            hideCustomConfirm();
        });
        customConfirmCancelBtn.addEventListener('click', hideCustomConfirm);

        // Auth
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Login failed');
                }

                const data = await response.json();
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('user_email', email); // Store user email
                updateAuthUI(true);
                showCustomConfirm('Logged in successfully!', () => {
                    // Load data and show dashboard after login
                    loadCollectionFromBackend();
                    fetchBullion();
                    fetchSpotPrices(); // Fetch spot prices after login
                    showView('content-dashboard');
                });
            } catch (error) {
                console.error('Login error:', error);
                showCustomConfirm(`Login failed: ${error.message}`, () => {});
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Signup failed');
                }

                const data = await response.json();
                showCustomConfirm(data.message + ' You can now log in.', () => {});
            } catch (error) {
                console.error('Signup error:', error);
                showCustomConfirm(`Signup failed: ${error.message}`, () => {});
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_email');
            userCoins = []; // Clear local data
            bullionCollection = []; // Clear local bullion data
            updateAuthUI(false);
            showView('content-home'); // Go back to home when logged out
            history.replaceState(null, '', window.location.pathname); // Clear public URL param on logout
            renderAllViews();
            showCustomConfirm('Signed out successfully!', () => {});
        });

        // Home View buttons
        if (homeSignupBtn) {
            homeSignupBtn.addEventListener('click', () => showView('content-settings')); // Navigate to settings for signup
        }
        if (homeLearnMoreBtn) {
            homeLearnMoreBtn.addEventListener('click', () => {
                if (isAuthenticated()) {
                    showView('content-dashboard');
                } else {
                    showCustomConfirm('Please sign in to access the dashboard.', () => {});
                }
            });
        }

        // Account Settings
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const currentPassword = currentPasswordInput.value;
                const newPassword = newPasswordInput.value;
                const confirmNewPassword = confirmNewPasswordInput.value;
                const token = getToken();

                if (newPassword !== confirmNewPassword) {
                    passwordChangeStatus.textContent = 'New passwords do not match.';
                    passwordChangeStatus.classList.add('text-red-400');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/change_password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Password change failed.');
                    }

                    const data = await response.json();
                    passwordChangeStatus.textContent = data.message;
                    passwordChangeStatus.classList.remove('text-red-400');
                    passwordChangeStatus.classList.add('text-emerald-400');
                    resetForms();
                } catch (error) {
                    console.error('Password change error:', error);
                    passwordChangeStatus.textContent = `Error: ${error.message}`;
                    passwordChangeStatus.classList.remove('text-emerald-400');
                    passwordChangeStatus.classList.add('text-red-400');
                }
            });
        }

        if (deleteAccountBtn) {
            deleteAccountBtn.addEventListener('click', () => {
                showCustomConfirm('Are you absolutely sure you want to delete your account? This cannot be undone.', async () => {
                    const token = getToken();
                    try {
                        const response = await fetch(`${API_BASE_URL}/delete_account`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Account deletion failed.');
                        }

                        const data = await response.json();
                        showCustomConfirm(data.message, () => {
                            localStorage.clear(); // Clear all local storage
                            updateAuthUI(false); // Update UI to logged out state
                            window.location.href = '/'; // Redirect to home page
                        });
                    } catch (error) {
                        console.error('Account deletion error:', error);
                        showCustomConfirm(`Error: ${error.message}`, () => {});
                    }
                });
            });
        }

        // Share Collection functionality
        if (shareCollectionBtn) {
            shareCollectionBtn.addEventListener('click', () => {
                if (!isAuthenticated()) {
                    showCustomConfirm('Please sign in to share your collection.', () => {});
                    return;
                }
                shareLinkModal.classList.remove('hidden');
                generatePublicCollectionLink(); // Generate/refresh link when modal opens
            });
        }
        if (closeShareModalBtn) {
            closeShareModalBtn.addEventListener('click', () => {
                shareLinkModal.classList.add('hidden');
                publicUrlStatus.textContent = ''; // Clear status message
            });
        }
        if (copyPublicUrlBtn) {
            copyPublicUrlBtn.addEventListener('click', async () => {
                const urlToCopy = publicCollectionUrlInput.value;
                if (urlToCopy) {
                    try {
                        await navigator.clipboard.writeText(urlToCopy);
                        publicUrlStatus.textContent = 'Link copied!';
                        setTimeout(() => publicUrlStatus.textContent = '', 3000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        publicUrlStatus.textContent = 'Failed to copy link.';
                    }
                }
            });
        }

        // Mobile sidebar toggle
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mobileSidebarOverlay.classList.toggle('hidden');
            });
        }
        if (mobileSidebarOverlay) {
            mobileSidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                mobileSidebarOverlay.classList.add('hidden');
            });
        }

        // Theme Toggle
        if (themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
    }


    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM Content Loaded. Starting app initialization...');
    applySavedTheme(); // Apply theme immediately on load
    attachGlobalEventListeners(); // Attach all event listeners

    // --- PASTE THESE NEW FUNCTION DEFINITIONS HERE ---

    /**
     * Fetches the user's coin collection from the backend API.
     * Updates the UI with the fetched data.
     */
    async function fetchCoins() {
        if (!isAuthenticated()) {
            console.warn('Not authenticated. Cannot fetch coins.');
            return;
        }
        try {
            const token = localStorage.getItem('access_token');
            // This API endpoint /api/coins (GET) matches your app (5).py
            const response = await fetch(`${API_BASE_URL}/coins`, { 
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const coins = await response.json();
                console.log('Fetched coins:', coins);
                // TODO: Add code here to render these coins in your UI
                // For example: displayCoins(coins);
            } else {
                const errorData = await response.json();
                console.error('Failed to fetch coins:', errorData.message);
                // TODO: Handle error, e.g., show an alert to the user
            }
        } catch (error) {
            console.error('Error fetching coins:', error);
            // TODO: Handle network error
        }
    }

    /**
     * Fetches current spot prices for gold and silver from the backend API.
     * Updates relevant UI elements with these prices.
     */
    async function fetchSpotPrices() {
        // This function does not require authentication if your backend /api/spot_prices is public
        try {
            // This API endpoint /api/spot_prices (GET) matches your app (5).py
            const response = await fetch(`${API_BASE_URL}/spot_prices`); 
            if (response.ok) {
                const prices = await response.json();
                console.log('Fetched spot prices:', prices);
                // TODO: Update your UI elements with these prices (e.g., a dashboard widget)
                // For example: document.getElementById('gold-price').textContent = prices.gold_usd_oz;
            } else {
                console.error('Failed to fetch spot prices:', response.statusText);
            }
        } catch (error) {
            console.error('Error fetching spot prices:', error);
        }
    }

    /**
     * Fetches the user's bullion collection from the backend API.
     * Updates the UI with the fetched data.
     */
    async function fetchBullion() {
        if (!isAuthenticated()) {
            console.warn('Not authenticated. Cannot fetch bullion.');
            return;
        }
        try {
            const token = localStorage.getItem('access_token');
            // This API endpoint /api/bullion (GET) matches your app (5).py
            const response = await fetch(`${API_BASE_URL}/bullion`, { 
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const bullion = await response.json();
                console.log('Fetched bullion:', bullion);
                // TODO: Add code here to render this bullion data in your UI
                // For example: displayBullion(bullion);
            } else {
                const errorData = await response.json();
                console.error('Failed to fetch bullion:', errorData.message);
                // TODO: Handle error
            }
        } catch (error) {
            console.error('Error fetching bullion:', error);
            // TODO: Handle network error
        }
    }

    /**
     * Checks the user's public collection status (e.g., if it's enabled/disabled).
     * Updates UI elements related to public sharing.
     */
    async function checkPublicCollectionStatus() {
        if (!isAuthenticated()) {
            console.warn('Not authenticated. Cannot check public collection status.');
            return;
        }
        try {
            const token = localStorage.getItem('access_token');
            // IMPORTANT: Your app (5).py DOES NOT currently have a GET endpoint for /api/public_collection/status.
            // You need to add this route to your app (5).py for this function to work.
            const response = await fetch(`${API_BASE_URL}/public_collection/status`, { 
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.ok) {
                const data = await response.json();
                console.log('Public collection status:', data);
                // TODO: Update UI based on data.is_public or data.public_url
                // For example: togglePublicShareButton(data.is_public);
            } else {
                console.error('Failed to fetch public collection status:', response.statusText);
            }
        } catch (error) {
            console.error('Error checking public collection status:', error);
        }
    }

    /**
     * Fetches a public collection by its unique ID.
     * Displays the public collection data on the page.
     * @param {string} publicId - The unique ID of the public collection.
     */
    async function fetchPublicCollection(publicId) {
        if (!publicId) {
            console.error('Public ID is missing.');
            return;
        }
        try {
            // This API endpoint /api/public_collection/<public_id> (GET) matches your app (5).py
            const response = await fetch(`${API_BASE_URL}/public_collection/${publicId}`); 
            if (response.ok) {
                const publicData = await response.json();
                console.log('Fetched public collection:', publicData);
                // TODO: Render this publicData in the 'content-public-collection' view
                // For example: displayPublicCollection(publicData);
            } else {
                const errorData = await response.json();
                console.error('Failed to fetch public collection:', errorData.message || response.statusText);
                // TODO: Handle cases where the public collection doesn't exist or is invalid
                showCustomConfirm('Public collection not found or inaccessible.', () => {
                    history.replaceState(null, '', window.location.pathname); // Clear URL param
                    showView('content-home'); // Redirect to home if public collection not found
                });
            }
        } catch (error) {
            console.error('Error fetching public collection:', error);
            // TODO: Handle network error
        }
    }

    // --- END OF NEW FUNCTION DEFINITIONS ---

    const urlParams = new URLSearchParams(window.location.search);
    const publicId = urlParams.get('public');

    if (publicId) {
        // If public ID is present, render public collection view directly
        updateAuthUI(false); // Ensure logged out state for public view
        showView('content-public-collection'); // This will trigger loading public data
        await fetchPublicCollection(publicId); // Fetch and render public data
    } else {
        // Otherwise, proceed with normal authenticated app flow
        updateAuthUI(isAuthenticated()); // Update UI based on initial token presence
        if (isAuthenticated()) {
            await fetchCoins(); // Fetch coins if authenticated
            await fetchSpotPrices(); // Fetch spot prices if authenticated
            await fetchBullion(); // Fetch bullion if authenticated
            checkPublicCollectionStatus(); // Check if public collection exists for this user
            showView('content-dashboard'); // Default view on load is now the dashboard if authenticated
        } else {
            showView('content-home'); // Default view on load is home page if not authenticated
        }
    }
    console.log('App initialization completed successfully.');

    // ... (The rest of your DOMContentLoaded code, like loginForm.addEventListener, registerForm.addEventListener, etc., goes here)
});

</script>

</body>
</html>
